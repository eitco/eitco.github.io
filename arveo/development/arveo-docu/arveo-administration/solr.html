<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solr :: arveo Documentation</title>
    <link rel="canonical" href="https://eitco.github.io/arveo-docu/arveo-administration/solr.html">
    <link rel="prev" href="audit.html">
    <link rel="next" href="jobs.html">
    <meta name="generator" content="Antora 3.2.0-alpha.4">
    <link rel="stylesheet" href="../../ui-assets/css/site.css">
    <link rel="stylesheet" href="../../ui-assets/css/custom.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand"> 
      <img src="../../ui-assets/img/arveo_WortBildmarke_NEG_500px.png" id="arveoLogo" style="vertical-align:middle;margin:10px 0px">
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://eitco.github.io">Home</a>
        <!--<div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>-->
        <!--<div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>-->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="arveo-docu" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-general/product-summary.html">What is <em>arveo</em> - Content Services Platform (CSP)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architecture Overview</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/content-services.html">Content Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/technology-stack.html">Opensource Technology Stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/application-security.html">Application security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/gobd.html">Compliance recommendations (GoBD)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Store</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-storage.html">Persistence architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-deletion.html">Data deletion</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-getting-started/getting-started.html">Getting Started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration und Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deployment-options.html">Deployment options</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="system-requirements.html">System requirements</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="authentication-oauth2.html">OAuth Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="db-access.html">Database access</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="content-elements-storage.html">Storage locations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="renditions.html">Renditions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention-container.html">Retention and Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="encryption.html">Encryption</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="messaging.html">Configure Active MQ</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="maintenance-mode-db-schema.html">Maintenance mode for the database schema</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="audit.html">Audit</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="solr.html">Solr</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="jobs.html">System jobs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="vault.html">Using Hashicorp Vault</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../commons/configuration-properties.html">Configuration Properties</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring.html">Monitoring</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Access Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/access-rights.html">Access rights</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/attribute-based-security.html">Attribute Based Access Control (ABAC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/permissions.html">Permissions on Type definitions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Modelling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/entity-types.html">Entity types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/entity-annotations.html">Entity annotations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/data-types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/system-fields.html">System fields</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/document-types.html">Document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/container-types.html">Container types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/relation-types.html">Relation types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/folder-types.html">Folder types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/metadata-types.html">Metadata types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/inheritance.html">Inheritance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/retention-annotations.html">Retention document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/tenant-separation.html">Tenant separation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/advanced-schema-changes.html">Advanced database schema changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-developer/repo-service.html">Repository Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-upload-data.html">Upload Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-download-data.html">Download Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-delete-objects.html">Delete Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-locking.html">Locking</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-download-links-external-users.html">Download Links for External Users</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/versioning.html">Versioning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/search-service.html">Search language</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-developer/retention-introduction.html">Retention</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/retention.html">Retention periods</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/retention-cleanup-job.html">Cleanup job</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">SDKs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/client-sdks-json-serialization.html">Client SDKs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/sdk-and-batch-operations.html">Java SDK for Spring applications</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/non-spring-sdk.html">Java SDK for non-Spring applications</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Events and messaging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/events.html">Events</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/integration-service.html">Enterprise Integration Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Archetypes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/slim-archetype.html">The Types archetype</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/full-featured-archetype.html">The full-featured archetype</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arveo-developer/system-tables.html">System Tables</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/compatibility-list.html">Compatibility List</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/release-notes.html">Release Notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/glossary.html">Important Terminology</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">arveo Documentation</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../arveo-general/product-summary.html">arveo Documentation</a></li>
    <li>Administration und Configuration</li>
    <li>Administration</li>
    <li><a href="solr.html">Solr</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Solr</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In order to use Solr in connection with <em>arveo</em>, an installation of a Solr service is required. Under the
following link you can download the current versions of Solr: <a href="https://solr.apache.org/downloads.html" class="bare" target="_blank" rel="noopener">https://solr.apache.org/downloads.html</a>.</p>
</div>
<div class="paragraph">
<p>The Solr service must be configured in <em>arveo</em> within the <em>application.yaml</em>. See
<a href="../commons/configuration-properties.html#_ecr_server_solr" class="xref page">Configuration properties</a> for details.</p>
</div>
<div class="paragraph">
<p>When a type definition is annotated with <code>@NOSql</code>, the entities stored in this type definition will be stored in
Solr, too. See <a href="../arveo-developer/entity-annotations.html#_entity_annotations_nosql_example" class="xref page">NOSQL Example</a> for how to enable this feature. The system
will create a special queue table in the relational database for such a type definition. The queue table will contain
the entities that have to be stored in Solr. A <a href="jobs.html#nosql_queue_job" class="xref page">system job</a> is used to process the
entries in the queue table.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solr_deployment"><a class="anchor" href="#solr_deployment"></a>Solr deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A small tutorial for setting up Solr for <em>arveo</em>.</p>
</div>
<div class="sect2">
<h3 id="arveo_yaml_configuration"><a class="anchor" href="#arveo_yaml_configuration"></a><em>arveo</em> yaml configuration:</h3>
<div class="paragraph">
<p>In the following example you can see a minimal <em>arveo</em> yaml configuration for Solr:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">ecr:
  server:
    solr:
      defaultConfigName: "ecr-config"
      host: "http://localhost:38983/solr"
      username: "ecr-solr-user"
      password: "password"</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Collections will be created automatically from <em>arveo</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>More information you can find in the chapter <a href="../commons/configuration-properties.html#_ecr_server_solr" class="xref page">ecr.server.solr</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="solr_security"><a class="anchor" href="#solr_security"></a>Solr security</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
As default Solr has <strong>no security settings</strong> set. It is very important to add the security settings for Solr!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information for setting up the security settings for Solr you can go the chapter <a href="#solr_security_configuration">solr security configuration</a></p>
</div>
</div>
<div class="sect2">
<h3 id="solr_configurations"><a class="anchor" href="#solr_configurations"></a>Solr Configurations</h3>
<div class="paragraph">
<p>If you want to use solr with <em>arveo</em> you must upload a ecr-config to the Solr zookeeper. The ecr-config you can find at the following url
<a href="https://nexus.eitco.de/repository/maven-ecr-releases/de/eitco/ecr/ecr-environment-configuration/18.0.0-SNAPSHOT/ecr-environment-configuration-18.0.0-SNAPSHOT-solr.zip">nexus.eitco.de</a> as zip-file.<br></p>
</div>
<div class="paragraph">
<p>The zip-file you can upload to zookeeper with the following command on the command line interface.</p>
</div>
<div class="paragraph">
<p>Shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">[path to zookeeper in solr]/zkcli.sh -cmd upconfig -confdir [path to solr-config from nexus.eitco.de]/solr-config -confname ecr-config -z [zookeeper host]:[zookeeper port]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Windows Shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[path to zookeeper in solr]\zkcli.bat -cmd upconfig -confdir [path to solr-config from nexus.eitco.de]\solr-config -confname ecr-config -z [zookeeper host]:[zookeeper port]</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="type_definitions"><a class="anchor" href="#type_definitions"></a>Type definitions</h4>
<div class="paragraph">
<p>You can annotate a type definition Class with @NOSql. If you do that every attribute in the type definition will be created as field in the Solr schema. If you want to deactivate an attribute of a type definition for Solr you can do the following:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have a type definition which is using the annotation @NOSql you must setup a Solr instance. Otherwise, <em>arveo</em> will not start!
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@NOSql
public interface PersonSimple {
    String getFirstName();
    void setFirstName(String value);

    @NOSql(value = false)
    String getLastName();
    void setLastName(String value);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example only the firstname will be automatically created in the schema of Solr.</p>
</div>
</div>
<div class="sect3">
<h4 id="fulltext_extraction"><a class="anchor" href="#fulltext_extraction"></a>Fulltext Extraction</h4>
<div class="paragraph">
<p><em>arveo</em> automatically extracts the content of the type definitions which are annotated with <code>@Type(ObjectType.DOCUMENT)</code> and <code>@NOSql</code>. You must set up the documents conversion service for this functionality. At the following we describe the process of the automatic extraction of Solr:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Arveo saves the documents who are annotated with <code>@NOSql</code> in a queue table named <em>type_definition_name + _ng</em>;</p>
</li>
<li>
<p>Now a job will fetch all entry in the queue table;</p>
</li>
<li>
<p>For each entry which are annotated with <code>@Type(ObjectType.DOCUMENT)</code> arveo will call the document conversion service to extract the fulltext from the content;</p>
</li>
<li>
<p>At the end all information will be saved to Solr.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>More general information about the document service full text extraction can be found <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons/document-conversion-parent/0.0.10-SNAPSHOT/documentation/index.html#_extracting_text_from_a_pdf_file">here</a> and <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons/document-conversion-parent/0.0.10-SNAPSHOT/documentation/index.html#_fulltext_plugins">here</a>.</p>
</div>
<div class="paragraph">
<p>More general information about extracting text with arveo and Solr you can find at chapter <a href="#fulltext_extraction_2">Fulltext extraction</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solr_security_configuration"><a class="anchor" href="#solr_security_configuration"></a>Solr security configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, Solr does not use any kind of authorization or authentication. In productive systems, Solr must be secured
by enabling transport encryption, authentication and authorization.</p>
</div>
<div class="paragraph">
<p>The transport encryption can be enabled by enabling HTTPs in Solr. See the
<a href="https://solr.apache.org/guide/8_11/enabling-ssl.html">Solr documentation</a> for instructions. When SSL is enabled, the
url in the configuration property <code>ecr.server.solr.host</code> must use the <em>https</em> scheme.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> can use basic authentication to authenticate requests sent to Solr. Solr provides a basic authentication
plugin that must be enabled as described in the <a href="https://solr.apache.org/guide/8_11/basic-authentication-plugin.html">documentation</a>.
Enabling authentication and authorization in Solr requires uploading a <em>security.json</em> file to Zookeeper. The following
example shows a security.json file that enables the basic auth plugin and a
<a href="https://solr.apache.org/guide/8_11/rule-based-authorization-plugin.html">rule based authorization plugin</a>.</p>
</div>
<div class="paragraph">
<p>There is a <a href="https://github.com/ansgarwiechers/solrpasswordhash">github project</a> containing a tool to generate the value
for the salt and password used in the credentials-property of the basic auth plugin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "authentication": {
    "blockUnknown": true,
    "class": "solr.BasicAuthPlugin",
    "credentials": {
      "ecr-solr-user": "qkxp6hmEeGTaqnEvSmH7f+qytLWd/JcwaUyqpdjt5rg= NERXZefDt7lXYvdZfB0hT3ZCgNFSqI4nJ7kGgbhaTWs="
    },
    "realm": "My Solr users",
    "forwardCredentials": false
  },
  "authorization": {
    "class": "solr.RuleBasedAuthorizationPlugin",
    "permissions": [
      {
        "name": "schema-edit",
        "role": "admin"
      },
      {
        "name": "update",
        "role": "admin"
      },
      {
        "name": "read",
        "role": [
          "user",
          "admin"
        ]
      }
    ],
    "user-role": {
      "ecr-solr-user": [
        "user",
        "admin"
      ]
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable basic auth support for the Solr client used by <em>arveo</em>, you have to set the following parameters in the
configuration for <em>arveo</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">ecr:
  server:
    solr:
      username: "ecr-solr-user"
      password: "password"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="storing_entities_in_solr"><a class="anchor" href="#storing_entities_in_solr"></a>Storing entities in Solr</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To be able to use Solr for advanced queries, the entities must be stored in Solr, too. To enable this, simply add the
<code>@NOSql</code> annotation to the attributes to be stored in Solr to the getters of your type definitions. The annotation can
be added to the class to store all attributes in Solr. <em>arveo</em> will automatically create the required fields
in the Solr schema. All entities will be stored in a single collection in Solr. To avoid name collisions,
the names of the fields in Solr will consist of the name of the type definition and the name of the attribute, separated
by a dot. For example, an attribute called "name" in a type definition called "invoice" would be named "invoice.name".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fulltext_extraction_2"><a class="anchor" href="#fulltext_extraction_2"></a>Fulltext extraction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is also possible to store fulltext data of the content of documents in Solr. For this, set the <code>fulltextExtraction</code>
attribute of the <code>@ContentElement</code> annotation to true (see <a href="content-elements-storage.html#configure_storage_locations" class="xref page">Content Elements</a>). The
fulltext data of the content elements will be stored in a field called
<code>&lt;typeDefinitionName&gt;.&lt;contentElementName&gt;.fulltext</code> in Solr. This field can be used in queries
just like any other field.</p>
</div>
<div class="paragraph">
<p>The fulltext extraction is performed by the document conversion service. Which types of content are supported for
fulltext extraction depends on the active plugins of the document conversion service. The open source plugins contained
in the document conversion service project support fulltext extraction for PDFs with text content and Microsoft Office
documents. The mime type of a content element is required for the fulltext extraction. By default, the mime type is
contained in the metadata of a content element. When the content element is stored in a separate field on the
database, the mime type is not available in the metadata but it can be defined in the <code>@ContentElement</code> annotation. If
the mime type is set to the default value (application/octet-stream), the service will try to auto-detect the mime type.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="searching_in_solr"><a class="anchor" href="#searching_in_solr"></a>Searching in Solr</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>arveo</em> API provides methods to perform queries in Solr. The methods use the EQL just like the regular
search methods that perform queries on the relational database. There are some EQL features that are not supported
when searching in Solr:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>joins and unions</p>
</li>
<li>
<p>subselects</p>
</li>
<li>
<p>exists expressions</p>
</li>
<li>
<p>toLower</p>
</li>
<li>
<p>less than</p>
</li>
<li>
<p>greater than</p>
</li>
<li>
<p>is null</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The behavior of the supported query expressions is dependent from the configuration of the field in Solr. For example,
a text field with a tokenizer that splits text by whitespaces will deliver different results for equality expressions
than a text field without such a tokenizer.</p>
</div>
<div class="paragraph">
<p>To perform a query in Solr for one specific type definition, use the <code>getNoSqlSearchService</code> method of the service client
for the type definition. In the following example, this method is used to find an entity by its ID in Solr:</p>
</div>
<div class="listingblock">
<div class="title">Searching for an entity by ID in Solr</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Optional&lt;TypedNOSqlSearchHit&lt;FieldTypeContainer&gt;&gt; optional = serviceClient.getNoSqlSearchService()
    .where().id().equalTo().value(identifier).holds().uniqueResult();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows how to search in the fulltext data stored in Solr.</p>
</div>
<div class="listingblock">
<div class="title">Searching for fulltext data in Solr</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">list = serviceClient.getNoSqlSearchService().where().contextReference(SimpleInvoiceNames.CONTENT_FULLTEXT)
    .contains().value("Gubergren accumsan takimata").holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>To search for values in a specific field, the correct field name must be used in the context reference. The auto-
generated name constant classes for the type definition interfaces contain a helper method to compute the name.
The following example shows how to use this method to search in a specific field of an entity.</p>
</div>
<div class="listingblock">
<div class="title">Searching for data in Solr using a specific field</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">list = serviceClient.getNoSqlSearchService().where()
    .contextReference(FieldTypeContainerNames.noSqlName(FieldTypeContainerNames.INTEGER_FIELD))
    .equalTo().value(7).holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the <code>getNoSqlSearchService</code> method, the query performed in Solr will automatically be limited to entities
belonging to one single type definition. In this case, it is not necessary to use the helper method from the generated
name constant class to compute the name. The service is able to automatically compute the corret name. To search for
entities in multiple type definitions, the method <code>de.eitco.ecr.sdk.SearchClient.searchServiceForNoSql</code> can be used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="combined_search"><a class="anchor" href="#combined_search"></a>Combined search</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>arveo</em> creates a special multi-valued field called <code>ecr_attributes</code> in Solr. When a getter (or an entire
interface) is annotated with <code>@NOSql(combinedSearch = true)</code>, the attribute of the getter (or all attributes of the interface)
will be copied in this field. The <code>ecr_attributes</code> field is of type string. The values of the attributes copied into
this field, will be converted automatically by Solr.</p>
</div>
<div class="paragraph">
<p>The <code>ecr_attributes</code> field can be used for a combined search of all attribute values. This makes it possible to provide
a search method where the user does not need to know the name of the attribute to search for:</p>
</div>
<div class="listingblock">
<div class="title">Performing a combined search</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Optional&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; hit =
    serviceClient1.getNoSqlSearchService().where().noSqlCombinedField().equalTo()
        .value(invoiceNumber).holds().uniqueResult();
Optional&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; hit =
    serviceClient1.getNoSqlSearchService().where().noSqlCombinedField().equalTo()
        .value(invoiceNumber).and().noSqlCombinedField().equalTo().value("29.99").holds().uniqueResult();
Optional&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; hit =
    serviceClient1.getNoSqlSearchService().where().noSqlCombinedField().like()
        .value("Kasd invidunt stet dolor")
        .and().contextReference(EcrQueryLanguage.COMBINED_SEARCH_FIELD).equalTo().value(invoiceNumber)
        .holds().uniqueResult();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to copy the extracted fulltext data of content elements to the combined <code>ecr_attributes</code> field, too. To
do so, configure the respective content element as shown below:</p>
</div>
<div class="listingblock">
<div class="title">Using combined search for extracted fulltext data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ContentElement(name = "pdf", contentType = "application/pdf", fulltextExtraction = true, textCombinedSearch = true, textCombinedSearchLimit = 200)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The relevant settings are <code>textCombinedSearch=true</code>, which enables the copying of the extracted fulltext data. The
<code>textCombinedSearchLimit</code> setting limits the number of characters to copy. This makes it possible to reduce the size of
the Solr index. A value of <code>0</code> means no limit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="relations_in_solr"><a class="anchor" href="#relations_in_solr"></a>Relations in Solr</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Relations between entities can be described using relation type definitions. While those relations can be easily
resolved in the relational database, NoSQL databases like Solr are not designed to support a relational data model as
shown in the following diagram:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="_images/3077d084ea9c6e6e4c75a114d20709c822a1bc9d.svg" alt="relation-type-model">
</div>
<div class="title">Figure 1. A model using a relation table</div>
</div>
<div class="paragraph">
<p>It is still possible to search for <em>Parent</em> entities by the IDs of the related <em>Child</em> entities in Solr using
arveo. To make this possible arveo stores the IDs of the <em>Child</em> entities related to a <em>Parent</em>
entity in a multi value field in Solr. To enable this feature, the type definition interface of the <em>Parent</em> type
must be annotated with <code>@NOSqlResolvedRelations</code>. The annotation requires a parameter containing the type definition
classes of the relations to store in Solr.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Only relations from the current version of the <em>Parent</em> entity to the current version of the <em>Child</em> entity can be
stored in Solr.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows how to search for entities by related child IDs:</p>
</div>
<div class="listingblock">
<div class="title">Searching for relation child IDs in Solr</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; list = documentServiceClient.getNoSqlSearchService().where() <i class="conum" data-value="1"></i><b>(1)</b>
    .contextReference(noSqlSearchHelper.getRelationChildIdsField(SimpleInvoice.class, InvoicePersonRelation.class)) <i class="conum" data-value="2"></i><b>(2)</b>
    .contains().value(containerClient.getIdentifier()).holds().unpaged(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain a NoSql search service from the service client for the <em>Parent</em> entity type definition</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using an (injectable) instance of <code>NoSqlSearchHelper</code> it is possible to get the name of the field containing the
child IDs in Solr</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the ID of the child entity to search for from the entity client of the relation child entity</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rebuilding_the_solr_index"><a class="anchor" href="#rebuilding_the_solr_index"></a>Rebuilding the Solr index</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Currently, there is no automated way to rebuild the Solr index. If the data in Solr was lost or corrupted, it can be
rebuilt using the NOSql queue tables of the affected type definitions.</p>
</div>
<div class="paragraph">
<p>When an entity is added or updated in a type
definition that is annotated with <code>@NOSql</code>, an entry for this entity is added to a queue table by a trigger on the
database. This queue table is named like the main table for the type definition with a <code>_nq</code> suffix. So for example,
if the main table is called <code>my_type_definition</code>, the queue table would be called <code>my_type_definition_nq</code>. It contains
a column for each attribute that is supposed to be contained in Solr and the following system fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nosql_queue_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the entry in the queue. This value is assigned automatically by the database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nosql_processing_counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A counter that is incremented each time the system has tried to store the entry in Solr. The initial value is supposed
 to be 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nosql_trigger_operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the operation that caused the entry to be added to the queue table. Could be INSERT, UPDATE or DELETE.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A system job periodically reads the entries contained in the queue table and stores them in Solr. When the entry was
successfully stored in Solr, it is deleted from the queue. If the entry could not be stored in Solr, the processing
counter is incremented and the job will try again until the maximum number of tries has been reached.</p>
</div>
<div class="paragraph">
<p>To rebuild the Solr index, the data to be stored in Solr has to be added to the queue table by copying the data
contained in the main table of the type definition. By definition, only the most recent version of each entity is
contained in Solr, so the data contained in the version table of the type definition is of no interest here. The
value of the <code>nosql_processing_counter</code> field must be set to 0. To treat the entity as a new object in Solr, set the
value of the <code>nosql_trigger_operation</code> field to <code>INSERT</code>. To perform an update on an already existing object in Solr,
set the value to <code>UPDATE</code>.</p>
</div>
<div class="paragraph">
<p>The code of the trigger function used to populate the queue table might be useful when creating the SQL script that
copies the entries. The trigger function is called like the main table of the type definition with a <code>_ntf</code> suffix.</p>
</div>
<div class="paragraph">
<p>When the type definition makes use of the <code>@NOSqlResolvedRelations</code> annotation, an additional field containing the
resolved IDs of the child entities of the relations on each entity will be contained in the queue table. This field
will be called <code>relation_&lt;type-id&gt;_child_ids</code> where <code>type-id</code> is the numeric ID of the relation type definition. This
ID can be found in the <code>ecr_types</code> table. To store the resolved child IDs in Solr, additional entries for each entity
containing the entity ID, the resolved child IDs, the update counter and the trigger operation are added to the queue
table. Note that the value for the trigger operation field must be set to <code>UPDATE</code> in this case.
The resolved child IDs can be copied from the table containing the relation. The <code>parent_id</code> field in this table will
contain the ID of the entity that is to be stored in Solr. The <code>child_id</code> field contains the IDs of the related child
entities.</p>
</div>
<div class="paragraph">
<p>The code of the trigger function used to populate the queue with the entries containing the resolved child ID might be
useful when writing the SQL script to copy these values. The trigger function will be called like the main table of
the relation type definition with a <code>_nrtf</code> suffix.</p>
</div>
<div class="sect2">
<h3 id="example_scripts"><a class="anchor" href="#example_scripts"></a>Example scripts</h3>
<div class="paragraph">
<p>The following examples show how to copy data to the queue table. The main table of the type definition in the example
is called <code>test_simple_invoice</code>.</p>
</div>
<div class="listingblock">
<div class="title">copying data from the main table to the queue table</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">insert
    into
    "test_simple_invoice_nq"(
        "version_number",
        "latest_version_id",
        "version_comment",
        "initial_creation_date",
        "creator_user_id",
        "retention_date",
        "modification_user_id",
        "creation_date",
        "update_counter",
        "last_delete_restore_date",
        "litigation_hold",
        "deleted",
        "parent_id",
        "modification_date",
        "id",
        "amount",
        "invoice_number",
        "nosql_processing_counter",
        "nosql_trigger_operation"
    )
select
    "version_number",
    "latest_version_id",
    "version_comment",
    "initial_creation_date",
    "creator_user_id",
    "retention_date",
    "modification_user_id",
    "creation_date",
    "update_counter",
    "last_delete_restore_date",
    "litigation_hold",
    "deleted",
    "parent_id",
    "modification_date",
    "id",
    "amount",
    "invoice_number",
    0,
    'INSERT'
from "test_simple_invoice";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">copying the resolved child IDs to the queue table</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">insert
    into
    "test_simple_invoice_nq"(
        "id",
        "relation_32877_child_ids",
        "nosql_processing_counter",
        "nosql_trigger_operation"
    )
select distinct
    a."parent_id",
    array(select b."child_id" from "test_invoice_person_relation" b
        where b."parent_id" = a."parent_id" and b."parent_version_id" is null),
    0,
    'UPDATE'
from "test_invoice_person_relation" a;</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="audit.html">Audit</a></span>
  <span class="next"><a href="jobs.html">System jobs</a></span>
</nav>
</article>
  </div>
</main>
    <!-- The Modal -->
    <div id="imageModalBox" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="img01">
        <div id="caption"></div>
    </div>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../ui-assets/js/site.js" data-ui-root-path="../../ui-assets"></script>
<script async src="../../ui-assets/js/vendor/highlight.js"></script>
<script async src="../../ui-assets/js/modal.js"></script>
<script src="../../ui-assets/js/vendor/lunr.js"></script>
<script src="../../ui-assets/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../ui-assets/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
