<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OAuth2.0 authentication and authorization :: arveo Documentation</title>
    <link rel="canonical" href="https://eitco.github.io/arveo-docu/arveo-administration/authentication-oauth2.html">
    <link rel="prev" href="system-requirements.html">
    <link rel="next" href="db-access.html">
    <meta name="generator" content="Antora 3.2.0-alpha.4">
    <link rel="stylesheet" href="../../ui-assets/css/site.css">
    <link rel="stylesheet" href="../../ui-assets/css/custom.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand"> 
      <img src="../../ui-assets/img/arveo_WortBildmarke_NEG_500px.png" id="arveoLogo" style="vertical-align:middle;margin:10px 0px">
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://eitco.github.io">Home</a>
        <!--<div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>-->
        <!--<div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>-->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="arveo-docu" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-general/product-summary.html">What is <em>arveo</em> - Content Services Platform (CSP)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architecture Overview</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/content-services.html">Content Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/technology-stack.html">Opensource Technology Stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/application-security.html">Application security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/gobd.html">Compliance recommendations (GoBD)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Store</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-storage.html">Persistence architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-deletion.html">Data deletion</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-getting-started/getting-started.html">Getting Started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration und Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deployment-options.html">Deployment options</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="system-requirements.html">System requirements</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="authentication-oauth2.html">OAuth Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="db-access.html">Database access</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="content-elements-storage.html">Storage locations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="renditions.html">Renditions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention-container.html">Retention and Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="encryption.html">Encryption</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="messaging.html">Configure Active MQ</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="maintenance-mode-db-schema.html">Maintenance mode for the database schema</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="audit.html">Audit</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="solr.html">Solr</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="jobs.html">System jobs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="vault.html">Using Hashicorp Vault</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../commons/configuration-properties.html">Configuration Properties</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring.html">Monitoring</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Access Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/access-rights.html">Access rights</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/attribute-based-security.html">Attribute Based Access Control (ABAC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/permissions.html">Permissions on Type definitions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Modelling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/entity-types.html">Entity types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/entity-annotations.html">Entity annotations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/data-types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/system-fields.html">System fields</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/document-types.html">Document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/container-types.html">Container types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/relation-types.html">Relation types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/folder-types.html">Folder types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/metadata-types.html">Metadata types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/inheritance.html">Inheritance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/retention-annotations.html">Retention document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/tenant-separation.html">Tenant separation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/advanced-schema-changes.html">Advanced database schema changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-developer/repo-service.html">Repository Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-upload-data.html">Upload Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-download-data.html">Download Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-delete-objects.html">Delete Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-locking.html">Locking</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/repo-service-download-links-external-users.html">Download Links for External Users</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/versioning.html">Versioning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/search-service.html">Search language</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-developer/retention-introduction.html">Retention</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/retention.html">Retention periods</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/retention-cleanup-job.html">Cleanup job</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">SDKs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/client-sdks-json-serialization.html">Client SDKs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/sdk-and-batch-operations.html">Java SDK for Spring applications</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/non-spring-sdk.html">Java SDK for non-Spring applications</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Events and messaging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/events.html">Events</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/integration-service.html">Enterprise Integration Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Archetypes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/slim-archetype.html">The Types archetype</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-developer/full-featured-archetype.html">The full-featured archetype</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arveo-developer/system-tables.html">System Tables</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/compatibility-list.html">Compatibility List</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/release-notes.html">Release Notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/glossary.html">Important Terminology</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">arveo Documentation</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../arveo-general/product-summary.html">arveo Documentation</a></li>
    <li>Administration und Configuration</li>
    <li>Administration</li>
    <li><a href="authentication-oauth2.html">OAuth Authentication</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">OAuth2.0 authentication and authorization</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>All <em>arveo</em> services require authentication, ensuring that only another <em>arveo</em> service or an authenticated user can use the REST API. Authentication of a user is done by an authentication service like Keycloak using OAuth2.0 and OpenID Connect.</p>
</div>
<div class="paragraph">
<p>This chapter describes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>how <em>arveo</em>'s content services act as an OAuth2.0 resource server for applications using the <em>arveo</em> REST API</p>
</li>
<li>
<p>how the <em>arveo</em> services use OAuth2.0 to authenticate to other services as a technical user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All content services use Spring Security for user authentication and authorization. The services support OAuth2.0 with OpenID Connect.
An arveo service can take the role of an OAuth2.0 <em>resource server</em> and/or a <em>client</em>. Services acting as a <em>client</em> perform authenticated requests to other services, using the authentication service to retrieve an access token.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="oauth2_0_flows_grant_types"><a class="anchor" href="#oauth2_0_flows_grant_types"></a>OAuth2.0 Flows (Grant types)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OAuth2.0 defines four flows to get an access token. These flows are called grant types. <em>arveo</em> supports the following flows for user authentication and service authentication.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client Credentials Flow: used for machine-to-machine service communication.</p>
</li>
<li>
<p>Authorization Code Flow with Proof Key for Code Exchange (PKCE) technique: used by <em>arveo</em> Web Applications sand also used by mobile apps.</p>
</li>
<li>
<p>Resource Owner Password Flow: can be used by highly-trusted apps.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connecting_arveo_services_to_an_authentication_service_using_oauth2_0"><a class="anchor" href="#connecting_arveo_services_to_an_authentication_service_using_oauth2_0"></a>Connecting arveo services to an authentication service using OAuth2.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To connect the arveo services to an authentication service that supports OAuth2.0, the issuer URI of the authentication service must be configured. Required configuration properties like OAuth2.0 endpoints and public keys will be discovered automatically. If the authentication service does not support auto discovery of configuration options, the required settings can be set manually using the configuration options of <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.security" target="_blank" rel="noopener">Spring Security</a>.</p>
</div>
<div class="paragraph">
<p>The following example shows a configuration for an arveo service acting as a <em>resource-server</em> using Keycloak.</p>
</div>
<div class="listingblock">
<div class="title">resource-server configuration using JSON web tokens</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: "https://keyloak.example.com/realms/MyRealm"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case the authentication service uses opaque tokens instead of JSON web tokens, the configuration would look as shown in the next example. In this case, the URI of the token introspection endpoint of the authentication service must be configured.</p>
</div>
<div class="listingblock">
<div class="title">resource-server configuration using opaque tokens</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  security:
    oauth2:
      resourceserver:
        opaquetoken:
          introspection-uri: "https://authentication.example.com/oauth2/introspect"
          client-id: "opaque-client"
          client-secret: "secret"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the service will communicate with other services, it acts as a <em>resource-server</em> and a <em>client</em>. Therefore, an oauth client must be configured as well. The following example shows a client configuration using the <em>client_credentials</em> grant type for service to service communication:</p>
</div>
<div class="listingblock">
<div class="title">resource-server and client configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: "https://keyloak.example.com/realms/MyRealm"
      client:
        registration:
          keycloak-client-credentials:
            provider: keycloak
            client-id: "myclient"
            client-secret: "BatqOpzPlIksUsqeZjgxcbAgrA0PQuFM"
            authorization-grant-type: "client_credentials"
        provider:
          keycloak:
            issuer-uri: "https://keyloak.example.com/realms/MyRealm"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="access_tokens_and_openid_connect"><a class="anchor" href="#access_tokens_and_openid_connect"></a>Access tokens and OpenID Connect</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The arveo services retrieve required information about the user from the access token. The <em>authentication</em> of the user is done by validating the signature of the JSON web token (JWT) or by introspecting the opaque token submitted in the request. <em>Authorization-</em> and additional information of the user like name, e-mail or custom attributes are retrieved from the access token&#8217;s claims.</p>
</div>
<div class="paragraph">
<p>Each arveo service checks the audience (<em>aud</em>) claim of a JWT to ensure that the user is authorized to access the service. The <em>aud</em> claim must contain the service&#8217;s name. The following table contains the names of the services.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">audiences</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content Repository Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">content-repository-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">audit-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Conversion Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">document-conversion-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TUS Upload Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tus-upload-service</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>User rights are read from the <code>scope</code> claim and from a custom claim called <code>authorities</code>. Some services require specific authorities for some features. The required authorities are listed in the service&#8217;s documentation.</p>
</div>
<div class="paragraph">
<p>It is possible to limit the access to a specific service by defining an additional mandatory user right. This can be enabled using the property <code>security.general.role-for-secured-access</code>.</p>
</div>
<div class="paragraph">
<p>The information read from the access token can be used in ABAC security methods to check a user&#8217;s access rights. Sometimes the information in the access tokens might not be sufficient. For example, information about a user&#8217;s group memberships might be too big to be stored in an access token. For situations like this, the OpenID Connect (OIDC) user information endpoint can be used to load additional information about a user. Information loaded using OIDC is added to the security context and is available in ABAC security methods, too. To activate this feature, the following configuration parameter must be set:</p>
</div>
<div class="listingblock">
<div class="title">enabling OIDC</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">commons:
  security:
    oauth2:
      external-user-management:
        oidc:
          fetch-user-info: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the URI of the user info endpoint is determined automatically by using the configured issuer URL of the resource-server configuration. Alternatively, the issuer URI for the OIDC lookup can be configured as shown below:</p>
</div>
<div class="listingblock">
<div class="title">configuring the issuer-uri</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">commons:
  security:
    oauth2:
      external-user-management:
        oidc:
          fetch-user-info: true
          issuer-uri: "http://localhost:12345"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The information loaded from the user info endpoint is cached to avoid frequent requests to the authentication service. By default, the cache entries are kept for 60 minutes. The configuration properties section for the group <code>commons.security.oauth2</code> contains information about how to change the caching parameters.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user_ids"><a class="anchor" href="#user_ids"></a>User IDs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Services that require a unique ID of a user use the value of the subject (<em>sub</em>) claim of a JWT or the name attribute of the token introspection response in case opaque tokens are used. The content repository service requires a unique 64 bit integer ID for each user. There are different ways of how to assign these internal IDs to a user. By default, the content repository service assumes that the authentication service is not able to assign numerical IDs and assigns a unique numerical ID to each user when the user performs the first request to the service. The assigned IDs are stored in a database table called <code>cmn_external_users</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The external ID used in the mapping is read from the subject claim of the token by default. If another claim contains the external ID, the name of this claim must be configured using the property <code>commons.security.oauth2.external-user-management.database-id-resolver.external-id-claim</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The automatic assignment of internal IDs can be deactivated as shown below:</p>
</div>
<div class="listingblock">
<div class="title">deactivating automatic internal ID assignment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">commons:
  security:
    oauth2:
      external-user-management:
        database:
          enabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service will then try to get a numeric ID for the user from the access token by checking for the claim configured in <code>commons.security.oauth2.external-user-management.token-id-resolver.id-claim</code>. By default, the claim <code>user-id</code> will be used. It must contain a value that can be parsed to <code>java.lang.Long</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="keycloak"><a class="anchor" href="#keycloak"></a>Keycloak</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak is the recommended authentication and authorization service to be used for <em>arveo</em>. Setup and configuration is covered by the <a href="https://www.keycloak.org/documentation">Keycloak documentation</a>. This section contains some best practices and recommendations.</p>
</div>
<div class="paragraph">
<p>Keycloak uses realms to separate environments. It is recommended to create a separate realm for <em>arveo</em>. The signature algorithm used for the tokens should be RS256, which currently is the default value in Keycloak.</p>
</div>
<div class="paragraph">
<p>Access to the services and client applications can be controlled by Keycloak clients. Each client should be used for one service or client application. For example, a separate client for service-to-service communication should be created. This must be a confidential client (requiring a client secret) that does only support the <code>client_credentials</code> flow. A client for application-to-service communication does not need to be confidential and should support the <code>authorization_code</code> and/or the <code>resource_owner_password</code> flow.</p>
</div>
<div class="paragraph">
<p>By default, Keycloak will add several attributes of a user to an issed token like the user&#8217;s unique ID in the <code>sub</code> claim. Additional required claims like <code>aud</code> (audience) can be set using token mappers.</p>
</div>
<div class="sect2">
<h3 id="using_active_directory_or_entra_id"><a class="anchor" href="#using_active_directory_or_entra_id"></a>Using Active Directory or Entra ID</h3>
<div class="paragraph">
<p>Keycloak can act as an intermediate between Microsoft Active Directory (using user federation) and Azure Entra ID (using an identity provider). User data will be managed in Active Directory or Entra ID while Keycloak will issue tokens for the services and client applications.</p>
</div>
<div class="paragraph">
<p>User federation with Active Directory can be achieved by setting up an LDAP synchronization. Single sign on using the Windows credentials is possible using Kerberos.</p>
</div>
<div class="paragraph">
<p>Azure Entra ID must be added as a generic OpenID Connect 1.0 provider. The predefined social login template for Microsoft Azure does not offer the required customization options. All that is required in Entra ID is an app registration for Keycloak with the redirect URI shown in the Keycloak admin UI. By default, Keycloak will use it&#8217;s internal UUID of an imported user for the <code>sub</code> claim in the issued tokens. It is recommended to use the object ID of the user in Azure instead. Add a mapper of type <em>Attribute Importer</em> to the identity provider that maps the <code>oid</code> claim to a user attribute called <code>oid</code>. To get access to the <code>oid</code> claim, the <em>Scopes</em> setting of the identity provider must be set to <code>openid profile</code>. Then configure a token mapper to add this user attribute to a token claim called <code>oid</code>. Using the property <code>commons.security.oauth2.external-user-management.database-id-resolver.external-id-claim=oid</code> will tell <em>arveo</em> to use this claim as the user&#8217;s external ID.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="system-requirements.html">System requirements</a></span>
  <span class="next"><a href="db-access.html">Database access</a></span>
</nav>
</article>
  </div>
</main>
    <!-- The Modal -->
    <div id="imageModalBox" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="img01">
        <div id="caption"></div>
    </div>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../ui-assets/js/site.js" data-ui-root-path="../../ui-assets"></script>
<script async src="../../ui-assets/js/vendor/highlight.js"></script>
<script async src="../../ui-assets/js/modal.js"></script>
<script src="../../ui-assets/js/vendor/lunr.js"></script>
<script src="../../ui-assets/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../ui-assets/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
