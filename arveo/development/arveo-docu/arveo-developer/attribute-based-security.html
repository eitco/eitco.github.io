<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Attribute Based Access Control (ABAC) :: arveo Documentation</title>
    <link rel="canonical" href="https://eitco.github.io/arveo-docu/arveo-developer/attribute-based-security.html">
    <link rel="prev" href="access-rights.html">
    <link rel="next" href="permissions.html">
    <meta name="generator" content="Antora 3.2.0-alpha.4">
    <link rel="stylesheet" href="../../ui-assets/css/site.css">
    <link rel="stylesheet" href="../../ui-assets/css/custom.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand"> 
      <img src="../../ui-assets/img/arveo_WortBildmarke_NEG_500px.png" id="arveoLogo" style="vertical-align:middle;margin:10px 0px">
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://eitco.github.io">Home</a>
        <!--<div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>-->
        <!--<div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>-->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="arveo-docu" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-general/product-summary.html">What is <em>arveo</em> - Content Services Platform (CSP)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architecture Overview</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/content-services.html">Content Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/technology-stack.html">Opensource Technology Stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/application-security.html">Application security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/gobd.html">Compliance recommendations (GoBD)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Store</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-storage.html">Persistence architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-deletion.html">Data deletion</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-getting-started/getting-started.html">Getting Started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration und Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-administration/installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/deployment-options.html">Deployment options</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/system-requirements.html">System requirements</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/authentication-oauth2.html">OAuth Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/db-access.html">Database access</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/content-elements-storage.html">Storage locations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/renditions.html">Renditions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/retention-container.html">Retention and Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/encryption.html">Encryption</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/messaging.html">Configure Active MQ</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/maintenance-mode-db-schema.html">Maintenance mode for the database schema</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/audit.html">Audit</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/solr.html">Solr</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/jobs.html">System jobs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/vault.html">Using Hashicorp Vault</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../commons/configuration-properties.html">Configuration Properties</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arveo-administration/monitoring.html">Monitoring</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Access Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="access-rights.html">Access rights</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="attribute-based-security.html">Attribute Based Access Control (ABAC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="permissions.html">Permissions on Type definitions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Modelling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="entity-types.html">Entity types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="entity-annotations.html">Entity annotations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="data-types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="system-fields.html">System fields</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="document-types.html">Document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="container-types.html">Container types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="relation-types.html">Relation types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="folder-types.html">Folder types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="metadata-types.html">Metadata types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="inheritance.html">Inheritance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention-annotations.html">Retention document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tenant-separation.html">Tenant separation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced-schema-changes.html">Advanced database schema changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="repo-service.html">Repository Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-upload-data.html">Upload Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-download-data.html">Download Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-delete-objects.html">Delete Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-locking.html">Locking</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-download-links-external-users.html">Download Links for External Users</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="versioning.html">Versioning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="search-service.html">Search language</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="retention-introduction.html">Retention</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention.html">Retention periods</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention-cleanup-job.html">Cleanup job</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">SDKs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="client-sdks-json-serialization.html">Client SDKs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="sdk-and-batch-operations.html">Java SDK for Spring applications</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="non-spring-sdk.html">Java SDK for non-Spring applications</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Events and messaging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="events.html">Events</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="integration-service.html">Enterprise Integration Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Archetypes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="slim-archetype.html">The Types archetype</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="full-featured-archetype.html">The full-featured archetype</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="system-tables.html">System Tables</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/compatibility-list.html">Compatibility List</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/release-notes.html">Release Notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/glossary.html">Important Terminology</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">arveo Documentation</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../arveo-general/product-summary.html">arveo Documentation</a></li>
    <li>Developer</li>
    <li>Access Control</li>
    <li><a href="attribute-based-security.html">Attribute Based Access Control (ABAC)</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Attribute Based Access Control (ABAC)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>arveo allows entity access based on attributes of that entity.
This can be specified per entity by a static method annotated with <code>@Security</code>.
The method must return an eql expression that resolves to a boolean i.e. a condition.
It will be called by arveo when entities of the given type are accessed to retrieve an additional filter for the access.
<strong>Operations will only affect entities where the condition evaluates to true.</strong></p>
</div>
<div class="paragraph">
<p>Every operation on entities of the type will execute the method and add the resulting expression to the filter of the operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Searches will add the expression to the filter of the search request.</p>
</li>
<li>
<p>Batch operations will add the expression to their filter</p>
</li>
<li>
<p>Calls that operate on a specific id will fail if the expression yields <code>false</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The simplest case would look like this:</p>
</div>
<div class="listingblock">
<div class="title">The simplest access check</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.DOCUMENT)
public interface UnsecuredDocuments {

    @Security
    static Expression&lt;Boolean&gt; calculateAccess() {

        return Eql.alwaysTrue();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would add the filter 'true' to every operation on the entity, which would allow anyone to access entities.</p>
</div>
<div class="paragraph">
<p>In most cases, one would want to compare attributes of the entity with properties of the user requesting the current operation.
The first can be accomplished with the eql:</p>
</div>
<div class="listingblock">
<div class="title">Accessing an attribute</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.CONTAINER)
public interface ThresholdContainer {

    int getThreshold();

    void setThreshold(int threshold);

    @Security
    static Expression&lt;Boolean&gt; calculateAccess(Alias alias) {

        return EcrQueryLanguage.condition().
                        alias(alias).field("threshold").
                                greaterThan().value(300);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Users may only access entities of the type above where the field 'threshold' is greater than 300.</p>
</div>
<div class="paragraph">
<p>In order to check the user requesting an operation, one can define a parameter to the method of the type <code>de.eitco.ecr.common.search.AuthenticationContext</code>.
Other information may be accessed this way, too.
The method can have up to four parameters of the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>de.eitco.ecr.common.search.AuthenticationContext</code>: this class holds information about the user requesting the operation.</p>
</li>
<li>
<p><code>de.eitco.ecr.common.AccessRight</code>: the right needed to perform the operation.</p>
</li>
<li>
<p><code>de.eitco.ecr.common.search.Alias</code>: identifies the part of the query that holds the entity</p>
</li>
<li>
<p><code>org.jooq.DSLContext</code>: an entrypoint to the <a href="https://www.jooq.org/doc/3.15/manual/">jooq</a> api bound to the database and schema the table containing the entities is located in.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="parameters"><a class="anchor" href="#parameters"></a>Parameters</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="authenticationcontext_who_requests_the_operation"><a class="anchor" href="#authenticationcontext_who_requests_the_operation"></a><code>AuthenticationContext</code>: who requests the operation?</h3>
<div class="paragraph">
<p>The <code>AuthenticationContext</code> holds information about the user requesting the operation.
This parameter will most likely be used in every such method, except for the most basic cases.</p>
</div>
<div class="paragraph">
<p>Take a case where access to a document is specified by a field named <code>access_token</code>.
It holds the name of a user-management authority every user with access to it must have.
If it is null, every user has access to the document:</p>
</div>
<div class="listingblock">
<div class="title">A type specifying different access to different users</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.DOCUMENT)
@OverwriteAllowed
public interface DocumentWithAccessToken {

    @Mandatory(false)
    String getAccessToken(); <i class="conum" data-value="1"></i><b>(1)</b>

    void setAccessToken(String accessToken);

    @Security
    static Expression&lt;Boolean&gt; calculateAccess(Alias alias, AuthenticationContext authenticationContext, DSLContext dslContext) { <i class="conum" data-value="4"></i><b>(4)</b>

        return EcrQueryLanguage.condition()
            .alias(alias).field("access_token").isNull() <i class="conum" data-value="2"></i><b>(2)</b>
            .or()
            .value(authenticationContext.getAuthoritiesAsStrings())
            .contains().alias(alias).field("access_token")
            .holds();
    }

    // ...
    // more attributes <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the type defines the attribute that specifies access</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the query generated uses this attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>other elements of the type are omitted for the sake of readability</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>note that the third parameter is unused. In such a case it could be omitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>AuthenticationContext</code> provides access to the <code>CommonAuthentication</code> and the <code>ExternalCommonUserDetails</code> stored in the
security context of the current user. The <code>CommonAuthentication</code> contains the user&#8217;s IDs (internal and external). The
<code>ExternalCommonUserDetails</code> contain common and generic attributes that were read from the user&#8217;s access token and/or from
the OpenID Connect user info endpoint. All of this information can be used to decide whether the user is allowed to
perform a specific action or not. In the next example the email of a user is used in an ABAC security method.</p>
</div>
<div class="listingblock">
<div class="title">using a user&#8217;s email address in ABAC</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mandatory
String getEmail();

void setEmail(String email);

@Security
static Expression&lt;Boolean&gt; checkAccess(Alias alias, AuthenticationContext authenticationContext) {

    ExternalCommonUserDetails details = authenticationContext.getCommonUserDetails();

    return EcrQueryLanguage.condition()
        .alias(alias).field("email")
        .equalTo().value(details.getEmail())
        .holds();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="accessright_what_will_the_operation_do"><a class="anchor" href="#accessright_what_will_the_operation_do"></a><code>AccessRight</code>: what will the operation do?</h3>
<div class="paragraph">
<p>The <code>AccessRight</code> parameter holds the right necessary to perform the operation requested.
This is a hint for the method about what should actually be done in the operation.
It allows differentiating between read and write access:</p>
</div>
<div class="listingblock">
<div class="title">A type differentiating between read and write access</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.CONTAINER)
@OverwriteAllowed
public interface ContainerAccessedByUserId {

    long getOwner(); <i class="conum" data-value="1"></i><b>(1)</b>

    void setOwner(long owner);

    List&lt;Long&gt; getAudience(); <i class="conum" data-value="2"></i><b>(2)</b>

    void setAudience(List&lt;Long&gt; audience);

    @Security
    static Expression&lt;Boolean&gt; checkAccess(Alias alias, AuthenticationContext authenticationContext, AccessRight right) {

        long userId = authenticationContext.getAuthentication().getInternalIdOrFail();

        if (AccessRight.READ.getValue() &lt; right.getValue()) { <i class="conum" data-value="3"></i><b>(3)</b>

            return EcrQueryLanguage.condition().alias(alias).field("owner").equalTo().value(userId).holds();
        }

        return EcrQueryLanguage.condition()  <i class="conum" data-value="4"></i><b>(4)</b>
            .alias(alias).field("audience").contains().value(userId)
            .or().alias(alias).field("owner").equalTo().value(userId)
            .holds();
    }

    // ...
    // more attributes
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This type defines an attribute <code>owner</code> holding the user id of the user, responsible.
The owner of an entity will be the only user to modify the entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The type also defines a list of user ids <code>audience</code>, holding the ids of users that may read the entity.
Users that are neither <code>owner</code> nor <code>audience</code> have no access on the entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Thus, in cases where a right greater than <code>READ</code> is requested, the method returns an expression, that checks whether the current user is the owner of the document.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In every other case .i.e. the requested access right is <code>READ</code> or below, an expression is returned, that checks whether the current user is the owner or part of the audience.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="alias"><a class="anchor" href="#alias"></a><code>Alias</code></h3>
<div class="paragraph">
<p>The alias identifies the part of the query executed that contains the entity and should be used to reference its members.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Always use the alias as given in the examples.
Other ways to reference the entity might work in most cases but only using the alias assures that referencing entity attributes works in every case.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The full class name is <code>de.eitco.ecr.common.search.Alias</code>.
Avoid confusion with another <code>Alias</code> class.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="dslcontext"><a class="anchor" href="#dslcontext"></a><code>DSLContext</code></h3>
<div class="paragraph">
<p>In some cases, using expressions on the entity itself may become cumbersome or slow.
For that, one can use the DSLContext parameter.
This allows access by <a href="https://www.jooq.org/doc/3.15/manual/">jooq</a> to any table in the same schema the table of the requested entity is located in.
It can be used to obtain specific data directly.</p>
</div>
<div class="paragraph">
<p>Since the access is directly to the database, there are no further access checks on queries using DSLContext.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Depending on the operation requested, the method may be able to execute <code>INSERT</code> or <code>UPDATE</code> statements.
It is the responsibility of the security methods author to make sure changes do not create an inconsistent or otherwise corrupted state of the database.
The simplest way to assure this, is to use the DSLContext only to read data.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_abac_properties"><a class="anchor" href="#_abac_properties"></a>Security properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes it might be required to distinguish between a user changing the value of an attribute used for the attribute based access control and a user changing some other attribute of an entity. For example, the security requirements might make it necessary that only one specific user is allowed to change security-relevant attributes, but other users are allowed to change other attributes.</p>
</div>
<div class="paragraph">
<p>To meet such requirements, attributes used in ABAC can be annotated with <code>@SecurityProperty</code>. Changing the value of such a property requires the highest access right <code>CHANGE_ACCESS_RIGHTS</code>. If such an operation occurs, the ABAC method will be called with the value <code>CHANGE_ACCESS_RIGHTS</code> for the <code>AccessRight</code> parameter.</p>
</div>
<div class="paragraph">
<p>Security properties can be defined as exclusive or basic. Exclusive security properties cannot be changed in an operation that would change any other property of the entity. This can be used to ensure that a user, who is designated to manage entity security cannot perform any other kind of change on the entities.</p>
</div>
<div class="paragraph">
<p>The following example shows a type definition that uses a list of user IDs to decide whether a user is allowed to access an entity or not. To keep the example simple, no distinction is made betweed read- and write-access. Changing the value of the security attribute however is only allowed if the user was given an authority called <code>CHANGE_ACCESS_RIGHTS</code>.</p>
</div>
<div class="listingblock">
<div class="title">security properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@SecurityProperty(exclusive = true)
@Optional
List&lt;Long&gt; getAuthorizedUsers(); <i class="conum" data-value="1"></i><b>(1)</b>

void setAuthorizedUsers(List&lt;Long&gt; authorizedUsers);

@Security
static Expression&lt;Boolean&gt; checkAccess(Alias alias, AuthenticationContext authenticationContext, AccessRight right) {

    if (right == AccessRight.CHANGE_ACCESS_RIGHTS) {

        Set&lt;String&gt; authorities = authenticationContext.getAuthoritiesAsStrings();
        return EcrQueryLanguage.condition().value(right.name()).in().values(authorities).holds(); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    long userId = authenticationContext.getAuthentication().getInternalIdOrFail();

    return EcrQueryLanguage.condition()
        .alias(alias).field("authorized_users").isNull().or()
        .alias(alias).field("authorized_users").contains().value(userId).holds(); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Changing this attribute requires the <code>CHANGE_ACCESS_RIGHTS</code> right</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only a user with an authority called <code>CHANGED_ACCESS_RIGHTS</code> is allowed to perform this operation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Everything else is allowed, when the user&#8217;s ID is contained in the list of authorized users</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="security_attributes_and_inheritance"><a class="anchor" href="#security_attributes_and_inheritance"></a>Security attributes and inheritance</h3>
<div class="paragraph">
<p>It is possible to annotate an <a href="inheritance.html#_inheritance" class="xref page">inherited</a> attribute with <code>@SecurityProperty</code>, but there is one important difference compared to non-inherited attributes. The inheritance is triggered as an update one the foreign key attribute that is used to reference the entity the value is inherited from. This means that such an operation requires the <code>WRITE</code> access right, not the <code>CHANGE_ACCESS_RIGHTS</code> right. The actual update of the value is performed on the database level, where the check for the <code>CHANGE_ACCESS_RIGHTS</code> right will occur. For the inheritance to work, the user performing the operation needs both <code>WRITE</code> and <code>CHANGE_ACCESS_RIGHTS</code> privileges on the entity. Of course, it is possible to annotate the foreign key attribute with <code>@SecurityProperty</code>, too. This would impose a stricter access requirement, making it impossible to change any inherited attribute for users without the <code>CHANGE_ACCESS_RIGHTS</code> right.</p>
</div>
<div class="listingblock">
<div class="title">security attribute inheritance</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ForeignKey(target = LabeledContainer.class, targetProperty = "id")
Long getContainerId(); <i class="conum" data-value="1"></i><b>(1)</b>

void setContainerId(Long value);

@SecurityProperty(exclusive = true)
@InheritedProperty(foreignKeyPropertyName = "container_id", sourcePropertyName = "label")
String getSecurityLabel(); <i class="conum" data-value="2"></i><b>(2)</b>

@Security
static Expression&lt;Boolean&gt; checkAccess(Alias alias, AuthenticationContext authenticationContext, AccessRight right) {

    if (right == AccessRight.CHANGE_ACCESS_RIGHTS) { <i class="conum" data-value="3"></i><b>(3)</b>

        Set&lt;String&gt; authorities = authenticationContext.getAuthoritiesAsStrings();
        return EcrQueryLanguage.condition().value(right.name()).in().values(authorities).holds();
    }

    Set&lt;String&gt; authorities = authenticationContext.getAuthoritiesAsStrings();

    return EcrQueryLanguage.condition() <i class="conum" data-value="4"></i><b>(4)</b>
        .alias(alias).field("security_label").equalTo().value("admins")
        .and().value(authorities).contains().value("ECR_ADMIN") <i class="conum" data-value="5"></i><b>(5)</b>
        .or()
        .alias(alias).field("security_label").equalTo().value("auditors")
        .and().value(authorities).contains().value("AUDITOR").holds(); <i class="conum" data-value="6"></i><b>(6)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The foreign key that references the entity to inherit the value for the security_label attribute from</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The inherited security attribute</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The condition for operations requiring <code>CHANGE_ACCESS_RIGHTS</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The condition for operations requiring all other rights including <code>WRITE</code>, which is required for inheritance</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>In this case, the user would require the <code>ECR_ADMIN</code> and the <code>CHANGE_ACCESS_RIGHTS</code> authority to successfully change the inherited security property</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>In this case, the user would require the <code>AUDITOR</code> and the <code>CHANGE_ACCESS_RIGHTS</code> authority to successfully change the inherited security property</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="subselect"><a class="anchor" href="#subselect"></a>Subselect</h3>
<div class="paragraph">
<p>There might be cases where the attribute defining access is not part of the entity itself, but part of another entity referred to by a foreign key or a relation.
In such cases a subselect comes handy.
Assume two entity types: documents, to which access is restricted by an attribute named <code>owner_group</code> which is part of the second entity a container.
An owner group must be given Documents are linked to their container with a foreign key named <code>contained_in</code>:</p>
</div>
<div class="listingblock">
<div class="title">The container entity</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.CONTAINER)
public interface OwnedContainer {

    long getOwnerGroup(); <i class="conum" data-value="1"></i><b>(1)</b>

    void setOwnerGroup(long ownerGroup);


    // ...
    // more attributes

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The document entity</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.DOCUMENT)
public interface OwnedDocument {

    @ForeignKey(target = OwnedContainer.class, targetProperty = "id")
    ContainerId getContainedIn(); <i class="conum" data-value="2"></i><b>(2)</b>

    void setContainedIn(ContainerId container);

    @Security
    static Expression&lt;Boolean&gt; calculateAccess(Alias alias, AuthenticationContext authenticationContext) {

        Collection&lt;Long&gt; groupIds = authenticationContext.getCommonUserDetails().getCollectionAttribute("group-ids", Long.class, List.of()); <i class="conum" data-value="3"></i><b>(3)</b>

        return EcrQueryLanguage.condition().alias(alias).field("contained_in").in() <i class="conum" data-value="4"></i><b>(4)</b>
            .select("id").from("owned_container").as("container").where().
            contextReference("container", "owner_group").in().values(groupIds).holds().holds();
    }

    // ...
    // more attributes
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The entity <code>OwnedContainer</code> holds the attribute that specifies access.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity <code>OwnedDocument</code> is linked with a container by its attribute <code>contained_in</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>AuthenticationContext</code> is used to obtain the ids of every group the current user is a member of.
The <em>group-ids</em> attribute was added to the user info response by the authentication service and loaded by the repository service using OpenId Connect.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The group ids are used to create a check whether the entity is contained in a container whose <code>owner_group</code> is one of the users groups.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interface_inheritance"><a class="anchor" href="#interface_inheritance"></a>Interface inheritance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since attribute based security - by definition - is based on attributes, it must be able to be specified by type.
However, in some cases a more general solution is desired.
In these cases, java interface inheritance comes handy.</p>
</div>
<div class="paragraph">
<p>Assume the class <code>DocumentWithAccessToken</code> from above.
Assume further that there are other types (<code>ContainerWithAccessToken</code> and <code>FolderWithAccessToken</code>) that should be secured by their access-token as well.
In this case it is a good practice to combine the access method and field in a common superinterface:</p>
</div>
<div class="listingblock">
<div class="title">Superinterface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><i class="conum" data-value="2"></i><b>(2)</b>
public interface WithAccessToken {

    @SecurityProperty
    @Mandatory(false)
    String getAccessToken();

    void setAccessToken(String accessToken);

    @Security
    static Expression&lt;Boolean&gt; calculateAccess(Alias alias, AuthenticationContext authenticationContext) {

        return EcrQueryLanguage.condition() <i class="conum" data-value="1"></i><b>(1)</b>
            .alias(alias).field("access_token").isNull()
            .or()
            .alias(alias).field("access_token").in()
            .values(authenticationContext.getAuthoritiesAsStrings())
            .holds();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The check for the access token is defined here.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>note that this interface does not specify an entity by itself, since it lacks a <code>@Type</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then the types itself can simply inherit this feature:</p>
</div>
<div class="listingblock">
<div class="title">Inheriting entity 1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.CONTAINER)
@OverwriteAllowed
public interface ContainerWithAccessToken extends WithAccessToken {
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Inheriting entity 2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.FOLDER)
@OverwriteAllowed
public interface FolderWithAccessToken extends WithAccessToken {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="complex_scenario_a_hospital"><a class="anchor" href="#complex_scenario_a_hospital"></a>Complex scenario: a Hospital</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here we take a look at a more complex example: a Hospital.
The hospital manages <strong>documents</strong> concerning <strong>cases</strong>.
A case belongs to a <strong>patient</strong>.
Users of the system are hospital employees and may access data about documents, cases and patients.
These users are part of one or several <strong>wards</strong>.
For every ward there is a group in the system containing the users that are part of this ward.
Cases have a list of wards - that may change over time - where the patient was treated for that case.
Access is specified as follows;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A user may only access cases whose wards contain at least one ward, the user is a member of.</p>
</li>
<li>
<p>A user may only access patients whose cases he may access.</p>
</li>
<li>
<p>A user may only access document whose cases he may access.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cases could be modeled as follows:</p>
</div>
<div class="listingblock">
<div class="title">The case</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.CONTAINER)
public interface MedicalRecordCase {

    @Mandatory
    @ForeignKey(target = MedicalRecordPatient.class, targetProperty = "id")
    ContainerId getPatient();  <i class="conum" data-value="1"></i><b>(1)</b>

    void setPatient(ContainerId containerId);

    @Mandatory
    List&lt;String&gt; getWards(); <i class="conum" data-value="2"></i><b>(2)</b>

    void setWards(List&lt;String&gt; wards);

    @Security
    static Expression&lt;Boolean&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        Collection&lt;String&gt; groupNames = authenticationContext.getCommonUserDetails()
            .getCollectionAttribute("group-names", String.class, List.of()); <i class="conum" data-value="3"></i><b>(3)</b>

        Expression&lt;Boolean&gt; result = null;

        for (String groupName : groupNames) { <i class="conum" data-value="4"></i><b>(4)</b>

            Expression&lt;Boolean&gt; wardCondition = EcrQueryLanguage.condition() <i class="conum" data-value="5"></i><b>(5)</b>
                .alias(alias).field("wards").contains().value(groupName)
                .holds();

            if (result == null) {

                result = wardCondition;

            } else {

                result = Eql.or(result, wardCondition); <i class="conum" data-value="6"></i><b>(6)</b>
            }
        }

        if (result == null) {

            return Eql.alwaysFalse(); <i class="conum" data-value="7"></i><b>(7)</b>
        }

        return result;
    }


    // case attributes ... <i class="conum" data-value="8"></i><b>(8)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A case holds a foreign key to a patient.
Since a case must have a patient, this attribute is mandatory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A case has a list of wards, where it was treated.
This attribute is also mandatory.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When computing access, the groups - and thus the wards - of the current user are obtained from the <code>AuthenticationContext</code>.
The <em>group-names</em> attribute was added to the user info response by the authentication service and loaded by the repository service using OpenId Connect.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Since it is necessary to check whether the intersection between the wards of the case and the groups of the user is not empty, it is iterated over all the groups of the user.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A condition is created that checks whether the entities wards contain the current group.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Access is granted when one of the conditions created yields <code>true</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If the user is in no group whatsoever he may access no case at all.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Further attributes are omitted for the sake of readability.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now Patients specify their security as follows:</p>
</div>
<div class="listingblock">
<div class="title">The patient</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.CONTAINER)
public interface MedicalRecordPatient {

    @Security
    static Expression&lt;Boolean&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        Alias caseAlias = Alias.byName("case"); <i class="conum" data-value="2"></i><b>(2)</b>

        Expression&lt;Boolean&gt; caseAccessCondition = MedicalRecordCase.access(caseAlias, authenticationContext);  <i class="conum" data-value="1"></i><b>(1)</b>

        return EcrQueryLanguage.condition().exists()
            .select("id").from(MedicalRecordCase.class).as(caseAlias.getValue()) <i class="conum" data-value="3"></i><b>(3)</b>
            .where()
            .alias(caseAlias).field("patient").equalTo().alias(alias).id() <i class="conum" data-value="4"></i><b>(4)</b>
            .and(caseAccessCondition).holds().holds(); <i class="conum" data-value="5"></i><b>(5)</b>
    }

    // patient attributes ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Access to a patient depends on access to cases.
So, the <code>MedicalRecordCase.access()</code> is called (see above).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In order to do that a custom alias is specified, that is used for the method call and in the query below.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Using a subselect its is checked whether there is a case &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203; that is assigned to the patient the access is checked for and &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>&#8230;&#8203; and to which the current user may access.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Documents may specify their security method very similar, only the document-to-case link is specified the other way around:</p>
</div>
<div class="listingblock">
<div class="title">The document</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.DOCUMENT)
public interface MedicalRecordDocument {

    @ForeignKey(target = MedicalRecordCase.class, targetProperty = "id")
    @Mandatory
    ContainerId getCase(); <i class="conum" data-value="1"></i><b>(1)</b>

    void setCase(ContainerId containerId);

    @Security
    static Expression&lt;Boolean&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        Alias caseAlias = Alias.byName("case");

        Expression&lt;Boolean&gt; caseAccessCondition = MedicalRecordCase.access(caseAlias, authenticationContext); <i class="conum" data-value="2"></i><b>(2)</b>

        return EcrQueryLanguage.condition()
            .exists().select("id").from(MedicalRecordCase.class).as(caseAlias.getValue())
            .where()
            .alias(caseAlias).id().equalTo().alias(alias).field("case") <i class="conum" data-value="3"></i><b>(3)</b>
            .and(caseAccessCondition).holds().holds();
    }

    // patient attributes ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A document is assigned to a case.
This is mandatory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As for patients, the access check for documents depends on the access check for cases.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A similar subselect to the one above is created, however here the outer select holds the link to the inner one.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="revision_history_and_abac"><a class="anchor" href="#revision_history_and_abac"></a>Revision history and ABAC</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the example above access to the entities is defined by one attribute: the wards of a case. It is assumed that a case may be treated in several wards - one after another - and every employee belonging to those wards needs access  to the case, its patients data and its documents. Visiting the wards one after another will result in several updates on the case - each adding another ward - and thus in a revision history where the list of wards will build up over time.</p>
</div>
<div class="paragraph">
<p>This has an interesting consequence in the scenario above : The access to older versions of the case will be granted to users who were allowed to access it at the time the version was created.</p>
</div>
<div class="paragraph">
<p>For instance, if a case started in the pulmonology it would have the following revision list:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If it was moved to intensive care after that, it would result in the following revision list:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology, intensive care</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Employees working in intensive care would be unable to access data of revision 1 of this case.
Depending on the scenario this might or might not be desired.</p>
</div>
<div class="paragraph">
<p>If this is not desired, it can be fixed with a simple annotation on the case interface:</p>
</div>
<div class="listingblock">
<div class="title">An alternative case</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Mandatory
    @Versioned(value = false)
    List&lt;String&gt; getWards();</code></pre>
</div>
</div>
<div class="paragraph">
<p>By simply specifying the <code>wards</code> attribute as not versioned, changes on the attribute will affect every revision of the case.
If a case started in the pulmonology it would at first have the same revision history as above:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>However, if it was moved to intensive care now, the revision list would look like this:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology, intensive care</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology, intensive care</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Now all employees in pulmonology and intensive care have access to every revision of this case.</p>
</div>
<div class="paragraph">
<p>This solution can be used generally.
When access control to entities depends on attributes, deciding whether those attributes are versioned or not is an important detail.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="accessing_external_tables"><a class="anchor" href="#accessing_external_tables"></a>Accessing external tables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Assume that in the hospital from the example above, the information which employee belongs to which ward is kept in a separate table named 'employee_to_ward'.
This table is managed by an external application.</p>
</div>
<div class="sect2">
<h3 id="using_direct_database_access"><a class="anchor" href="#using_direct_database_access"></a>Using direct database access</h3>
<div class="paragraph">
<p>As stated earlier, it is possible to add a parameter of the type <code>org.jooq.DSLContext</code> to a security method in order to gain direct access to the database.
This could be used to access the 'employee_to_ward' table:</p>
</div>
<div class="listingblock">
<div class="title">Using DSLContext</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Security
    static Expression&lt;Boolean&gt; access(
        Alias alias,
        AuthenticationContext authenticationContext,
        DSLContext context  <i class="conum" data-value="1"></i><b>(1)</b>
    ) {

        long userId = authenticationContext.getAuthentication().getInternalIdOrFail(); <i class="conum" data-value="2"></i><b>(2)</b>

        final List&lt;String&gt; wards = context.selectFrom("test_employee_to_ward")
            .where(DSL.field(DSL.name("employee")).eq(DSL.value(userId))) <i class="conum" data-value="3"></i><b>(3)</b>
            .fetch(DSL.field("ward", String.class));

        Expression&lt;Boolean&gt; result = null;

        for (String ward : wards) {

 // ... (as above) <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>DSLContext</code> is defined as another parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>AuthenticationContext</code> is only used to get the current users id.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The wards of the user are obtained using the <a href="https://www.jooq.org/doc/3.15/manual/">jooq-api</a> to directly access the database.
Depending on the scenario, it might improve performance to cache the result of this query.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After that, the same code as above is executed.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using_a_metadata_type"><a class="anchor" href="#using_a_metadata_type"></a>Using a Metadata type</h3>
<div class="paragraph">
<p>Alternatively, an arveo custom <code>@Type</code> could be used to access the external table:</p>
</div>
<div class="listingblock">
<div class="title">An external type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@View <i class="conum" data-value="1"></i><b>(1)</b>
@Name("employee_to_ward") <i class="conum" data-value="2"></i><b>(2)</b>
@Type(ObjectType.META)
public interface UserToWard {

    long getEmployee();

    void setEmployee(long employee);

    String getWard();

    void setWard(String ward);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@View</code> annotation marks the type as external.
This means arveo will not create the corresponding table.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>@Name</code> annotation specifies the name of the table the types entities are stored in.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, in the security method this type can be accessed with a subselect:</p>
</div>
<div class="listingblock">
<div class="title">Using subselect</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Security
    static Expression&lt;Boolean&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        final Alias userWard = Alias.byName("user_ward");  <i class="conum" data-value="1"></i><b>(1)</b>

        return EcrQueryLanguage.condition()
            .exists().select("ward").from(UserToWard.class).as(userWard.getValue())<i class="conum" data-value="2"></i><b>(2)</b>
            .where()
                .alias(userWard).field("employee").equalTo()
                .value(authenticationContext.getAuthentication().getInternalIdOrFail()) <i class="conum" data-value="3"></i><b>(3)</b>
            .and()
                .alias(alias).field("wards").contains() <i class="conum" data-value="4"></i><b>(4)</b>
                .alias(userWard).field("ward").holds()
            .holds();
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First, an alias is declared for the subselect.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then, a query is created that checks whether there is a ward, that &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>&#8230;&#8203; the current user is assigned to and &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203; that is contained in the current entities <code>wards</code> attribute.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="access-rights.html">Access rights</a></span>
  <span class="next"><a href="permissions.html">Permissions on Type definitions</a></span>
</nav>
</article>
  </div>
</main>
    <!-- The Modal -->
    <div id="imageModalBox" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="img01">
        <div id="caption"></div>
    </div>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../ui-assets/js/site.js" data-ui-root-path="../../ui-assets"></script>
<script async src="../../ui-assets/js/vendor/highlight.js"></script>
<script async src="../../ui-assets/js/modal.js"></script>
<script src="../../ui-assets/js/vendor/lunr.js"></script>
<script src="../../ui-assets/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../ui-assets/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
