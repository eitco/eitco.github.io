<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Search language :: arveo Documentation</title>
    <link rel="canonical" href="https://eitco.github.io/arveo-docu/17.0.0/arveo-developer/search-service.html">
    <link rel="prev" href="versioning.html">
    <link rel="next" href="retention-introduction.html">
    <meta name="generator" content="Antora 3.2.0-alpha.4">
    <link rel="stylesheet" href="../../ui-assets/css/site.css">
    <link rel="stylesheet" href="../../ui-assets/css/custom.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand"> 
      <img src="../../ui-assets/img/arveo_WortBildmarke_NEG_500px.png" id="arveoLogo" style="vertical-align:middle;margin:10px 0px">
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://eitco.github.io">Home</a>
        <!--<div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>-->
        <!--<div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>-->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="arveo-docu" data-version="17.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-general/product-summary.html">What is <em>arveo</em> - Content Services Platform (CSP)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architecture Overview</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/content-services.html">Content Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/technology-stack.html">Opensource Technology Stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/application-security.html">Application security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/gobd.html">Compliance recommendations (GoBD)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Store</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-storage.html">Persistence architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-deletion.html">Data deletion</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-getting-started/getting-started.html">Getting Started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration und Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-administration/installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/deployment-options.html">Deployment options</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/system-requirements.html">System requirements</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/authentication-oauth2.html">OAuth Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/db-access.html">Database access</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/content-elements-storage.html">Storage locations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/renditions.html">Renditions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/retention-container.html">Retention and Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/encryption.html">Encryption</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/messaging.html">Configure Active MQ</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/maintenance-mode-db-schema.html">Maintenance mode for the database schema</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/audit.html">Audit</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/solr.html">Solr</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/jobs.html">System jobs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/vault.html">Using Hashicorp Vault</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../commons/configuration-properties.html">Configuration Properties</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arveo-administration/monitoring.html">Monitoring</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Access Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="access-rights.html">Access rights</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="attribute-based-security.html">Attribute Based Access Control (ABAC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="permissions.html">Permissions on Type definitions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Modelling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="entity-types.html">Entity types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="entity-annotations.html">Entity annotations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="data-types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="system-fields.html">System fields</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="document-types.html">Document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="container-types.html">Container types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="relation-types.html">Relation types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="folder-types.html">Folder types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="metadata-types.html">Metadata types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="inheritance.html">Inheritance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention-annotations.html">Retention document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tenant-separation.html">Tenant separation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced-schema-changes.html">Advanced database schema changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="repo-service.html">Repository Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-upload-data.html">Upload Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-download-data.html">Download Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-delete-objects.html">Delete Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-locking.html">Locking</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repo-service-download-links-external-users.html">Download Links for External Users</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="versioning.html">Versioning</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="search-service.html">Search language</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="retention-introduction.html">Retention</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention.html">Retention periods</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention-cleanup-job.html">Cleanup job</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">SDKs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="client-sdks-json-serialization.html">Client SDKs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="sdk-and-batch-operations.html">Java SDK for Spring applications</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="non-spring-sdk.html">Java SDK for non-Spring applications</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Events and messaging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="events.html">Events</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="integration-service.html">Enterprise Integration Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Archetypes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="slim-archetype.html">The Types archetype</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="full-featured-archetype.html">The full-featured archetype</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="system-tables.html">System Tables</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/compatibility-list.html">Compatibility List</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/release-notes.html">Release Notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/glossary.html">Important Terminology</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">arveo Documentation</span>
    <span class="version">17.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../arveo-general/product-summary.html">17.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../arveo-general/product-summary.html">arveo Documentation</a></li>
    <li>Developer</li>
    <li><a href="repo-service.html">Repository Service</a></li>
    <li><a href="search-service.html">Search language</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Search language</h1>
<div class="sect1">
<h2 id="_search_service"><a class="anchor" href="#_search_service"></a>Concept</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Any client application, that needs a search function, can implement the Search Service with a suitable parameter. An
example of such an implementation is the class <em>DocumentServiceClient</em> in the Client API. The search queries are
formulated similarly, what is different is the search result, which is always typed. In  <em>arveo</em> the type is
<em>Entity</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="technical_implementation"><a class="anchor" href="#technical_implementation"></a>Technical implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Search Service is part of the module 'commons'. It was created to enable more convenient searching. The Search Service
works on the basis of EQL (Eitco Query Language). This query language is also used for some other services.
The main interface is SearchService. It is a functional interface, providing just one method to be implemented: search().
However, this functional interface has a variety of convenience methods, enabling faster and more convenient search, like
<em>firstResult()</em>, <em>uniqueResult()</em>, <em>count()</em>, <em>stream()</em> and others.</p>
</div>
<div class="listingblock">
<div class="title">Listing for the search method definition</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Page&lt;EntityType&gt; search(@NotNull SearchRequest searchRequest);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the only parameter, a search request is accepted, returning a <em>Page</em> of results. A Page has a page definition, a
completeCount and a parameterized list of results. The Search Service also provides a method <em>where()</em> with a condition
builder, filtering results based on a specific condition.</p>
</div>
<div class="paragraph">
<p><em>SearchServiceFactory</em> is a server class, which builds search queries. It has methods for creating an instance of search
service for Documents (<em>searchServiceForDocument()</em>), but also for all the other entities, including Metadata. The result
of the search is transformed into a Document (or respectively another entity) by the <em>DocumentMapper</em>.</p>
</div>
<div class="paragraph">
<p>The class <em>SearchResourceImplementation</em> provides an API for searches that are not bound to one and only one type
definition.</p>
</div>
<div class="paragraph">
<p>The interface SearchService is implemented by the class <em>EcrSearchService</em>.</p>
</div>
<div class="paragraph">
<p>The search client creates different search services, which can be used to search for corresponding entities, for
instance a folder search service, a document search service and so on. And there is also a <em>GenericUnionSearchService</em>,
that can be used to create any joins on search statements.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage"><a class="anchor" href="#usage"></a>Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following examples demonstrates the usage of the Search Service to retrieve an object page.</p>
</div>
<div class="listingblock">
<div class="title">Example of Search Service usage</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SearchService&lt;Object&gt; searchService = &lt;a valid instance&gt;;
Page&lt;Object&gt; objectPage = searchService.where()
    .contextReference("field").equalTo().value(7).or()
    .contextReference("other_field").greaterEqual().contextReference("another_field")
    .holds()
    .order().descendingBy("field").from(5).pageSize(7);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to check the type of object searched for:</p>
</div>
<div class="listingblock">
<div class="title">Example for type checking</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">            searchService.where() <i class="conum" data-value="1"></i><b>(1)</b>
                .entity().typeId()   <i class="conum" data-value="2"></i><b>(2)</b>
                .equalTo()
                .typeId(NamedFile.class) <i class="conum" data-value="3"></i><b>(3)</b>
                .or()
                .entity().typeName() <i class="conum" data-value="4"></i><b>(4)</b>
                .in().expressions(x -&gt; x
                    .typeName(NamedTextFile.class) <i class="conum" data-value="5"></i><b>(5)</b>
                    .typeName(NamedFolder.class)
                ).and()
                .entity().typeId().notEqual().typeId("named_relation") <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The variable <code>searchService</code> is an <code>EcrSearchService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The id of the type of given entity is referenced by the method <code>typeId()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type id is checked to be the id of the type defined by the class <code>NamedFile</code> (which is obtained by the method <code>typeId()</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here the type name is referenced instead of the type id.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>As with the type id, the name of the type defined by the class <code>NamedTextFile</code> is obtained.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The type id can also be obtained if only the type name is given.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="search_endpoints"><a class="anchor" href="#search_endpoints"></a>Search endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using the ecr sdk you will be able to obtain a <code>SearchClient</code> by spring injection.</p>
</div>
<div id="search-client-injection" class="listingblock">
<div class="title">Injecting a search client</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Autowired
    private SearchClient searchClient;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A search client has several methods to search in different ways or different contexts.</p>
</div>
<div class="sect2">
<h3 id="union_search_and_reference_evaluation"><a class="anchor" href="#union_search_and_reference_evaluation"></a>Union Search and Reference Evaluation</h3>
<div class="paragraph">
<p>A powerful search end-point is the union search. It searches entities that are part of unions of different joins.</p>
</div>
<div class="paragraph">
<p>For example, consider the following types:</p>
</div>
<div class="listingblock">
<div class="title">union search example types</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.DOCUMENT)
public interface DocumentA {

    @ForeignKey(target = ContainerA.class, targetProperty = "id")
    Long getContainer(); <i class="conum" data-value="1"></i><b>(1)</b>

    String getProperty1(); <i class="conum" data-value="2"></i><b>(2)</b>

    String getProperty3(); <i class="conum" data-value="4"></i><b>(4)</b>

    String getProperty4(); <i class="conum" data-value="5"></i><b>(5)</b>

    String getProperty7(); <i class="conum" data-value="7"></i><b>(7)</b>
}
@Type(ObjectType.CONTAINER)
public interface ContainerA {

    String getProperty1(); <i class="conum" data-value="2"></i><b>(2)</b>

    String getProperty2(); <i class="conum" data-value="3"></i><b>(3)</b>

    String getProperty4();  <i class="conum" data-value="5"></i><b>(5)</b>

}
@Type(ObjectType.DOCUMENT)
public interface DocumentB {

    @ForeignKey(target = ContainerB.class, targetProperty = "id")
    Long getContainer(); <i class="conum" data-value="1"></i><b>(1)</b>

    Integer getProperty1();  <i class="conum" data-value="2"></i><b>(2)</b>

    String getProperty3();  <i class="conum" data-value="4"></i><b>(4)</b>

    String getProperty4(); <i class="conum" data-value="5"></i><b>(5)</b>

    String getProperty5(); <i class="conum" data-value="6"></i><b>(6)</b>
}
@Type(ObjectType.CONTAINER)
public interface ContainerB {

    String getProperty1(); <i class="conum" data-value="2"></i><b>(2)</b>

    String getProperty2();  <i class="conum" data-value="3"></i><b>(3)</b>

    String getProperty4();  <i class="conum" data-value="5"></i><b>(5)</b>

    String getProperty7(); <i class="conum" data-value="7"></i><b>(7)</b>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>note that:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These are two pairs of types that are each related to each other by a foreign key in the Document type both using the property <code>container</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Every type has a property named <code>property1</code>, however in <code>DocumentB</code> its type is <code>Integer</code> while in the other types it is <code>String</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Only the container types have a property named <code>property2</code>, in both cases of type <code>String</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Only the document types have a property named <code>property3</code>, also both of type <code>String</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>All types have a property named <code>property4</code> in all cases it is of type <code>String</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Only the type <code>DocumentB</code> has a property <code>property5</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Only the types <code>ContainerB</code> and <code>DocumentA</code> contain the property <code>property7</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, using the <code>SearchClient.genericUnionSearch()</code> method, it is possible to search on a union like the following:</p>
</div>
<div class="listingblock">
<div class="title">sql equivalent of a union search</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">            document_a as document
                left join container_a as container
                on document.container = container.id
            union all
            document_b as document
                left join container_b as container
                on document.container = container.id</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the sql query <em>arveo</em> will actually generate will be more complex. We stick to a simpler variant
here for ease of understanding.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is done as follows:</p>
</div>
<div id="aliases" class="listingblock">
<div class="title">corresponding union search service</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        Alias DOCUMENT = Alias.byName("document");
        Alias CONTAINER = Alias.byName("container");

        EcrSearchService&lt;JoinedEntities&lt;Object&gt;&gt; unionSearchService = searchClient. <i class="conum" data-value="1"></i><b>(1)</b>
                genericUnionSearch() <i class="conum" data-value="2"></i><b>(2)</b>
                .type(DocumentA.class).as(DOCUMENT).leftJoin().type(ContainerA.class).as(CONTAINER) <i class="conum" data-value="3"></i><b>(3)</b>
                .on().alias(DOCUMENT).field("container").equalTo().alias(CONTAINER).id().holds() <i class="conum" data-value="4"></i><b>(4)</b>
                .unionAll() <i class="conum" data-value="5"></i><b>(5)</b>
                .type(DocumentB.class).as(DOCUMENT).leftJoin().type(ContainerB.class).as(CONTAINER) <i class="conum" data-value="6"></i><b>(6)</b>
                .on().alias(DOCUMENT).field("container").equalTo().alias(CONTAINER).id().holds()
                .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>assume we have a search client already injected (<a href="#search-client-injection">see above</a>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>using the method <code>genericUnionSearch</code> &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>&#8230;&#8203; we can define a left join between <code>DocumentA</code> and <code>ContainerA</code> &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203; using the foreign key of the field <code>container</code> as join condition.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This join can now be unified with another join.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The other join being a left join between <code>DocumentB</code> and <code>ContainerB</code> with basically the same join condition. Note that both joins use the same aliases for the document type and the container type respectively.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now the <code>unionSearchService</code> can be used to search elements of the defined union:</p>
</div>
<div class="listingblock">
<div class="title">A simple search on the union</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        Stream&lt;JoinedEntities&lt;Object&gt;&gt; stream =
                unionSearchService. <i class="conum" data-value="1"></i><b>(1)</b>
                        all().order(). <i class="conum" data-value="2"></i><b>(2)</b>
                        stream(200); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using the union search service &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203; we can now obtain every element of this union in no specified order &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>&#8230;&#8203; as stream that will page with a size of 200 elements.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the resulting stream will contain up to 200 elements. If the search resulted in more elements, the stream will invoke a search call transparently each 200 elements. The size of these pages can - of course - be specified by the parameter to  the <code>stream()</code> method seen above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since we used analogous aliases in the different elements of the union we can filter on the common elements of the types:</p>
</div>
<div class="sect3">
<h4 id="filtering_with_conditions"><a class="anchor" href="#filtering_with_conditions"></a>Filtering with conditions</h4>
<div class="listingblock">
<div class="title">A simple filtered search</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        unionSearchService.where()
                .alias(DOCUMENT).field("property4").equalTo().value("target")
                .or()
                .alias(CONTAINER).field("property4").equalTo().value("target")
                .holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This call would result in a stream containing all joined elements of the union where the document types or the container types property <code>property4</code> has the value <code>target</code></p>
</div>
<div class="paragraph">
<p>We do not need to filter on properties of both types of a join. Consider the following query:</p>
</div>
<div class="listingblock">
<div class="title">A simple filtered search</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        unionSearchService.where()
                .alias(CONTAINER).field("property2").equalTo().value("target")
                .holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query will return a stream containing all the joined elements of the union where the container types property <code>property2</code> has the value <code>target</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Keep in mind that these filters are working since we used the same <a href="#aliases">aliases</a> in both elements of the union.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we want to filter on properties however that are not part of every union element, there arise some difficulties. In that case, references to these properties will not be valid for every join.
<em>arveo</em> solves these issues by preprocessing the search filter in the context of every element of the union being able to simplify some references.</p>
</div>
<div class="paragraph">
<p>For example, the following query will not work:</p>
</div>
<div class="listingblock">
<div class="title">A query with a reference to a property that is not valid in every part of the union</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        // will throw exception
        unionSearchService.where()
                .alias(DOCUMENT).field("property5")
                .equalTo().value("target")
                .holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>As seen earlier the property <code>property5</code> is only defined on the type <code>DocumentB</code>. Because of that, the query above will throw an exception, since
the filter cannot be applied to the first element of the join (where the <code>DOCUMENT</code> alias refers to <code>DocumentA</code> where this property is not defined).</p>
</div>
<div class="paragraph">
<p>The query can be fixed in several ways. One can be to check the validity of the property inside the query using an is-null
check and thus guarding the reference to the property:</p>
</div>
</div>
<div class="sect3">
<h4 id="explicit_guards"><a class="anchor" href="#explicit_guards"></a>Explicit Guards</h4>
<div class="listingblock">
<div class="title">explicitly guarding a reference to a field</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        unionSearchService.where()
                .not().alias(DOCUMENT).field("property5").isNull() <i class="conum" data-value="1"></i><b>(1)</b>
                .and().alias(DOCUMENT).field("property5")
                .equalTo().value("target") <i class="conum" data-value="2"></i><b>(2)</b>
                .holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adding the further condition to the property to not be null (note the <code>not()</code> at the start of the line) &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203; the reference to the field is explicitly guarded and will not throw an exception.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>How does that work? <em>arveo</em> will <strong>not</strong> simply add the given filter to the union query:</p>
</div>
<div class="listingblock">
<div class="title">naive sql query <em>arveo</em> does <strong>not</strong> generate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">        select * from (
            document_a as document
                left join container_a as container
                on document.container = container.id
            union all
            document_b as document
                left join container_b as container
                on document.container = container.id
        ) where &lt;filter-condition&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>instead it will preprocess the filter in the context of every element of the union and add the resulting condition to their corresponding element of the union:</p>
</div>
<div class="listingblock">
<div class="title">conceptual sql query <em>arveo</em> actually generates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">        select * from (
            document_a as document
                left join container_a as container
                on document.container = container.id
                where &lt;filter-condition preprocessed in the
                        context of document_a join container_a&gt;
            union all
            document_b as document
                left join container_b as container
                on document.container = container.id
                where &lt;filter-condition preprocessed in the
                        context of document_b join container_b&gt;
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specifically in the given example <em>arveo</em> can simplify the condition in the context of the first element as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">    not document.property5 is null and document.property5 = 'target'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since in the context of <code>DocumentA</code> the property does not exist, <em>arveo</em> can reduce this query to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">    false and document.property5 = 'target'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>false and &lt;any condition&gt;</code> always results in false this can be further simplified to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">    false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this simple condition does not contain a reference to <code>property5</code> and may thus be evaluated.
In the context of the second element the condition cannot be simplified anymore. Since <code>property5</code> does exist
on <code>DocumentB</code> the property may not be <code>null</code> so the first part of the condition cannot be simplified. However
the condition can be evaluated on this part of the union. Thus, it will result in a query like the following:</p>
</div>
<div class="listingblock">
<div class="title">simplified sql query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">        select * from (
            document_a as document
                left join container_a as container
                on document.container = container.id
                where false
            union all
            document_b as document
                left join container_b as container
                on document.container = container.id
                where
                    not document.property5 is null
                    and document.property5 = 'target'
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the condition simplified to <code>false</code> in the first case <em>arveo</em> will actually drop the first part of the union resulting in a query like that:</p>
</div>
<div class="listingblock">
<div class="title">even more simplified sql query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">        select * from (
            document_b as document
                left join container_b as container
                on document.container = container.id
                where
                    not document.property5 is null
                    and document.property5 = 'target'
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can obviously see that the resulting query will never yield any result from the first part of the union. That may
be the desired effect. However, should you want to have results from the first element of the union you can guard the
context reference with an <code>or</code> operator, also:</p>
</div>
<div class="listingblock">
<div class="title">explicitly guarding a reference to a field using the or operator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        unionSearchService.where()
                .alias(DOCUMENT).field("property5").isNull() <i class="conum" data-value="1"></i><b>(1)</b>
                .or().alias(DOCUMENT).field("property5")
                .equalTo().value("target") <i class="conum" data-value="2"></i><b>(2)</b>
                .holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case <em>arveo</em> will simplify the query to</p>
</div>
<div class="listingblock">
<div class="title">simplified sql query guarding a reference using the or-operator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">        select * from (
            document_a as document
                left join container_a as container
                on document.container = container.id
                where true
            union all
            document_b as document
                left join container_b as container
                on document.container = container.id
                where
                    document.property5 is null
                    or document.property5 = 'target'
        )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thus returning all entities of the first union element and the entities of the second union element where the property <code>property5</code> is null or <code>target</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="implicit_guards"><a class="anchor" href="#implicit_guards"></a>Implicit Guards</h4>
<div class="paragraph">
<p>Another option is to refer to the type containing the property not by its alias but by its type name, thus guarding the property implicitly:</p>
</div>
<div class="listingblock">
<div class="title">implicitly guarding a reference</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        unionSearchService.where()
                .alias("document_b").field("property5")
                .equalTo().value("target")
                .holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <em>arveo</em> will preprocess making the assumption that any relational operator where at least one of the
operands is a reference to a type that is not part of the current union element (but of another union element) will
simply yield <code>false</code>. Since the join</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">            document_a as document
                left join container_a as container
                on document.container = container.id</code></pre>
</div>
</div>
<div class="paragraph">
<p>does not contain the type <code>document_b</code> the condition <code>document_b.property5 = 'target'</code> will be simplified to <code>false</code> in the context of this union element.
This will result in the same query as above, where the reference to the property was explicitly guarded with an <code>and</code> operator.</p>
</div>
<div class="paragraph">
<p>Be aware that searches will still fail if a property is referenced that does not exist at all:</p>
</div>
<div class="listingblock">
<div class="title">querying a non existent property</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        // will throw exception
        unionSearchService.where()
                .alias(DOCUMENT).field("property6")
                .equalTo().value("target")
                .holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since none of the document types contain a property <code>property6</code> this query will fail. Additionally, this property can not be guarded not even explicitly:</p>
</div>
<div class="listingblock">
<div class="title">querying a non existent property</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        unionSearchService.where()
                .not().alias(DOCUMENT).field("property6").isNull()
                .and().alias(DOCUMENT).field("property6")
                .equalTo().value("target").holds().order().stream(200).findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query will also fail. Only properties that are valid in at least one element of a union may be guarded.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aggregation_searches"><a class="anchor" href="#aggregation_searches"></a>Aggregation searches</h3>
<div class="paragraph">
<p>In some situations one needs to accumulate some values that are listed in a database. In SQL this is done using aggregate functions and the <code>group by</code> clause. For example in an invoice archive one might be interested in the number of invoices per customer, or the sum of their totals (per customer).
Queries like this can be executed using the aggregated search. As opposed to the other search methods the result entity type of this search method is <code>Map&lt;String, Object&gt;</code>, since aggregating properties will potentially result in a different type - one that might not be specified. Thus, a more general return type is used.</p>
</div>
<div class="paragraph">
<p>To start an aggregated search query, you will need to build a search service for your aggregated search first. We will build a service for the example above: querying the number and total sum of invoices per user.</p>
</div>
<div class="paragraph">
<p>Assume that we have a type <code>customer</code> defined by the class <code>Customer</code> and a type <code>invoice</code> defined by the class <code>Invoice</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Type(ObjectType.DOCUMENT)
@FilingEnabled
public interface Customer {

    @SystemProperty(SystemPropertyName.ID)
    DocumentId id();

    @Unique
    String getName();

    void setName(String name);

}

@Type(ObjectType.DOCUMENT)
@FilingEnabled
public interface Invoice {

    @ForeignKey(name = "fk_invoice_customer", target = Customer.class, targetProperty = "id")
    long getCustomerNumber();
    
    void setCustomerNumber(long number);

    @Optional
    String getCustomerName();
    void setCustomerName(String customerName);

    @Optional
    String getName();

    void setName(String name);

    @Optional
    Integer getTotal();

    void setTotal(Integer total);

    @Optional
    Boolean getOpen();

    void setOpen(Boolean open);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the invoice references the customer with the property <code>customer_number</code> defined by the method <code>getCustomerNumber()</code>. Now we can build a search service as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        final EcrSearchService&lt;Map&lt;String, Object&gt;&gt; aggregationSearchService = searchClient.aggregate() <i class="conum" data-value="1"></i><b>(1)</b>
            .count("i", "id").as("invoice_count") <i class="conum" data-value="2"></i><b>(2)</b>
            .sum("i", "total").as("invoice_total")
            .groupedBy("c", "name").as("customer")
            .from().type(ProtectedInvoice.class).as("i").join().type(ProtectedCustomer.class).as("c")  <i class="conum" data-value="3"></i><b>(3)</b>
            .on().alias("i").field("customer_number").equalTo().alias("c").id() <i class="conum" data-value="4"></i><b>(4)</b>
            .holds().build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Calling <code>SearchClient.aggregate()</code> is the entry point to the fluent api to build a search service for aggregation search requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>At first, we need to specify what to aggregate and what to group by: In our case we want to get the count (of the invoice ids) and the sum of the invoice totals grouped by customer name (which is  unique). Every field that is grouped by will also be part of the result.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Now we need to specify from where the data to aggregate comes from. We join the type <code>Invoice</code> with the type <code>Customer</code>. Note that we specify aliases for the types <code>"i"</code> and <code>"c"</code>, which we used in the step before to reference the types fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now we specify the condition for the join. The condition is that the invoices <code>customer_number</code> must equal the customers' id - as the foreign key <code>fk_invoice_customer</code> above specifies.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can query for the aggregated data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        final List&lt;Map&lt;String, Object&gt;&gt; all = aggregationSearchService.where().alwaysTrue().holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in a list of maps - one map per customer - where every map contains the keys <code>"customer"</code>, <code>"invoice_count"</code> and <code>"invoice_total"</code>. Holding the customers name, the number of their invoices and their total sum, respectivelyÂ´.</p>
</div>
<div class="paragraph">
<p>Additionally, we can query specific customers and invoices using the same search service. In this scenario for example we could query every customers <code>"invoice_count"</code> and <code>"invoice_total"</code> of invoices that are open i.e. that they haven&#8217;t paid, yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        final List&lt;Map&lt;String, Object&gt;&gt; open = aggregationSearchService.where()
            .alias("i").field("open").equalTo().value(true)
            .holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will also result in a list of maps - one map per customer - where every map contains the keys <code>"customer"</code>, <code>"invoice_count"</code> and <code>"invoice_total"</code>. Holding the customers name, the number of their invoices and their total sum, respectivelyÂ´ - only counting open invoices.</p>
</div>
<div class="paragraph">
<p>Note that we can reference the invoices field <code>open</code> by using the alias <code>i</code> we provided earlier, even though it is not part of the result.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="versioning.html">Versioning</a></span>
  <span class="next"><a href="retention-introduction.html">Retention</a></span>
</nav>
</article>
  </div>
</main>
    <!-- The Modal -->
    <div id="imageModalBox" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="img01">
        <div id="caption"></div>
    </div>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../ui-assets/js/site.js" data-ui-root-path="../../ui-assets"></script>
<script async src="../../ui-assets/js/vendor/highlight.js"></script>
<script async src="../../ui-assets/js/modal.js"></script>
<script src="../../ui-assets/js/vendor/lunr.js"></script>
<script src="../../ui-assets/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../ui-assets/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
