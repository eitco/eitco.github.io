<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Introduction</title>
<style>
@import "https://eitco.github.io/eitco.css";


</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">arveo 14.0.1</div>
<ul class="sectlevel1">
<li><a href="#_introduction"><strong>Introduction</strong></a>
<ul class="sectlevel2">
<li><a href="#_what_is_arveo">What is <em>arveo</em>?</a></li>
<li><a href="#_headless_content_services">Headless Content Services</a></li>
<li><a href="#_api_first">API first</a></li>
<li><a href="#_best_of_breed_strategy">Best-Of-Breed strategy</a></li>
<li><a href="#_scalability">Scalability</a></li>
<li><a href="#_future_proof">Future proof</a></li>
<li><a href="#_hybrid_operation">Hybrid operation</a></li>
<li><a href="#_micro_frontends">Micro frontends</a></li>
</ul>
</li>
<li><a href="#_architecture_overview"><strong>Architecture Overview</strong></a>
<ul class="sectlevel2">
<li><a href="#_content__services">Content Services</a></li>
<li><a href="#_3rd_party_services">3rd Party Services</a></li>
<li><a href="#_industry_standards">Industry standards</a></li>
<li><a href="#_opensource_technology_stack">Opensource technology stack</a></li>
</ul>
</li>
<li><a href="#_security"><strong>Security</strong></a>
<ul class="sectlevel2">
<li><a href="#_application_security">Application security</a></li>
<li><a href="#_data_security">Data security</a></li>
<li><a href="#_tenant_security">Tenant security</a></li>
<li><a href="#_security_patches">Security patches</a></li>
<li><a href="#_application_protection_by_design">Application protection by design</a></li>
<li><a href="#_compliance_recommendations_gobd">Compliance recommendations (GoBD)</a></li>
</ul>
</li>
<li><a href="#_data_store"><strong>Data Store</strong></a>
<ul class="sectlevel2">
<li><a href="#_persistence_architecture">Persistence architecture</a></li>
<li><a href="#_data_types">Data types</a></li>
<li><a href="#_high_availability">High availability</a></li>
<li><a href="#_data_integrity">Data integrity</a></li>
<li><a href="#_content_storage_2">Content storage</a></li>
<li><a href="#_clustering">Clustering</a></li>
<li><a href="#_data_deletion">Data deletion</a></li>
<li><a href="#_recycle_bin">Recycle bin</a></li>
</ul>
</li>
<li><a href="#_installation"><strong>Installation</strong></a>
<ul class="sectlevel2">
<li><a href="#_deployment_options">Deployment options</a></li>
<li><a href="#_system_requirements">System requirements</a></li>
<li><a href="#_installation_2">Installation</a></li>
</ul>
</li>
<li><a href="#_getting_started"><strong>Getting Started</strong></a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_maven_configuration">Maven configuration</a></li>
<li><a href="#_step_1_type_definitions">Step 1 - Type definitions</a></li>
<li><a href="#_step_2_command_line_tool">Step 2 - Command line tool</a></li>
<li><a href="#_step_3_perform_a_task_with_arveo">Step 3 - Perform a task with arveo</a></li>
<li><a href="#_the_types_archetype">The Types archetype</a></li>
<li><a href="#_overview_of_the_generated_project">Overview of the generated project</a></li>
<li><a href="#_the_full_featured_archetype">The full-featured archetype</a></li>
<li><a href="#_overview_of_the_generated_project_2">Overview of the generated project</a></li>
<li><a href="#_working_on_the_generated_project">Working on the generated project</a></li>
</ul>
</li>
<li><a href="#_administration"><strong>Administration</strong></a>
<ul class="sectlevel2">
<li><a href="#_configure_database_access">Configure Database access</a></li>
<li><a href="#_configure_storage_locations">Configure Storage Locations</a></li>
<li><a href="#_renditions">Renditions</a></li>
<li><a href="#_configure_retention_container">Configure retention container</a></li>
<li><a href="#_encryption">Configure Encryption</a></li>
<li><a href="#_configure_active_mq">Configure Active MQ</a></li>
<li><a href="#_configure_arveo_user_management_as_authentication_service">Configure <em>arveo</em> user management as Authentication Service</a></li>
<li><a href="#_configure_authentication_between_content_services">Configure authentication between Content Services</a></li>
<li><a href="#_authentication-oauth2">OAuth2.0 Authentication</a></li>
<li><a href="#_configure_audit">Configure audit</a></li>
<li><a href="#_solr">Solr</a></li>
<li><a href="#_system_jobs">System jobs</a></li>
<li><a href="#_hashicorp_vault">Using Hashicorp Vault</a></li>
<li><a href="#_configuration_properties">Configuration Properties</a></li>
</ul>
</li>
<li><a href="#_monitoring"><strong>Monitoring</strong></a>
<ul class="sectlevel2">
<li><a href="#_custom_health_indicators">Custom health indicators</a></li>
<li><a href="#_custom_endpoints">Custom endpoints</a></li>
<li><a href="#_custom_metrics">Custom metrics</a></li>
<li><a href="#_prometheus">Prometheus</a></li>
<li><a href="#_other_monitoring_systems">Other monitoring systems</a></li>
<li><a href="#_attributes_in_mdc">Attributes in MDC</a></li>
<li><a href="#_open_telemetry">Open Telemetry</a></li>
</ul>
</li>
<li><a href="#_access_control"><strong>Access Control</strong></a>
<ul class="sectlevel2">
<li><a href="#_access_rights">Access rights</a></li>
<li><a href="#_access_control_lists">Access control lists</a></li>
</ul>
</li>
<li><a href="#_attribute_based_access_control_abac">Attribute Based Access Control (ABAC)</a>
<ul class="sectlevel2">
<li><a href="#_parameters">Parameters</a></li>
<li><a href="#_examples_2">Examples</a></li>
<li><a href="#_interface_inheritance">Interface inheritance</a></li>
<li><a href="#_complex_scenario_a_hospital">Complex scenario: a Hospital</a></li>
<li><a href="#_revision_history_and_abac">Revision history and ABAC</a></li>
<li><a href="#_accessing_external_tables">Accessing external tables</a></li>
</ul>
</li>
<li><a href="#_data_modelling"><strong>Data Modelling</strong></a>
<ul class="sectlevel2">
<li><a href="#_objects_types_definitions">Entity types</a></li>
<li><a href="#_type_annotations">Type annotations</a></li>
<li><a href="#_property_annotations">Property annotations</a></li>
<li><a href="#_data_types_2">Data Types</a></li>
<li><a href="#_system_properties">System Properties</a></li>
<li><a href="#_document_type">Document type</a></li>
<li><a href="#_container_type">Container type</a></li>
<li><a href="#_relation_type">Relation type</a></li>
<li><a href="#_folder_type">Folder type</a></li>
<li><a href="#_metadata_type">Metadata type</a></li>
<li><a href="#_inheritance">Inheritance</a></li>
<li><a href="#_retention_3">Retention</a></li>
<li><a href="#_tenant_separation">Tenant separation</a></li>
<li><a href="#_advanced_db_schema_changes">Advanced db schema changes</a></li>
</ul>
</li>
<li><a href="#_document_service"><strong>Document Service</strong></a>
<ul class="sectlevel2">
<li><a href="#_upload_data">Upload data</a></li>
<li><a href="#_download_data">Download data</a></li>
<li><a href="#_document_service_recycle_bin">Delete an object</a></li>
<li><a href="#_locking">Locking</a></li>
<li><a href="#_download_links_for_external_users">Download links for external users</a></li>
<li><a href="#_versioning_v">Versioning</a></li>
<li><a href="#_search_language">Search language</a></li>
<li><a href="#_search_endpoints">Search endpoints</a></li>
<li><a href="#_retention_periods_retention">Retention periods</a></li>
</ul>
</li>
<li><a href="#_rest_api"><strong>REST API</strong></a>
<ul class="sectlevel2">
<li><a href="#_client_sdks">Client SDKs</a></li>
<li><a href="#_java_sdk">Java SDK</a></li>
</ul>
</li>
<li><a href="#_system_tables"><strong>System tables</strong></a>
<ul class="sectlevel2">
<li><a href="#_tables_for_type_definitions">Tables for type definitions</a></li>
<li><a href="#_folder_structure_tables">Folder structure tables</a></li>
<li><a href="#_recovery_table">Recovery table</a></li>
<li><a href="#_keystore_tables">Keystore tables</a></li>
</ul>
</li>
<li><a href="#_compatibility_list"><strong>Compatibility list</strong></a></li>
<li><a href="#_important_terminology"><strong>Important Terminology</strong></a></li>
</ul>
</div>
</div>
<div id="content">
<div style="page-break-after: always;"></div>
<div class="sect1">
<h2 id="_introduction"><strong>Introduction</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_arveo">What is <em>arveo</em>?</h3>
<div class="paragraph">
<p><em>arveo</em> is a <strong>Headless Content Service Platform</strong>.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> expands your digital company platform and your public cloud or data center solutions with cloud-based
enterprise content management (ECM).</p>
</div>
<div class="paragraph">
<p><em>arveo</em> is a multi-client and 100% cloud-ready content services platform. With <em>arveo</em> you can legally
secure (GoBD certified) and DSGVO/GDPR-compliant manage the entire life cycle of your documents and files and process all your content. <em>arveo</em> ensures data and legal security even when using cloud storage services and takes into
account the requirements of the GDPR and DSGVO with regard to the secure deletion of data.</p>
</div>
<div class="paragraph">
<p>With <em>arveo</em> enterprise-ready solutions can be created, from revision-proof content archives
to complex file and transaction processing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
What is Content Service Platform?<br>
&#8230;&#8203; is a cloud ready Enterprise Content Management System<br>
… is a collection of Microservices sharing the same data repositories<br>
&#8230;&#8203; provides REST interfaces.<br>
&#8230;&#8203; typically has ECM Services, AI Services, BPM, Conversion, Enterprise Search, etc.<br>
… provides access to all kind of content like documents, videos, images, audio, etc.<br>
&#8230;&#8203; serves all kind of use cases with the organization<br>
… content is stored once and edited and read by many applications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>arveo</em>'s modern architecture based on microservices and state-of-the-art technologies was natively built for the cloud.
Connect our lightweight <em>arveo</em> content services with a single, lean API with your system landscape, other open systems and the most suitable services for you from the cloud or on-premises. With this Best-Of-Breed approach, you can easily realize your company&#8217;s dream of a “single source of truth” across all systems.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/arveo_subteaser.jpg" alt="arveo subteaser">
</div>
<div class="title">Figure 1. Our Vision: single source of information</div>
</div>
<div class="paragraph">
<p>The <em>arveo</em> content services manage the entire life cycle of your content like</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Documents</p>
</li>
<li>
<p>Images</p>
</li>
<li>
<p>Videos</p>
</li>
<li>
<p>Audio</p>
</li>
<li>
<p>Text.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>arveo</em> allows the free configuration of the content objects including metadata and mapping of folder hierarchies and electronic files.</p>
</div>
<div class="paragraph">
<p>The NoSQL technologies allow you to search across all meta values and document content with high performance regardless of the complexity of your search. Decisive advantages in mass data processing and search
performance through the additional use of horizontally scalable NoSQL technologies.
The used NoSQL apache solr 8.6 enterprise search engine combined with key value caches leads to an increase in speed of up to a factor of 1,000 compared to relational database systems.</p>
</div>
</div>
<div class="sect2">
<h3 id="_headless_content_services">Headless Content Services</h3>
<div class="paragraph">
<p>The market for "headless systems" has been growing for some time.
These offer backend functions without a user interface of the system completely
can be used by the end user.
This is best known from content management systems (CMS) used in web development.
With the increasing use of different end devices such as smartphones, tablets or wearables, they are increasing
also the requirements for content management systems. In addition, users have a lot of content on different channels.
Headless CMS dispense with the front end and thus enable your content to be displayed
various channels through a single REST API.</p>
</div>
<div class="paragraph">
<p>So if products are to be fully and seamlessly integrated in a platform and
a dependency on a user interface or client is no longer desired,
one speaks of so-called "headless systems".</p>
</div>
<div class="paragraph">
<p>The wide availability of different cloud services and solutions enables the set up
a modern platform for your business processes. Instead of relying on a monolithic ECM as before,
companies combine the most suitable cloud content services and create with the "best-of-breed"
Approach targeted added value for your digital company platforms.</p>
</div>
<div class="paragraph">
<p>Regardless of whether you have your own solution, an open cloud application or your company portal, want to add secure and legally compliant ECM functions:
You can access all of your data directly via a single interface (REST API),
Access documents and information.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> is headless by design. All modules are hosted as pure backend cloud services
from Eitco or optionally hybrid in your private cloud or on-premises in your data center
disposal. Of course, these are natively suitable for mobile applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="_api_first">API first</h3>
<div class="paragraph">
<p>The stateless REST API is our product and is used by all <em>arveo</em> components and user interfaces. The web services are stable over the long term and are fully available to every customer.</p>
</div>
<div class="paragraph">
<p>It is important to us that our services have open interfaces and can be easily integrated into an enterprise service infrastructure.
As a modern content services platform, the <em>arveo</em> uses standards wherever
possible in order to use the steadily growing number of cloud-enabled services inside or outside the company infrastructure. Whether operating system, database, text recognition, machine learning or object storage, <em>arveo</em> can access services from different manufacturers and combine them with its own services in order to quickly create added value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_best_of_breed_strategy">Best-Of-Breed strategy</h3>
<div class="paragraph">
<p>There are many ECM products and the market is constantly changing. A manufacturer-independent ECM standard such as SQL
for relational databases has not fully established itself for ECM applications despite several attempts from WebDAV to
JSR 170 to CMIS. The market is dominated by monolithic packages that master all ECM applications.
A customer who implements a complex ECM application for his company often becomes highly dependent on a manufacturer and is faced with costs that
are difficult to calculate when changing providers.</p>
</div>
<div class="paragraph">
<p>Due to the availability of platforms such as Amazon Web Services (AWS) or Microsoft Azure, which make a wide variety of services easily usable via web services, we are seeing a change in the behavior of companies who want to buy fewer complete solutions and instead are looking for specialized services that can easily be combined and thus create targeted added value for the digital company platform.
Companies choose the best features from different manufacturers and combine them to create
their own solutions, whereby you control the services used via your own API management or API gateways. This creates company platforms that not only access one, but often several repositories.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/best-of-breed.png" alt="Best-Of-Breed">
</div>
<div class="title">Figure 2. Best-Of-Breed strategy</div>
</div>
<div class="paragraph">
<p>This often called Best-Of-Breed strategy benefits from the fact that the services available in the marketplaces have become increasingly standardized in recent years.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> consistently relies on a microservice architecture. The individual services are loosely connected
to one another via lightweight stateless web service interfaces (http, REST) and each service can run and scale
independently. All <em>arveo</em> functions are available via a uniform REST API gateway,
which also takes care of the intelligent load distribution and the detection of defective services.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scalability">Scalability</h3>
<div class="paragraph">
<p>Modern cloud-ready platforms rely on horizontal scaling and the load is distributed over many nodes, which can consist of inexpensive commodity hardware. Such a structure can also save costs through automated SCALE OUT and DOWN by switching nodes on or off as required. The <em>arveo</em> platform has a high tolerance for the failure of individual nodes. A high-performance availability is also required, since the end user nowadays only shows a limited understanding of long response times and can quickly switch to the competition in case of doubt.</p>
</div>
<div class="paragraph">
<p>All <em>arveo</em> services support containerized deployment and use stateless REST APIs so that they can be easily integrated into any cloud infrastructure.
Through the use of containerized applications (Docker) and the service management of the open source Spring Framework, which well-known providers such as Netflix use and continuously improve, the services can be installed automatically as often as required and thus scale out and down if you use the cloud orchestration framework kubernetes.
You can cluster together linux containers and build an auto-scaling and high available platform with high fail safety.
A blue-green deployment for the risk-free, downtime-free rollout of new software versions is also possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="_future_proof">Future proof</h3>
<div class="paragraph">
<p>Our services use standards as far as possible, so that services from different providers can be delivered without great integration effort and the customer can react quickly to changes in the market. Due to the secure web service interfaces, all services including the database can be obtained from the cloud at any time.</p>
</div>
<div class="paragraph">
<p>With <em>arveo</em> services, you can build a sustained system architecture. By design <em>arveo</em> will you allow to separate your business logic from <em>arveo</em>
ECM standard services and all other available cloud services like OCR, AI,
document conversion (e.g. to PDF), identity management. <em>arveo</em> solutions are designed to be manufacturer-independent, so that the underlying REST ECM and other services can be exchanged at easily calculable costs.</p>
</div>
<div class="paragraph">
<p>This approach makes it possible to exchange individual services through to the content services of the <em>arveo</em> with little and easily calculable effort. Even <em>arveo</em> ECM services can be replaced by comparable services and via an open source S3 connector supplied, third-party systems can access the content objects migration-free using the S3 standard API.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hybrid_operation">Hybrid operation</h3>
<div class="paragraph">
<p><em>arveo</em> is a native cloud platform and is based on Open Source libraries and services. Through the consistent microservice architecture and the use of open source cloud technology, you can keep <em>arveo</em>'s operating costs low.</p>
</div>
<div class="paragraph">
<p>Advantages of <em>arveo</em> operation</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All services are horizontally scalable separately and can therefore also be operated on simple hardware. <em>arveo</em> runs on all Linux and Windows operating systems.</p>
</li>
<li>
<p>No additional license costs due to the consistent use of open source technology such as Linux,
postgreSQL 12 and apache solr 8.6 NoSQL.</p>
</li>
<li>
<p>Container deployment: Simple integration into existing cloud platforms enables load-dependent,
automated service provision up to blue-green deployment for seamless updates to new software versions.</p>
</li>
<li>
<p>Hybrid architecture: Flexible use of cloud services or on-premise services.</p>
</li>
<li>
<p>Low manufacturer dependency: By separating the user interface and business logic from the ECM / BPM services while using standards such as REST, S3 or BPMN2, there is less dependency on one manufacturer.</p>
</li>
<li>
<p>Web applications: We deliver templates for PWA (Progressive Web Apps) based on the state-of-the-art angular framework, which are completely open source. I.e. their surfaces belong to you and can be used independently of <em>arveo</em>.</p>
</li>
<li>
<p>Use of standards: Low training costs and high availability of know-how on the market through the use of standard frameworks (angular), standard interfaces (REST, S3, SAP Archive Link) and SDKs for Javascript, JAVA, C #.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micro_frontends">Micro frontends</h3>
<div class="paragraph">
<p>In addition, you can also use our ready-made, modern, clear, responsive and functional micro frontends, to make the <em>arveo</em> content services and thus their content easily available at the right time and in the right place in your business processes.</p>
</div>
<div class="paragraph">
<p>Mobile First: All surface components and interfaces are designed for mobile use.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/micro-frontends.png" alt="_arveo_ Micro Frontends">
</div>
<div class="title">Figure 3. Micro frontends</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture_overview"><strong>Architecture Overview</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_content__services">Content Services</h3>
<div class="paragraph">
<p><em>arveo</em> is a content service platform and provides a set of lightweight, <strong>operating system-independent</strong> content microservices.</p>
</div>
<div class="paragraph">
<p>All services and clients exclusively use the secure, stateless, state-of-the-art <strong>HTTPS REST API</strong>*.
For the highest possible security on the web and to be suitable for mobile access, <em>arveo</em> uses token security based on the state-of-the-art <strong>Spring security</strong> framework.</p>
</div>
<div class="paragraph">
<p>A Java, C# und Javascript <strong>SDKs</strong> is available.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> has <strong>multi tenant support</strong> and separates content and meta values per tenant.</p>
</div>
<div class="paragraph">
<p>As <em>arveo</em> is built for cloud operating systems like Openstack you automatically deploy and can scale the <em>arveo</em> <strong>containerized applications</strong> with the cloud orchestration framework kubernetes. You can cluster together linux containers and build an auto-scaling and high available platform with high fail safety. Containerized applications scale horizontally and can run on commodity hardware.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> is available as containerized application or WAR/JAR file and allows a <strong>hybrid deployment</strong>: On-Premise or in Cloud.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/arveo-architecture.png" alt="diagram">
</div>
<div class="title">Figure 4. Architecture Overview</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Content services in <em>arveo</em></caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store, edit and version documents, records/folders and their metadata.</p>
<p class="tableblock">Manage storage locations with retention periods (GoBD certificate &amp; GDPR/DSGVO compliant)</p>
<p class="tableblock">Search of metadata with relational database postgreSQL 12 and NoSQL document db apache solr 8.6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Management Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User management with users, groups and roles.<br>
Secure login and token authentication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registry Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service registry for all <em>arveo</em> content services managing the availability of the services.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secure storage of configuration data in git or database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Control Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object access control providing permissions to users/groups</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates and manages audit tables for all other entity types like document types, user management objects, etc.
Provides API to access the audit trail of any object by its entoty ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP Archive Link Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web server that processes documents in accordance with the SAP Archive Link standard</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Conversion Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conversion of document formats like docx, xlsx, etc. to image formats or PDF/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise User Management Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <em>arveo</em> with organisation structure features like positions or substitutes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise Integration Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The _arveo enterprise integration service supports over 300 data formats
and interfaces like XML, REST, CSV, Mail,<br>
Easily integrate all your applications and IT systems e.g. scheduled data import or listen on  events, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Federation Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multi repository architecture: The open connector plugin interface allows to access data from other repositories (Saperion, Documentum, file systems directories)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_3rd_party_services">3rd Party Services</h3>
<div class="paragraph">
<p>To operate <em>arveo</em> successfully the operator of the platform must provide and manage the following services.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. 3rd Party Services in <em>arveo</em></caption>
<colgroup>
<col style="width: 35%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active MQ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Queue Service to process JMS and AMQP message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">postgreSQL 12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relational database cluster for arveo system properties and customer metadata</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apache solr 8.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NoSQL document database to support high performance content and metadata full text search</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content Storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a S3 API capable object store service or a redundant file system server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication Service (optional)<br>
Keycloak, Active Directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identity Management implementing OAUTH2 workflow for secure login.<br>
Implement Single Sign On (SSO) with identity management providers:  Keycloak, Active Directory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Monitoring (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supports logging / monitoring via ELK (Elasticsearch, Logstash, and Kibana.</p>
<p class="tableblock">Supports Spring Service Admin Monitor</p>
<p class="tableblock">Supports Prometheus + Grafana Monitoring frontends</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_industry_standards">Industry standards</h3>
<div class="paragraph">
<p><em>arveo</em> relies on industry standards as much as possible to make integrations as easy as possible.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API: REST (JSON)</p>
</li>
<li>
<p>Storage: S3 (Cloud Object Storage API)</p>
</li>
<li>
<p>Authentication: OAUTH2, X.509 or Basic Auth.</p>
</li>
<li>
<p>Relational Database: JDBC access for PostgreSQL, Oracle, SQL Server</p>
</li>
<li>
<p>SAP: Archive Link Service</p>
</li>
<li>
<p>Containerized application deployment</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_opensource_technology_stack">Opensource technology stack</h3>
<div class="paragraph">
<p>The technology stack has been chosen to ensure creating high-performance, cloud- and client-capable and scalable state-of-the-art (micro) services with a modern web user interface. Our chose tech stack enables the implementation of both small projects, which only consist of a single component in the backend, and large projects with various distributed components. The created components are deployable both locally on the customer&#8217;s hardware and
in a cloud environment.</p>
</div>
<div class="paragraph">
<p>So the stack consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Framework</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The implementation of the backend components has been done in Java and Kotlin. The Spring Framework is
used as the basis. Spring is an Open Source (Apache License) framework that has existed since 2004 with a large and very
active developer community. The framework has a modular structure, which is why it is suitable for both simple and complex
applications. It provides dependency injection, externalized configuration, and assistance with things like database
access, transactions, messaging, etc.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring MVC, WebFlux</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring MVC is a framework for creating web applications, especially for REST services. It is based on the servlet stack,
in which a request is processed in a dedicated thread. WebFlux is also a framework for web applications, but is based on
the reactive stack, in which the processing of a request is not restricted to one thread.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Security</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Security is a component that provides authentication and authorization functionality. It can be used to secure
web applications and also offers support for SSO technologies such as OAuth and SAML.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Cloud</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Cloud is a collection of additional Spring components that provide the typical functionality required in a
distributed or cloud application. The individual components can be used independently of one another and partly consist
of integrable dependencies as well as independent applications. Which of the Spring Cloud components are used therefore
depends entirely on the project requirements. Spring Cloud applications can be operated in managed cloud environments
such as Cloud Foundry.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Cloud Config</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Cloud Config offers a central configuration service as well as a client library for components that consume the
configuration. In a Spring Boot application, it is sufficient to add the corresponding dependency. From then on, Spring
will automatically read from the configuration service if it is available. The configuration data can be stored in simple
files, in a database, a Git repository or in a protected repository such as Vault.</p>
</div>
<div class="paragraph">
<p>In a distributed application with several components running on different machines, Spring Cloud Config can be used to
implement central management for the configuration of all components.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Cloud Bus</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Cloud Bus provides a bus for communication between the components or for connecting external components. The
communication is based on the AMQP protocol and requires a backend such as RabbitMQ or ActiveMQ. With the help of the
bus, e.g. Notify components when their configuration in the configuration service has changed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eureka</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Eureka is a Spring Cloud component provided by Netflix that provides a service registry. A service registry is a central
directory of all service instances. A service or a client application therefore only needs to know the URL of the service
registry in order to access one of the other services. Eureka is an independently executable component and offers a
client library for access to the registry.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hystrix</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hystrix is a Spring Cloud component provided by Netflix that can be imagined as a fuse in an electrical installation. If
one component of a cloud environment fails, Hystrix can isolate it from the other components to prevent further failures.
Another instance of the component can then provide the functionality.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zuul</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Zuul is a Spring Cloud component provided by Netflix that provides an API gateway. An API gateway acts like a reverse
proxy and hides the individual microservices from a client application. The client application only knows the API
gateway and does not have to worry about the URLs of the various services.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ribbon</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ribbon is a Spring Cloud component provided by Netflix that provides a client-side load balancer.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Archetypes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are Maven archetypes that can be used to easily start a new project based on our technology stack. Different
archetypes are available for different types of applications. The generated projects contain a Jenkins file with a
preconfigured CI environment including static code analysis with sonar, OWASP dependency checks, load tests based on
JMeter, a release mechanism at the push of a button and an optional teams hook. Also included are packaging modules
with which the application can be packaged as a Linux daemon or as a Windows service and IDE configuration files for
IntelliJ and Eclipse.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Logging</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order not to depend on a specific logging implementation, logging has been implemented with a logging facade SLF4J or
to be exact, with its specific implementation logback. In contrast to Log4J, Logback is actively maintained and is less
complicated during initialization. It can be combined with SLF4J. Logback is one of the standard Spring dependencies.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Caching</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Caching frameworks are available in many variants that cover very different use cases. Frameworks are listed
here sorted according to their primary use case.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Local in-memory cache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Caffeine has proven itself as a fast local in-memory cache. It can be combined with Spring&#8217;s caching abstraction layer.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDBC connection pool
HikariCP has proven itself for JDBC connection pooling. This pool is also Spring&#8217;s standard dependency.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security"><strong>Security</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_application_security">Application security</h3>
<div class="paragraph">
<p><em>arveo</em> is a content service platform you can trust. We are continuously working to ensure
that our services can be operated securely in the cloud.</p>
</div>
<div class="paragraph">
<p>All <em>arveo</em> content services and clients communicate via state-of-the-art secure REST interfaces via
the secure HTTPS (SSL) protocol.
All services require the web standard OAUTH2 with OpenID Connect authentication using tokens.
A central authentication service (Keycloak, Active Directory or <em>arveo</em> user management service) issues tokens with an
expiry date. That ensures that only client authenticated against the central service can use the content service APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_security">Data security</h3>
<div class="paragraph">
<p><em>arveo</em>  can encrypt the content with AES 256 and thus protect it against unauthorized access.
The key is stored in such a way that maximum security is guaranteed.
In order not to re-encrypt all data if the key is compromised, own keys are generated.
Only the keys used are encrypted with the customer key and stored separately (<a href="#_encryption">Encryption</a>).<br>
See also <a href="#_data_integrity">Data Integrity</a>.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> allows you to organize documents into folders and records.
<em>arveo</em> can control the access rights such as reading, writing or deleting to each document via
attributes or access lists and thus grant or deny the corresponding access to the groups or users.</p>
</div>
<div class="paragraph">
<p><strong>ACL Permissions</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>None</strong> - no authorization (object not visible)</p>
</li>
<li>
<p><strong>Browse</strong> - the user is allowed to see the metadata of the object, but not the content</p>
</li>
<li>
<p><strong>Read</strong> - the user can read metadata and content</p>
</li>
<li>
<p><strong>Relate</strong> - The user can add an annotation</p>
</li>
<li>
<p><strong>Version</strong> - The user may change the content, but may not overwrite it</p>
</li>
<li>
<p><strong>Write</strong> - The user can change metadata and content with the possibility to overwrite</p>
</li>
<li>
<p><strong>Delete</strong> - The user can delete the object</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tenant_security">Tenant security</h3>
<div class="paragraph">
<p>The metadata and the content of the tenants are separated. Each tenant has its own storage container and
database. It is ensured that all data of a tenant is protected from
unauthorized access by another tenant.<br>
The data of a tenant can be easily exported.</p>
</div>
</div>
<div class="sect2">
<h3 id="_security_patches">Security patches</h3>
<div class="paragraph">
<p>For us it is important to continuously ensure that all known vulnerabilities are fixed
and that we deliver security patches and hotfixes as early as possible to our customers.</p>
</div>
<div class="paragraph">
<p>To achieve this goal we integrated all kind of state-of-the-art tools like OWASP dependency check in our build process
that perform automated static code analysis.
We also perform PEN Tests on a regular basis.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>What is OWASP?</strong><br>
The Open Web Application Security Project® (OWASP) is a nonprofit foundation that works to improve the security of software.
Through community-led open-source software projects, hundreds of local chapters worldwide, tens of thousands of members,
and leading educational and training conferences, the OWASP Foundation is the source for developers and technologists
to secure the web.<br>
OWASP is dedicated to enabling organizations to conceive, develop, acquire, operate, and maintain applications
that can be trusted. <br>
All of our projects, tools, documents, forums, and chapters are free and open to anyone interested in improving application security (<a href="https://owasp.org" class="bare">https://owasp.org</a>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_application_protection_by_design">Application protection by design</h3>
<div class="paragraph">
<p>What does Eitco to develop, operate and maintain a secure content service platform?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>we only use Opensource Software from secure and accepted projects like Apache or Spring.</p>
</li>
<li>
<p>we implemented an open source review and monitor process</p>
<div class="ulist">
<ul>
<li>
<p>Software architecture review by the Eitco software architects</p>
</li>
<li>
<p>security check using OWASP dependency check</p>
</li>
<li>
<p>legal licence check to ensure that it is a real open source project on the long term.</p>
</li>
<li>
<p>we continuously check our open source dependencies with reference to architecture, security leaks, maintainability.</p>
</li>
</ul>
</div>
</li>
<li>
<p>to ensure that all known vulnerabilities of 3rd party open source projects are eliminated we integrated the OWASP dependency-check tool in our nightly build.
Dependency check checks our dependencies against a database with all known vulnerabilities.</p>
</li>
<li>
<p>in case a severe vulnerability is found we take the appropriate countermeasures.</p>
<div class="ulist">
<ul>
<li>
<p>provide a security path for our customers with a new version of the 3rd party library</p>
</li>
<li>
<p>change the implementation or configuration using the 3rd party component</p>
</li>
<li>
<p>inform our customers to update or reconfigure components like database, message queue, application server, etc.</p>
</li>
<li>
<p>replace the 3rd party component. The typically requires a major update.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_owasp_dependency_check_tool">OWASP dependency-check tool</h4>
<div class="paragraph">
<p>it is a Software Composition Analysis tool trying to find vulnerabilities made public within the project dependencies.<br>
The tool checks if there is an issue tracked in the "Common Platform Enumeration (CPE)" for the dependency.<br>
If a vulnerability is found it creates report with a link to the CVE entry.<br>
It is command line interface that can be easily integrated in any nightly build process.<br>
For further information, consult National Vulnerability Database (NVD)– (<a href="https://nvd.nist.gov" class="bare">https://nvd.nist.gov</a>). <br>
The following source is worth having a look at: Jeff Williams und Arshan Dabirsiaghi “Unfortunate Reality of Insecure Libraries”<br>
 (<a href="https://owasp.org/www-pdf-archive/ASDC12-The_Unfortunate_Reality_of_Insecure_Libraries.pdf" class="bare">https://owasp.org/www-pdf-archive/ASDC12-The_Unfortunate_Reality_of_Insecure_Libraries.pdf</a>).<br></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliance_recommendations_gobd">Compliance recommendations (GoBD)</h3>
<div class="paragraph">
<p>All companies using electronic data processing for legally or tax relevant documents have to be compliant to the "Principles for the proper management and storage of books, records and documents in electronic form and for data access" (GoBD, BMF letter November 28, 2019).</p>
</div>
<div class="paragraph">
<p>In addition to the proper use of the <em>arveo</em> and 3rd party services, we recommend implementing these measures when using <em>Eitco</em> as compliant repository for legally compliant storage of records and documents.</p>
</div>
<div class="sect4">
<h5 id="_indexing_and_retrievel">Indexing and retrievel</h5>
<div class="paragraph">
<p>To allow users and 3rd party applications to identify and find objects in <em>arveo</em> you should define a unique and immutable unique identifier property ( <a href="#type_annotations"><strong>Data Modelling</strong></a>).
The property must be <em>@Unique</em> to ensure that a user or business application can clearly identify the item.
The unique identifier should use the taxonomy of business processes and contain all information to clearly recognize the document.
Make the property <em>@Readonly</em> to ensure that the identifier is always set and immutable.</p>
</div>
<div class="paragraph">
<p>The minimizes the risk of incorrect indexing and undetectability of documents because the index is immutable, duplicate identifiers are rejected and the compliant taxonomy ensures that every user can find documents easy and fast. We strongly recommend building a documented, simple but clear taxonomy.</p>
</div>
<div class="paragraph">
<p>Your business application or the user must set the value when the object is created (<em>@Mandatory</em> annotation), or you can let <em>arveo</em> create a unique value by adding counter annotations.
Add the <em>@Autoincrement</em> annotation if a simple sequential Long id meets your requirements.</p>
</div>
<div class="paragraph">
<p>If you need a more sophisticated unique identifier you can use the annotation _@FormattedCounter which allows you to create e.g. String identifiers like &lt;year&gt;-&lt;sequence&gt; (<a href="#_formatted_counters_example"><strong>Unique Identifier Example</strong></a>)</p>
</div>
<div class="paragraph">
<p>List data types allow you to store more than String or long value for a property. You can search for each value using the array search operation of the <em>arveo</em> query language (<a href="#_data_types"><strong>Data Types</strong></a>).</p>
</div>
<div class="paragraph">
<p>Enumeration data types allow you to set one or more values from a fixed set of values.</p>
</div>
</div>
<div class="sect3">
<h4 id="_retention_periods">Retention periods</h4>
<div class="paragraph">
<p>Enable that the statutory retention periods are assigned to the records, cases and document types  (<a href="#_retention_periods_retention"><strong>Retention Periods</strong></a>, <a href="#_retention"><strong>Retention Rules</strong></a>) and ensure that the storage container are configured correctly (<a href="#_retention_container"><strong>Retention Container</strong></a>) .</p>
</div>
<div class="paragraph">
<p>Check if the technically assigned retention periods also correspond to the statutory retention periods. Monitor the audit logs to ensure that the retention period is set and is correct. Monitoring could be automated or could be a random control by an employee.</p>
</div>
<div class="paragraph">
<p>The operating team must ensure that storage container contain only documents with the same retention period. Please do not use the same bucket in different storage profiles or assign a storage profile containing content with retention to different document types.</p>
</div>
<div class="paragraph">
<p>Grant the deletion right for your storage containers to <em>arveo</em>. If <em>arveo</em> cannot delete the containers, your operating team is in charge of this task, and you must set the option <em>delete rows only</em>.</p>
</div>
<div class="paragraph">
<p>Configuring storage containers in <em>arveo</em>-service.yaml and your content storage is an ongoing task for your operating team.
<em>Eitco</em> will try to create the buckets or subdirectory on your storage system but can also use already existing ones.</p>
</div>
<div class="paragraph">
<p>It must be ensured that the system time cannot be manipulated (e.g. NTP server). Suitable map measures that a change in the system time is detected promptly.</p>
</div>
<div class="paragraph">
<p>Because the new legal data privacy / protection act makes it necessary to erase data even before the expected retention period has expired <em>arveo</em> please take care that the content storage has no default hardware retention activated.</p>
</div>
<div class="sect4">
<h5 id="_audit_log">Audit log</h5>
<div class="paragraph">
<p>Enable the audit option for all types containing legally compliant content (<a href="#_configure_audit">Audit Log</a>). If the platform is operated safely (<a href="#<em>platform_link">Platform Security</a>) users and applications can exclusively write content and metadata using the _arveo</em> REST API. <em>arveo</em> logs all user or application update operations of content and metadata to the audit table.</p>
</div>
<div class="paragraph">
<p>All changes of content or metadata are persisted as a traceable and immutable version (<a href="#_versioning_v">Versioning</a>) on your storage system and an audit entry is written to the audit log table (<a href="#_configure_audit">Audit Log</a>) containing the author and the timestamp of the change. If a document is updated the version is incremented and saved in the version number. Although all version are traceable and accessible by the API we recommend making the version number system property visible in the application to identify copies of the original easily.</p>
</div>
<div class="paragraph">
<p>Ensure that the <em>@Overwrite</em> option is not set for legally compliant document types. If overwrite is turned on it is possible to manipulate the originally saved content and compromise the document without creating a versioned copy.</p>
</div>
<div class="paragraph">
<p>The audit logs are subject to the retention period of commercial and tax law. Ensure that the audit logs are kept for the legal retention period (10 years). We recommend that the operator of the platform exports and clears the audit tables using database tools after 2 years.
Save the dumps as an <em>arveo</em> document with a 10-year retention period. If you need access to older audit logs you easily download the dumps and upload them to the database.</p>
</div>
<div class="paragraph">
<p>The audit tables must be protected against unauthorized access by users. Do not allow write-access to the audit tables to anyone but the <em>arveo</em> services. Only data protection officers are allowed to have controlled read access to the audit data.</p>
</div>
<div class="paragraph">
<p>Check the audit logs regularly to find unauthorized user activities.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_download_and_migration">Download and migration</h4>
<div class="paragraph">
<p>All documents in <em>arveo</em> that are subject to retention are available by the REST API and can be downloaded. The integrity and availability of the content is the responsibility of the provider and operator of the platform. The provider must ensure that failures of the storage systems for database and content are identified at an early stage and take appropriate countermeasures. See chapter <a href="#_fail_safety">Fail Safety</a> for technical and organizational measures for high availability of the <em>arveo</em> platform.</p>
</div>
<div class="paragraph">
<p>In the event that data has to be migrated, <em>arveo</em> offers an extensive export API that enables content and metadata to be exported.
<em>arveo</em> saves the hash value (<a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function" class="bare">https://en.wikipedia.org/wiki/Cryptographic_hash_function</a>) in the database that was determined when the content was first uploaded (<a href="#_upload_data">Upload Data</a>). This hash value can be used as a checksum to detect accidental or intentionally corruption of data. If the hash value of the content after the migration is identical to the original hash the migration report proves the correctness of the migration process. To report the completeness of the migration process  the <em>arveo</em> API allows you to export a list of all records, cases and documents in a document type.</p>
</div>
</div>
<div class="sect3">
<h4 id="_legally_compliant_migration">Legally compliant migration</h4>
<div class="ulist">
<ul>
<li>
<p>Prerequisite for the migration</p>
<div class="ulist">
<ul>
<li>
<p>use verify and best hash check possible in your solution when uploading content to <em>arveo</em>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>During the migration</p>
<div class="ulist">
<ul>
<li>
<p>download content and metadata (including the original hash and retention period)</p>
</li>
<li>
<p>upload metadata and content to the migrated platform and set the retention period to the exact same value.</p>
</li>
<li>
<p>calculate hash of the migrated platform by downloading the content</p>
</li>
</ul>
</div>
</li>
<li>
<p>After the migration</p>
<div class="ulist">
<ul>
<li>
<p>Correctness: compare hash, metadata and retention period for each original and migrated record, case and document.</p>
</li>
<li>
<p>Completeness: check that each migrated document can be found using the unique identifier</p>
</li>
<li>
<p>Traceability: Create a report for each document type. Report the content hash evidence and the metadata for all migrated objects.<br>
Upload the migration report to the migrated platform and set the retention period to the retention date of the document with the longest retention period within the report.<br>
Depending on your retention policy you can create separate reports for a retention period range (e.g. by year).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_data_integrity">Data integrity</h4>
<div class="paragraph">
<p><em>arveo</em> guarantees high availability, reliability and high performance at all times. The system has to be protected from manipulation attempts by proven and well-thought concepts. The data that is stored and managed in the system is protected via the API. The access and editing rights are managed via ACLs. User rights are based on the developed concepts for roles, groups and ACLs. More detailed information on this is provided in the relevant chapters of this manual.</p>
</div>
<div class="paragraph">
<p>Access to all data (documents, metadata) takes place exclusively via the API, with the corresponding protection mechanisms so that the security of the data is guaranteed at all times.</p>
</div>
<div class="sect4">
<h5 id="_content_storage">Content storage</h5>
<div class="paragraph">
<p>The operator must take appropriate technical or organizational measures to ensure that the data is stored in the storage in such a way that it cannot be changed within the legally prescribed retention period.</p>
</div>
<div class="paragraph">
<p>Enable the verify option for all clients and integrations. The upload API optionally can verify the uploaded content. The content service downloads the just uploaded stream from the
content storage and compares the hash once again with the expected value (<a href="#_upload_data">Upload content</a>).
<em>arveo</em> stores the hash value in a system property and persists the value in the document type metadata table.</p>
</div>
<div class="paragraph">
<p>In case of very sensible data you can enable transparent encryption (<a href="#_encryption">Encryption</a>) to follow the data protection rules and prevent your administrators from access of document content.</p>
</div>
</div>
<div class="sect4">
<h5 id="_databases">Databases</h5>
<div class="paragraph">
<p>For the supported databases postgreSQL 12 you can select between different data replication strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Asynchronous replication (backup or mirror): Enables an asynchronous disaster recovery. Your database is periodically mirrored.</p>
</li>
<li>
<p>Synchronous database cluster: Transactions are synchronously replicated on more than one master node.
The provider of the postgreSQL 12 cluster must guarantee that data is stored redundant and reduce potential data loss.
The provider of the apache solr 8.6 cluster must guarantee that data is replicated between the nodes and that the backup strategy prevents data loss.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The provider of the apache solr 8.6 cluster must guarantee that data is replicated between the nodes and that
the backup strategy prevents data loss.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fail_safety">Fail safety</h4>
<div class="paragraph">
<p>The system operator is responsible for data security and recovery. He must ensure that the backups of the data are checked regularly and that recovery is reliably possible in the event of a failure.
The IT processes that ensure the secure, redundant and highly available storage of <em>arveo</em> data in databases and object or file system storage systems are particularly decisive for the proper operation of the platform.
These are the responsibility of the operator of the platform, who must implement the availability and security of the systems in accordance with legal and organizational requirements.</p>
</div>
<div class="paragraph">
<p>We strongly recommend using a redundant file system or object storage system. If you do not at least backup your data periodically
a data loss is likely. For high availability with almost zero data loss our storage system should replicate the written content and data synchronously. The operating team of the platform must ensure that an appropriate replication is set up and monitored.</p>
</div>
<div class="paragraph">
<p>Object storages with REST APIs are designed for the cloud. If you decide to use storage from the Cloud (public or private) we recommend to use object storage via S3 API. Object storages provide a high level of redundancy (even geo redundant) and fail safety.
The REST S3 API is very tolerant against network and infrastructure failures.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ensure technically and organizationally that there is sufficient space for storing the data.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the best high availability the provider of your storage system must protect the stored data against accidental, malicious, or disaster-induced loss of data. The better your data replication the better is your availability in case of a failure.</p>
</div>
<div class="paragraph">
<p>To achieve high availability for <em>arveo</em> the provider must guarantee that all required (<a href="#_content__services">content services</a>) run as a cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="_security_2">Security</h4>
<div class="sect4">
<h5 id="_operators">Operators</h5>
<div class="paragraph">
<p>The provider of the <em>arveo</em> services should ensure that only authorized data protection officers &amp; administrators have data
write (INSERT,UPDATE, DELETE) permissions for the database and the content repository.</p>
</div>
<div class="paragraph">
<p>An administrator only can illegally manipulate content if he can access both database and content storage because the control hash value of the content is stored in the database. Take care that none of your administrators has exclusive and unattended access to the content storage and the database.</p>
</div>
<div class="paragraph">
<p>Distributed management roles of the storage systems and the <em>arveo</em> transparent <a href="#_encryption"><strong>encryption</strong></a> feature make your system more forgery-proof!</p>
</div>
<div class="paragraph">
<p>The activities of administrators with extensive rights must be logged by the operator. The logs are subject to the retention periods of tax law and must be checked regularly.</p>
</div>
</div>
<div class="sect4">
<h5 id="_platform_link">Platform</h5>
<div class="paragraph">
<p>To prevent unauthorized access to the <em>arveo</em> platform the provider must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ensure that HTTPS communication is enabled for all clients, applications, 3rd party components and services (<a href="#_content__services"><strong>Services</strong></a>).</p>
</li>
<li>
<p>enable OAuth2.0 or X.509 certificate authentication <a href="#_authentication-x509">X.509 certificate authentication</a> and authorization for all <em>arveo</em> service (<a href="#_authentication-oauth2"><strong>OAuth2.0</strong></a>). All <em>arveo</em> services require authentication, ensuring that only  <em>arveo</em> services or authenticated and authorized users can use the API. We recommend using a state-of-the-art authentication services like keycloak and to enable <a href="#_configure_keycloak_for_sso_with_kerberos"><strong>SSO</strong></a> with at least 2-factor authentication.</p>
</li>
<li>
<p>take suitable technical or organizational actions against unauthorized changes to the data such as firewall, VPN, transparent encryption with <em>arveo</em> or at hardware level,</p>
</li>
<li>
<p>provide adequate protection of passwords by using a state-of-the-art IDP such as Keycloak or MS Active Directory and increasing the password complexity accordingly.</p>
</li>
<li>
<p>take actions against denial of service attacks.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_arveo_content_services"><em>arveo</em> Content Services</h5>
<div class="paragraph">
<p>The administrators of the <em>arveo</em> platform must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>make sure that only authorized persons receive an account that grants access to <em>arveo</em> documents;</p>
</li>
<li>
<p>ensure that objects are protected against unauthorized access using ACLs. We recommend defining a separation of functions and implementing this via <a href="#_access_control_lists"><strong>ACLs</strong></a>. To achieve the best data security assign ACLs to all records, cases and documents. Make sure that for all used ACLs the assignment of access rights to users and groups is carried out regularly (e.g. Invoice document type, accounting: write, employees: read);</p>
</li>
<li>
<p>the activities of managers who can change ACLs are logged via <em>arveo</em> audit and checked at regular intervals;</p>
</li>
<li>
<p>organizationally ensure that the password the <em>arveo</em> administration users are changed regularly.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_store"><strong>Data Store</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_persistence_architecture">Persistence architecture</h3>
<div class="paragraph">
<p><em>arveo</em> guarantees forgery-proof long term availability of your content and metadata.</p>
</div>
<div class="paragraph">
<p>All revisions of content or metadata are stored as a traceable and immutable version
(<a href="#_versioning_v">Versioning</a>) to the storage systems.
The content service checks the integrity of uploaded content by computing SHA-256 hashes on client and server side.
Additionally, an audit entry is written to the audit log table (<a href="#_configure_audit">Audit Log</a>).
<em>arveo</em> provides a role based access control on object level and allows you to prevent unauthorized access
to content and metadata.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> protects content and metadata by software design. <em>arveo</em> only allows access to
content and metadata via the <em>arveo</em> REST API. As only <em>arveo</em> and highly authorized administrators have
data writer rights for the database and the storage it is impossible that content
is deleted or manipulated by unauthorized persons.</p>
</div>
<div class="paragraph">
<p>Together with <em>arveo</em>'s capabilities to manage the retention periods of documents and records
(<a href="#_retention_periods_retention">Retention Periods</a>) <em>arveo</em> guarantees a  GDPR and/or DSGVO compliant data protection and data privacy.</p>
</div>
<div class="paragraph">
<p><strong><em>arveo</em> meets the the requirements of a revision proof long term archive and is a corner stone for the legal compliance of your IT systems.</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Because the new legal data privacy / protection act makes it necessary to erase data even before the expected
retention period has expired <em>arveo</em> does not use hardware retention features.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If needed you can add verifiable evidence records to the documents (signatures, timestamps) to proof the integrity and authenticity
of content and author. The creation of the evidence is not a feature of <em>arveo</em> . It only stores the record together with
the content.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this chapter you will find all information how to setup a secure and legally compliant content service platform
with <em>arveo</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_types">Data types</h3>
<div class="paragraph">
<p><em>arveo</em> distinguishes three kinds of data and stores each to the most suitable storage system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Content: <em>arveo</em> stores unstructured content like documents, audio, video and images to
either a cloud object storage or a file system storage.<br>
Most cloud providers like AWS S3, NetAPP ONTAP, EMC Elastic Cloud, etc. provide file system storage or object storage systems.
Object storages are organized in buckets and allow you to store an almost unlimited numbers of objects in a bucket.
<em>arveo</em> accesses the content via REST Standard S3.<br>
For an optimized and fast access of often used content objects <em>arveo</em> can integrate a NoSQL Keyvalue
Cache DB like redis.</p>
</li>
<li>
<p>Structured system properties: containing all primary keys and technical information
about documents, containers and folders. The data has a fix data model and requires highest performance, consistency and
transaction support. <em>arveo</em> saves the data on a relational database.</p>
</li>
<li>
<p>Customer specific metadata: The data model is different for each document, container or folder type. This metadata is
semi structured and new properties might be added during the life cycle of the application.</p>
<div class="ulist">
<ul>
<li>
<p>Eventually consistent customer information: Sometimes the consistency of the data is not important, but we must guarantee a high performance and facets support when we filter by any value without the risk of a full table scan.
<em>arveo</em> saves customer metadata on a NoSQL document DB apache solr 8.6 which
is highly efficient for inserting and searching and offers automatic completion and facets.</p>
</li>
<li>
<p>Consistent customer keys: The properties require highest performance, consistancy and
transaction support. <em>arveo</em> saves the data on a relational database.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_high_availability">High availability</h3>
<div class="paragraph">
<p>The high availability (HA) of <em>arveo</em> depends highly on the HA of the storage systems for all kind of data. Each of the storage systems and as a result the <em>arveo</em> services follow the CAP (Consistency, Availability and Partition Tolerance) theorem saying that the availability and fail safety of a system depend on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consistency: All clients see the same content and metadata.</p>
</li>
<li>
<p>Availability: All clients can read and write.</p>
</li>
<li>
<p>Partition Tolerance: the system is fail safe when one or more nodes fail.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/captheorem.png" alt="CAP theorem">
</div>
</div>
<div class="paragraph">
<p>The CAP theorem in a nutshell predicts that you cannot have all three properties but only two of them.</p>
</div>
<div class="paragraph">
<p>As <em>arveo</em> is a ECM cloud platform <strong>consistency</strong> and <strong>availability</strong> (read/write) of content and metadata
are most important. <em>arveo</em> tolerates that network or message failure of either the primary content
storage or database node can cause exceptions on the client application.
The <em>arveo</em> services do not store data within their containers and focus on scalability and partition tolerance.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <em>arveo</em> micro services should be deployed as containers in your cloud environment (e.g. kubernetes) and auto scaling should be implemented.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_data_integrity">Data integrity</h3>
<div class="paragraph">
<p><em>arveo</em> ensures the immutability and integrity of all your digital content and evidence records by an automated hash check each time content is up- or downloaded.</p>
</div>
<div class="sect4">
<h5 id="_upload">Upload</h5>
<div class="paragraph">
<p><strong>Hash-Check:</strong> When you use the upload content API, the client side and content service compute SHA-256 hash for the streamed data.
Only if both values are identical the upload process is successful.
The upload API allows you to pass the expected SHA-256 value and the API will only return OK if the server side hash
matches the expected hash.</p>
</div>
<div class="paragraph">
<p><strong>Verify:</strong> The upload API optionally can verify the uploaded content. The content service downloads the just uploaded stream from the
content storage and compares the hash once again with the expected value (<a href="#_upload_data">Upload Content</a>).
<em>arveo</em> stores the hash value in a system property and persists the value in the document type metadata table.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The verify option of the Upload API may slow down your system when uploading a huge amount of data.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_transactions">Transactions</h5>
<div class="paragraph">
<p>The <em>arveo</em> REST API is stateless and there is no session. That means that all REST API calls are atomic and all database commands are executed within one transaction. <em>arveo</em> guarantees the atomicity of the transactions and to avoid inconsistent states, all aborted transactions are removed and rolled back. Hanging transactions are removed and rolled back to avoid database locks.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The database provider should configure the transaction deadlock timeout on your database to avoid locks on the database that can decrease the performance of your UPDATE and DELETE calls.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_download">Download</h5>
<div class="paragraph">
<p>When you use the download API (<a href="#_download_data">Download Content</a>) the client SDK computes the SHA-256 hash of the downloaded stream and compares it to the hash value
in the system property of the document type. If the hash does not match the upload hash value in the database the download fails with a data integrity exception
telling the caller that the data on the storage was most likely manipulated.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
An administrator only can illegally manipulate content if he can access both database and content storage because the control hash value of the content is stored in the database. Take care that none of your administrators has exclusive and unattended access to the content storage and the database.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Distributed management roles of the storage systems and the <em>arveo</em> transparent encryption feature can make your system forgery-proof!
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_content_storage_2">Content storage</h3>
<div class="paragraph">
<p><em>arveo</em> support evidence proof long term storage of your content and metadata by storing the content legally secure to either a S3 object storage or a file system. The storage must be redundant. Object storage systems like AWS, NetAPP or EMC Elastic Cloud Storage guarantee the long term availability and integrity of your content.</p>
</div>
<div class="paragraph">
<p>All changes of content or metadata are persisted as a traceable and immutable version (<a href="./versioning.html">Versioning</a>) on your storage system
and an audit entry is written to the audit log table (<a href="#_configure_audit">Audit Log</a>).
<em>arveo</em> creates a version each time metadata including comments and annotations or content of a document is changed by the API <em>arveo</em>} creates a new entry containing the author and the timestamp pf the change in the version management table.
The Update API allows you to add a comment to each version. The Version Management API provides access to all version information and metadata and content of previous versions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
To ensure that the content is immutable only <em>arveo</em> should have write access to the storage system.<br>
Only authorized data protection officers &amp; administrators should have write-access to the storage system.<br>
In case of very sensible data you can enable encryption (<a href="#_encryption">Encryption</a>) to follow the data protection rules and prevent your administrators from access of document content.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For best high availability the provider of your storage system must protect the stored data against accidental, malicious, or disaster-induced
loss of data. The better your data replication the better is your availability in case of a failure.</p>
</div>
<div class="sect4">
<h5 id="_data_replication_redundancy">Data replication (redundancy)</h5>
<div class="paragraph">
<p>For both supported storages (S3, file system) you can select between different data replication strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Backup or Mirror enables an asynchronous disaster recovery. Your content data is periodically mirrored and the data;</p>
</li>
<li>
<p>Synchronous replication;</p>
</li>
<li>
<p>Asynchronous replication.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_fail_safety_consistency_availability">Fail Safety (Consistency, Availability)</h4>
<div class="paragraph">
<p>As <em>arveo</em> stores each version of the content as an immutable object it is not possible that clients will get
outdated data. If the replication is asynchronous it only can happen that clients get a read error.</p>
</div>
<div class="paragraph">
<p>In case the storage is offline <em>arveo</em> is not available and the system has an outage.
In case the storage allows only read access <em>arveo</em> can download content but upload operations fail.</p>
</div>
<div class="paragraph">
<p>If the storage node has a long term outage the potential data loss is limited by the time
that has passed since the last replication and the number of objects stored since that time.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
We strongly recommend using a redundant file system or object storage system. If you do not at least backup your data periodically
a data loss is likely.<br>
For high availability with almost zero data loss
your storage system should replicate the written content and data synchronously.<br>
The operating team of the platform must ensure that an appropriate replication is set up and monitored.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can configure different storage location (Cloud-Storage or on premise) for your content and document types (<a href="#_bucketorganizer">Storage Configuration</a>).<br>
Reduce costs by storing non compliant and legally relevant data like PDF/A renditions of documents on storage systems with lower availability and performance SLAs.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Object storages with REST APIs are designed for the cloud. If you decide to use storage from the Cloud (public or private)
we recommend to use object storage via S3 API. Object storages provide a high level of redundancy (even geo redundant) and fail safety.
The REST S3 API is very tolerant against network and infrastructure failures.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_consistent_meta_data_storage_relational_database">Consistent meta data storage (relational database)</h4>
<div class="paragraph">
<p>The relational database postgreSQL 12 is responsible for 100% consistent processing of the structured metadata and transactions.</p>
</div>
<div class="sect4">
<h5 id="_data_replication_redundancy_2">Data replication (redundancy)</h5>
<div class="paragraph">
<p>For the supported databases postgreSQL 12 you can select between different data replication strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Asynchronous replication (backup or mirror): Enables an asynchronous disaster recovery. Your database is periodically mirrored.</p>
</li>
<li>
<p>Synchronous database cluster: Transactions are synchronously replicated on more than one master node.</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The provider of the postgreSQL 12 cluster must guarantee that data is stored redundant and reduce potential data loss.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fail_safety_consistency_availability_2">Fail safety (consistency, availability)</h4>
<div class="paragraph">
<p>In case the database cluster is down or allows only read access <em>arveo</em> is not available (Deny Of Service/DOS).
If the database has a long term outage and the data files are affected the potential data loss is limited by the time
that has passed since the last replication and the number of objects stored since that time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_eventually_consistent_meta_data_storage_nosql_document_database_apache_solr_8_6">Eventually consistent meta data storage (NoSQL document database apache solr 8.6)</h4>
<div class="paragraph">
<p><em>arveo</em> uses modern NoSQL storage technologies to guarantee high search performance and horizontal scalability at
all times. We store semi-structured or dynamic document metadata to a NoSQL document database apache solr 8.6.</p>
</div>
<div class="paragraph">
<p>Solr is an open source search platform that has been partially integrated into <em>arveo</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/solr_arveo.png" alt="solr arveo">
</div>
</div>
<div class="paragraph">
<p>Based on the type definitions that are created in <em>arveo</em>, <em>arveo</em> automatically creates a schema
that Solr uses. In addition, for each client that is created in <em>arveo</em>, a new collection is also created in
Solr, so that there is also a separation of data there.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_replication_redundancy_3">Data Replication (Redundancy)</h4>
<div class="paragraph">
<p>Setup a cluster of replicated nodes for apache solr 8.6. Refer to the apache solr 8.6 documentation to
setup a redundant cluster.</p>
</div>
<div class="sect4">
<h5 id="_fail_safety_availability_partition_tolerance">Fail safety (availability, partition tolerance)</h5>
<div class="paragraph">
<p>In case the database cluster is down <em>arveo</em> is still available but free customer searches fail.
In case one database node is down or the database is read only <em>arveo</em> is still available but searches may return outdated results.
If the database has a long term outage and the data files are affected the potential data loss is limited by the time that has passed since the last replication and the number of objects stored since that time.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The provider of the apache solr 8.6 cluster must guarantee that data is replicated between the nodes and that the a backup strategy prevents data loss.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clustering">Clustering</h3>
<div class="paragraph">
<p>Each <em>arveo</em> service can be configured as a service cluster to achieve HA. Depending on the deployment you can either set up an application server cluster (WAR deployment) or run our containerized applications on a cloud platform like open-stack with kubernetes.</p>
</div>
<div class="sect4">
<h5 id="_fail_safety_consistency_availability_3">Fail safety (consistency, availability)</h5>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Content services in <em>arveo</em></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Failure risks</th>
<th class="tableblock halign-left valign-top">Recommended</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User management Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No login possible, system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration not available to all nodes, system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registry Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service registry not available, system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store, edit and version documents and metadata not available, system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2-n, automatic scale up/down by load</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP Archive Link Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP archive link not available, SAP outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2-n, automatic scale up/down by load</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Conversion Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conversion to PDF/A not available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2-n, automatic scale up/down by load</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise Integration Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job execution paused and integration with external systems not available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2-n</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Federation Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access to external repositories (Documentum, Saperion) not available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2-n, automatic scale up/down by load</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Control Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access of objects with  access control list fails, partial system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_required_3rd_party_services">Required 3rd party services</h4>
<div class="paragraph">
<p>To operate <em>arveo</em> successfully with high availability the operator of the platform must provide
the following services as a cluster.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Failure risks</th>
<th class="tableblock halign-left valign-top">Recommended</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active MQ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Asynchronous operations are not triggered</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">postgreSQL 12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access to metadata not available, system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2-n depending on load and configuration of postgreSQL 12 cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apache solr 8.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise search not available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2-n depending on load and configuration of apache solr 8.6 cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content Storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content access not available, system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage cluster depending on provider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login not available via OAUTH2, system outage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Monitoring (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ELK (Elasticsearch, Logstash, and Kibana)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster 2</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
To achieve high availability for <em>arveo</em> the provider must guarantee that all required <a href="#_content__services">content services</a> run as a cluster.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_deletion">Data deletion</h3>
<div class="paragraph">
<p>By default all documents of a specific document type stored in <em>arveo</em> store the metadata to the configured database and their content to the object storage. When a version is created the content or metadata is stored as a traceable and immutable version (<a href="#_versioning_v">Versioning</a>) to the database and storage system. That means that we have separate content objects and database entries for each version.
Each document can have a retention period that ensures that the document cannot be deleted before the period expires.</p>
</div>
<div class="paragraph">
<p>You can delete or purge any object with the <em>arveo</em> Delete-API if you have the <em>DELETE</em> right for the document type and the object ACL and the retentions period has not expired.</p>
</div>
<div class="paragraph">
<p>The delete method deletes all entities including all versions of the object in the database, but it does not delete the content objects or files. The delete operation cannot be restored and the data is permanently deleted.</p>
</div>
<div class="paragraph">
<p>The purge method additionally erases the content objects or files from the content storage.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you delete objects only in the database the content objects are orphaned, and it is impossible to restore them and almost impossible to delete them later on because there is no relation left in the database. The content objects remain as data trash in the system and cannot be accessed by the API.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_recycle_bin">Recycle bin</h3>
<div class="paragraph">
<p>Any document, container or folder type can use the optional <em>recycle bin</em> feature. If it is enabled, entities in the type definition can be moved to and restored from the recycle bin.</p>
</div>
<div class="paragraph">
<p>The recycle bin is implemented as a boolean database system property <em>DELETED</em>. Entities in the recycle bin will be filtered from normal queries by default, but a client can compose search expressions that override this behavior (see <a href="#_document_service_recycle_bin"><strong>Recycle Bin</strong></a>).</p>
</div>
<div class="paragraph">
<p>If you delete or purge an object in the recycle bin it is deleted like a document without recycle bin feature and cannot be restored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For compliance reasons the audit entries in the database are not deleted by the Delete-API and the delete operation written to the audit log. The operator of the  platform must clean up the audit table after the legal retention period has expired. We recommend backing up the audit logs to meet the legal requirements of data protection and to ensure that the backups can be restored within the legal retention period.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_automated_recycle_bin_emptying">Automated recycle bin emptying</h4>
<div class="paragraph">
<p>It is possible to empty your recycle bin by an automated job scheduled in the Enterprise Integration Service of <em>arveo</em>.You can activate the predefined empty recycle bin job, and you can change the age from the 6 months default value to the age you choose. The job deletes all entries permanently that have been in the recycle bin for longer than the set age.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recovery_log">Recovery log</h4>
<div class="paragraph">
<p>In addition to the recycle bin feature, the <em>arveo</em> offers an additional safety layer to recover permanently deleted entities.By annotating a type definition with <em>@Recovery</em>, it is possible to define a time period, in which permanently deleted entities will be kept in a system-wide recovery table before they are removed completely.An entity in such a type definition that is deleted (or purged) will be removed from the type definition&#8217;s table (and its version table).A copy of each version of the entity will be stored in the recovery table making it possible to restore it manually.If the entity is a document, its contents will not be deleted from the storage until the entity is removed from the recovery table.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
There is no API to restore data from the recovery table.
This feature is only intended as a last backup in order to make accidentally deleted data available to the business by an administrator.The admin can copy the content file from the storage together with the JSON metadata and send it to the business department.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recovery_log_emptying">Recovery log emptying</h4>
<div class="paragraph">
<p>The system management API provides a method to remove expired entities from the recovery table.An entity is considered expired when its keep-until timestamp is in the past compared from the moment the method is invoked.A user who calls this
method needs the <strong>ECR_PURGE_RECOVERY_TABLE</strong> authority (see <a href="#_access_rights">Access Rights</a>).</p>
</div>
<div class="paragraph">
<p>The recovery of deleted entities is a manual process. The recovery table contains a JSONB column containing a JSON representation of the entire entity including attributes, content information and modification information. Each version of an entity is contained in the recovery table as a separate row.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is possible to empty the recovery log by an automated custom job scheduled in the Enterprise Integration Service of <em>arveo</em>. The job must execute the Management-API method to empty the recovery table.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><strong>Installation</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_deployment_options">Deployment options</h3>
<div class="paragraph">
<p>The lightweight and stateless services are delivered as
containers for all platforms and allow the <em>arveo</em> to automatically scale horizontally. Customers have the choice between an on-premise, cloud or hybrid installation.</p>
</div>
<div class="paragraph">
<p>The deployment may be done as a:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Docker images (for the <em>arveo</em> services): A Docker image is a template that contains a set of instructions for
creating a container. Several containers can be started from one image;</p>
</li>
<li>
<p>executable jar: Integrate the content services in your java application and run on any platform that provides a JVM;</p>
</li>
<li>
<p>a <em>.war</em> file: Deploy the services as web applications in an application server like Tomcat;</p>
</li>
<li>
<p>Spring Boot application: Deployed as a self running service using an embedded undertow servlet container;</p>
</li>
<li>
<p>Debian package: Debian packages are used for software installation on Debian-based operating systems;</p>
</li>
<li>
<p>Kubernetes HELM charts: Deploy the content services as containerized applications in your kubernetes environment with flexible HELM charts. That will enable load-dependent,
automated service provision.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_system_requirements">System requirements</h3>
<div class="paragraph">
<p>This chapter describes the system requirements for an on premise installation. The configuration and deployment of all required artefacts is performed by Eitco or a partner by the automated deployment tool "Puppet".</p>
</div>
<div class="sect3">
<h4 id="_general_prerequisites">General prerequisites</h4>
<div class="sect4">
<h5 id="_firewall">Firewall</h5>
<div class="paragraph">
<p>Some firewall permissions are required. The IP addresses and the ports are customer-specific. In order to notify the provider of this, the customer must fill out the form customer-specific information.</p>
</div>
</div>
<div class="sect4">
<h5 id="_network_access">Network Access</h5>
<div class="paragraph">
<p>SSH access from the Eitco network to all customer-specific systems (including server) is required so that the installation can be carried out. Access to the official Ubuntu package sources is required. This is done either in the form of direct access via the Internet or by providing a local copy of the corresponding repository.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_smtp_mail">SMTP Mail</h4>
<div class="paragraph">
<p>In addition, an SMTP server access is required for sending mail, as well as access to the Eitco Puppet Master via VPN. The following parameters must also be provided by the customer so that any error messages from the HL7 Integration Service can be sent by email:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SMTP_SERVER</p>
</li>
<li>
<p>SMTP_PORT</p>
</li>
<li>
<p>SMTP_STARTTLS = true / false</p>
</li>
<li>
<p>SMTP_USER</p>
</li>
<li>
<p>SMTP_PASSWORD</p>
</li>
<li>
<p>MAIL_TO</p>
</li>
<li>
<p>MAIL_FROM.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>MAIL_TO is the address to which the mails are sent and MAIL_FROM is the sender address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reference_integration_system">Reference Integration System</h4>
<div class="paragraph">
<p>A reference system (in the form of a VM or similar) is required to test the system. There must be the same setup as on the customer client systems (i.e. the same web browser, with the same settings, etc). In addition, a terminal / RDP access is to be provided so that Eitco can test the client installation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_web_browser">Web browser</h4>
<div class="paragraph">
<p>For the administration user interfaces the following web browsers are supported: Safari, Google Chrome, Microsoft Edge, Mozilla Firefox, each in the current version.</p>
</div>
</div>
<div class="sect3">
<h4 id="_system_requirements">Containerized Applications</h4>
<div class="paragraph">
<p>For the installation of the product, certain requirements for the hardware, software and infrastructure to be provided
must be met.
In a typical cloud environment each <em>arveo</em> service is deployed as a containerized application and is hosted and scaled by a cloud operating system.
However, a different setup can be used, depending on the customer infrastructure and the load of the system (see <a href="#">Deployment Options</a>)</p>
</div>
<div class="paragraph">
<p>The following chapter describes the minimum CPU and RAM requirements of each <em>arveo</em> service in a production environment.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Content services requirements</caption>
<colgroup>
<col>
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">CPU</th>
<th class="tableblock halign-left valign-top">RAM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 x&gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 32 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Management Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 2 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registry Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 512 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 512 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Control Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 2 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 512 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP Archive Link Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 1 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Conversion Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 2 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise User Management Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 1 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise Integration Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 1 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Federation Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1x &gt; 2 GHz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;= 2 GB</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The number of started services for each service group and the assigned CPU and RAM depends very much on the load and the number of documents and objects in the database. You should always monitor the system and scale up or down on demand.
Especially service like document conversion or enterprise integration service can produce heavy load and require a lot of containers consuming RAM and CPU.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For a test or development system the requirements are lower
and each service requires: &lt; 1 CPU, 256 MB for all services.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_typical_non_containerized_installation">Typical Non-Containerized Installation</h4>
<div class="paragraph">
<p>Assuming that the installation is performed as spring boot services we recommend to set up a minimum of 3 machines. The database and the document service carry the highest load and should be deployed on separate machines. All other services and 3rd party services can run on one OS instance. Some services like Archive Link, Document Conversion may consume high CPU and RAM and can make it necessary to outsource them to separate machines,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>System machine 1 - <strong>database</strong>. The PostgreSQL database is installed here.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Requirements for the database machine</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Recommendation</th>
<th class="tableblock halign-left valign-top">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4x (&gt; 2 GHz)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 16 GB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Depending on the size of the database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB Storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proportional to the number and the kind of the entities</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recommendation: should be stored on separate
storage</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Depending on the volume of changes to the database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recommendation: Should be stored on separate storage</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 18.04/20.04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The operating system recommendation is optional, hence any system satisfying the requirements
of the PostgreSQL database may be installed</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>System machine 2 - Document Service is installed here.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Requirements for the <em>arveo</em> machine</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Recommendation</th>
<th class="tableblock halign-left valign-top">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4x (&gt; 2 GHz)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32 GB</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proportional to the size of the content objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These storages are supported:<br>
1) on a separate file storage<br>
2) AWS, NetAPP or EMC Elastic Cloud Storage.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 18.04/20.04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The tests are performed on a Debian machine, hence it is recommended to install a Debian
based distribution, for example a current LTS version of Ubuntu</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The storage is meant for storing the <em>arveo</em> content objects of type <em>Document</em>, meaning binary content. All metadata and system properties are stored in the database, see System machine 1 above.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>System machine 3 - Here all other services of <em>arveo</em> are installed: see <a href="#_content__services"><strong>Content Services</strong></a>, <a href="#_3rd_party_services"><strong>3rd party services</strong></a></p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Requirements for the Services machine</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Recommendation</th>
<th class="tableblock halign-left valign-top">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4x (&gt; 2 GHz)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16 GB</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 18.04/20.04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The operating system should be a Debian based</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The importance of testing shouldn&#8217;t be underestimated, so there should always be a way to test specific cases
without trying it out on a production system. For this reason, it is important to create a test system, which has
the same specification and a similar data set as the original system.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the <em>arveo</em> services JDK 11, 16 is required. All the other recommendations listed above are
non-binding, but they have proven to work well. In some cases, other recommendations can be made, according to your
individual project setup as well as the requirements of the project.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_2">Installation</h3>
<div class="sect3">
<h4 id="_general_concept">General concept</h4>
<div class="paragraph">
<p>These instructions describe the installation procedure, the installation content and the items required for commissioning the product.
We recommend controlling the rollout of the <em>_arveo</em> services by a continuous integration process that provides all artefact required for the deployment of the required content services and your web solution and integrations.</p>
</div>
<div class="paragraph">
<p>Depending on the underlying platform, deployment takes place via binary service artifacts that are deployed on pre-installed VMs or via containerized applications that are made available in the host cloud system.</p>
</div>
</div>
<div class="sect3">
<h4 id="_on_premise_installation_by_eitco">On premise installation By Eitco</h4>
<div class="paragraph">
<p>This chapter describes the compliant On Premise installation provided by Eitco. The configuration and deployment of all required artefacts is performed by Eitco or a partner by the automated deployment tool "Puppet".</p>
</div>
<div class="paragraph">
<p>The customer provides several virtual machines that are configured by Eitco with the automated deployment tool Puppet (<a href="#_puppet">Puppet Deployment</a>) in order to ensure a problem-free software rollout in the customer system.</p>
</div>
<div class="paragraph">
<p>Depending on the service level agreement Eitco can guarantee high availability, reliability and high performance at all times. The system has to be protected from manipulation attempts by technical or organizational measures. The data that is stored and managed in the system is protected via the API. The access and editing rights are managed via ACLs. User rights are based on the concepts for roles, groups and ACLs. More detailed information on this is provided in the relevant chapters of this manual.</p>
</div>
<div class="paragraph">
<p>All changes to the system and the data are logged via the API, and the changes are traceable via
the audit log. If auditing is activated, every database change is logged.
In order to guarantee the atomicity of the transactions and to avoid inconsistent states, all are aborted transactions removed and rolled back.</p>
</div>
<div class="paragraph">
<p>Access to all data (documents, metadata) is exclusively provided via the API, with the corresponding protection mechanisms so that the security of the data is guaranteed at all times.</p>
</div>
</div>
<div class="sect3">
<h4 id="_puppet">Puppet</h4>
<div class="paragraph">
<p>Puppet is open source software developed by Puppet Labs and is used for the automated configuration and deployment of software deliveries. It ensures the configuration management of servers with both Unix-like operating systems and the Windows operating system via network. The Ad-min-Tool allows the automated configuration of computers and servers as well as the services installed on them.
The <em>arveo</em> services are installed and configured with Puppet. After the server has been provided, see <a href="#_system_requirements">System Requirements</a>, the Puppet Agent is installed on it, which then takes care of setting up the environment and the actual application. The duration of the installation process can vary and requires an adequate internet connection. The individual installation components are installed in the form of .deb packages.
The installation is completely automated and carried out remotely.</p>
</div>
</div>
<div class="sect3">
<h4 id="_installed_services">Installed services</h4>
<div class="paragraph">
<p><a href="#_3rd_party_services"><strong>3rd Party Services</strong></a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>postgreSQL 12 Database</p>
</li>
<li>
<p>apache solr 8.6 Document Database (full text)</p>
</li>
<li>
<p>JDK 11, 16</p>
</li>
<li>
<p>Keycloak, Active Directory Authentication Service</p>
</li>
<li>
<p>Active MQ Message Service Hub</p>
</li>
<li>
<p>Tomcat 9 Application Server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#_content__services"><strong><em>arveo</em> Content Services</strong></a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Document Service</p>
</li>
<li>
<p>Registry Service</p>
</li>
<li>
<p>Configuration Service</p>
</li>
<li>
<p>User Management Service</p>
</li>
<li>
<p>Access Control Service</p>
</li>
<li>
<p>Audit Service (optional)</p>
</li>
<li>
<p>Document Conversion Service (optional)</p>
</li>
<li>
<p>Enterprise Integration Service (optional)</p>
</li>
<li>
<p>Enterprise User Management Service (optional)</p>
</li>
<li>
<p>Enterprise Federation Service (optional).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Customer Applications &amp; Services</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eitco or Customer application and integration services (typically web client and Apache Camel integration end pints)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_order_of_services">Order of services</h4>
<div class="paragraph">
<p>Following you find the order of the service starts. The content services may not work before important services are started.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All commands should be executed as root. When running as a non-root user, sudo should be set in front of systemctl.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The services are initially started by Puppet.
After the installation of <em>arveo</em> has been successfully completed, the customer applications can be started.
Additional information on registration, user management and the use of the web client can be found in the user and admin manual.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>postgreSQL 12: systemctl start/stop postgresql</p>
</li>
<li>
<p>apache solr 8.6: systemctl start/stop solr.service, systemctl start/stop zookeeper.service</p>
</li>
<li>
<p>Config Service: systemctl start/stop common_config_service.service</p>
</li>
<li>
<p>Registry Service: systemctl start/stop common_registry_service.service</p>
</li>
<li>
<p>User Management Service: systemctl start/stop common_user_management.service</p>
</li>
<li>
<p>ACL Service: systemctl start/stop common_access_control.service</p>
</li>
<li>
<p>Enterprise User Management Service: systemctl start/stop common_enterprise_user_management.service (optional)*</p>
</li>
<li>
<p>Federation Service: esystemctl start/stop cr_federation.service (optional)</p>
</li>
<li>
<p>Audit Service: systemctl start/stop common_audit.service (optional)</p>
</li>
<li>
<p>Document Service: systemctl start/stop ecr_repository_service.service</p>
</li>
<li>
<p><em>Document Conversion Service: systemctl start/stop common_document_conversion.service</em> (optional)</p>
</li>
<li>
<p><em>Enterprise Integration Service: systemctl start/stop common_enterprise_integration.service</em> (optional)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The current status of the service can also be determined with systemctl status &lt;service&gt;.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ssl_certificates">SSL Certificates</h4>
<div class="paragraph">
<p>If all connections between the services are to be encrypted, SSL certificates are required. The following requirements apply:
An <a href="authentication-x509.html">X-509 certificate</a> with an associated "private key" is required for each server. The certificate should be signed by an official CA or the company&#8217;s own CA. Self-signed certificates can also be used. The following special feature must be observed: the X509 extension “Subject Alternative Name” must contain all DNS names and IP addresses via which the respective systems are accessed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_licensing">Licensing</h4>
<div class="paragraph">
<p>The client software uses several 3rd party licenses. The list of licenses can be called up via the following link: <a href="https://&lt;customername&gt;.eitco.de/3rdpartylicenses.txt" class="bare">https://&lt;customername&gt;.eitco.de/3rdpartylicenses.txt</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_backups">Backups</h4>
<div class="paragraph">
<p>The logs are on the db server in the directory /var/log/postgresql/backup.log.
The database backup script is located at /var/lib/postgresql/backup.sh. This can also be started manually at any time. There should not yet be a folder with the current date under / backup / full /. If such a folder exists, it must be moved beforehand.
The script is controlled by cron and is always started automatically at 10 p.m.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><strong>Getting Started</strong></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide you will create a simple application that implements a basic project file scenario. It will consist of a document type, that represents documents used in a project.</p>
</div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="paragraph">
<p>To complete the steps in this guide, you need the following tools installed on your machine:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 11 or newer (<a href="https://adoptium.net/" class="bare">https://adoptium.net/</a>). Please use only LTS versions!</p>
</li>
<li>
<p>Apache Maven (<a href="https://maven.apache.org/" class="bare">https://maven.apache.org/</a>)</p>
</li>
<li>
<p>An IDE of your choice (we recommend IntelliJ)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_maven_configuration">Maven configuration</h3>
<div class="paragraph">
<p>To be able to access the maven artifacts of arveo, you need access to the EITCO Nexus repository.</p>
</div>
<div class="sect3">
<h4 id="_internal">Internal</h4>
<div class="paragraph">
<p>When you are inside the company network or the VPN, you can use the internal Nexus that does not require authentication. The following maven settings.xml file shows how to configure the required repositories. The settings.xml file can be found in the <em>.m2</em> directory in your user home directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;settings</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/SETTINGS/1.0.0</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;pluginGroups&gt;</span>
  <span class="tag">&lt;/pluginGroups&gt;</span>
  <span class="tag">&lt;proxies&gt;</span>
  <span class="tag">&lt;/proxies&gt;</span>
  <span class="tag">&lt;servers&gt;</span>
  <span class="tag">&lt;/servers&gt;</span>
  <span class="tag">&lt;mirrors&gt;</span>
  <span class="tag">&lt;/mirrors&gt;</span>
  <span class="tag">&lt;profiles&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
      <span class="tag">&lt;id&gt;</span>repos-default<span class="tag">&lt;/id&gt;</span>
      <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;activeByDefault&gt;</span>true<span class="tag">&lt;/activeByDefault&gt;</span>
      <span class="tag">&lt;/activation&gt;</span>
      <span class="tag">&lt;properties&gt;</span>
      <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;repositories&gt;</span>
        <span class="tag">&lt;repository&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
          <span class="tag">&lt;id&gt;</span>nexus<span class="tag">&lt;/id&gt;</span>
          <span class="tag">&lt;url&gt;</span>https://nexus-intern.eitco.de/repository/maven-private/<span class="tag">&lt;/url&gt;</span>
          <span class="tag">&lt;releases&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/releases&gt;</span>
          <span class="tag">&lt;snapshots&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/snapshots&gt;</span>
        <span class="tag">&lt;/repository&gt;</span>
      <span class="tag">&lt;/repositories&gt;</span>
      <span class="tag">&lt;pluginRepositories&gt;</span>
        <span class="tag">&lt;pluginRepository&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="tag">&lt;id&gt;</span>nexus<span class="tag">&lt;/id&gt;</span>
          <span class="tag">&lt;url&gt;</span>https://nexus-intern.eitco.de/repository/maven-private/<span class="tag">&lt;/url&gt;</span>
          <span class="tag">&lt;releases&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/releases&gt;</span>
          <span class="tag">&lt;snapshots&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/snapshots&gt;</span>
        <span class="tag">&lt;/pluginRepository&gt;</span>
      <span class="tag">&lt;/pluginRepositories&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
  <span class="tag">&lt;/profiles&gt;</span>
<span class="tag">&lt;/settings&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The maven repository that contains maven artifacts of arveo</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The plugin repository that contains maven plugins used when building the demo project</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_external">External</h4>
<div class="paragraph">
<p>When you are outside the company network and the VPN, you need to use the public Nexus repository that requires authentication. To do so, maven requires credentials. For security reasons, the credentials should be encrypted. Follow the instructions in the <a href="https://maven.apache.org/guides/mini/guide-encryption.html">Maven documentation</a> to configure a master password and to create an encrypted password.</p>
</div>
<div class="paragraph">
<p>You should now have created a settings-security.xml file in the <em>.m2</em> directory like the one shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;settingsSecurity&gt;</span>
  <span class="tag">&lt;master&gt;</span>{encryped-master-password}<span class="tag">&lt;/master&gt;</span>
<span class="tag">&lt;/settingsSecurity&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you have to adapt your maven settings.xml as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;settings</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/SETTINGS/1.0.0</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;pluginGroups&gt;</span>
  <span class="tag">&lt;/pluginGroups&gt;</span>
  <span class="tag">&lt;proxies&gt;</span>
  <span class="tag">&lt;/proxies&gt;</span>
  <span class="tag">&lt;servers&gt;</span>
    <span class="tag">&lt;server&gt;</span>
      <span class="tag">&lt;id&gt;</span>nexus<span class="tag">&lt;/id&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tag">&lt;username&gt;</span>username<span class="tag">&lt;/username&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tag">&lt;password&gt;</span>{your-encrypted-password}<span class="tag">&lt;/password&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tag">&lt;/server&gt;</span>
  <span class="tag">&lt;/servers&gt;</span>
  <span class="tag">&lt;mirrors&gt;</span>
  <span class="tag">&lt;/mirrors&gt;</span>
  <span class="tag">&lt;profiles&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
      <span class="tag">&lt;id&gt;</span>repos-default<span class="tag">&lt;/id&gt;</span>
      <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;activeByDefault&gt;</span>true<span class="tag">&lt;/activeByDefault&gt;</span>
      <span class="tag">&lt;/activation&gt;</span>
      <span class="tag">&lt;properties&gt;</span>
        <span class="tag">&lt;solr.repositoryUrl&gt;</span>https://nexus.eitco.de/repository/raw-public<span class="tag">&lt;/solr.repositoryUrl&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;repositories&gt;</span>
        <span class="tag">&lt;repository&gt;</span>
          <span class="tag">&lt;id&gt;</span>nexus<span class="tag">&lt;/id&gt;</span> <i class="conum" data-value="5"></i><b>(5)</b>
          <span class="tag">&lt;url&gt;</span>https://nexus.eitco.de/repository/maven-private/<span class="tag">&lt;/url&gt;</span>
          <span class="tag">&lt;releases&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/releases&gt;</span>
          <span class="tag">&lt;snapshots&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/snapshots&gt;</span>
        <span class="tag">&lt;/repository&gt;</span>
      <span class="tag">&lt;/repositories&gt;</span>
      <span class="tag">&lt;pluginRepositories&gt;</span>
        <span class="tag">&lt;pluginRepository&gt;</span>
          <span class="tag">&lt;id&gt;</span>nexus<span class="tag">&lt;/id&gt;</span>
          <span class="tag">&lt;url&gt;</span>https://nexus.eitco.de/repository/maven-private/<span class="tag">&lt;/url&gt;</span>
          <span class="tag">&lt;releases&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/releases&gt;</span>
          <span class="tag">&lt;snapshots&gt;</span>
            <span class="tag">&lt;updatePolicy&gt;</span>never<span class="tag">&lt;/updatePolicy&gt;</span>
          <span class="tag">&lt;/snapshots&gt;</span>
        <span class="tag">&lt;/pluginRepository&gt;</span>
      <span class="tag">&lt;/pluginRepositories&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
  <span class="tag">&lt;/profiles&gt;</span>
<span class="tag">&lt;/settings&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The server id is used to tie credentials to repositories</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The username you use to logon to nexus</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The password encrypted by maven using the master password</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Sets the repository to use for the SOLR plugin used in the system tests</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Tells maven to use the credentials for the server with id 'nexus'</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Make sure to use only https repositories when using credentials. Current maven versions already block the usage of
unencrypted repository connections.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_1_type_definitions">Step 1 - Type definitions</h3>
<div class="paragraph">
<p>In the first step you will define the data model of your application. In arveo, this is done by creating Java
(or Kotlin) interfaces which contain getters and setters for the fields that will be available on each individual entity
type. There is a <a href="https://maven.apache.org/guides/introduction/introduction-to-archetypes.html">maven archetype</a> to create
a project that will contain those type definition interfaces and integration tests to try out the created types.
More information about the archetype can be found <a href="#_archetype_overview">here</a>.</p>
</div>
<div class="paragraph">
<p>First, create a directory that will contain the project files for the demo application. Open a command line in this
directory and perform the following operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn archetype:generate -DarchetypeGroupId=de.eitco.ecr -DarchetypeArtifactId=ecr-types-archetype -DarchetypeVersion=&lt;arveo-version&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The archetype version is the arveo version that you are working with. The current version is 14.0.1.</p>
</div>
<div class="paragraph">
<p>Maven will start by downloading a couple of required artifacts. After that, the archetype plugin will be started in
interactive mode. It will query for several settings required for the generated project. Some of the settings have
default values that can be used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>class-name-prefix</strong>: A prefix that will be used for the generated classes. Use <em>Demo</em> for this guide.</p>
</li>
<li>
<p><strong>groupId</strong>: The group-id of the artifact that will contain the types. Use <em>de.eitco.demo</em>.</p>
</li>
<li>
<p><strong>artifactId</strong>: The artifact-id of the artifact that will contain the type. Use <em>demo-types</em>.</p>
</li>
<li>
<p><strong>version</strong>: The version of the artifact. You can use the default value.</p>
</li>
<li>
<p><strong>package</strong>: The package that will contain the types. You can use the default value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the last step, the archetype plugin shows the selected property values and asks for confirmation. After the settings are confirmed, the project will be generated in a folder called <em>demo-types</em>.</p>
</div>
<div class="paragraph">
<p>The <a href="#_archetype_overview">archetype documentation</a> contains a description of the generated project. For this guide,
the files in <em>implementation/types</em> are the most important ones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>DemoModel.java:</strong> This file contains the type definition interface. The generated example is a simple document type
with a name, a number and some system properties. The annotations used to define the type are documented
<a href="#type_annotations">here</a>.</p>
</li>
<li>
<p><strong>DemoTypeRegistration.java:</strong> A spring component that automatically registers your type(s) in the arveo service.
Only types that have been registered can be used in your application.</p>
</li>
<li>
<p><strong>spring.factories:</strong> This file tells spring to autoconfigure the DemoRegistration component.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The archetype has generated integration tests for the generated type definition, too. You can find them in the directory <em>test/system-test</em>. The file <em>DemoClientIT.java</em> contains some tests that show how to perform basic CRUD operations on the generated document type.</p>
</div>
<div class="paragraph">
<p>You will notice an additional class called <em>DemoModelId</em>. This class demonstrates how to create a typed ID for a specific model class. It is not required for the system to be able to use the <em>DemoModel</em> type. If you do not require typed IDs, you can remove the class.</p>
</div>
<div class="sect3">
<h4 id="_running_the_tests">Running the tests</h4>
<div class="paragraph">
<p>The tests are run automatically in a full maven build. The system-test module is configured to automatically start a complete arveo system including all required services and a database. If you want to run the tests manually from the IDE, you can still use maven to start the <em>arveo</em> system.Open a command line in the system-test directory and run <code>mvn -Denv</code>. Maven will start the following processes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A PostreSQL database server</p>
</li>
<li>
<p>An ActiveMQ message broker</p>
</li>
<li>
<p>A SOLR server</p>
</li>
<li>
<p>The Service Registry</p>
</li>
<li>
<p>The Configuration Service</p>
</li>
<li>
<p>The User management Service</p>
</li>
<li>
<p>The Audit Service</p>
</li>
<li>
<p>The Access Control Service</p>
</li>
<li>
<p>The <em>arveo</em> Service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The services will be kept alive until you press <em>enter</em> in the command line.</p>
</div>
<div class="paragraph">
<p>This will only work if a complete build has been performed at least once (which can be done through <code>mvn install</code>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The system set up by maven in the system test module is already configured to contain the type definitions that were
defined in this project. To use those definitions in another system, you have to add the jar containing the definitions
to the classpath of the arveo service instances. This can be done by copying the ja to a lib directory and
adding the following command line option when starting the arveo service instances:
<code>-Dloader.path=path/to/libs</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adapt_the_model">Adapt the model</h4>
<div class="paragraph">
<p>Now you can adapt the generated type definition so that it fits the requirements for our project scenario. In this
scenario, documents are organized in a two-level folder structure. For example, the project could contain a folder
called "invoices" which again contains two folders named "inbound" and "outbound". Each document is contained in
exactly one folder and belongs to exactly one project. The document type will contain the following meta data fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>projectName</strong>: The name of the project the documents belongs to</p>
</li>
<li>
<p><strong>type</strong>: The type of document, e.g. whether it is an invoice, a contract or something else</p>
</li>
<li>
<p><strong>structureLevel1</strong>: This field is used to represent the first level of the folder structure</p>
</li>
<li>
<p><strong>structureLevel2</strong>: This field is used to represent the second level of the folder structure</p>
</li>
<li>
<p><strong>status</strong>: Represents the current status of the document</p>
</li>
<li>
<p><strong>customerName</strong>: The name of the customer associated to the project</p>
</li>
<li>
<p><strong>contactPerson</strong>: The contact person for the document</p>
</li>
<li>
<p><strong>assignedTo</strong>: The employee currently assigned to work on the document</p>
</li>
<li>
<p><strong>fileSystemCreationDate</strong>: The timestamp at which the file was created in the file system (not the time it was
imported to arveo - see system fields)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to these custom fields, the document will contain some system fields like content metadata (filename, size, mimetype&#8230;&#8203;) and versioning information like creation- and update-timestamps. The two metadata fields name and number that are already contained in DemoModel.java can be removed.</p>
</div>
<div class="sect4">
<h5 id="_adding_getters_for_system_fields">Adding getters for system fields</h5>
<div class="paragraph">
<p>Complete listings for the steps below can be found at the end of this chapter.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first add some getters for system fields. Those will provide access to system information that is generated automatically when an entity is created or updated. The generated DemoModel class already contains getters for the ID- and ACL- system properties. Add the following lines to DemoModel.java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SystemProperty</span>(SystemPropertyName.CONTENT)
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentInformation&gt; getContentInformation();

<span class="annotation">@SystemProperty</span>(SystemPropertyName.VERSION_INFO)
VersionInformation getVersionInformation();

<span class="annotation">@SystemProperty</span>(SystemPropertyName.MODIFICATION_INFO)
ModificationInformation getModificationInformation();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JavaDoc for the SystemPropertyName enum constants contains information about each field. The data type for the <em>contentInformation</em> field is a map because each document can contain multiple content elements. For example, a document could contain a TIFF image and a PDF rendition of the TIFF.</p>
</div>
</div>
<div class="sect4">
<h5 id="_adding_getters_and_setters_for_custom_fields">Adding getters and setters for custom fields</h5>
<div class="paragraph">
<p>Now we can add the getters and setters for the custom metadata fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Mandatory</span>
<span class="predefined-type">String</span> getProjectName();
<span class="type">void</span> setProjectName(<span class="predefined-type">String</span> projectName);

<span class="annotation">@Mandatory</span>
<span class="predefined-type">String</span> getStructureLevel1();
<span class="type">void</span> setStructureLevel1(<span class="predefined-type">String</span> structureLevel1);

<span class="annotation">@Optional</span>
<span class="predefined-type">String</span> getStructureLevel2();
<span class="type">void</span> setStructureLevel2(<span class="predefined-type">String</span> structureLevel2);

<span class="annotation">@Optional</span>
<span class="predefined-type">String</span> getCustomerName();
<span class="type">void</span> setCustomerName(<span class="predefined-type">String</span> customerName);

<span class="annotation">@Optional</span>
<span class="predefined-type">String</span> getContactPerson();
<span class="type">void</span> setContactPerson(<span class="predefined-type">String</span> contactPerson);

<span class="annotation">@Mandatory</span>
ZonedDateTime getFileSystemCreationDate();
<span class="type">void</span> setFileSystemCreationDate(ZonedDateTime fileSystemCreationDate);

<span class="annotation">@Optional</span>
<span class="predefined-type">Long</span> getAssignedTo();
<span class="type">void</span> setAssignedTo(<span class="predefined-type">Long</span> assignedTo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotations <code>@Mandatory</code> and <code>@Optional</code> can be used to control which fields have to be set by the client and which can be left empty.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The annotations for the arveo type definitions always have to be added to the getters. You can find an overview of the supported data types <a href="#">here</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the <em>type</em> field we want to limit the possible values that can be set. This can be done by defining an enumeration. Create the following enumeration type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">de.eitco.demo.types</span>;

<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.Enumeration</span>;

<span class="annotation">@Enumeration</span>
<span class="directive">public</span> <span class="type">enum</span> DemoModelType {
    INVOICE,
    CONTRACT,
    OTHER
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This enum class will be mapped to an enumeration type on the database. It needs to be registered in the type registration just like the DemoModel type. Adapt the class DemoTypeRegistration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Register</span>(DemoModel.class)
<span class="annotation">@Register</span>(DemoModelType.class)
<span class="annotation">@Register</span>(DemoModelStatus.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoTypeRegistration</span> <span class="directive">implements</span> TypeDefinitionRegistration {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will do the same for the status field. Add and register the following enum class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Enumeration</span>
<span class="directive">public</span> <span class="type">enum</span> DemoModelStatus {
    IN_PROGRESS,
    DONE
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to register it in the DemoTypeRegistration class.</p>
</div>
<div class="paragraph">
<p>Now you can add the getters and setters for the two fields in the DemoModel class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Mandatory</span>
DemoModelType getType();
<span class="type">void</span> setType(DemoModelType type);

<span class="annotation">@Optional</span>
DemoModelStatus getStatus();
<span class="type">void</span> setStatus(DemoModelStatus status);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your DemoModel class should now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">de.eitco.demo.types</span>;

<span class="keyword">import</span> <span class="include">de.eitco.commons.asdl.annotation.AsdlIgnore</span>;
<span class="keyword">import</span> <span class="include">de.eitco.commons.asdl.annotation.Model</span>;
<span class="keyword">import</span> <span class="include">de.eitco.commons.user.management.common.model.ModificationInformation</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.common.ContentInformation</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.common.VersionInformation</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.common.document.DocumentId</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.ObjectType</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.Type</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.constraint.Mandatory</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.constraint.Optional</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.system.SystemProperty</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.system.SystemPropertyName</span>;

<span class="keyword">import</span> <span class="include">java.time.ZonedDateTime</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="annotation">@Model</span>
<span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DemoModel</span> {

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ID)
    DocumentId getDocumentId();

    <span class="annotation">@AsdlIgnore</span>
    <span class="keyword">default</span> DemoModelId id() {

        <span class="keyword">return</span> DemoModelId.of(getDocumentId());
    }

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ACL_ID)
    <span class="predefined-type">Long</span> getAclId();
    <span class="type">void</span> setAclId(<span class="predefined-type">Long</span> aclId);

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.CONTENT)
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentInformation&gt; getContentInformation();

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.VERSION_INFO)
    VersionInformation getVersionInformation();

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.MODIFICATION_INFO)
    ModificationInformation getModificationInformation();

    <span class="annotation">@Mandatory</span>
    <span class="predefined-type">String</span> getProjectName();
    <span class="type">void</span> setProjectName(<span class="predefined-type">String</span> projectName);

    <span class="annotation">@Mandatory</span>
    <span class="predefined-type">String</span> getStructureLevel1();
    <span class="type">void</span> setStructureLevel1(<span class="predefined-type">String</span> structureLevel1);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">String</span> getStructureLevel2();
    <span class="type">void</span> setStructureLevel2(<span class="predefined-type">String</span> structureLevel2);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">String</span> getCustomerName();
    <span class="type">void</span> setCustomerName(<span class="predefined-type">String</span> customerName);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">String</span> getContactPerson();
    <span class="type">void</span> setContactPerson(<span class="predefined-type">String</span> contactPerson);

    <span class="annotation">@Mandatory</span>
    ZonedDateTime getFileSystemCreationDate();
    <span class="type">void</span> setFileSystemCreationDate(ZonedDateTime fileSystemCreationDate);

    <span class="annotation">@Mandatory</span>
    DemoModelType getType();
    <span class="type">void</span> setType(DemoModelType type);

    <span class="annotation">@Optional</span>
    DemoModelStatus getStatus();
    <span class="type">void</span> setStatus(DemoModelStatus status);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">Long</span> getAssignedTo();
    <span class="type">void</span> setAssignedTo(<span class="predefined-type">Long</span> assignedTo);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before you can build and use the adapted type, you have to adapt the generated integration tests.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_command_line_tool">Step 2 - Command line tool</h3>
<div class="paragraph">
<p>In the second step you will implement a simple command line application that uses the model defined in step 1. We will use the Spring Initializer to generate a maven project with the required dependencies for a Spring command line application.</p>
</div>
<div class="sect3">
<h4 id="_generating_the_project">Generating the project</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to <a href="https://start.spring.io/" class="bare">https://start.spring.io/</a></p>
</li>
<li>
<p>Under "Project", select "Maven Project"</p>
</li>
<li>
<p>Under "Language", select "Java"</p>
</li>
<li>
<p>Select Spring Boot version 3.1.2. If your required version is not available, select the most compatible one in terms of major.minor.patch.</p>
</li>
<li>
<p>Define project metadata. For example, use Group = de.eitco.demo, Artifact = demo-tool, Name = demo-tool, Package name = de.eitco.demo.tool</p>
</li>
<li>
<p>Select "Jar" Packaging</p>
</li>
<li>
<p>Select Java version 11 or newer</p>
</li>
<li>
<p>Add a dependency to "Picocli"</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/spring-initializer.png" alt="spring initializer">
</div>
</div>
<div class="paragraph">
<p>Click Generate and download the zip file containing the generated project. Unzip the file to a directory of your choice and open the project in your IDE. Delete the 'test' directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adding_arveo_dependencies">Adding arveo dependencies</h4>
<div class="paragraph">
<p>Open the generated pom.xml file and add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>de.eitco.ecr<span class="tag">&lt;/groupId&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;artifactId&gt;</span>ecr-sdk-http<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>14.0.1<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;exclusions&gt;</span>
        <span class="tag">&lt;exclusion&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tag">&lt;groupId&gt;</span>de.eitco.commons<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>cmn-spring-security5-oauth2-client<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;/exclusion&gt;</span>
    <span class="tag">&lt;/exclusions&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tag">&lt;groupId&gt;</span>de.eitco.commons<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>cmn-spring-security5-oauth2-client-non-web<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>4.0.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>de.eitco.demo<span class="tag">&lt;/groupId&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tag">&lt;artifactId&gt;</span>demo-types-types<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This dependency contains a spring boot starter for the arveo SDK</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We have to exclude the OAuth2 client for web applications because the tool will be a console application</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This dependency contains the OAuth2 client for non-web applications</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The data model that was defined in step 1</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You have to set the version of arveo that was used in the project containing the data model.</p>
</div>
<div class="paragraph">
<p>Additionally, you have to define a dependency management for the EITCO Commons Spring Security library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>de.eitco.commons<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>cmn-commons-spring-security<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>8.0.0<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_the_tool">Implementing the tool</h4>
<div class="paragraph">
<p>The tool will use the picocli library to make it easy to write a command line application with features like usage help and simple parameter binding. You can read more about picocli <a href="https://picocli.info">here</a>.</p>
</div>
<div class="paragraph">
<p>Go to the de.eitco.demo.tool package and create a new class called "ArveoCommand". This will contain the business logic behind the commands available in the command line application. In picocli, those commands need to implement <em>Runnable</em>, so we have to implement this interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@CommandLine</span>.Command( <i class="conum" data-value="2"></i><b>(2)</b>
    mixinStandardHelpOptions = <span class="predefined-constant">true</span>,
    version = <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0-SNAPSHOT</span><span class="delimiter">&quot;</span></span>,
    description = <span class="string"><span class="delimiter">&quot;</span><span class="content">arveo demo tool</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ArveoCommand</span> <span class="directive">implements</span> <span class="predefined-type">Runnable</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> LOGGER = <span class="predefined-type">Logger</span>.getLogger(ArveoCommand.class); <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> run() {

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Defines ArveoCommand as an injectable spring component</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Activate picocli features like usage help</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We will use the de.eitco.commons.lang.Logger to log exception messages</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To be able to access arveo, the command line tool will have to authenticate to
the arveo service. We will use a simple username/password authentication, so the user must be able to enter credentials. With picocli, we can implement this with some annotated fields in <em>ArveoCommand</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-u</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--username</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>, interactive = <span class="predefined-constant">true</span>,
    description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The username used to log on to arveo</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> username;

<span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-p</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--password</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>, interactive = <span class="predefined-constant">true</span>,
    description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The password used to log on to arveo</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> password;

<span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-t</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--tenant</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>,
    description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The tenant used to log on to arveo</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> tenant;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the interactive=true option, the user will be prompted to enter username and password when the program is running.</p>
</div>
<div class="paragraph">
<p>The ArveoCommand class will need to know the directory to import from and (optionally) a customer name. To be able to access the arveo API, we have to get an instance of the <em>TypeDefinitionServiceClient</em>. This can be done using dependency injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-d</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--directory</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>,
    description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The base directory to import from</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">File</span> baseDirectory;

<span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-c</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--customer</span><span class="delimiter">&quot;</span></span>}, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The name of the customer</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> customer;

<span class="annotation">@Autowired</span>
<span class="directive">private</span> TypeDefinitionServiceClient typeDefinitionServiceClient;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to implement the import. Add the following methods to the <em>ArveoCommand</em> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> importProject(<span class="predefined-type">File</span> root) {

    <span class="predefined-type">String</span> projectName = root.getName();

    <span class="predefined-type">Arrays</span>.stream(root.listFiles()).forEach(file -&gt; {

        <span class="keyword">if</span> (file.isFile()) {
            LOGGER.warn(() -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Ignored file </span><span class="delimiter">&quot;</span></span> + file);
        } <span class="keyword">else</span> {
            importLevel1(projectName, file);
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The importProject method will be used to import a project located in the provided root directory. The scenario does not support files located directly in the root of the project, so we will log a warning when we encounter such a file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> importLevel1(<span class="predefined-type">String</span> projectName, <span class="predefined-type">File</span> level1) {

    <span class="predefined-type">String</span> level1Value = level1.getName();


    <span class="predefined-type">Arrays</span>.stream(level1.listFiles()).forEach(file -&gt; {

        <span class="keyword">if</span> (file.isDirectory()) {
            importLevel2(projectName, level1Value, file);
        } <span class="keyword">else</span> {
            importFile(projectName, level1Value, <span class="predefined-constant">null</span>, file);
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The importLevel1 method will collect all files and directories located in the first level of the project structure. Files will be imported directly, directories will be passed to the next importer method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> importLevel2(<span class="predefined-type">String</span> projectName, <span class="predefined-type">String</span> level1Value, <span class="predefined-type">File</span> level2) {

    <span class="predefined-type">String</span> level2Value = level2.getName();

    <span class="predefined-type">Arrays</span>.stream(level2.listFiles()).forEach(file -&gt; {

        <span class="keyword">if</span> (file.isDirectory()) {
            LOGGER.warn(() -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Ignoring directory </span><span class="delimiter">&quot;</span></span> + file);
        } <span class="keyword">else</span> {
            importFile(projectName, level1Value, level2Value, file);
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method collects all files located in the second level of the project structure. We do not support deeper structures, so we log a warning when we encounter a directory below level 2.</p>
</div>
<div class="paragraph">
<p>The method used to actually import data into arveo is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> importFile(<span class="predefined-type">String</span> projectName, <span class="predefined-type">String</span> level1, <span class="predefined-type">String</span> level2, <span class="predefined-type">File</span> file) {

    AuthenticationHelper.runAsUser(username, password, tenant, () -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

        TypedDocumentServiceClient&lt;DemoModel&gt; serviceClient = <i class="conum" data-value="2"></i><b>(2)</b>
            typeDefinitionServiceClient.getDocumentServiceClient().byClass(DemoModel.class);

        DemoModel model = serviceClient.createTypeInstance(); <i class="conum" data-value="3"></i><b>(3)</b>

        model.setProjectName(projectName);
        model.setStructureLevel1(level1);
        model.setStructureLevel2(level2);
        model.setCustomerName(customer);

        model.setFileSystemCreationDate(ZonedDateTime.ofInstant(
            Instant.ofEpochMilli(file.lastModified()),
            ZoneId.systemDefault())
        );

        DemoModelType type = DemoModelType.OTHER; <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="predefined-type">String</span> fileName = file.getName();

        <span class="keyword">if</span> (fileName.startsWith(DemoModelType.CONTRACT.name())) {
            type = DemoModelType.CONTRACT;
        } <span class="keyword">else</span> <span class="keyword">if</span> (fileName.startsWith(DemoModelType.INVOICE.name())) {
            type = DemoModelType.INVOICE;
        }

        model.setType(type);

        <span class="keyword">try</span> (<span class="predefined-type">InputStream</span> stream = Files.newInputStream(file.toPath())) {

            ContentUpload contentUpload = <span class="keyword">new</span> ContentUpload(fileName, stream);
            <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentUpload&gt; contentElements = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, contentUpload); <i class="conum" data-value="5"></i><b>(5)</b>


            serviceClient.create(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(contentElements, model)); <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Imported file </span><span class="delimiter">&quot;</span></span> + fileName + <span class="string"><span class="delimiter">&quot;</span><span class="content"> belonging to project </span><span class="delimiter">&quot;</span></span> + projectName);

        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            LOGGER.exception(e);
        }
    });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>AuthenticationHelper</code> takes care of populating spring&#8217;s security context with the required credentials. The OAuth2 client will use the provided username and password to retrieve an access token from the authentication service to authenticate the requests to the arveo service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use the injected TypeDefinitionServiceClient to get a service client for the type definition of our model class.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The service client can provide an instance of the interface defining the model. This instance is then populated
with the metadata.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We will use a simple file name prefix to determine the type of the document.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here we define the content elements of the new document</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Finally we send the create request to the arveo service</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can now implement the run() method of the ArveoCommand class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> run() {

    <span class="keyword">if</span> (!baseDirectory.isDirectory()) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Base directory option must point to a directory.</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="predefined-type">Arrays</span>.stream(baseDirectory.listFiles(<span class="predefined-type">File</span>::isDirectory)).forEach(<span class="local-variable">this</span>::importProject); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use a filter to ignore files in the base directory as they obviously do not belong to any project</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we have to adapt the application class that was generated by the spring initializer. Spring provides a <em>CommandLineRunner</em> interface for command line applications. Adapt the <em>DemoToolApplication</em> class as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBootApplication</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoToolApplication</span> <span class="directive">implements</span> CommandLineRunner {

        <span class="annotation">@Autowired</span>
        <span class="directive">private</span> ArveoCommand arveoCommand;

        <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
                <span class="keyword">new</span> SpringApplicationBuilder(DemoToolApplication.class)
                        .web(WebApplicationType.NONE) <i class="conum" data-value="1"></i><b>(1)</b>
                        .run(args);
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> run(<span class="predefined-type">String</span>... args) <span class="directive">throws</span> <span class="exception">Exception</span> {

                <span class="keyword">new</span> CommandLine(arveoCommand).execute(args); <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Turns off spring boot web features that are not required in a command line application</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize the picocli command line and execute our command with the options from the command line</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the last step, we have to set some configuration properties for our command line tool. Rename the generated <em>application.properties</em> file in src/main/resource to <em>application.yaml</em> and add the following settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">spring</span>:
  <span class="key">security</span>:
    <span class="key">oauth2</span>:
      <span class="key">client</span>:
        <span class="key">registration</span>:
          <span class="key">cmn-user-service-client</span>: <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="key">provider</span>: <span class="string"><span class="content">user-service</span></span>
            <span class="key">client-id</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test-client</span><span class="delimiter">&quot;</span></span>
            <span class="key">client-secret</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">my-secret</span><span class="delimiter">&quot;</span></span>
            <span class="key">authorization-grant-type</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>
            <span class="key">scope</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">arveo</span><span class="delimiter">&quot;</span></span>
        <span class="key">provider</span>:
          <span class="key">user-service</span>: <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="key">authorization-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:39004/oauth/auth</span><span class="delimiter">&quot;</span></span>
            <span class="key">token-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:39004/oauth/token</span><span class="delimiter">&quot;</span></span>

<span class="key">eureka</span>:
  <span class="key">client</span>:
    <span class="key">registerWithEureka</span>: <span class="string"><span class="content">false </span></span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="key">logging</span>: <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="key">file</span>:
    <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">demo-tool.log</span><span class="delimiter">&quot;</span></span>
  <span class="key">level</span>:
    <span class="key">root</span>: <span class="string"><span class="content">ERROR</span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures an OAuth2 client that uses the resource owner password grant type. Client-id and secret are configured
in the test system provided by the system test module of the project created in step 1.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tells the OAuth2 client where to get a token from</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The command line tool should not register itself in the service registry</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Log only errors to a file</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_building_and_running_the_tool">Building and running the tool</h4>
<div class="paragraph">
<p>Now we can build and run the command line tool. You can either use the IDE or run <code>mvn clean install</code> in a command line for the project containing the demo tool. After the build has finished, you have to start the test system. Open a command line in the system-test module of the type definition project and execute the command <code>mvn -Denv</code> (see <a href="#_running_the_tests">Running the tests</a>). Now we can use another command line in the target directory of the command line tool project to run the tool. Running <code>java -jar .\demo-tool-0.0.1-SNAPSHOT.jar</code> prints out usage help for the tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; java -jar .\demo-tool-0.0.1-SNAPSHOT.jar

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.5.8)

Missing required options: '--username', '--password', '--directory=&lt;baseDirectory&gt;'
Usage: &lt;main class&gt; [-hV] -p -u [-c=&lt;customer&gt;] -d=&lt;baseDirectory&gt; [-t=&lt;tenant&gt;]
arveo demo tool
  -c, --customer=&lt;customer&gt;
                          The name of the customer
  -d, --directory=&lt;baseDirectory&gt;
                          The base directory to import from
  -h, --help              Show this help message and exit.
  -p, --password          The password used to log on to arveo
  -t, --tenant=&lt;tenant&gt;   The tenant used to log on to arveo
  -u, --username          The username used to log on to arveo
  -V, --version           Print version information and exit.</pre>
</div>
</div>
<div class="paragraph">
<p>The test system already contains a user that can be used for testing. The user&#8217;s credentials are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>username:</strong> ecr-user</p>
</li>
<li>
<p><strong>password:</strong> password</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example shows how to use the tool to import projects from a folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; java -jar .\demo-tool-0.0.1-SNAPSHOT.jar -p -u -t=integrationtest -c=Customer1 "-d=C:\test-data\"

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.5.8)

Enter value for --password (The password used to log on to arveo):
Enter value for --username (The username used to log on to arveo):
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by de.eitco.commons.reflection.MethodLookup to constructor java.lang.invoke.MethodHandles$Lookup(java.lang.Class,int)
WARNING: Please consider reporting this to the maintainers of de.eitco.commons.reflection.MethodLookup
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
Imported file INVOICE_invoice1.txt belonging to project TestProject1
Imported file INVOICE_invoice2.txt belonging to project TestProject1
Imported file customer meeting 1.txt belonging to project TestProject1
Imported file standup 1.txt belonging to project TestProject1
Imported file standup 2.txt belonging to project TestProject1
Imported file standup 3.txt belonging to project TestProject1
Imported file uncategorized meeting 1.txt belonging to project TestProject1</pre>
</div>
</div>
<div class="paragraph">
<p>The warning message can be ignored. The reflective access operation will be replaced in a future version.</p>
</div>
<div class="paragraph">
<p>Finally, here is a complete listing of the ArveoCommand class for copy&amp;paste:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">de.eitco.demo.tool</span>;

<span class="keyword">import</span> <span class="include">de.eitco.commons.lang.Logger</span>;
<span class="keyword">import</span> <span class="include">de.eitco.commons.spring.security.AuthenticationHelper</span>;
<span class="keyword">import</span> <span class="include">de.eitco.demo.types.DemoModel</span>;
<span class="keyword">import</span> <span class="include">de.eitco.demo.types.DemoModelType</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.common.ContentUpload</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.sdk.TypeDefinitionServiceClient</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.sdk.document.TypedDocumentInput</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.sdk.document.TypedDocumentServiceClient</span>;
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;
<span class="keyword">import</span> <span class="include">picocli.CommandLine</span>;

<span class="keyword">import</span> <span class="include">java.io.File</span>;
<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.io.InputStream</span>;
<span class="keyword">import</span> <span class="include">java.nio.file.Files</span>;
<span class="keyword">import</span> <span class="include">java.time.Instant</span>;
<span class="keyword">import</span> <span class="include">java.time.ZoneId</span>;
<span class="keyword">import</span> <span class="include">java.time.ZonedDateTime</span>;
<span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="annotation">@Component</span>
<span class="annotation">@CommandLine</span>.Command(
    mixinStandardHelpOptions = <span class="predefined-constant">true</span>,
    version = <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0-SNAPSHOT</span><span class="delimiter">&quot;</span></span>,
    description = <span class="string"><span class="delimiter">&quot;</span><span class="content">arveo demo tool</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ArveoCommand</span> <span class="directive">implements</span> <span class="predefined-type">Runnable</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> LOGGER = <span class="predefined-type">Logger</span>.getLogger(ArveoCommand.class);

    <span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-u</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--username</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>, interactive = <span class="predefined-constant">true</span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The username used to log on to arveo</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> username;

    <span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-p</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--password</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>, interactive = <span class="predefined-constant">true</span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The password used to log on to arveo</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> password;

    <span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-t</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--tenant</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The tenant used to log on to arveo</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> tenant;

    <span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-d</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--directory</span><span class="delimiter">&quot;</span></span>}, required = <span class="predefined-constant">true</span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The base directory to import from</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">File</span> baseDirectory;

    <span class="annotation">@CommandLine</span>.Option(names = {<span class="string"><span class="delimiter">&quot;</span><span class="content">-c</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--customer</span><span class="delimiter">&quot;</span></span>}, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The name of the customer</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> customer;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> TypeDefinitionServiceClient typeDefinitionServiceClient;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> run() {

        <span class="keyword">if</span> (!baseDirectory.isDirectory()) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Base directory option must point to a directory.</span><span class="delimiter">&quot;</span></span>);
        }

        <span class="predefined-type">Arrays</span>.stream(baseDirectory.listFiles(<span class="predefined-type">File</span>::isDirectory)).forEach(<span class="local-variable">this</span>::importProject);
    }

    <span class="directive">private</span> <span class="type">void</span> importProject(<span class="predefined-type">File</span> root) {

        <span class="predefined-type">String</span> projectName = root.getName();

        <span class="predefined-type">Arrays</span>.stream(root.listFiles()).forEach(file -&gt; {

            <span class="keyword">if</span> (file.isFile()) {
                LOGGER.warn(() -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Ignored file </span><span class="delimiter">&quot;</span></span> + file);
            } <span class="keyword">else</span> {
                importLevel1(projectName, file);
            }
        });
    }

    <span class="directive">private</span> <span class="type">void</span> importLevel1(<span class="predefined-type">String</span> projectName, <span class="predefined-type">File</span> level1) {

        <span class="predefined-type">String</span> level1Value = level1.getName();


        <span class="predefined-type">Arrays</span>.stream(level1.listFiles()).forEach(file -&gt; {

            <span class="keyword">if</span> (file.isDirectory()) {
                importLevel2(projectName, level1Value, file);
            } <span class="keyword">else</span> {
                importFile(projectName, level1Value, <span class="predefined-constant">null</span>, file);
            }
        });
    }

    <span class="directive">private</span> <span class="type">void</span> importLevel2(<span class="predefined-type">String</span> projectName, <span class="predefined-type">String</span> level1Value, <span class="predefined-type">File</span> level2) {

        <span class="predefined-type">String</span> level2Value = level2.getName();

        <span class="predefined-type">Arrays</span>.stream(level2.listFiles()).forEach(file -&gt; {

            <span class="keyword">if</span> (file.isDirectory()) {
                LOGGER.warn(() -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Ignoring directory </span><span class="delimiter">&quot;</span></span> + file);
            } <span class="keyword">else</span> {
                importFile(projectName, level1Value, level2Value, file);
            }
        });
    }

    <span class="directive">private</span> <span class="type">void</span> importFile(<span class="predefined-type">String</span> projectName, <span class="predefined-type">String</span> level1, <span class="predefined-type">String</span> level2, <span class="predefined-type">File</span> file) {

        AuthenticationHelper.runAsUser(username, password, tenant, () -&gt; {

            TypedDocumentServiceClient&lt;DemoModel&gt; serviceClient =
                typeDefinitionServiceClient.getDocumentServiceClient().byClass(DemoModel.class);

            DemoModel model = serviceClient.createTypeInstance();

            model.setProjectName(projectName);
            model.setStructureLevel1(level1);
            model.setStructureLevel2(level2);
            model.setCustomerName(customer);

            model.setFileSystemCreationDate(ZonedDateTime.ofInstant(
                Instant.ofEpochMilli(file.lastModified()),
                ZoneId.systemDefault())
            );

            DemoModelType type = DemoModelType.OTHER;

            <span class="predefined-type">String</span> fileName = file.getName();

            <span class="keyword">if</span> (fileName.startsWith(DemoModelType.CONTRACT.name())) {
                type = DemoModelType.CONTRACT;
            } <span class="keyword">else</span> <span class="keyword">if</span> (fileName.startsWith(DemoModelType.INVOICE.name())) {
                type = DemoModelType.INVOICE;
            }

            model.setType(type);

            <span class="keyword">try</span> (<span class="predefined-type">InputStream</span> stream = Files.newInputStream(file.toPath())) {

                ContentUpload contentUpload = <span class="keyword">new</span> ContentUpload(fileName, stream);
                <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentUpload&gt; contentElements = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, contentUpload);


                serviceClient.create(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(contentElements, model));
                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Imported file </span><span class="delimiter">&quot;</span></span> + fileName + <span class="string"><span class="delimiter">&quot;</span><span class="content"> belonging to project </span><span class="delimiter">&quot;</span></span> + projectName);

            } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                LOGGER.exception(e);
            }
        });
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_perform_a_task_with_arveo">Step 3 - Perform a task with arveo</h3>
<div class="paragraph">
<p>In the third step you will perform a specific task using arveo.</p>
</div>
<div class="sect3">
<h4 id="_creating_a_standardized_project_structure">Creating a standardized project structure</h4>
<div class="paragraph">
<p>Your project structure must have a certain structure to be successfully imported and/or archived in arveo.</p>
</div>
<div class="listingblock">
<div class="title">Required project structure</div>
<div class="content">
<pre>skinparam Legend {
	BackgroundColor transparent
	BorderColor transparent
}

legend
Projects
|_ Project 1
  |_ Element 1.1
  |_ Element 1.2
|_ Project 2
  |_ Element 2.1
end legend</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of implementing this structure:</p>
</div>
<div class="listingblock">
<div class="title">Examplary project structure</div>
<div class="content">
<pre>skinparam Legend {
	BackgroundColor transparent
	BorderColor transparent
}

legend
Projects
|_ Webclient
  |_ Orders
  |_ Invoices
|_ Server_maintenance
  |_ Invoices
  |_ Email_correspondence
end legend</pre>
</div>
</div>
<div class="paragraph">
<p>In the last step of the tutorial you executed the Maven command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; java -jar .\demo-tool-0.0.1-SNAPSHOT.jar -p -u -t=integrationtest -c=Customer1 "-d=C:\test-data\"</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can replace the last element with your actual project folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; java -jar .\demo-tool-0.0.1-SNAPSHOT.jar -p -u -t=integrationtest -c=MedicalInsuranceAG "-d=C:\Projects"</pre>
</div>
</div>
<div class="paragraph">
<p>After this command has been executed, you will see the report about imported files and folders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Enter value for --password (The password used to log on to arveo):
Enter value for --username (The username used to log on to arveo):
...
Imported file Orders - Received_invoices.png belonging to project Webclient
Imported file Incoming_invoice.png belonging to project Webclient
...</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_types_archetype">The Types archetype</h3>
<div id="_archetype_overview" class="paragraph">
<p>This archetype creates a rather small project. It consists of an arveo scenario and tests for that.</p>
</div>
<div class="paragraph">
<p>The maven coordinate of this archetype are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;groupId&gt;</span>de.eitco.ecr<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>ecr-types-archetype<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>{project-technical-version}<span class="tag">&lt;/version&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To create an arveo scenario project use the maven archetype plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn archetype:generate -DarchetypeGroupId=de.eitco.ecr -DarchetypeArtifactId=ecr-types-archetype -DarchetypeVersion={project-technical-version}</pre>
</div>
</div>
<div class="paragraph">
<p>Here, the variable {project-technical-version} must be replaced with the actual version, f.e. 5.0.1.</p>
</div>
<div class="paragraph">
<p>Also, you have to remember, that this will generate a project structure into a project folder. So before you type this command in your command line, make sure you have prepared a folder where your project structure is going to be and you have switched into this folder on your command line.</p>
</div>
<div class="paragraph">
<p>This will start a process that will ask for some parameters and then generate a maven project according to the parameters. The following parameters will be asked for:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maven groupId of the new project</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>artifactId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maven artifactId of the new project</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maven version of the new project</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>class-name-prefix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A prefix for the names of the generated classes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scm-locator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location in the eitco bitbucket server where the sources are (or will be). For a project located in <a href="https://git.eitco.de/scm/&lt;project&gt;/&lt;repository&gt;.git" class="bare">https://git.eitco.de/scm/&lt;project&gt;/&lt;repository&gt;.git</a>, this would be <code>&lt;project&gt;/&lt;repository&gt;.git</code>. This configures the maven release plugin. If this is omitted (or set to a wrong value) the project will work for now - however the release process will not work - unless it is fixed.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Some or all of these parameters can also be given on the commandline via <code>-D</code>. The process will not ask for parameters given by command line. So the command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn archetype:generate -DarchetypeGroupId=de.eitco.ecr -DarchetypeArtifactId=ecr-types-archetype -DarchetypeVersion={project-technical-version} -DgroupId=my.group.id -DartifactId=my-artifact-id -Dversion=0.0.1-SNAPSHOT -Dclass-name-prefix=My -Dscm-locator=prj/repo.git</pre>
</div>
</div>
<div class="paragraph">
<p>would not ask for any parameters and just create the project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_the_generated_project">Overview of the generated project</h3>
<div class="paragraph">
<p>The project generated by the archetype will consist of two modules:</p>
</div>
<div class="sect3">
<h4 id="_implementationtypes">implementation\types</h4>
<div class="paragraph">
<p>This module contains your arveo scenario. An example type will be created with the name &lt;class-name-prefix&gt;Model. You can define more types here, but you will need to register them in register in &lt;class-name-prefix&gt;TypeRegistration. The chapter <a href="#_objects_types_definitions"><strong>arveo type definitions</strong></a> describes how to define types.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testsystem_test">test\system-test</h4>
<div class="paragraph">
<p>This module contains tests for your scenario. These tests will be executed in the build. For that a complete arveo environment will be created, so you can add tests, that simply connect to arveo by the http client and can assume that your scenario is deployed.</p>
</div>
<div class="paragraph">
<p>This module can also be used to set up an arveo environment with your scenario on which you can then run tests manually. In the module run</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn -Denv</pre>
</div>
</div>
<div class="paragraph">
<p>to set up the environment. It will be torn down when you press &lt;enter&gt; in the console.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_full_featured_archetype">The full-featured archetype</h3>
<div class="paragraph">
<p>This archetype creates a more complex project. It is based on the eitco commons archetype It will contain a simple web service, with an automatically generated client layer, based on eitco commons.
The maven coordinate of this archetype are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;groupId&gt;</span>de.eitco.ecr<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>ecr-service-archetype<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>{project-technical-version}<span class="tag">&lt;/version&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To create an arveo based service project use the maven archetype plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn archetype:generate -DarchetypeGroupId=de.eitco.ecr -DarchetypeArtifactId=ecr-service-archetype -DarchetypeVersion={project-technical-version}</pre>
</div>
</div>
<div class="paragraph">
<p>This will start a process that will ask for some parameters and then generate a maven project according to the parameters. The following parameters will be asked for:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maven groupId of the new project</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>artifactId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maven artifactId of the new project</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maven version of the new project</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>class-name-prefix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A prefix for the names of the generated classes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scm-locator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location in the eitco bitbucket server where the sources are (or will be). For a project located in <a href="https://git.eitco.de/scm/&lt;project&gt;/&lt;repository&gt;.git" class="bare">https://git.eitco.de/scm/&lt;project&gt;/&lt;repository&gt;.git</a>, this would be <code>&lt;project&gt;/&lt;repository&gt;.git</code>. This configures the maven release plugin. If this is omitted (or set to a wrong value) the project will work for now - however the release process will not work - unless it is fixed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disable-optional-features</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">when set to false, it will create a little more complex project, including the audit service, the user-management enterprise service and jmeter samplers. If set to true (the default value) these features will be disabled but can be activated by uncommenting certain source locations.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Some or all of these parameters can also be given on the commandline via <code>-D</code>. The process will not ask for parameters given by command line. So the command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn archetype:generate -DarchetypeGroupId=de.eitco.ecr -DarchetypeArtifactId=ecr-service-archetype -DarchetypeVersion={project-technical-version} -DgroupId=my.group.id -DartifactId=my-artifact-id -Dversion=0.0.1-SNAPSHOT -Dclass-name-prefix=My -Dscm-locator=prj/repo.git -Ddisable-optional-features=false</pre>
</div>
</div>
<div class="paragraph">
<p>would not ask for any parameters and just create the project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_the_generated_project_2">Overview of the generated project</h3>
<div class="paragraph">
<p>The project generated by the archetype will consist of four modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>documentation</code></p>
</li>
<li>
<p><code>implementation</code></p>
</li>
<li>
<p><code>packaging</code></p>
</li>
<li>
<p><code>test</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_the_documentation_module">The documentation module</h4>
<div class="paragraph">
<p>This module holds a frame for an asciidoc based documentation of your project.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_implementation_module">The implementation module</h4>
<div class="paragraph">
<p>This module contains the actual source code. It is separated into five submodules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>common</code></p>
<div class="ulist">
<ul>
<li>
<p>This submodule contains classes that are available on the server side as well as the client side.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>generated</code></p>
<div class="ulist">
<ul>
<li>
<p>This submodule contains modules that are automatically generated.</p>
</li>
<li>
<p>Normally developers will not add code in these modules.</p>
<div class="ulist">
<ul>
<li>
<p>They are however relevant for building the project.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The following submodules exist</p>
<div class="ulist">
<ul>
<li>
<p>serialization</p>
<div class="ulist">
<ul>
<li>
<p>This submodule contains automatically generated serialization meta information.</p>
</li>
</ul>
</div>
</li>
<li>
<p>client</p>
<div class="ulist">
<ul>
<li>
<p>This submodule contains a few submodules itself, holding client side applications for:</p>
<div class="ulist">
<ul>
<li>
<p>a java spring based http client api,</p>
</li>
<li>
<p>a java spring based embedded client api,</p>
</li>
<li>
<p>a typescript http client api.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>jmeter-sampler</p>
<div class="ulist">
<ul>
<li>
<p>This submodule generated jmeter samplers of the services api, usable in load tests.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>server</code></p>
<div class="ulist">
<ul>
<li>
<p>This submodule contains the server side implementation.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>types</code></p>
<div class="ulist">
<ul>
<li>
<p>this submodule contains the arveo based model. The generated interface named &lt;class-name-prefix&gt;Model describes an  <a href="#_objects_types_definitions"><strong>arveo type definition</strong></a> as will every interface you register in &lt;class-name-prefix&gt;TypeRegistration. The jar compiled by this module will be available on the server side and client side. Additionally, it needs to be in the class path of your arveo instance. For the system tests (se below) this is already taken care of.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_the_packaging_module">The packaging module</h4>
<div class="paragraph">
<p>This module contains delivery artifacts to deliver the service to or with different runtimes. This includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a stand-alone jar</p>
</li>
<li>
<p>a java web archive (war)</p>
</li>
<li>
<p>a helm chart for deployment in a kubernetes cluster</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_the_test_module">The test module</h4>
<div class="paragraph">
<p>This module contains a system test module. When building this module maven will start a complete arveo system (containing all required services) with the newly generated service in the <code>pre-integration-test</code>-phase so that tests written here (like the generated example &lt;class-name-prefix&gt;ClientIT) may simply call the new service via the generated http-client (see above).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_working_on_the_generated_project">Working on the generated project</h3>
<div class="paragraph">
<p>Most implementation will be done in the implementation\server module since this contains the server side code. You api and model will be defined in the implementation\common and implementation\types modules. The later will only be used for classes that are part of your arveo model and need to be in the classpath of arveo.</p>
</div>
<div class="paragraph">
<p>When testing your code, the test\system-test module comes in handy. As mentioned above, it will start a complete arveo system so that your tests can simply use the generated http client api to test your functionality. However, you can use this to manually test and debug your service, too. In case you simply need to start up the environment, in the test\system-test directory call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn -Denv</pre>
</div>
</div>
<div class="paragraph">
<p>If you want to debug your service call</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn -Denv -Dservice.skip</pre>
</div>
</div>
<div class="paragraph">
<p>This will start the environment except for your service. You can then start your service in debug mode from your IDE.</p>
</div>
<div class="paragraph">
<p>In both cases you can now start tests manually or call the service api directly to test your code.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administration"><strong>Administration</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_configure_database_access">Configure Database access</h3>
<div class="paragraph">
<p><em>arveo</em> uses the default spring datasource configuration for the JDBC datasource. The datasource must be
configured as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">configuring the datasource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">spring</span>:
  <span class="key">datasource</span>:
    <span class="key">url</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:postgresql://localhost:5432/postgres?currentSchema=arveo&amp;ApplicationName=${spring.application.name}</span><span class="delimiter">&quot;</span></span>
    <span class="key">driver-class-name</span>: <span class="string"><span class="content">org.postgresql.Driver</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">username</span></span>
    <span class="key">password</span>: <span class="string"><span class="content">password</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Specifying the <code>ApplicationName</code> property is optional but can be helpful when analyzing database issues. The name of the
Spring application will then be visible in Postgres query analytics.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The username and password should not be stored in the configuration files. Instead, they should be stored in <a href="#">Vault</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Advanced configuration properties can be found in the
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.data">Spring boot documentation</a>.
To configure the connection pool, use the <code>spring.datasource.hikari</code> properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configure_storage_locations">Configure Storage Locations</h3>
<div class="sect3">
<h4 id="_content_and_type_definitions">Content and type definitions</h4>
<div class="paragraph">
<p>Only Documents can contain content elements. A Document in the repository can contain several content elements.
For example, a document could contain a content element with the original content (like a TIFF image or a Word document)
and a PDF rendition. Each content element has a <em>contentName</em> and some more properties like the media type.
The <em>contentName</em> is a label that uniquely identifies a single content element contained in a Document.
For example, a Document might contain two content elements that are identified by the contentNames 'content' and
'rendition'.</p>
</div>
<div class="paragraph">
<p>The contentNames are not only relevant for uniquely identifying a content element contained in a document, but serve
as reference for further customization of the repository. The repository does accept configuration options that are
directly related to contentNames and the Document type definitions define restrictions regarding the
allowed contentNames.</p>
</div>
<div class="paragraph">
<p>Type definitions define which contentNames can be contained in the entities stored in the
definition.</p>
</div>
<div class="paragraph">
<p>Each content element is stored in a storage profile, which defines the place where the actual content will
be stored. The <em>contentType</em>  parameter can be used to define what kind of content
a content element can contain. When the media type is set to <code>application/octet-stream</code>, any kind of content can be used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The name of a content element must start with a letter and can consist only of letters (upper- and lower-case),
numbers and the <code>&#95;</code> character. More formally, the name must match the regular expression <code>[a-zA-Z][a-zA-Z0-9_]*</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_types_of_content_elements">Types of content elements</h4>
<div class="paragraph">
<p>It is specified in the type definition, which content elements this type definition may have.</p>
</div>
<div class="paragraph">
<p>Usually, the content elements of the entities are stored in a JSON field in the database which contains the storage-ID
and additional metadata like size, media type and a hash. The actual content data is not stored in the JSON field.
If required, a content element can also be stored in a separate field of type text. The separate field will contain only the
storage-ID but no additional metadata. Additional metadata for content elements using separate fields have to be
handled by the client application, for example by storing them in a custom metadata attribute.</p>
</div>
<div class="paragraph">
<p>The following example is an object of type <em>Document</em>, for which two content elements are defined: "content" and
"LARGE_CONTENT". In this example, "separateField = true" means a separate column in the database, otherwise it is
written in the corresponding json field of the database. The name of a separate column in the database is derived
from the name of the content element.</p>
</div>
<div class="listingblock">
<div class="title">Example of a Document with two content elements</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, separateField = <span class="predefined-constant">true</span>)
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">LARGE_CONTENT</span><span class="delimiter">&quot;</span></span>, separateField = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">TwoContentsDocument</span> {

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ID)
    DocumentId getId();

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.CONTENT)
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentInformation&gt; getContentInformation();

    <span class="predefined-type">String</span> getName();

    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>contentType</code> attribute of the <code>@ContentElement</code> annotation one can define the required content type for a
content element. The content type <em>application/octet-stream</em> is used as a wildcard type for any type of content.
For example, if the value of the contentType attribute is set to <em>application/pdf</em>, only PDF files can be stored in the
content element.</p>
</div>
<div class="paragraph">
<p>It is possible to define the content type of a new content element when it is uploaded. The server will trust this
information, so the client is responsible to send the correct content type. If the client does not define the content
type, the server will automatically detect the content type of the uploaded binary data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_default_content_element">The default content element</h4>
<div class="paragraph">
<p>If a type definition of type DOCUMENT does not contain any <code>@ContentElement</code> annotations, the server will automatically
assign a content element with the name <code>content</code> to it. This content element&#8217;s metadata will be stored in the JSON
field of the type definition and it accepts any kind of content type.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_contentelement_annotation">The ContentElement annotation</h4>
<div class="paragraph">
<p>The following Table contains an Overview of the available attributes of the <code>@ContentElement</code> annotation.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Attributes of the ContentElement annotation</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the content element. This attribute is mandatory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the storage profile used to store the content element. This attribute is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">contentType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/octet-stream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of content supported by the content element.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">separateField</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to store only the content ID and no additional metadata in a separate database field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fulltextExtraction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, the fulltext content of the content element will be extracted and stored in the NOSQL database.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_storage_profiles">Storage profiles</h4>
<div class="paragraph">
<p>A StorageProfile defines on which storage the content elements are saved. Access to the storage backends (like
filesystem or S3) is handled by storage plugins.</p>
</div>
<div class="paragraph">
<p>A StoragePlugin is defined in the StorageProfile, which is used to access the connected storage.
The same plugin can be used in several StorageProfiles. Each StorageProfile can have a different set of parameters (access
data, URls, &#8230;&#8203;) for the plugin.</p>
</div>
<div class="listingblock">
<div class="title">StorageProfile definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">ecr</span>:
  <span class="key">server</span>:
    <span class="key">storage</span>:
      <span class="key">profiles</span>:
        <span class="key">fileSystemProfile</span>: <i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">defaultProfile</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="4"></i><b>(4)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">pluginSettings</span>: <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="key">storagePath</span>: <span class="string"><span class="content">/storage</span></span>
        <span class="key">s3Profile</span>: <i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">pluginSettings</span>: <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:49999</span><span class="delimiter">&quot;</span></span>
            <span class="key">region</span>: <span class="string"><span class="content">us-west-2</span></span>
            <span class="key">accessKey</span>: <span class="string"><span class="content">myaccesskey</span></span>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">mysecretaccesskey</span></span>
            <span class="key">bucket</span>: <span class="string"><span class="content">testbucket</span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>profile name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>class name of the plugin</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>plugin specific configuration data like the path for the filesystem plugin or the bucket for the S3 plugin</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>defines this profile as the default profile (see <a href="#_mapping_content_elements_to_storage_profiles">Mapping content elements to storage profiles</a>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each profile is identified by name and defines the storage plugin to use. Plugin-specific settings can be configured
in the <code>pluginSettings</code> map. So the plugin class name determines the storage technology and the plugin settings.</p>
</div>
<div class="paragraph">
<p>If a content element has been saved using the named StoragePlugin, the plugin defined in the profile will return a
contentID, with which the stored data can be retrieved later. This id, which is usually of type String, is saved with
the document. It is a task of the storage plugin to implement, which contents this id has. Usually it is a UUID, but
it may also be a text string.</p>
</div>
<div class="paragraph">
<p>A plugin is assigned to each profile based on the fully qualified class name. Any name-value pairs can be
specified for the configuration of the plug-in. The profiles are identified by their name.</p>
</div>
<div class="sect4">
<h5 id="_using_aliases_for_storage_profiles">Using aliases for storage profiles</h5>
<div class="paragraph">
<p>It is possible to assign aliases to storage profile names. This might be required when storage profiles are mapped
to content elements by configuration as described below. Assigning aliases can be done in the configuration by defining
<code>alias: profileName</code> entries as shown below:</p>
</div>
<div class="listingblock">
<div class="title">Storage profile aliases</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">ecr</span>:
  <span class="key">server</span>:
    <span class="key">storage</span>:
      <span class="key">profile-aliases</span>:
        <span class="key">alias1</span>: <span class="string"><span class="content">encryptedProfile</span></span>
        <span class="key">another_alias</span>: <span class="string"><span class="content">encryptedProfile</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to define more than one alias for a storage profile.
Aliases are resolved before a content element is saved. The resulting <code>ContentId</code> will contain the resolved profile, not
the alias name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The bucket selector plugin does not support aliases when selection rules are evaluated.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mapping_content_elements_to_storage_profiles">Mapping content elements to storage profiles</h4>
<div class="paragraph">
<p>There are two ways to map a specific content element to a storage profile.</p>
</div>
<div class="sect4">
<h5 id="_mapping_by_code">Mapping by code</h5>
<div class="paragraph">
<p>To define the mapping of the content elements to storage profiles in the application code, the storage profile name
can be set in the <code>@ContentElement</code> annotation using the <code>profile</code> attribute.</p>
</div>
<div class="listingblock">
<div class="title">Defining the storage profile of a content element in the code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, profile = <span class="string"><span class="delimiter">&quot;</span><span class="content">fileSystemProfile</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MyDocument</span> {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above shows a document type with a single named content element that will be stored in a storage profile
called <em>fileSystemProfile</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mapping_by_configuration">Mapping by configuration</h5>
<div class="paragraph">
<p>If the mapping should be controlled by the configuration and not be defined in the code, storage profiles with auto-
matchable names must be used. The matching is based on the name of the type definition (in snake-case) and the name
of the content element separated by <code>-</code>.</p>
</div>
<div class="paragraph">
<p>The following type definition is used as an example in the following explanations. It uses one content element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">rendition</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MyDocument</span> {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A matching profile for the content element named <em>rendition</em> of the interface MyDocument would be selected using the
following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check if there is a profile called <code>my_document-rendition</code>. If so, use it.</p>
</li>
<li>
<p>If not, check if there is a profile called <code>my_document</code>. If so, use it.</p>
</li>
<li>
<p>If not, check if there is a <em>default storage profile</em>. If so, use it.</p>
</li>
<li>
<p>If none of the steps above succeeded, an exception is thrown.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_examples">Examples</h4>
<div class="paragraph">
<p>The following example shows the simplest possible configuration. The type definition does not contain any content element.
It implicitly uses the default content element named <code>content</code>. The content element will be stored in a storage profile
called <em>my_document</em>, or, if no such profile exists, in the default storage profile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ContentType.DOCUMENT)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MyDocument</span> {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows the same type definition, but with an annotation that defines which storage profile to use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ContentType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name = ContentElement.CONTENT, profile=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileSystemProfile</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MyDocument</span> {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows a type definition that contains two content elements. The "rendition"
content element will support only PDF documents. The PDFs contained in the rendition content element will be stored
in an S3 storage. The content in the other element will either be stored in a profile called <em>my_document-content</em>, in
a profile called <em>my_document</em> or, if neither of those profiles exists, in the default profile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ContentType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@ContentElement</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">rendition</span><span class="delimiter">&quot;</span></span>, contentType=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/pdf</span><span class="delimiter">&quot;</span></span>, storageProfile=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3Profile</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MyDocument</span> {

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_plugin_configuration">Plugin configuration</h4>
<div class="paragraph">
<p>The service uses a plug-in interface for connection to the specific storage provider. The following plugins
are currently available:</p>
</div>
<div class="sect4">
<h5 id="_file_system">File system</h5>
<div class="paragraph">
<p>Class name: <em>de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</em>.</p>
</div>
<div class="paragraph">
<p>The FileSystemPlugin offers storage of the data as files in the file system.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Configuration parameters of the file system</caption>
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">parameter</th>
<th class="tableblock halign-left valign-top">meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">storagePath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the directory that is used to store the files</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_aws_netapp_or_emc_elastic_cloud_storage">AWS, NetAPP or EMC Elastic Cloud Storage</h5>
<div class="paragraph">
<p>Class name: <em>de.eitco.ecr.storage.plugin.s3.S3Plugin</em>.</p>
</div>
<div class="paragraph">
<p>The S3 plug-in stores data in an Amazon S3 compatible storage.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If <em>arveo</em> has no permissions to create buckets, then the administrator has to create the buckets manually.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Configuration parameter of the S3 plugin</caption>
<colgroup>
<col style="width: 20%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Meaning</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pathStyleAccessEnabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the client to use path-style access for all requests.
  Amazon S3 supports virtual-hosted-style and path-style access in all regions.
  The path-style syntax, however, requires that you use the region-specific endpoint when attempting to access a bucket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">serviceEndpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL to the S3 endpoint to be used by the plugin</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">region</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The region for access to AWS</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">accessKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS Access Key</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">secretAccessKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS Secret Access Key</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bucket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the S3 bucket to be created by the plugin. The name can only contain lowercase letters.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">signer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the name of the signature algorithm to use for signing requests made by this client. If not set,
the default configuration of the Amazon S3 SDK will be used.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">proxyhost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The optional proxy host used by the client when connecting to the S3 storage.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">proxyprotocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The protocol (HTTP or HTTPS) used to connect to the proxy.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">proxyport</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The port used by the client to connect to the proxy.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">streambuffersize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the send- and receive-buffers in bytes.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32768</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uploadpresignedurl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to true, the client will use pre-signed URL requests to communicate with the S3 storage.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">acceleratemode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the client to use S3 accelerate endpoint for all requests.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxconnection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of allowed open HTTP connections.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1 (no limit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxErrorRetries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of retries for failed requests.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1 (no retries)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">baseDelay</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The base delay in milliseconds for the retry policy.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1 (no delay)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxBackoffTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum backoff time in milliseconds for the retry policy.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1 (no maximum backoff time)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backoffStrategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The backoff strategy used by the retry policy.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retentionEnabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the use of S3 object locks for object retention.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retentionMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the protection level of retention object locks. Can be <code>COMPLIANCE</code> or <code>GOVERNANCE</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GOVERNANCE</code></p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="_configuring_the_retry_policy_of_the_s3_plugin">Configuring the retry policy of the S3 plugin</h6>
<div class="paragraph">
<p>The Amazon S3 SDK used to connect to a S3 compatible storage supports different ways to retry failed requests. By default,
a retry policy using jitter and 3 retries is used. To configure a custom retry policy, all three parameters <code>baseDelay</code>,
<code>maxBackoffTime</code> and <code>backoffStrategy</code> have to be configured. The <code>backoffStrategy</code> parameter must be set to one of the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FULL_JITTER</code></p>
</li>
<li>
<p><code>EQUAL_JITTER</code></p>
</li>
<li>
<p><code>EXPONENTIAL</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <a href="https://docs.aws.amazon.com/de_de/general/latest/gr/api-retries.html">Amazon documentation</a> contains an explanation
of the different strategies.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_retention">Retention</h5>
<div class="paragraph">
<p>The S3 plugin supports the usage of S3 object locks to set a retention time and litigation hold status on content
elements stored in the S3 compatible storage. To enable the feature, set the parameter <code>retentionEnabled</code> to true.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the retention support is enabled, the bucket used by the storage profile must be created manually.
The S3 Object Locks option must be enabled for the bucket.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The S3 plugin uses the governance retention mode by default, which means, that retention protected objects
can be deleted by or overwritten by any user of the AWS account with the required privileges. When the compliance
retention mode is used, no user (not even the root administrator of the S3 account) is able to delete or overwrite
retention protected objects. To configure this behavior, set the property <code>retentionMode</code> to <code>GOVERNANCE</code> or
<code>COMPLIANCE</code>. More information about object locks can be found in the
<a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock-overview.html">AWS documentation</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the <code>COMPLIANCE</code> retention mode is used, it is impossible to delete objects from the S3 storage account before
the end of the retention interval is reached.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_azure_blob_storage">Azure blob storage</h5>
<div class="paragraph">
<p>Class name: <code>de.eitco.ecr.storage.plugin.azureblob.AzureBlobStoragePlugin</code></p>
</div>
<div class="paragraph">
<p>The Azure blob storage plugin can be used to connect to a storage account in Microsoft Azure.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Configuration parameter of the azure blob storage plugin</caption>
<colgroup>
<col style="width: 20%;">
<col>
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Meaning</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectionString</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The connection string used to connect to the storage account. The access string can be obtained from the azure portal.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containerName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the container in the storage account that will contain the data of the storage profile.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeoutMillis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The timeout in milliseconds for requests to Azure.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retentionSupport</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables usage of the immutability policy feature of Azure.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">policyMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the protection level of the immutability policies. Can be <code>LOCKED</code> or <code>UNLOCKED</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UNLOCKED</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Additional parameters contained in the plugin configuration will be passed on to the <code>Configuration</code> used for the
Azure SDK.</p>
</div>
<div class="sect5">
<h6 id="_retention_2">Retention</h6>
<div class="paragraph">
<p>The Azure blob storage plugin supports the immutability policy feature of Azure blob storage. Using this feature
enables an additional security level for retention protected content elements. If a content element is retention
protected or in a litigation hold, it will not be possible to delete it using the Azure management interface or the
Azure SDK.</p>
</div>
<div class="paragraph">
<p>To enable the retention support, the parameter <code>retentionSupport</code> must be set to true.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the retention support is enabled, the container used by the storage profile must be created manually in Azure.
The setting <em>version-level immutability support</em> must be enabled when the container is created. To be able to
enable the version-level immutability support, the storage account must support versioning for blobs. More information
can be found in the <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/immutable-storage-overview">Azure documentation</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The plugin creates unlocked immutability policies by default. Unlocked policies can be altered by Azure users with the
required privileges. Locked immutability policies can neither be deleted nor can the expiry time be shortened.
Prolonging the expiry time (and by this, the retention period), is still possible. Note that even the administrator
of the storage account is not able to delete objects with a locked immutability policy. To configure the policy mode,
set the parameter <code>policyMode</code> to <code>LOCKED</code> or <code>UNLOCKED</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the <code>policyMode</code> is set to <code>LOCKED</code>, it is not possible to delete retention protected objects from the storage
account before the end of the retention interval is reached.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bucketorganizer">BucketOrganizer</h4>
<div class="paragraph">
<p>Class name: <em>de.eitco.ecr.server.storage.plugins.BucketOrganizerPlugin</em>.</p>
</div>
<div class="paragraph">
<p>The BucketOrganizer is not specific for a specific storage technology or storage interface but delegates storage requests
to other storage plugins.The selection of the target plugin depends on the retention information of the document that contains
the content element to be stored. The selection criteria that are used to select the target plugin can be configured in
terms of a list of bucket selection rules.</p>
</div>
<div class="paragraph">
<p>The relevant retention information of the document is defined by the values of the system fields <em>RETENTION_DATE</em> and
<em>LITIGATION_HOLD</em>.
This value pair is matched against the bucket selection rules.The matching process starts with the first rule
and continues to the next rule if the rule does not match the value pair.The matching process ends at the first rule that
matches the value pair.The storage profile named in this rule will be used to store the content. Each bucket
selection rule consists of three parts that are separated by the pipe (|) symbol.</p>
</div>
<div class="sect4">
<h5 id="_1_retention_date_match_expression">1.  retention date match expression</h5>
<div class="paragraph">
<p>The retention date match expression is usually a time interval that begins at some calendar day and extends to some
later calendar day. The notation for the interval is inspired by ISO 8601 and may read like this
<code>2021-01-01+01:00&#8212;&#8203;2022-01-01+01:00</code>. The general format is <code>begin_date&#8212;&#8203;end_date</code>, that is both dates are separated
by "--". A retention date matches the expression if <code>begin date &#8656; retention date &lt; end date</code>.
The begin and end dates are specified as <code>YYYY-MM-DD</code> followed by a time zone offset as <code>+hh:mm</code> or <code>-hh:mm</code>
It is possible to define open intervals by specifying one of the boundary dates as <code>UNBOUNDED</code>.
Retention dates may be NULL if the retention date has not (yet) been set on the document. A NULL retention date will
not match any interval specified in a match rule. For this reason the retention date match expression may be specified
to be <code>NULL</code> to match NULL retention dates.
A retention date match expression can also be specified to be <code>&#42;</code> if the rule should always match.</p>
</div>
</div>
<div class="sect4">
<h5 id="_2_litigation_hold_match_expression">2.  litigation hold match expression</h5>
<div class="paragraph">
<p>The litigation hold match expression can be one of these literals: <code>true</code>, <code>false</code>, <code>&#42;</code>.
While the literal <code>&#42;</code> will always match, the other literals will match the denoted value only.</p>
</div>
</div>
<div class="sect4">
<h5 id="_3_target_storage_profile_name">3.  target storage profile name</h5>
<div class="paragraph">
<p>The name of the target storage profile to be used if both expressions match the corresponding system field values</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_parameters">Configuration parameters</h5>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Configuration parameters of BucketOrganizer plugin</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bucketSelectionRules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of bucket selection rules</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">storage</span>:
  <span class="key">profiles</span>:
    <span class="key">bucketProfile</span>: <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.server.storage.plugins.BucketOrganizerPlugin </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">pluginSettings</span>:
        <span class="key">bucketSelectionRules</span>: <i class="conum" data-value="3"></i><b>(3)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">*|true|fsProfileLitigationHold</span><span class="delimiter">&quot;</span></span>  <i class="conum" data-value="4"></i><b>(4)</b> <i class="conum" data-value="5"></i><b>(5)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">NULL|false|fsProfileForever</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2021-01-01+01:00--2022-01-01+01:00|false|fsProfile2021</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2022-01-01+01:00--2023-01-01+01:00|false|fsProfile2022</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2023-01-01+01:00--2024-01-01+01:00|false|fsProfile2023</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2024-01-01+01:00--2025-01-01+01:00|false|fsProfile2024</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2025-01-01+01:00--2026-01-01+01:00|false|fsProfile2025</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2026-01-01+01:00--2027-01-01+01:00|false|fsProfile2026</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2027-01-01+01:00--2028-01-01+01:00|false|fsProfile2027</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2028-01-01+01:00--2029-01-01+01:00|false|fsProfile2028</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2029-01-01+01:00--2030-01-01+01:00|false|fsProfile2029</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">2030-01-01+01:00--2031-01-01+01:00|false|fsProfile2030</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
          - <span class="string"><span class="delimiter">&quot;</span><span class="content">*|*|fsProfileAnotherEra</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="key">fsProfileLitigationHold</span>: <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
      <span class="key">pluginSettings</span>:
        <span class="key">storagePath</span>: <span class="string"><span class="content">${project.build.directory}/storage/litigationHold</span></span>
    <span class="key">fsProfileForever</span>:
      <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
      <span class="key">pluginSettings</span>:
        <span class="key">storagePath</span>: <span class="string"><span class="content">${project.build.directory}/storage/forever</span></span>
    <span class="key">fsProfile2021</span>:
      <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
      <span class="key">pluginSettings</span>:
        <span class="key">storagePath</span>: <span class="string"><span class="content">${project.build.directory}/storage/2021</span></span>
 <span class="comment">#...</span>
    <span class="key">fsProfile2030</span>:
      <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
      <span class="key">pluginSettings</span>:
        <span class="key">storagePath</span>: <span class="string"><span class="content">${project.build.directory}/storage/2030</span></span>
    <span class="key">fsProfileAnotherEra</span>:
      <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
      <span class="key">pluginSettings</span>:
        <span class="key">storagePath</span>: <span class="string"><span class="content">${project.build.directory}/storage/anotherEra</span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>profile name;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>type of plugin, so its class name;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>rules list.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>a bucket selection rule, consisting of retention date match expression, litigation hold match expression and
target storage profile name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>the referenced profile name.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_storage_profile_templates">Storage profile templates</h5>
<div class="paragraph">
<p>To reduce the number of required entries in the list of bucket selection rules, storage profile templates can be used.
A storage profile template consists of a name template with placeholders, a specific time range and the regular
configuration parameters like the class name of the storage profile.The <code>&lt;year&gt;</code> placeholder can be used as a variable
for the current year.</p>
</div>
<div class="paragraph">
<p>Storage profile templates are configured in a separate section as shown below:</p>
</div>
<div class="listingblock">
<div class="title">Storage profile template configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">ecr</span>:
  <span class="key">server</span>:
    <span class="key">storage</span>:
      <span class="key">profiles</span>:
        <span class="key">bucketProfile</span>:
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.server.storage.plugins.BucketOrganizerPlugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">bucketSelectionRules</span>:
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">*|true|fsProfileLitigationHold</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">NULL|false|fsProfileForever</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;year&gt;-01-01+01:00|false|fsProfile&lt;year&gt;|2021--2030</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">profile-templates</span>:
        - <span class="string"><span class="content">nameTemplate: &quot;fsProfile&lt;year&gt;&quot; </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">genericTimeRange</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2021--2029</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">storagePath</span>: <span class="string"><span class="content">${storage.base.directory}/storage/&lt;year&gt; </span></span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A bucket selection rule using a profile template with the year placeholder for the years between 2021 and 2030.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A name template that will create profiles for the years 2021 to 2029.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Defines the time range used to create profiles based on the template</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The year placeholder can be used in the configuration properties of the plugin.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_writing_a_custom_storage_plugin">Writing a custom storage plugin</h4>
<div class="paragraph">
<p>As mentioned above, <em>arveo</em> uses a plugin interface for the connection to the storage backends. This section
describes how to write a new storage plugin.</p>
</div>
<div class="paragraph">
<p>All classes and interfaces required to implement a custom plugin are contained in the dependency</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>de.eitco.ecr<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>ecr-server<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>14.0.1<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A storage plugin must implement the interface <code>de.eitco.ecr.server.storage.StoragePlugin</code>. There are two abstract
implementations that can be extended to simplify the implementation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AbstractStoragePlugin</code>: Provides several methods that make it easier to get plugin configuration settings.</p>
</li>
<li>
<p><code>AbstractSimplifiedStoragePlugin</code>: The superclass of all plugins that do not need retention support</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the interface to implement, there are some guidelines to respect when writing a custom storage plugin:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The plugin must provide a default no argument constructor because it will be instantiated using reflection.</p>
</li>
<li>
<p>The plugin can use dependency injection, but because of the need for a default constructor, only field injection
using <code>@Autowired</code> is possible.</p>
</li>
<li>
<p>There will be one instance of the plugin for each storage profile configured to use the plugin, so the plugin must
be thread-safe.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_configuration_settings">Configuration settings</h5>
<div class="paragraph">
<p>The <code>StoragePlugin</code> interface contains a method called <code>configure</code>, which will be called once for each plugin instance.
It is used to process the generic parameter values that might be required to configure the plugin. For example, the
parameters might contain a path to a file system directory or credentials for a remote storage system. Because storage
plugins can be configured in <a href="#_storage_profile_templates">profile templates</a>, it might be necessary to replace
placeholders configured in the template. The class <code>AbstractStoragePlugin</code> already contains helper methods like
<code>getMandatoryProperty</code> that take care of these replacements. The <code>configure</code> method is expected to return the actual
configuration with all replacements that is used by this plugin instance. The returned configuration settings are used
by the health checks.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_the_custom_storage_plugin">Using the custom storage plugin</h5>
<div class="paragraph">
<p>To use the custom plugin, it is enough to add its classes to the classpath of the repository service. The plugin can then
be used for a storage profile by specifying it&#8217;s qualified class name in the <code>pluginClassName</code> parameter. To add the
plugin&#8217;s class to the classpath, use the <code>-Dloader.path=&lt;path&gt;</code> argument to start the service. The argument must point
to a directory containing the required jar files.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_renditions">Renditions</h3>
<div class="paragraph">
<p>Renditions of content elements, for example a PDF rendition of an image, can be created automatically. To create a
rendition, the <code>@Rendition</code> annotation can be used as shown in the following example.</p>
</div>
<div class="listingblock">
<div class="title">A document type definition with a rendition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">original</span><span class="delimiter">&quot;</span></span>, separateField = <span class="predefined-constant">true</span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Rendition</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">rendition</span><span class="delimiter">&quot;</span></span>, sourceElement = <span class="string"><span class="delimiter">&quot;</span><span class="content">original</span><span class="delimiter">&quot;</span></span>, contentType = MediaType.APPLICATION_PDF_VALUE, separateField = <span class="predefined-constant">true</span>) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@OverwriteAllowed</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DocumentWithRendition</span> {

    <span class="predefined-type">String</span> getName();
    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

    <span class="annotation">@ContentType</span>(contentElement = <span class="string"><span class="delimiter">&quot;</span><span class="content">original</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="predefined-type">String</span> getContentType();
    <span class="type">void</span> setContentType(<span class="predefined-type">String</span> contentType);

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.RENDITION_STATUS) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, RenditionStatusInformation&gt; getRenditionStatus();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The content element containing the original content</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The rendition content element to create automatically</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The content type of the original content</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A getter for the current status of the renditions of the document</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The above example shows a document type with one content element and one rendition. Both the original and the rendition
element are stored in separate fields. This is possible but not required for renditions. When the original content
is stored in a separate field, meta information like the content type is not stored in the database. As the content
type of the original content is required to create a rendition, it is recommended to define an attribute of type 'String'
that contains the original content&#8217;s type. The attribute must be annotated with <code>@ContentType</code> to bind its value to
the original content element and return a valid mime type string like "image/jpeg". If no such attribute is present,
the system will try to detect the content type automatically.</p>
</div>
<div class="paragraph">
<p>The current status of the renditions can be retrieved as shown in the example above. The returned map contains a
<code>RenditionStatusInformation</code> instance for each rendition content element of the document. The status information contains
a status value and the number of times the system tried to create the rendition, if available. The status of a rendition can
be one of the following values:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Rendition status values</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">parameter</th>
<th class="tableblock halign-left valign-top">meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AVAILABLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The rendition was created successfully (or was uploaded by a client) and is available.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PENDING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The rendition is not yet available but is expected to be available in the future.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAILED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creating the rendition has failed permanently.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EMPTY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The rendition is not available because the source content element does not exist.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RESET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creating the rendition has failed and the status was manually reset (see error handling).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>@Rendition</code> annotation accepts the following parameters:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Parameters of <code>@Rendition</code></caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">parameter</th>
<th class="tableblock halign-left valign-top">meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the rendition content element</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sourceElement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the content element to create a rendition of</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">contentType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the rendition to create (a mime type string like "application/pdf")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the profile used to store the rendition content element (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">separateField</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) whether to store the renditions&#8217;s meta data in a separate field or in the JSON content field</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Renditions are created asynchronously. When a document is created or updated, a message will be posted to a queue in
ActiveMQ. The messages are processed by event listeners in the repository service. Depending on the current load it
might take some time until the rendition is available.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The system will not try to create a rendition when the rendition content element is written by the client.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The actual rendering will be done by the Document Conversion Service. Which conversions are supported, depends on the
plugins available on the classpath of the service.</p>
</div>
<div class="sect3">
<h4 id="_error_handling">Error handling</h4>
<div class="paragraph">
<p>When the creation of a rendition fails, the system will re-try to create the rendition. The number of re-tries can
be configured, the default is three (see <a href="#_ecr_server_messaging">configuration properties</a>).
When all retries have failed, the rendition message will be added to a dead letter queue and the status field of the
rendition will be set to -1 (FAILED). For this to work, the message queue in ActiveMQ must be configured to
use an individual dead letter queue as described in <a href="https://activemq.apache.org/message-redelivery-and-dlq-handling.html">the ActiveMQ documentation</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;policyEntry</span> <span class="attribute-name">queue</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ecr-queue-create-renditions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;deadLetterStrategy&gt;</span>
        <span class="tag">&lt;individualDeadLetterStrategy</span> <span class="attribute-name">queuePrefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DLQ.</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">useQueueForQueueMessages</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/deadLetterStrategy&gt;</span>
<span class="tag">&lt;/policyEntry&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_reset_status_of_failed_renditions">Reset status of failed renditions</h5>
<div class="paragraph">
<p>The status of failed renditions can be set to RESET (-2) either by using the API method
<code>de.eitco.ecr.sdk.document.TypedDocumentServiceClient.resetFailedRenditionStatus</code> or simply by setting the value in the
database directly. A system job polls the database and will enqueue new rendition messages in ActiveMQ to re-try to
create the renditions. The interval in which the job polls the database can be configured using the parameter
<code>retry-renditions.cron-expression</code> (see <a href="#_ecr_server_messaging">configuration properties</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_dynamically_skipping_renditions">Dynamically skipping renditions</h5>
<div class="paragraph">
<p>There are cases where the decision, whether to create a rendition for a content element, can only be made at run-time. For cases like this a type can provide a method implementing that decision. This method is marked by the annotation <code>@RenditionCreationCondition</code>. Only one method of a type may have this annotation. The method</p>
</div>
<div class="ulist">
<ul>
<li>
<p>must have the return type <code>boolean</code>, <code>java.lang.Boolean</code> or <code>kotlin.Boolean</code></p>
<div class="ulist">
<ul>
<li>
<p>In case it is <code>java.lang.Boolean</code> it may not return null</p>
</li>
</ul>
</div>
</li>
<li>
<p>must not be abstract</p>
<div class="ulist">
<ul>
<li>
<p>should the defining class be an interface this means that it is either a static or a default-method</p>
<div class="ulist">
<ul>
<li>
<p>note that - should the type be defined in kotlin and the method not be static - this means it has to be compiled with <code>-Xjvm-default=all</code> or <code>-Xjvm-default=all-compatibility</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>can have up to two parameters of type <code>RenditionInfo</code></p>
<div class="ulist">
<ul>
<li>
<p>The first representing the source to render</p>
</li>
<li>
<p>And the second representing the target to render to</p>
</li>
<li>
<p>if only one parameter is given it is assumed to be the source</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If such a method exists, arveo evaluates it before posting rendition messages. If the method returns <code>false</code> the message is not posted. Such a method may be present on types that are not Documents, but will not have any effect. This might be helpful in scenarios where there are complex inheritance structures.</p>
</div>
<div class="sect5">
<h6 id="_example_1">Example 1</h6>
<div class="paragraph">
<p>Let&#8217;s assume a scenario where we have a document with a content element "content" that can have an arbitrary type. It is supposed to be a multi-page document, so in most cases it is a pdf-file. However, there are cases  where a document is created with the content element being an MS-word document and in some cases it is just a single page image. Even multi-page tiffs are possible and in some seldom cases the content is unclear and simply "application/octet-stream".</p>
</div>
<div class="paragraph">
<p>In this scenario there is a web viewer that is supposed to show the documents content. For the viewer, pdf files are no problem whatsoever. It is fully capable to view the images also, except multiple-page tiff files that pose a problem. It is unable to view ms-office files. And for "application/octet-stream" it can only provide a download link.</p>
</div>
<div class="paragraph">
<p>Thus is decided that the backend needs to create a pdf rendition for ms-office formats and tiff files. This could be implemented with the following class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Rendition</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">rendition</span><span class="delimiter">&quot;</span></span>, sourceElement = <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, contentType = MediaType.APPLICATION_PDF_VALUE) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DocumentWithDynamicRenditionDecision</span> {

    <span class="predefined-type">String</span> getName();
    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

    <span class="annotation">@RenditionCreationCondition</span>
    <span class="keyword">default</span> <span class="type">boolean</span> decideRendition( <i class="conum" data-value="3"></i><b>(3)</b>
        RenditionInfo source,
        RenditionInfo target <i class="conum" data-value="4"></i><b>(4)</b>
    ) {

        <span class="keyword">if</span> (source.getMediaType().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/msword</span><span class="delimiter">&quot;</span></span>)) { <i class="conum" data-value="5"></i><b>(5)</b>

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="keyword">if</span> (source.getMediaType().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/vnd.openxmlformats-officedocument.wordprocessingml.document</span><span class="delimiter">&quot;</span></span>)) {

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="keyword">if</span> (source.getMediaType().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">image/tiff</span><span class="delimiter">&quot;</span></span>)) {

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A content element with the name "content" is defined.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A pdf rendition of that element is defined with the name "rendition".</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A default method "decideRendition" is created and marked with <code>@RenditionCreationCondition</code>.
<div class="ulist">
<ul>
<li>
<p>Note that:</p>
<div class="ulist">
<ul>
<li>
<p>Its return type is <code>boolean</code>.</p>
</li>
<li>
<p>as a <code>default</code> method it is not abstract</p>
</li>
<li>
<p>it hast two parameters of the type <code>RenditionInfo</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Thus, it is applicable.</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Note that the second parameter is unused. It could be omitted.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The implementation of the method is pretty simple. It checks whether the mime-type of the source element is one that we want to create a rendition for - ms-word files (old and new) or tif. If so, it returns <code>true</code> indicating that the arveo should create a rendition for the element. Otherwise, it returns <code>false</code> so that no rendition is created.</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_example_2">Example 2</h6>
<div class="paragraph">
<p>Assume the application described in example 1. Assume further that at one point it becomes necessary to migrate some older documents to this application. An importer is written, however most of the imports fail. This is due to the fact that many of the documents are in an older msword format that the current render engine is incapable of transforming into pdf. So it is decided to not create a rendition for those elements and simply provide a download link in the applications' client.</p>
</div>
<div class="paragraph">
<p>This poses a problem in the <code>decideRendition()</code> method: Ms word documents that are created from the old source still should have created a rendition for. Thus, it is not possible to decide whether to render from the source type alone. A simple solution for this could be to add a new property <code>create_rendition</code> to the type. This nullable boolean could be set when created to imply whether to create a rendition for the content element or not. A value of <code>null</code> would activate the behaviour already implemented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Rendition</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">rendition</span><span class="delimiter">&quot;</span></span>, sourceElement = <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, contentType = MediaType.APPLICATION_PDF_VALUE)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DynamicRenditionExample2</span> {

    <span class="predefined-type">String</span> getName();
    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">Boolean</span> getCreateRendition();
    <span class="type">void</span> setCreateRendition(<span class="predefined-type">Boolean</span> value);

    <span class="annotation">@RenditionCreationCondition</span>
    <span class="keyword">default</span> <span class="type">boolean</span> decideRendition(
        RenditionInfo source <i class="conum" data-value="2"></i><b>(2)</b>
    ) {

        <span class="keyword">if</span> (getCreateRendition() != <span class="predefined-constant">null</span>) { <i class="conum" data-value="3"></i><b>(3)</b>

            <span class="keyword">return</span> getCreateRendition();
        }

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="keyword">if</span> (source.getMediaType().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/msword</span><span class="delimiter">&quot;</span></span>)) {

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="keyword">if</span> (source.getMediaType().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/vnd.openxmlformats-officedocument.wordprocessingml.document</span><span class="delimiter">&quot;</span></span>)) {

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="keyword">if</span> (source.getMediaType().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">image/tiff</span><span class="delimiter">&quot;</span></span>)) {

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The property <code>create_rendition</code> is defined. Note that with the type <code>java.lang.Boolean</code> it is nullable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Note that in this case the unused parameter is omitted. This is the only change in the method signature.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>At the start of the method, it is checked, whether the new property is set, simply by calling the getter. If so the value is returned.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Otherwise, the code from example 1 is executed.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_text_renditions">Text renditions</h4>
<div class="paragraph">
<p>The rendition feature can be used to store extracted fulltext data as content elements of a document. To achieve this,
simply add a rendition content element with the content type <code>text/plain</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The content types of the source content element that can be used for text-extraction depend on the available extraction
plugins of the Document Conversion Service.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To be able to use the extracted fulltext data for searches, use the fulltext extraction feature for the SOLR integration.
See <a href="#_fulltext_extraction">SOLR</a> for details. The service will automatically use available text renditions
when the document is transferred to SOLR. If no text rendition is available, the text extraction will be performed on the
fly.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_retention_container">Configure retention container</h3>
<div class="sect4">
<h5 id="_configure_storage_containers_for_yearly_retention_periods">Configure storage containers for yearly retention periods</h5>
<div class="paragraph">
<p>Once you have deployed your new data type with enabled retention, all your data is stored in your default storage profile
and has a default retention of <strong>10 years</strong>.
The following example will define separate buckets containing all your objects with a retention period within one year.
Configure the buckets in the <em>ecr-service.yaml</em> of your config service in the section arveo:storage:profiles:
You can configure a new storage profile with an unlimited number of data buckets for your content.</p>
</div>
<div class="paragraph">
<p>Mandatory properties of your new bucket profile:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pluginClassName:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">must always be "de.eitco.ecr.server.storage.plugins.BucketOrganizerPlugin"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pluginSettings:bucketSelectionRules:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array of rules containing filter (string)|litigationHold (boolean)|storageProfile (string)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filter (string): Must be * to match all objects or a valid zoned date time range like 2031-01-01+01:00&#8212;&#8203;2032-01-01+01:00, the bucket selection is based on the document type property RETENTION_DATE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">litigationHold (boolean) true= is a litigationHold bucket, false for all other regular retention buckets</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">storageProfile (string): a valid storage profile name (arveo:storage:profiles:).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Find more details about selection rules in  <a href="#_bucketorganizer">Retention Bucket Selection Rules</a></p>
</div>
<div class="paragraph">
<p>If the configuration is not correct you will find more information in the startup log and will most likely find a MissingConfigurationException</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Defining storage containers in <em>arveo</em>-service.yaml and your storage system is an ongoing task for your operating team.
<em>Eitco</em> will try to create the buckets or subdirectory on your storage system but can also use already existing ones.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ecr-service.yaml example snippet for content definitions and storages. Adapt your ecr-service.yaml and replace rules, profile names and cloud storage url, etc. with your values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre><span class="key">arveo</span>:
  <span class="key">server</span>:
    <span class="key">content</span>:
      <span class="key">default-definition</span>:
        <span class="key">mediaType</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/octet-stream</span><span class="delimiter">&quot;</span></span>
        <span class="key">storageProfile</span>: <span class="string"><span class="content">bucketProfile </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">definitions</span>:
        <span class="key">content</span>:
          <span class="key">mediaType</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/octet-stream</span><span class="delimiter">&quot;</span></span>
          <span class="key">storageProfile</span>: <span class="string"><span class="content">bucketProfile </span></span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="key">rendition</span>:
          <span class="key">mediaType</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/octet-stream</span><span class="delimiter">&quot;</span></span>
          <span class="key">storageProfile</span>: <span class="string"><span class="content">bucketProfile </span></span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="key">documentTypeA</span>: <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">mediaType</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/octet-stream</span><span class="delimiter">&quot;</span></span>
          <span class="key">storageProfile</span>: <span class="string"><span class="content">storageProfileDocumentTypeA</span></span>
        <span class="key">documentTypeB</span>: <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">mediaType</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/octet-stream</span><span class="delimiter">&quot;</span></span>
          <span class="key">storageProfile</span>: <span class="string"><span class="content">storageProfileDocumentTypeB</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assign your bucket storage profile to the content types with a retention period.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The example provides two more storage profiles for other document types (storageProfileDocumentTypeA, storageProfileDocumentTypeB). To write all content of a document type to a storage profile you must assign this content type to the document type.
The upload API will only accept content of this type for the document type.</td>
</tr>
</table>
</div>
<div id="_retention_container" class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td>
  <td class="code"><pre>    <span class="key">storage</span>:
      <span class="key">profiles</span>:
        <span class="key">bucketProfile</span>:
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.server.storage.plugins.BucketOrganizerPlugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">bucketSelectionRules</span>:
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">*|true|storageProfileRetentionLitigationHold</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">NULL|false|storageProfileRetentionNone</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2031-01-01+01:00--2032-01-01+01:00|false|storageProfileRetention2031</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2032-01-01+01:00--2033-01-01+01:00|false|storageProfileRetention2032</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2033-01-01+01:00--2034-01-01+01:00|false|storageProfileRetention2033</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2034-01-01+01:00--2035-01-01+01:00|false|storageProfileRetention2034</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2035-01-01+01:00--2036-01-01+01:00|false|storageProfileRetention2035</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2036-01-01+01:00--2037-01-01+01:00|false|storageProfileRetention2036</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2037-01-01+01:00--2038-01-01+01:00|false|storageProfileRetention2037</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2038-01-01+01:00--2039-01-01+01:00|false|storageProfileRetention2038</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2039-01-01+01:00--2030-01-01+01:00|false|storageProfileRetention2039</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2030-01-01+01:00--2031-01-01+01:00|false|storageProfileRetention2030</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">2031-01-01+01:00--2032-01-01+01:00|false|storageProfileRetention2041</span><span class="delimiter">&quot;</span></span>
              - <span class="string"><span class="delimiter">&quot;</span><span class="content">*|*|storageProfileRetention2042Plus</span><span class="delimiter">&quot;</span></span>
        <span class="key">storageProfileRetentionLitigationHold</span>: <i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;cloudstorage url&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="key">region</span>: <span class="string"><span class="content">eu</span></span>
            <span class="key">accessKey</span>: <span class="string"><span class="content">&lt;myaccesskey&gt;</span></span>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">&lt;mysecret&gt;</span></span>
            <span class="key">bucket</span>: <span class="string"><span class="content">LitigationHold</span></span>
        <span class="key">storageProfileRetentionNone</span>: <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;cloudstorage url&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="key">region</span>: <span class="string"><span class="content">eu</span></span>
            <span class="key">accessKey</span>: <span class="string"><span class="content">&lt;myaccesskey&gt;</span></span>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">&lt;mysecret&gt;</span></span>
            <span class="key">bucket</span>: <span class="string"><span class="content">NoRetention</span></span>
        <span class="key">storageProfileRetention2032Plus</span>: <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;cloudstorage url&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="key">region</span>: <span class="string"><span class="content">eu</span></span>
            <span class="key">accessKey</span>: <span class="string"><span class="content">&lt;myaccesskey&gt;</span></span>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">&lt;mysecret&gt;</span></span>
            <span class="key">bucket</span>: <span class="string"><span class="content">RetentionPeriod2032Plus</span></span>
        <span class="key">storageProfileRetention2031</span>: <i class="conum" data-value="4"></i><b>(4)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;cloudstorage url&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="key">region</span>: <span class="string"><span class="content">eu</span></span>
            <span class="key">accessKey</span>: <span class="string"><span class="content">&lt;myaccesskey&gt;</span></span>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">&lt;mysecret&gt;</span></span>
            <span class="key">bucket</span>: <span class="string"><span class="content">RetentionPeriod2031</span></span>
        <span class="key">storageProfileRetention2032</span>:
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;cloudstorage url&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="key">region</span>: <span class="string"><span class="content">eu</span></span>
            <span class="key">accessKey</span>: <span class="string"><span class="content">&lt;myaccesskey&gt;</span></span>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">&lt;mysecret&gt;</span></span>
            <span class="key">bucket</span>: <span class="string"><span class="content">RetentionPeriod2032</span><span class="content">
             ... </span></span><i class="conum" data-value="5"></i><b>(5)</b>
        <span class="key">storageProfileDocumentTypeA</span>: <i class="conum" data-value="6"></i><b>(6)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;cloudstorage url&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="key">region</span>: <span class="string"><span class="content">eu</span></span>
            <span class="key">accessKey</span>: <span class="string"><span class="content">&lt;myaccesskey&gt;</span></span>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">&lt;mysecret&gt;</span></span>
            <span class="key">bucket</span>: <span class="string"><span class="content">DocumentTypeA</span></span>
        <span class="key">storageProfileDocumentTypeB</span>: <i class="conum" data-value="6"></i><b>(6)</b>
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.s3.S3Plugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">pathStyleAccessEnabled</span>: <span class="string"><span class="content">true</span></span>
            <span class="key">serviceEndpoint</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;cloudstorage url&gt;</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="key">region</span>: <span class="string"><span class="content">eu </span></span><i class="conum" data-value="7"></i><b>(7)</b>
            <span class="key">accessKey</span>: <span class="string"><span class="content">&lt;myaccesskey&gt; </span></span><i class="conum" data-value="7"></i><b>(7)</b>
            <span class="key">secretAccessKey</span>: <span class="string"><span class="content">&lt;mysecret&gt; </span></span><i class="conum" data-value="7"></i><b>(7)</b>
            <span class="key">bucket</span>: <span class="string"><span class="content">DocumentTypeB</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>always configure a litigation hold bucket</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>you should also configure a data that has no retention &#8230;&#8203; just in case</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>fall back bucket for all content with retention period past 2041.
You can leave this bucket and get an exception if you store content which cannot be assigned to a bucket</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>One buckets for each year</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Configure as many buckets as needed for your content</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Two more storage profiles for other document types without retention.
See content types without retention above arveo:server:content:DocumentTypeA/B</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>replace the placeholders with your S3 url, region, access key and access secret.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more details on storage profiles and content types see <a href="#_types_of_content_elements">Content types</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to use directories instead of buckets you can configure file system storage profiles and assign a sub directory (<a href="#_file_system">File system storage profile configuration</a>)
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre>        <span class="key">storageProfileLitigationHold</span>:
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">storagePath</span>: <span class="string"><span class="content">${storage.base.directory}/storage/litigationHold</span></span>
        <span class="key">storageProfileRetentionNone</span>:
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">storagePath</span>: <span class="string"><span class="content">${storage.base.directory}/storage/retentionNone</span></span>
        <span class="key">storageProfile2031</span>:
          <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
          <span class="key">pluginSettings</span>:
            <span class="key">storagePath</span>: <span class="string"><span class="content">${storage.base.directory}/storage/2031</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_encryption">Configure Encryption</h3>
<div class="paragraph">
<p><em>arveo</em> provides a transparent encryption for data stored in the profiles. The encryption can be configured individually
for each storage profile.</p>
</div>
<div class="sect3">
<h4 id="_overview">Overview</h4>
<div class="paragraph">
<p>Encrypting and decrypting is performed by configurable encryption providers. Each provider is identified by a unique
name. The available providers are described below.</p>
</div>
<div class="paragraph">
<p>The following tables give an overview of encryption settings for a storage profile.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Encryption settings</caption>
<colgroup>
<col style="width: 25%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enables or disables the encryption</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">providerName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name of the encryption provider to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">commons-aes</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To make sure all content of a specific type definition is encrypted, make sure to limit the content types supported
by the type definition to types that use an encrypting storage profile.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the <a href="#_bucketorganizer">BucketOrganizerPlugin</a> is used, the encryption settings must be configured for each plugin referenced
by the bucket selection rules. Configuring the encryption for the BucketOrganizerPlugin itself is not supported.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_commons_aes_provider">Commons AES provider</h4>
<div class="paragraph">
<p>The <code>commons-aes</code> provider supports AES encryption with 256bit keys. When a new content element is created in an encrypted
profile, the provider generates a random cipher key for the element. The key is encrypted using a master password that is
configured in the profile&#8217;s encryption settings. It is then stored in the database, which creates an identifier for the key.
The keys are stored in individual tables for each profile called ecr_keys_&lt;profileName&gt;. After that, the content is encrypted
and stored using the profile&#8217;s storage plugin. The key-id is stored in a header together with the encrypted data. When
the data is read, the cipher key is loaded from the database using the key-id read from the header. The key is decrypted
using the master password and used to decrypt the data read by the profile&#8217;s storage plugin.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the database table containing the keys or the master password is lost, it is impossible to restore the
data stored in the profile.
When the master password for a profile is changed, it is required to re-encrypt all stored keys for the profile.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the future, there will be a way to re-encrypt keys. For now, this issue hasn&#8217;t been implemented yet.</p>
</div>
<div class="paragraph">
<p>There is a second database table for each profile called ecr_keys_assoc_&lt;profileName&gt;. This table contains mappings of
key IDs to content element IDs and is intended for system administration purposes.
The encryption feature is configured as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Configuration of encryption for a storage profile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">storage</span>:
  <span class="key">profiles</span>:
    <span class="key">encryptedProfile</span>:
      <span class="key">pluginClassName</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span><span class="delimiter">&quot;</span></span>
      <span class="key">pluginSettings</span>:
        <span class="key">storagePath</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">/storage/encrypted</span><span class="delimiter">&quot;</span></span>
      <span class="key">encryptionSettings</span>:
        <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
        <span class="key">providerName</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">commons-aes</span><span class="delimiter">&quot;</span></span>
        <span class="key">providerSettings</span>:
          <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">changeme</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following tables give an overview of encryption settings for the <em>commons-aes</em> provider:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Provider specific settings for 'commons-aes'</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the master password used to encrypt the cipher keys</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rngAlgorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the algorithm used to generate secure random data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Platform specific. See docs for SecureRandom.getInstanceStrong(). If not specified, the
most secure algorithm available will be used</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_vault_aes_provider">Vault AES provider</h4>
<div class="paragraph">
<p>The <code>vault-aes</code> encryption provider uses the transit secrets engine of
<a href="https://www.vaultproject.io/docs/secrets/transit">Hashicorp Vault</a> to encrypt and decrypt a generated random cipher key.
The cipher key is generated using a configurable random data generation algorithm and then used to encrypt the content
with AES as described below. The cipher key is then encrypted by Vault and stored in a header together with the encrypted
content data. When the data is decrypted, the encrypted cipher key is read from the header, decrypted using Vault and
then used to decrypt the content. The advantage in comparison to the <code>commons-aes</code> provider is that no master key and
no stored encryption keys in the database are required. The keys required to decrypt the cipher keys (and though the
data, too) are securely stored in Vault and are never known to <em>arveo</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the Vault instance containing the keyring used to encrypt the random cipher keys is lost, it is impossible to
decrypt the content data!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following tables give an overview of encryption settings for the <code>vault-aes</code> provider:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Provider specific settings for 'commons-aes'</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name of the key ring contained in Vault&#8217;s transit secrets engine used to encrypt the cipher keys</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">transitEnginePath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) path of the transit engine. If null, the default path will be used.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rngAlgorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the algorithm used to generate secure random data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Platform specific. See docs for SecureRandom.getInstanceStrong(). If not specified, the
most secure algorithm available will be used</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following example shows a storage profile configuration using the <code>vault-aes</code> encryption provider.</p>
</div>
<div class="listingblock">
<div class="title">example configuration for the vault-aes provider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">vaultEncryptedProfile</span>:
  <span class="key">pluginClassName</span>: <span class="string"><span class="content">de.eitco.ecr.storage.plugin.filesystem.FileSystemPlugin</span></span>
  <span class="key">pluginSettings</span>:
    <span class="key">storagePath</span>: <span class="string"><span class="content">/storage/vault-encrypted</span></span>
  <span class="key">encryptionSettings</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">providerName</span>: <span class="string"><span class="content">vault-aes</span></span>
    <span class="key">providerSettings</span>:
      <span class="key">keyring</span>: <span class="string"><span class="content">arveo</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_details_of_aes_encryption">Implementation details of AES encryption</h4>
<div class="paragraph">
<p>The following chapter contains information about the implementation details of the AES encryption used by <em>arveo</em>.</p>
</div>
<div class="sect4">
<h5 id="_header">Header</h5>
<div class="paragraph">
<p>The encryption library is designed to encrypt data in such a way that it can be stored permanently in encrypted form and
possibly only decrypted after a long time. In order to guarantee decryption, all data required for this (except the key, of
course) are stored in a header together with the encrypted data. Using the data from the header, the library can thus
obtain, for example, the algorithm used and the data for key derivation, and only needs the password or the derived key
for decryption.</p>
</div>
</div>
<div class="sect4">
<h5 id="_aes">AES</h5>
<div class="paragraph">
<p>The library uses AES according to the recommendation of the Federal Office for Information Security of March 2020:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operating mode: Galois/Counter-Mode</p>
</li>
<li>
<p>Hash function for key derivation: Argon2</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The library allows the configuration of different parameters, but offers default values according to the recommendation
of the BSI:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Key length: 256 bit</p>
</li>
<li>
<p>Length of GCM checksums: 128 bit</p>
</li>
<li>
<p>Length of the initialisation vector: 96 bit</p>
</li>
<li>
<p>Length of the salt for the key derivation: 32 bit</p>
</li>
<li>
<p>Parallelism for Argon2: 1</p>
</li>
<li>
<p>Memory cost for Argon2: 4096 KB</p>
</li>
<li>
<p>Iterations for Argon2: 3</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The initialisation vector is randomly generated each time the encryption methods are called by using SecureRandom. The
salt for the key derivation is generated in the same way each time the password derivation method is called. The fact
that the initialisation vector is always regenerated ensures that the same combination of initialisation vector and key
can never be used more than once.
For both the AES algorithm and the Argon2 hash function, the implementations of the BouncyCastle library are used. For
performance and compatibility reasons, the BouncyCastle implementations are used directly and not via the JCA:</p>
</div>
<div class="listingblock">
<div class="title">Generation of the AES cipher with GCM</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GCMBlockCipher cipher = <span class="keyword">new</span> GCMBlockCipher(<span class="keyword">new</span> AESEngine());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Generation of the Argon2 hash generator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Argon2BytesGenerator generator = <span class="keyword">new</span> Argon2BytesGenerator();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the default implementation of the <em>CipherInputStream</em> from <em>javax.crypto</em> is not suitable for block ciphers with data
authentication, the implementations for <em>CipherInputStream</em> and <em>CipherOutputStream</em> from the <em>BouncyCastle</em> library are used.
To generate the random data for the initialisation vector and the salt, a <em>SecureRandom</em> instance created with
<em>SecureRandom.getInstanceStrong()</em> is used by default. However, the library allows you to specify a different RNG algorithm
(see <a href="#_note_on_linux">Note on Linux</a> below).</p>
</div>
</div>
<div class="sect4">
<h5 id="_header_format">Header Format</h5>
<div class="paragraph">
<p>The header begins with a string to identify data encrypted with the library followed by the length of the
payload data in the header. The header is divided into blocks and can be read serially.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>++&gt;~ENC~&lt;++|97|AES_GCM_ARGON2|1|256|128|10|4096|1|aWFtYW5pbml0aWFsaXphdGlvbnZlY3Rvcg==|aWFtYXNhbHQ=|bXlLZXlJZA==

Marker|length|method|header version|key length|checksum length|iteration|storage cost|parallelism|initialisation vector|salt|key ID</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_key">Key</h5>
<div class="paragraph">
<p>The keys used for encryption are either generated using random data or derived from any password using the Argon2 hash
function. Since deriving keys can be very computationally intensive depending on the configuration, a key ID can be
stored in the header. This makes it possible to store a key once it has been derived and to reuse it for decryption,
which avoids having to derive the key from the password again. The library is not responsible for the secure storage of
the key. Generating keys using random data is a much faster operation compared to key derivation. The disadvantage is,
that it is not possible to derive the key from a master password in case it was lost. When generated keys are used,
it is crucial to store those keys in a secure location. In this case, the header will not contain a salt but only the
ID of the stored key. When an external system like Vault is used to encrypt generated keys, the encrypted generated key
is stored in the header instead.</p>
</div>
</div>
<div class="sect4">
<h5 id="_usage">Usage</h5>
<div class="paragraph">
<p>Instantiation of the AesEncryptorAndDecryptor:</p>
</div>
<div class="listingblock">
<div class="title">Instantiation with default parameters</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AesEncryptorAndDecryptor encryptorAndDecryptor=<span class="keyword">new</span> AesEncryptorAndDecryptor.Builder().build();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Instantiation with customised parameters</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AesEncryptorAndDecryptor encryptorAndDecryptor=<span class="keyword">new</span> AesEncryptorAndDecryptor.Builder()
    .with128BitKeys()
    .withInitializationVectorLength(<span class="integer">128</span>)
    .withTagLength(<span class="integer">128</span>)
    .withIterations(<span class="integer">5</span>)
    .withMemoryCost(<span class="integer">1024</span>)
    .withParallelism(<span class="integer">3</span>)
    .withSaltLength(<span class="integer">64</span>)
    .withRngAlgorithm(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHA1PRNG</span><span class="delimiter">&quot;</span></span>)
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examples of usage can be found in the test class <em>de.eitco.commons.crypto.AesEncryptionTest</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_note_on_linux">Note on Linux</h5>
<div class="paragraph">
<p>On Linux, Java uses the NativePRNG algorithm by default for generating random data with SecureRandom.getInstanceStrong().
This implementation uses /dev/random and may block if there is not enough data available there. This can lead to very
long waiting times for key derivation and encryption. You can then either use a weaker RNG algorithm or make sure that
<em>/dev/random</em> always contains enough data. This can be achieved with the haveged daemon, for example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apt-get install haveged
update-rc.d haveged defaults
service haveged start</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_active_mq">Configure Active MQ</h3>
<div class="paragraph">
<p><em>arveo</em> uses Apache ActiveMQ to queue asynchronous tasks. Access to the message broker is configured in the YAML file of
the <em>arveo</em> service using the default configuration properties of the Spring ActiveMQ integration:</p>
</div>
<div class="listingblock">
<div class="title">Configuration of ActiveMQ</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">spring</span>:
  <span class="key">activemq</span>:
    <span class="key">broker-url</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">tcp://127.0.0.1:61616</span><span class="delimiter">&quot;</span></span>
    <span class="key">user</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">system</span><span class="delimiter">&quot;</span></span>
    <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">manager</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ActiveMQ&#8217;s OpenWire protocol is used to connect to the broker. The queues and topics used by the <em>arveo</em> can be identified
by <em>arveo</em>- name-prefix. The <em>arveo</em> uses text messages containing JSON data to make it possible to consume messages in
components not implemented in Java. The JSON data uses the same serialization mechanism as the REST API.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> uses ActiveMQ&#8217;s scheduler support for features like automated deletion of entities in the recycle bin after a
configurable time. Therefore it is required to enable the scheduler in ActiveMQ by setting schedulerSupport="true" in the
broker tag in <em>activemq.xml</em>.</p>
</div>
<div class="paragraph">
<p>Some features like the automatic creation of renditions or the removal of stored data for data protection compliance
require dead letter queues in ActiveMQ. See <a href="#<em>error_handling">renditions</a> for details. The queue-specific
dead letter queues must be activated by adding the following policy entries to _activemq.xml</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;policyEntry</span> <span class="attribute-name">queue</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ecr-queue-create-renditions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;deadLetterStrategy&gt;</span>
        <span class="tag">&lt;individualDeadLetterStrategy</span> <span class="attribute-name">queuePrefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DLQ.</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">useQueueForQueueMessages</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/deadLetterStrategy&gt;</span>
<span class="tag">&lt;/policyEntry&gt;</span>
<span class="tag">&lt;policyEntry</span> <span class="attribute-name">queue</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ecr-queue-delete-audit-entries</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;deadLetterStrategy&gt;</span>
        <span class="tag">&lt;individualDeadLetterStrategy</span> <span class="attribute-name">queuePrefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DLQ.</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">useQueueForQueueMessages</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/deadLetterStrategy&gt;</span>
<span class="tag">&lt;/policyEntry&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_arveo_user_management_as_authentication_service">Configure <em>arveo</em> user management as Authentication Service</h3>
<div class="paragraph">
<p>The User Management Service can also be used as an OAuth2.0 Authorization Server. The service can issue JSON web tokens that can be used to log in to services that are also secured with OAuth2.</p>
</div>
<div class="sect3">
<h4 id="_configuration_of_the_authorization_server">Configuration of the Authorization Server</h4>
<div class="paragraph">
<p>To enable the Authorization Server, the <em>user-service.authorization-server.enabled</em> setting must be
enabled and a keystore must be configured. The keystore must contain an RSA keypair under the specified alias:</p>
</div>
<div class="listingblock">
<div class="title">Excerpt from a configuration file</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">user-service</span>:
  <span class="key">authorization-server</span>:
  <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">keystore</span>:
    <span class="key">file</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Pfad/zum/Keytore/keystore.jks</span><span class="delimiter">&quot;</span></span>
    <span class="key">password</span>: <span class="string"><span class="content">test</span></span>
    <span class="key">alias</span>: <span class="string"><span class="content">test</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_oauth_clients">OAuth clients</h4>
<div class="paragraph">
<p>To obtain a token, a client application must log on to a specific client configured in the Authorization Server. Clients can be created both by API and by configuration. At least one client must have been configured to be able to log in via OAuth. Clients are always stored in the master
tenant. In the configuration, clients can be specified as follows:</p>
</div>
<div class="listingblock">
<div class="title">Excerpt from a configuration file</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">user-service</span>:
  <span class="key">config-data</span>:
    <span class="key">tenants</span>:
      - <span class="string"><span class="content">tenant-id: master</span></span>
        <span class="key">oauth2-clients</span>:
          - <span class="string"><span class="content">clientId: test-client</span></span>
            <span class="key">resourceIds</span>:
              - <span class="string"><span class="content">user-management-service</span></span>
            <span class="key">clientSecret</span>: <span class="string"><span class="content">my-secret</span></span>
            <span class="key">authorizedGrantTypes</span>:
              - <span class="string"><span class="content">password</span></span>
              - <span class="string"><span class="content">client_credentials</span></span>
              - <span class="string"><span class="content">refresh_token</span></span>
            <span class="key">authorities</span>:
              - <span class="string"><span class="content">USER_MANAGEMENT_SERVICE_USER</span></span>
            <span class="key">accessTokenValiditySeconds</span>: <span class="string"><span class="content">300</span></span>
            <span class="key">refreshTokenValiditySeconds</span>: <span class="string"><span class="content">600</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, a client with the ID "test-client" is configured to have access to the <em>arveo</em> User Management
Service (resourceIds and authorities) and to offer the authorization grants password, client_credentials and refresh_tokens. The grants are the same as those in the OAuth2.0 standard.</p>
</div>
<div class="paragraph">
<p>By default, the client&#8217;s configured authorities are included in the issued tokens. In addition, the user&#8217;s authorities
(= privileges) configured in the user service are entered in the tokens. To prevent the client&#8217;s authorities from
being included in the tokens, the <em>user-service.authorization-server.inherit-authorities</em> setting can be set to false.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The clients are always stored in the master tenant. For systems with multiple clients, care must be taken to specify the master tenant in the configuration.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_refreshing_tokens">Refreshing tokens</h5>
<div class="paragraph">
<p>When a new token is issued, a refresh token is also generated (except for the client_credentials grant). This refresh token can be used to renew an expiring token without requiring the user to log in again. By default, when a token refresh request is made, the user also receives a new refresh token whose validity is still that of the first refresh token. This ensures that a user cannot be issued new access tokens by the service indefinitely. If this behavior is not desired, and the refresh tokens should each have an extended validity, the <em>user-service.authorization-service.reuse-refresh-tokens</em> parameter can be set to false.</p>
</div>
</div>
<div class="sect4">
<h5 id="_client_login">Client login</h5>
<div class="paragraph">
<p>To get a token, the client application must send the respective client id and the client secret as HTTP Basic Auth
header in the token request. The remaining parameters are sent as form data via POST to the endpoint
<a href="https://user-management-service/oauth/token" class="bare">https://user-management-service/oauth/token</a>.
=== Configure authentication/SSO with Keycloak</p>
</div>
<div class="paragraph">
<p>The <em>arveo</em> content services support OAuth2.0 with OpenID Connect to authenticate users and services.
You can install Keycloak as your identity management and use it as OAuth2.0 authentication service instead of the _arveo user management service.
This will also allow you to enable single sign on for your web clients.</p>
</div>
<div class="paragraph">
<p>The content services take either the role of a "resource server" or the role "resource server" and a "client" if the use resources of other services.</p>
</div>
<div class="paragraph">
<p>In principle, any authentication server that supports OAuth2.0 and OpenID Connect can be used. Currently Keycloak, Active Directory are approved for use with <em>arveo</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_install_keycloak">Install Keycloak</h5>
<div class="ulist">
<ul>
<li>
<p>Download and install Keycloak: <a href="https://www.keycloak.org/downloads.html" class="bare">https://www.keycloak.org/downloads.html</a></p>
</li>
<li>
<p>Start the server. With standalone.bat -Djboss.socket.binding.port-offset=100 the used ports can be adjusted.</p>
</li>
<li>
<p>Call the configuration interface (e.g. localhost:8180) and define an administrator user for the first login.</p>
</li>
<li>
<p>Refer to Keycloak documentation to configure Keycloak on your system.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_create_keycloak_realm">Create Keycloak realm</h5>
<div class="ulist">
<ul>
<li>
<p>Create your own realm (e.g. "<em>arveo</em>") with keycloak configuration interface.</p>
</li>
<li>
<p>Copy the public RSA key from the realm keys tab. We will use later for the configuration of the content services.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_create_keycloak_clients">Create Keycloak clients</h5>
<div class="ulist">
<ul>
<li>
<p>Next, the keycloak clients for the <em>arveo</em> services are set up. Clients may access resources, resources validate access to themselves. There is also a mixed form (confidential) that accesses resources, but can also be a resource itself.<br>
All clients have set Client Protocol=openid-connect<br>
Client Authenticator must be Client Id and Secret to allow a secure OAuth2.0 flow.</p>
<div class="ulist">
<ul>
<li>
<p>Create a client <em>arveo</em>-service for the secure communication between the <em>arveo</em> services,<br>
This client behaves like a technical user for service/service calls<br>
access-type=confidential</p>
</li>
<li>
<p>Create client for your applications e.g. arveo-webclient which is public and accesses all <em>arveo</em> services<br>
This client is used for the users of your application that have logged with credentials.<br>
Client-Protocol=public<br>
Valid Redirect URIs=&lt;URI of your web client&gt;<br>
Client Protocol=openid-connect<br></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Implicit flow is no longer recommended. The standard flow should be used. Furthermore, the extension PKCE (Proof Key for Code Exchange Code) should be used (<a href="#_authentication_code_flow_pkce">*Authentication Standard Flow with PKCE</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_configure_a_client">Configure a client</h5>
<div class="ulist">
<ul>
<li>
<p>To allow the client to access the <em>arveo</em> services, add the role arveo-service-user to the client.</p>
</li>
<li>
<p>Add token mappers to allow <em>arveo</em> to get information from the token<br></p>
<div class="ulist">
<ul>
<li>
<p>Tenant, the tenant in <em>arveo</em>. This is used to assign the user to a client.<br>
Name=Tenant<br>
Mapper-Type=User Attribute<br>
User Attribute=tenant<br>
Token Claim Name=tenant<br>
Claim JSON Type=String<br>
Multi Valued = Off<br>
Add To Id Token=On<br>
Add To Access Token=On<br>
Add To User Info=On<br></p>
</li>
<li>
<p>Audience for repository service, _arveo pays attention to access tokens from the score-client at all, the score-backend client must also be in the token as an audience<br>
Name=Audience for arveo services<br>
Mapper-Type=Audience<br>
Included Client Audience=arveo-webclient<br>
Add To ID Token=Off<br>
Add To Access Token=On</p>
</li>
<li>
<p>GUUID, important for authentication via LDAP. In the access token, the user_name attribute is set to the GUUID from the LDAP. This is largely stable, in contrast to the Keycloak internal user ID.<br>
Name=GUUID<br>
Mapper-Type=User Attribute<br>
User Attribute=LDAP_ID<br>
Token Claim Name=user_name<br>
Claim JSON Type=String<br>
Multi Valued = Off<br>
Add To Id Token=On<br>
Add To Access Token=On<br>
Add To User Info=On</p>
</li>
<li>
<p>Client ID, keycloak ClientID
Name=Client ID<br>
Mapper-Type=User Session Note<br>
User Attribute=clientid<br>
Token Claim Name=clientid<br>
Claim JSON Type=String<br>
Add To Id Token=On<br>
Add To Access Token=On</p>
</li>
<li>
<p>Client roles, is required for the _arveo services. The client needs the authority arveo-user-role to access the service. All roles from the client with the ClientID arveo-client are added to the claim authorities.
Name=client roles<br>
Mapper-Type=User Client Role<br>
User Attribute=LDAP_ID<br>
Multi Valued = On<br>
Token Claim Name=authorities<br>
Claim JSON Type=String<br>
Multi Valued = Off<br>
Add To Id Token=Off<br>
Add To Access Token=On<br>
Add To UserInfo = Off</p>
</li>
<li>
<p>Service user. is required to identify the user of the access token as a service user.
Name=Service user<br>
Mapper-Type=Script Mapper<br>
Script=exports=user.getUserName.startsWith("service-account");<br>
Multi Valued = Off<br>
Token Claim Name=technical-user<br>
Claim JSON Type=boolean<br>
Add To Id Token=On<br>
Add To Access Token=On<br>
Add To UserInfo = On</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_configure_keycloak_for_sso_with_kerberos">Configure Keycloak for SSO with Kerberos</h5>
<div class="ulist">
<ul>
<li>
<p>Configure Keycloak user federation for SSO with Active Directory using Kerberos</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/keycloak-ldap-mapper.png" alt="LDAP Mapper">
</div>
<div class="title">Figure 5. LDAP Mapping</div>
</div>
<div class="ulist">
<ul>
<li>
<p>2 additional LDAP mappers have to be added:</p>
<div class="ulist">
<ul>
<li>
<p>Adding the tenant to the user attributes, since the tenant does not come from the AD.<br>
Name: add-<em>arveo</em>-tenant<br>
Mapper Type: hardcoded-attribute-mapper<br>
User Model Attribute Name: tenant<br>
Attribute Value: master</p>
</li>
<li>
<p>The role so that the user is authorized to access the <em>arveo</em> services
Name: add-arveo_-user<br>
Mapper Type: hardcoded-ldap-role-mapper<br>
Role: arveo-service-user<br></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As soon as a user logs on to the _arveo web client application for the first time, the user is imported from the LDAP into Keyclaok. Users who are not in the LDAP can be created locally in the Keycloak.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configure Keycloak:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install package freeipa-client (Ubuntu)</p>
</li>
<li>
<p>Setup /etc/krb5.conf<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>[libdefaults]
default_realm = &lt;your realm&gt;
# The following krb5.conf variables are only for MIT Kerberos.
kdc_timesync = 1
ccache_type = 4
forwardable = true
proxiable = true
# The following encryption type specification will be used by MIT Kerberos
# if uncommented. In general, the defaults in the MIT Kerberos code are
# correct and overriding these specifications only serves to disable new
# encryption types as they are added, creating interoperability problems.
#
# The only time when you might need to uncomment these lines and change
# the enctypes is if you have local software that will break on ticket
# caches containing ticket encryption types it doesn't know about (such as
# old versions of Sun Java).# default_tgs_enctypes = des3-hmac-sha1
# default_tkt_enctypes = des3-hmac-sha1
# permitted_enctypes = des3-hmac-sha1
# The following libdefaults parameters are only for Heimdal Kerberos.
fcc-mit-ticketflags = true
[realms]
YOURDOMAIN.COM={
kdc=yourdomaincontronler:port
}
[domain_realm]
yourdmain.com=YOURDOMAIN.COM
.yourdomain.com=YOURDOMAIN.COM</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>chown on arveo:arveo und chmod 600</p>
</li>
<li>
<p>Import the CA certificate to your Java truststore<br>
e.g. %javahome%/keytool -import -alias YourDomain.com -keystore truststore.jks -file ~/ca.pem</p>
</li>
<li>
<p>Activate Kerberos Single Sign On:<br>
To allow SSO set requirement for all Flow to ALTERNATIVE</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/keycloak-flows.png" alt="*Keycloak Flows*">
</div>
<div class="title">Figure 6. Keycloak Flows</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a non ldap test user in manage users<br>
Details:<br>
Name=TestUser<br>
User Enabled=On<br>
Attributes:<br>
LDAP_ID=&lt;new UUID&gt;<br>
Tenant=master<br>
Role Mappings=&lt;add arveo-service-user&gt;</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_authentication_between_content_services">Configure authentication between Content Services</h3>
<div class="paragraph">
<p>All <em>arveo</em> content services use <strong>Spring Security</strong> for user authentication and authorization. Spring Security supports several standardized protocols as well as custom implementations. The basic configuration is independent of the protocol used.</p>
</div>
<div class="paragraph">
<p>When configuring the service, it is important to consider the role that the service plays in the overall system. Some
services are only used by different clients and do not communicate with other services. These services only take the role of
a "resource server". Other services, such as the repository service, communicate with other services themselves and assume the
role of a "resource server" and a "client" at the same time.</p>
</div>
<div class="sect4">
<h5 id="_resource_and_client_configuration">Resource and client configuration</h5>
<div class="paragraph">
<p>The following configuration can be used to make a service an OAuth2.0 resource and/or an OAuth2.0 client in the service&#8217;s <em>application.yaml</em>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Client</th>
<th class="tableblock halign-left valign-top">Resource</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Management Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Control Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP Archive Link Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Conversion Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise User Management Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise Integration Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Federation Service (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_configure_resource">Configure resource</h5>
<div class="paragraph">
<p>Configure the respective <em>application.yaml</em> of the service like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="key">security</span>:
  <span class="key">general</span>:
    <span class="key">secured-ant-matchers</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">/api/**</span><span class="delimiter">&quot;</span></span>
    <span class="key">open-ant-matchers</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">/actuator/health,/actuator/info</span><span class="delimiter">&quot;</span></span>
    <span class="key">role-for-secured-access</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;service - name&gt;</span><span class="delimiter">&quot;</span></span>
    <span class="key">cors-configuration</span>:
      <span class="key">allowed-origins</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>
      <span class="key">allowed-headers</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>
      <span class="key">allowed-methods</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">GET,POST,PUT,PATCH,DELETE,OPTIONS</span><span class="delimiter">&quot;</span></span>
      <span class="key">max-age</span>: <span class="string"><span class="content">3600</span></span>

<span class="key">spring</span>:
  <span class="key">security</span>:
    <span class="key">oauth2</span>:
      <span class="key">resourceserver</span>:
        <span class="key">jwt</span>:
<span class="comment"># public key for user management service</span>
<span class="comment">#          public-key-location: &quot;http://localhost:39002/oauth/public_key&quot;</span>
<span class="comment"># public key location for keycloak</span>
          <span class="key">jwk-set-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth/realms/ecr/protocol/openid-connect/certs</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>(1) Generally, these parameters shouldn&#8217;t be changed.</p>
</div>
<div class="paragraph">
<p>(2) CORS defines a way in which a browser and server can interact to determine whether it is safe to allow the cross-origin request.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configure_the_client">Configure the client</h5>
<div class="paragraph">
<p>Configure the respective <em>application.yaml</em> of the service like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="key">spring</span>:
  <span class="key">security</span>:
    <span class="key">oauth2</span>:
      <span class="key">client</span>:
        <span class="key">registration</span>:
          <span class="key">cmn-user-service-client-credentials</span>:
            <span class="key">provider</span>: <span class="string"><span class="content">user-service</span></span>
            <span class="key">client-id</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">arveo-service</span><span class="delimiter">&quot;</span></span>
            <span class="key">client-secret</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">my-secret</span><span class="delimiter">&quot;</span></span>
            <span class="key">authorization-grant-type</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">client_credentials</span><span class="delimiter">&quot;</span></span>
            <span class="key">scope</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">arveo</span><span class="delimiter">&quot;</span></span>
        <span class="key">provider</span>:
          <span class="key">user-service</span>:
            <span class="key">authorization-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:39002/oauth/auth</span><span class="delimiter">&quot;</span></span>
            <span class="key">token-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:39002/oauth/token</span><span class="delimiter">&quot;</span></span><span class="string"><span class="content">-----</span></span>
          <span class="key">keycloak</span>:
            <span class="key">authorization-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth/realms/arveo/protocol/openid-connect/auth</span><span class="delimiter">&quot;</span></span>
            <span class="key">token-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth/realms/arveo/protocol/openid-connect/token</span><span class="delimiter">&quot;</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parameter</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">oauth2.resourceserver.jwt.public-key-location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation key of the authentication service to validate the token. e.g. PEM or RSA Public Key. For keycloak <a href="#_create_keycloak_realm"><strong>Realm Settings Keys</strong></a>, for User management service see documentation on user-management/securing rest endpoints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security.general.role-for-secured-access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unique identifier of the service: see names of services in table below</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.security.oauth2.client.registration.cmn-user-service-client-credentials.client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Id configured in your authentication service. In our keyckloak example: arveo-service,  <a href="#_configure_a_client"><strong>Client-ID</strong></a>, for User management service
see documentation on user management/client context/client ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.security.oauth2.client.registration.cmn-user-service-client-credentials.client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Your client secret of the authentication service. For keyckloak <a href="#_configure_a_client"><strong>Client Secret</strong></a>, for User management service
see documentation on user management/client context/client secret</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.security.oauth2.client.provider.user-service.authorization-uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">end point for user authorization</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.security.oauth2.client.provider.user-service.token-uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">end point to get an access token</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.security.oauth2.client.registration.cmn-user-service-client-credentials.scope</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scope is always arveo</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>The public-key-location defines a path to a resource containing the public key of the service that issued the signed tokens. If the issuing service supports JSON Web Keys, the URL to the JWK endpoint can be set using jwk-set-uri.</p>
</li>
<li>
<p>To enable the user impersonation feature, add the following to the <em>application.yaml</em> configuration:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>    <span class="key">commons</span>:
        <span class="key">security</span>:
            <span class="key">oauth2</span>:
                <span class="key">impersonation-enabled</span>: <span class="string"><span class="content">true</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>It is possible to disable the auto configuration of the server components by setting spring.security.oauth2.resourceserver.enabled to false.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Troubleshooting some common error messages and ways to fix them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>principal cannot be null from OAuth2AuthorizeRequest: There probably was no Authentication in the application&#8217;s SecurityContext. Check if the application sets an Authentication.</p>
</li>
<li>
<p>Startup fails because no bean of type ClientRegistrationRepository was found: Check the configuration. This usually happens when the values in spring.security.oauth2.client are either missing or invalid. Check indentation!</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting">Troubleshooting</h4>
<div class="paragraph">
<p>Some common error messages and ways to fix them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Principal cannot be null from OAuth2AuthorizeRequest: There probably was no Authentication in the application&#8217;s SecurityContext. Check if the application sets an Authentication.</p>
</li>
<li>
<p>Startup fails because no bean of type ClientRegistrationRepository was found: Check the configuration. This usually happens when the values in spring.security.oauth2.client are either missing or invalid. Check indentation!</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_authentication-oauth2">OAuth2.0 Authentication</h3>
<div class="paragraph">
<p>All <em>arveo</em> services require authentication, ensuring that only another <em>arveo</em> service or an authenticated user can use the REST API. Authentication of a user is done by the either a authentication service like Keycloak or the <em>arveo</em> User Management Service.
The user context is passed to invoked services. Single Sign on is supported with OAuth2.0 and Open ID Connect.</p>
</div>
<div class="paragraph">
<p>The <em>arveo</em> User Management Service can also be used as an OAuth2.0 Authorization Server. The service can issue JSON web tokens that can be used to log in to services that are also secured with OAuth2.</p>
</div>
<div class="paragraph">
<p>This chapter describes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>how <em>arveo</em>'s content services act as an OAuth2.0 resource server for applications using the <em>arveo</em> REST API</p>
</li>
<li>
<p>how the <em>arveo</em> services use OAuth2.0 to authenticate to other services as a technical user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All content services use Spring Security for user authentication and authorization. The services support OAuth2.0 with OpenID Connect.</p>
</div>
<div class="paragraph">
<p>Spring Security enables both the OAuth2.0 support for the service&#8217;s web resources and the OAuth2.0 client support. The content services retrieve a new OAuth2.0 token from the configured OAuth2.0 authorization service when a authentication is required.
This OAuth2.0 authorization service can either be the <em>arveo</em> user management service or Keycloak, Active Directory.</p>
</div>
<div class="sect3">
<h4 id="_oauth2_0_flows_grant_types">OAuth2.0 Flows (Grant types)</h4>
<div class="paragraph">
<p>OAuth2.0 defines four flows to get an access token. These flows are called grant types. <em>arveo</em> supports two flows for user authentication and service authentication.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client Credentials Flow: used for machine-to-machine content services communication.</p>
</li>
<li>
<p>Authorization Code Flow with Proof Key for Code Exchange (PKCE) technique: used by <em>arveo</em> Web Applications sand also used by mobile apps.</p>
</li>
<li>
<p>Resource Owner Password Flow: can be used by highly-trusted web apps.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the following paragraphs we describe the flows. The authentication service can either be the <em>arveo</em> User Management Service or Keycloak. If you use Keycloak you must turn off <em>arveo</em> internal authentication service.</p>
</div>
</div>
<div class="sect3">
<h4 id="_client_credential_flow">Client Credential Flow</h4>
<div class="paragraph">
<p>Our machine-to-machine content services authenticate and authorize the app not an user. For this scenario, typical authentication schemes like username + password or social logins don&#8217;t make sense. Instead, the services use the Client Credentials Flow, in which they pass along their Client ID and Client Secret to authenticate themselves and get a token.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/auth-sequence-client-credentials.png" alt="*Credential Flow*">
</div>
<div class="title">Figure 7. Credential Flow</div>
</div>
<div class="ulist">
<ul>
<li>
<p><em>arveo</em> authenticates with Authorization Service using its Client ID and Client Secret (/oauth/token endpoint).</p>
</li>
<li>
<p>The Authorization Service validates the Client ID and Client Secret.</p>
</li>
<li>
<p>The Authorization Service responds with an Access Token.</p>
</li>
<li>
<p><em>arveo</em> can use the Access Token to call an API on behalf of itself.</p>
</li>
<li>
<p>The Service API responds with requested data.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_authentication_code_flow_pkce">Authentication Code Flow (PKCE)</h4>
<div class="paragraph">
<p>The <em>arveo</em> single-page web applications requests Access Tokens, some additional security concerns are posed that are not mitigated by the Authorization Code Flow alone. This is because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Native apps cannot securely store a Client Secret. Decompiling the app will reveal the Client Secret, which is bound to the app and is the same for all users and devices.</p>
</li>
<li>
<p>Single-page apps cannot securely store a Client Secret because their entire source is available to the browser.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Given these situations, OAuth 2.0 provides a version of the Authorization Code Flow which makes use of a Proof Key for Code Exchange (PKCE).</p>
</div>
<div class="paragraph">
<p>The PKCE-enhanced Authorization Code Flow introduces a secret created by the calling application that can be verified by the authorization server; this secret is called the Code Verifier. Additionally, the calling app creates a transform value of the Code Verifier called the Code Challenge and sends this value over HTTPS to retrieve an Authorization Code. This way, a malicious attacker can only intercept the Authorization Code, and they cannot exchange it for a token without the Code Verifier.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/auth-sequence-auth-code-pkce.png" alt="Authentication Code Flow">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The user clicks Login within the application.</p>
</li>
<li>
<p>The OAUTH2 java script SDK creates a cryptographically-random code_verifier and from this generates a code_challenge.</p>
</li>
<li>
<p>OAUTH2 java script SDK redirects the user to the authorization service (/authorize endpoint) along with the code_challenge.</p>
</li>
<li>
<p>The authorization service redirects the user to the login and authorization prompt.</p>
</li>
<li>
<p>The user authenticates using one of the configured login options and may see a consent page listing the permissions Auth0 will give to the application.</p>
</li>
<li>
<p>The authorization service stores the code_challenge and redirects the user back to the application with an authorization code, which is good for one use.</p>
</li>
<li>
<p>OAUTH2 jav script SDK sends this code and the code_verifier (created in step 2) to the Auth0 Authorization Server (/oauth/token endpoint).</p>
</li>
<li>
<p>The authorization service verifies the code_challenge and code_verifier.</p>
</li>
<li>
<p>The authorization server responds with an ID Token and Access Token (and optionally, a Refresh Token).</p>
</li>
<li>
<p>The <em>arveo</em> web application can use the Access Token to call an API to access information about the user.</p>
</li>
<li>
<p>The API responds with requested data.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_maintenance_mode_for_the_database_schema">Maintenance mode for the database schema</h4>
<div class="paragraph">
<p>This chapter documents the <em>arveo</em> parameters to start the database service, alter schema and stop the service.</p>
</div>
<div class="paragraph">
<p>The <em>arveo</em> can be started in a special mode that ensures, that this instance changes the schema and prevents other
instances from being started or have already been started. If the database schema change fails, the instance terminates
in a way that can be easily evaluated by the administrator to be able to react to this exception.</p>
</div>
<div class="paragraph">
<p>The service does not start if registry query returns other running instances. The service terminates after the liquibase
script is executed. The following two parameters are set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">system</span>:
  <span class="key">terminateAfterCreation</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">updateSchema</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So the maintenance mode can be used to update the database schema. When the maintenance mode is enabled, the <em>arveo</em> starts,
performs necessary schema updates, and terminates once the schema was updated. Requests from clients are not processed
while the system is in maintenance mode. Clients will receive a HTTP 503 response code. Schema updates must be performed
by one single <em>arveo</em> instance to avoid race conditions. The recommended procedure for a schema update is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Shut down all <em>arveo</em> instances</p>
</li>
<li>
<p>If required: Update to a newer <em>arveo</em> version</p>
</li>
<li>
<p>Enable maintenance mode by setting system.maintenanceMode: true in the configuration</p>
</li>
<li>
<p>Start one single <em>arveo</em> instance and wait for it to shut down after the schema was updated</p>
</li>
<li>
<p>Disable maintenance mode in the configuration</p>
</li>
<li>
<p>Start all <em>arveo</em> instances.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The database schema of an existing system can be changed by adapting the type definition classes and restarting the
repository service with the setting <code>arveo.server.system.maintenance-mode=true</code>. The service will update the database
schema and shut down once the update is finished. It will not accept requests while the schema is updated.</p>
</div>
</div>
<div class="sect3">
<h4 id="_supported_schema_changes">Supported schema changes</h4>
<div class="paragraph">
<p>The following list contains the supported schema changes. Note that some changes like removing an attribute or adding
constraints might not be possible when the existing data or existing constraints might be violated by the change.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding a new attribute.</p>
</li>
<li>
<p>Removing an existing attribute. Note that the column will be dropped from the schema.</p>
</li>
<li>
<p>Adding and removing indexes as well as changing index properties.</p>
</li>
<li>
<p>Change the primary key (only for META types).</p>
</li>
<li>
<p>Adding and removing of foreign keys.</p>
</li>
<li>
<p>Add new content elements (only for DOCUMENT types).</p>
</li>
<li>
<p>Adding and removing unique constraints.</p>
</li>
<li>
<p>Adding and removing not-null constraints.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is also possible to enable certain features on existing type definitions. Disabling the features is not supported.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enabling ACL support.</p>
</li>
<li>
<p>Enabling document filing.</p>
</li>
<li>
<p>Enabling optimistic locking.</p>
</li>
<li>
<p>Enabling the recycle bin.</p>
</li>
<li>
<p>Enabling retention support.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_checking_for_schema_changes">Checking for schema changes</h4>
<div class="paragraph">
<p>By setting the properties <code>arveo.server.system.maintenanceMode</code> and <code>arveo.server.system.logSchemaChanges</code> to true,
the system will start up, check for required schema changes, write them to a special log file, and shut down again.
The database schema will not be changed. This makes it possible to check for unsupported changes to the schema before
performing the actual schema update.</p>
</div>
<div class="paragraph">
<p>The directory used to store the schema update log can be specified using the property <code>arveo.server.system.schemaChangeLogDirectory</code>.
The default value is <code>logs</code>. The system will create one logfile for each tenant. The contents of the file will look like
the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Supported changes for attributes of type definition my_document:
        - document_name: IS_UNIQUE
        - container_id: FOREIGN_KEY, IS_UNIQUE

Unsupported changes for attributes of type definition my_document:
        - document_name: none
        - container_id: none</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, there are three supported changes for the type definition named <em>my_document</em>. A unique constraint
will be added to or removed from the attributes <em>container_id</em> and <em>document_name</em> and a foreign key will be added to or
removed from the attribute <em>container_id</em>. There are no unsupported changes, so the actual schema update should succeed.</p>
</div>
<div class="paragraph">
<p>Please note that there are some advanced schema checks that can only be done correctly when the types are actually stored
in the database. For example, the checks for the correctness of parent- and child- types of a relation type is not
possible when the schema update itself is skipped.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_audit">Configure audit</h3>
<div class="paragraph">
<p>A <code>@Type</code> may define to be audited. This means, that any write access i.e. any create, update and delete operation to any entity of this type will be logged into another table. This is done with the annotation <code>@Audit</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@Audit</span>(AuditLocation.TYPE_SPECIFIC) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">AuditedContainer</span> {

    <span class="annotation">@Optional</span>
    <span class="predefined-type">String</span> getName();
    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">Integer</span> getInteger();
    <span class="type">void</span> setInteger(<span class="predefined-type">Integer</span> integer);
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The annotation <code>@Audit</code> activates auditing on a type</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The name of the table to be audited to is derived from the table name of the given type, following the form <code>&lt;table-name&gt;_log</code>. You can choose to specify one audit table per entity table, or alternatively to audit to one global table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@Audit</span>(
    value = AuditLocation.GLOBAL, <i class="conum" data-value="1"></i><b>(1)</b>
    indexOn = {AuditJsonField.CURRENT} <i class="conum" data-value="2"></i><b>(2)</b>
)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">AuditedDocument</span> {

    <span class="annotation">@Optional</span>
    <span class="predefined-type">String</span> getName();
    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">Integer</span> getInteger();
    <span class="type">void</span> setInteger(<span class="predefined-type">Integer</span> integer);
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note a different <code>AuditLocation</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>with <code>indexOn</code> it is possible to specify on which json fields of the audit table indices should be set</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this case the table to be audited to will be the <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons.audit/cmn-audit-parent/2.0.0/documentation/">audit services</a> default audit table <code>default_audit_log</code>.</p>
</div>
<div class="sect3">
<h4 id="_access_audit">Access audit</h4>
<div class="paragraph">
<p>To access the audit, the audit service provides a REST API. Access will be restricted depending on the type: If ACLs are activated on a <code>@Type</code>, only users that have read access to an entity will be allowed to audit this entity. If ACLs are deactivated on a <code>@Type</code>, only users with the <a href="#Basic functions of the user administration">authority</a> <code>AUDITOR</code> are allowed to audit the entities of this type.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_solr">Solr</h3>
<div class="paragraph">
<p>In order to use Solr in connection with <em>arveo</em>, an installation of a Solr service is required. Under the
following link you can download the current versions of Solr: <a href="https://solr.apache.org/downloads.html" class="bare">https://solr.apache.org/downloads.html</a>.</p>
</div>
<div class="paragraph">
<p>The Solr service must be configured in <em>arveo</em> within the <em>application.yaml</em>. See
<a href="#_ecr_server_solr">Configuration properties</a> for details.</p>
</div>
<div class="paragraph">
<p>When a type definition is annotated with <code>@NOSql</code>, the entities stored in this type definition will be stored in
Solr, too. See <a href="#_entity_annotations_nosql_example">NOSQL Example</a> for how to enable this feature. The system
will create a special queue table in the relational database for such a type definition. The queue table will contain
the entities that have to be stored in Solr. A <a href="#_nosql_queue_job">system job</a> is used to process the
entries in the queue table.</p>
</div>
<div class="sect3">
<h4 id="_solr_deployment">Solr deployment</h4>
<div class="paragraph">
<p>A small tutorial for setting up Solr for <em>arveo</em>.</p>
</div>
<div class="sect4">
<h5 id="_arveo_yaml_configuration"><em>arveo</em> yaml configuration:</h5>
<div class="paragraph">
<p>In the following example you can see a minimal <em>arveo</em> yaml configuration for Solr:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">ecr</span>:
  <span class="key">server</span>:
    <span class="key">solr</span>:
      <span class="key">defaultConfigName</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ecr-config</span><span class="delimiter">&quot;</span></span>
      <span class="key">host</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:38983/solr</span><span class="delimiter">&quot;</span></span>
      <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ecr-solr-user</span><span class="delimiter">&quot;</span></span>
      <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Collections will be created automatically from <em>arveo</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>More information you can find in the chapter <a href="#_ecr_server_solr">ecr.server.solr</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_solr_security">Solr security</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
As default Solr has <strong>no security settings</strong> set. It is very important to add the security settings for Solr!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information for setting up the security settings for Solr you can go the chapter <a href="#_solr_security_configuration">solr security configuration</a></p>
</div>
<div class="paragraph">
<p>If you use the <em>arveo</em> acl functionallity you can setup the solr-acl-plugin. More information for the solr-acl-plugin you can find <a href="#_acl_filter_plugin">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_solr_configurations">Solr Configurations</h5>
<div class="paragraph">
<p>If you want to use solr with <em>arveo</em> you must upload a ecr-config to the Solr zookeeper. The ecr-config you can find at the following url
<a href="https://nexus.eitco.de/repository/maven-ecr-releases/de/eitco/ecr/ecr-environment-configuration/14.0.1/ecr-environment-configuration-14.0.1-solr.zip">nexus.eitco.de</a> as zip-file.<br></p>
</div>
<div class="paragraph">
<p>The zip-file you can upload to zookeeper with the following command on the command line interface.</p>
</div>
<div class="paragraph">
<p>Shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell script">[path to zookeeper in solr]/zkcli.sh -cmd upconfig -confdir [path to solr-config from nexus.eitco.de]/solr-config -confname ecr-config -z [zookeeper host]:[zookeeper port]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bash:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[path to zookeeper in solr]\zkcli.bat -cmd upconfig -confdir [path to solr-config from nexus.eitco.de]\solr-config -confname ecr-config -z [zookeeper host]:[zookeeper port]</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_type_definitions">Type definitions</h6>
<div class="paragraph">
<p>You can annotate a type definition Class with @NOSql. If you do that every attribute in the type definition will be created as field in the Solr schema. If you want to deactivate an attribute of a type definition for Solr you can do the following:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have a type definition which is using the annotation @NOSql you must setup a Solr instance. Otherwise, <em>arveo</em> will not start!
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NOSql</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">PersonSimple</span> {
    <span class="predefined-type">String</span> getFirstName();
    <span class="type">void</span> setFirstName(<span class="predefined-type">String</span> value);

    <span class="annotation">@NOSql</span>(value = <span class="predefined-constant">false</span>)
    <span class="predefined-type">String</span> getLastName();
    <span class="type">void</span> setLastName(<span class="predefined-type">String</span> value);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example only the firstname will be automatically created in the schema of Solr.</p>
</div>
</div>
<div class="sect5">
<h6 id="_fulltext_extraction">Fulltext Extraction</h6>
<div class="paragraph">
<p><em>arveo</em> automatically extracts the content of the type definitions which are annotated with <code>@Type(ObjectType.DOCUMENT)</code> and <code>@NOSql</code>. You must set up the documents conversion service for this functionality. At the following we describe the process of the automatic extraction of Solr:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Arveo saves the documents who are annotated with <code>@NOSql</code> in a queue table named <em>type_definition_name + _ng</em>;</p>
</li>
<li>
<p>Now a job will fetch all entry in the queue table;</p>
</li>
<li>
<p>For each entry which are annotated with <code>@Type(ObjectType.DOCUMENT)</code> arveo will call the document conversion service to extract the fulltext from the content;</p>
</li>
<li>
<p>At the end all information will be saved to Solr.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>More general information about the document service full text extraction can be found <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons/document-conversion-parent/0.0.10-SNAPSHOT/documentation/index.html#_extracting_text_from_a_pdf_file">here</a> and <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons/document-conversion-parent/0.0.10-SNAPSHOT/documentation/index.html#_fulltext_plugins">here</a>.</p>
</div>
<div class="paragraph">
<p>More general information about extracting text with arveo and Solr you can find at chapter <a href="#_fulltext_extraction_2">Fulltext extraction</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solr_security_configuration">Solr security configuration</h4>
<div class="paragraph">
<p>By default, Solr does not use any kind of authorization or authentication. In productive systems, Solr must be secured
by enabling transport encryption, authentication and authorization.</p>
</div>
<div class="paragraph">
<p>The transport encryption can be enabled by enabling HTTPs in Solr. See the
<a href="https://solr.apache.org/guide/8_11/enabling-ssl.html">Solr documentation</a> for instructions. When SSL is enabled, the
url in the configuration property <code>ecr.server.solr.host</code> must use the <em>https</em> scheme.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> can use basic authentication to authenticate requests sent to Solr. Solr provides a basic authentication
plugin that must be enabled as described in the <a href="https://solr.apache.org/guide/8_11/basic-authentication-plugin.html">documentation</a>.
Enabling authentication and authorization in Solr requires uploading a <em>security.json</em> file to Zookeeper. The following
example shows a security.json file that enables the basic auth plugin and a
<a href="https://solr.apache.org/guide/8_11/rule-based-authorization-plugin.html">rule based authorization plugin</a>.</p>
</div>
<div class="paragraph">
<p>There is a <a href="https://github.com/ansgarwiechers/solrpasswordhash">github project</a> containing a tool to generate the value
for the salt and password used in the credentials-property of the basic auth plugin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">authentication</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">blockUnknown</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">class</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">solr.BasicAuthPlugin</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">credentials</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">ecr-solr-user</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">qkxp6hmEeGTaqnEvSmH7f+qytLWd/JcwaUyqpdjt5rg= NERXZefDt7lXYvdZfB0hT3ZCgNFSqI4nJ7kGgbhaTWs=</span><span class="delimiter">&quot;</span></span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Solr users</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">forwardCredentials</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">authorization</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">class</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">solr.RuleBasedAuthorizationPlugin</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">permissions</span><span class="delimiter">&quot;</span></span>: [
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">schema-edit</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">role</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">role</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>
      },
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">read</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">role</span><span class="delimiter">&quot;</span></span>: [
          <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>,
          <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>
        ]
      }
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">user-role</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">ecr-solr-user</span><span class="delimiter">&quot;</span></span>: [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>
      ]
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable basic auth support for the Solr client used by <em>arveo</em>, you have to set the following parameters in the
configuration for <em>arveo</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">ecr</span>:
  <span class="key">server</span>:
    <span class="key">solr</span>:
      <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ecr-solr-user</span><span class="delimiter">&quot;</span></span>
      <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_acl_filter_plugin">ACL filter plugin</h4>
<div class="paragraph">
<p>When searching for ACL protected entities in Solr, the search result is filtered by ACL right. This is achieved by
using a custom Solr plugin, which must be installed manually by following the steps below. The Nexus repository
contains a ZIP file with the plugin and all required libraries.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the <code>cmn-user-management-access-control-solr-plugin</code> ZIP (version 5.0.0) from the <a href="https://nexus.eitco.de/repository/maven-public-releases/de/eitco/commons/cmn-user-management-access-control-solr-plugin/5.0.0/cmn-user-management-access-control-solr-plugin-5.0.0-zip.zip">nexus repository</a>.</p>
</li>
<li>
<p>Install the plugin in Solr by extracting the content of the downloaded ZIP file as described in the <a href="https://solr.apache.org/guide/8_11/solr-plugins.html#installing-plugins">Solr documentation</a>.</p>
</li>
<li>
<p>Configure the plugin in <code>solrconfig.xml</code> as shown below:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;queryParser</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aclright</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">de.eitco.commons.user.management.access.control.solr.AclRightParserPlugin</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;str</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">solrAclPlugin.jdbcUrl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>jdbc:postgresql://localhost:5432/mydatabase?currentSchema=mytenant<span class="tag">&lt;/str&gt;</span>
    <span class="tag">&lt;str</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">solrAclPlugin.jdbcUser</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>myuser<span class="tag">&lt;/str&gt;</span>
    <span class="tag">&lt;str</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">solrAclPlugin.jdbcPassword</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>mypassword<span class="tag">&lt;/str&gt;</span>
<span class="tag">&lt;/queryParser&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The plugin requires a JDBC connection to the relational database to load ACL rights. Do not change the name of the
query parser. Solr queries generated by arveo will contain a filter query using the <code>aclright</code> prefix to
perform the actual filtering.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Access Control Solr Plugin does not yet support multiple tenants!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, the configuration parameters for the ACL filter plugin can be set as Java system properties for the
Solr server, as environment variables, or they can be stored as secrets in Vault. To use Vault, set the following
parameters either in the <code>solrconfig.xml</code> file, as Java system properties, or as environment variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>solrAclPlugin.vaultEnabled=true</code></p>
</li>
<li>
<p><code>solrAclPlugin.vaultAddress=https://myvaultserver:port</code> (optional, the default value is "http://127.0.0.1:8200")</p>
</li>
<li>
<p><code>solrAclPlugin.vaultToken=token</code> (optional, can be a token value or the path to a token file. By default, the plugin
will try to load a token from ~/.vault-token)</p>
</li>
<li>
<p><code>solrAclPlugin.vaultSecretEnginePath=path</code> (optional, the default is "secret")</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The order in which the plugin loads configuration properties is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vault</p>
</li>
<li>
<p>System properties</p>
</li>
<li>
<p>Environment variables</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_storing_entities_in_solr">Storing entities in Solr</h4>
<div class="paragraph">
<p>To be able to use Solr for advanced queries, the entities must be stored in Solr, too. To enable this, simply add the
<code>@NOSql</code> annotation to the attributes to be stored in Solr to the getters of your type definitions. The annotation can
be added to the class to store all attributes in Solr. <em>arveo</em> will automatically create the required fields
in the Solr schema. All entities of one tenant will be stored in a single collection in Solr. To avoid name collisions,
the names of the fields in Solr will consist of the name of the type definition and the name of the attribute, separated
by a dot. For example, an attribute called "name" in a type definition called "invoice" would be named "invoice.name".</p>
</div>
</div>
<div class="sect3">
<h4 id="_fulltext_extraction_2">Fulltext extraction</h4>
<div class="paragraph">
<p>It is also possible to store fulltext data of the content of documents in Solr. For this, set the <code>fulltextExtraction</code>
attribute of the <code>@ContentElement</code> annotation to true (see <a href="#_configure_storage_locations">Content Elements</a>). The
fulltext data of the content elements will be stored in a field called
<code>&lt;typeDefinitionName&gt;.&lt;contentElementName&gt;.fulltext</code> in Solr. This field can be used in queries
just like any other field.</p>
</div>
<div class="paragraph">
<p>The fulltext extraction is performed by the document conversion service. Which types of content are supported for
fulltext extraction depends on the active plugins of the document conversion service. The open source plugins contained
in the document conversion service project support fulltext extraction for PDFs with text content and Microsoft Office
documents. The mime type of a content element is required for the fulltext extraction. By default, the mime type is
contained in the metadata of a content element. When the content element is stored in a separate field on the
database, the mime type is not available in the metadata but it can be defined in the <code>@ContentElement</code> annotation. If
the mime type is set to the default value (application/octet-stream), the service will try to auto-detect the mime type.</p>
</div>
</div>
<div class="sect3">
<h4 id="_searching_in_solr">Searching in Solr</h4>
<div class="paragraph">
<p>The <em>arveo</em> API provides methods to perform queries in Solr. The methods use the EQL just like the regular
search methods that perform queries on the relational database. There are some EQL features that are not supported
when searching in Solr:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>joins and unions</p>
</li>
<li>
<p>subselects</p>
</li>
<li>
<p>exists expressions</p>
</li>
<li>
<p>toLower</p>
</li>
<li>
<p>less than</p>
</li>
<li>
<p>greater than</p>
</li>
<li>
<p>is null</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The behavior of the supported query expressions is dependent from the configuration of the field in Solr. For example,
a text field with a tokenizer that splits text by whitespaces will deliver different results for equality expressions
than a text field without such a tokenizer.</p>
</div>
<div class="paragraph">
<p>To perform a query in Solr for one specific type definition, use the <code>getNoSqlSearchService</code> method of the service client
for the type definition. In the following example, this method is used to find an entity by its ID in Solr:</p>
</div>
<div class="listingblock">
<div class="title">Searching for an entity by ID in Solr</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Optional&lt;TypedNOSqlSearchHit&lt;FieldTypeContainer&gt;&gt; optional = serviceClient.getNoSqlSearchService()
    .where().id().equalTo().value(identifier).holds().uniqueResult();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows how to search in the fulltext data stored in Solr.</p>
</div>
<div class="listingblock">
<div class="title">Searching for fulltext data in Solr</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">list = serviceClient.getNoSqlSearchService().where().contextReference(SimpleInvoiceNames.CONTENT_FULLTEXT)
    .contains().value(<span class="string"><span class="delimiter">&quot;</span><span class="content">Gubergren accumsan takimata</span><span class="delimiter">&quot;</span></span>).holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>To search for values in a specific field, the correct field name must be used in the context reference. The auto-
generated name constant classes for the type definition interfaces contain a helper method to compute the name.
The following example shows how to use this method to search in a specific field of an entity.</p>
</div>
<div class="listingblock">
<div class="title">Searching for data in Solr using a specific field</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">list = serviceClient.getNoSqlSearchService().where()
    .contextReference(FieldTypeContainerNames.noSqlName(FieldTypeContainerNames.INTEGER_FIELD))
    .equalTo().value(<span class="integer">7</span>).holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the <code>getNoSqlSearchService</code> method, the query performed in Solr will automatically be limited to entities
belonging to one single type definition. In this case, it is not necessary to use the helper method from the generated
name constant class to compute the name. The service is able to automatically compute the corret name. To search for
entities in multiple type definitions, the method <code>de.eitco.ecr.sdk.SearchClient.searchServiceForNoSql</code> can be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_combined_search">Combined search</h4>
<div class="paragraph">
<p><em>arveo</em> creates a special multi-valued field called <code>ecr_attributes</code> in Solr. When a getter (or an entire
interface) is annotated with <code>@NOSql(combinedSearch = true)</code>, the attribute of the getter (or all attributes of the interface)
will be copied in this field. The <code>ecr_attributes</code> field is of type string. The values of the attributes copied into
this field, will be converted automatically by Solr.</p>
</div>
<div class="paragraph">
<p>The <code>ecr_attributes</code> field can be used for a combined search of all attribute values. This makes it possible to provide
a search method where the user does not need to know the name of the attribute to search for:</p>
</div>
<div class="listingblock">
<div class="title">Performing a combined search</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Optional&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; hit =
    serviceClient1.getNoSqlSearchService().where().noSqlCombinedField().equalTo()
        .value(invoiceNumber).holds().uniqueResult();
Optional&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; hit =
    serviceClient1.getNoSqlSearchService().where().noSqlCombinedField().equalTo()
        .value(invoiceNumber).and().noSqlCombinedField().equalTo().value(<span class="string"><span class="delimiter">&quot;</span><span class="content">29.99</span><span class="delimiter">&quot;</span></span>).holds().uniqueResult();
Optional&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; hit =
    serviceClient1.getNoSqlSearchService().where().noSqlCombinedField().like()
        .value(<span class="string"><span class="delimiter">&quot;</span><span class="content">Kasd invidunt stet dolor</span><span class="delimiter">&quot;</span></span>)
        .and().contextReference(EcrQueryLanguage.COMBINED_SEARCH_FIELD).equalTo().value(invoiceNumber)
        .holds().uniqueResult();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to copy the extracted fulltext data of content elements to the combined <code>ecr_attributes</code> field, too. To
do so, configure the respective content element as shown below:</p>
</div>
<div class="listingblock">
<div class="title">Using combined search for extracted fulltext data</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">pdf</span><span class="delimiter">&quot;</span></span>, contentType = <span class="string"><span class="delimiter">&quot;</span><span class="content">application/pdf</span><span class="delimiter">&quot;</span></span>, fulltextExtraction = <span class="predefined-constant">true</span>, textCombinedSearch = <span class="predefined-constant">true</span>, textCombinedSearchLimit = <span class="integer">200</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The relevant settings are <code>textCombinedSearch=true</code>, which enables the copying of the extracted fulltext data. The
<code>textCombinedSearchLimit</code> setting limits the number of characters to copy. This makes it possible to reduce the size of
the Solr index. A value of <code>0</code> means no limit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_relations_in_solr">Relations in Solr</h4>
<div class="paragraph">
<p>Relations between entities can be described using relation type definitions. While those relations can be easily
resolved in the relational database, NoSQL databases like Solr are not designed to support a relational data model as
shown in the following diagram:</p>
</div>
<div class="literalblock">
<div class="title">A model using a relation table</div>
<div class="content">
<pre> +------------+               +--------+-----+              +------------+
 |   Parent   |               +   Relation   +              |   Child    |
 |------------|      source   |--------------|  target      |------------|
 |            |&lt;--------------|              |-------------&gt;|            |
 |            |               |              |              |            |
 +---+--------+               +--------------+              +------------+</pre>
</div>
</div>
<div class="paragraph">
<p>It is still possible to search for <em>Parent</em> entities by the IDs of the related <em>Child</em> entities in Solr using
arveo. To make this possible arveo stores the IDs of the <em>Child</em> entities related to a <em>Parent</em>
entity in a multi value field in Solr. To enable this feature, the type definition interface of the <em>Parent</em> type
must be annotated with <code>@NOSqlResolvedRelations</code>. The annotation requires a parameter containing the type definition
classes of the relations to store in Solr.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Only relations from the current version of the <em>Parent</em> entity to the current version of the <em>Child</em> entity can be
stored in Solr.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows how to search for entities by related child IDs:</p>
</div>
<div class="listingblock">
<div class="title">Searching for relation child IDs in Solr</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;TypedNOSqlSearchHit&lt;SimpleInvoice&gt;&gt; list = documentServiceClient.getNoSqlSearchService().where() <i class="conum" data-value="1"></i><b>(1)</b>
    .contextReference(noSqlSearchHelper.getRelationChildIdsField(SimpleInvoice.class, InvoicePersonRelation.class)) <i class="conum" data-value="2"></i><b>(2)</b>
    .contains().value(containerClient.getIdentifier()).holds().unpaged(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain a NoSql search service from the service client for the <em>Parent</em> entity type definition</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using an (injectable) instance of <code>NoSqlSearchHelper</code> it is possible to get the name of the field containing the
child IDs in Solr</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the ID of the child entity to search for from the entity client of the relation child entity</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_rebuilding_the_solr_index">Rebuilding the Solr index</h4>
<div class="paragraph">
<p>Currently, there is no automated way to rebuild the Solr index. If the data in Solr was lost or corrupted, it can be
rebuilt using the NOSql queue tables of the affected type definitions.</p>
</div>
<div class="paragraph">
<p>When an entity is added or updated in a type
definition that is annotated with <code>@NOSql</code>, an entry for this entity is added to a queue table by a trigger on the
database. This queue table is named like the main table for the type definition with a <code>_nq</code> suffix. So for example,
if the main table is called <code>my_type_definition</code>, the queue table would be called <code>my_type_definition_nq</code>. It contains
a column for each attribute that is supposed to be contained in Solr and the following system fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nosql_queue_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the entry in the queue. This value is assigned automatically by the database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nosql_processing_counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A counter that is incremented each time the system has tried to store the entry in Solr. The initial value is supposed
 to be 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nosql_trigger_operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the operation that caused the entry to be added to the queue table. Could be INSERT, UPDATE or DELETE.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A system job periodically reads the entries contained in the queue table and stores them in Solr. When the entry was
successfully stored in Solr, it is deleted from the queue. If the entry could not be stored in Solr, the processing
counter is incremented and the job will try again until the maximum number of tries has been reached.</p>
</div>
<div class="paragraph">
<p>To rebuild the Solr index, the data to be stored in Solr has to be added to the queue table by copying the data
contained in the main table of the type definition. By definition, only the most recent version of each entity is
contained in Solr, so the data contained in the version table of the type definition is of no interest here. The
value of the <code>nosql_processing_counter</code> field must be set to 0. To treat the entity as a new object in Solr, set the
value of the <code>nosql_trigger_operation</code> field to <code>INSERT</code>. To perform an update on an already existing object in Solr,
set the value to <code>UPDATE</code>.</p>
</div>
<div class="paragraph">
<p>The code of the trigger function used to populate the queue table might be useful when creating the SQL script that
copies the entries. The trigger function is called like the main table of the type definition with a <code>_ntf</code> suffix.</p>
</div>
<div class="paragraph">
<p>When the type definition makes use of the <code>@NOSqlResolvedRelations</code> annotation, an additional field containing the
resolved IDs of the child entities of the relations on each entity will be contained in the queue table. This field
will be called <code>relation_&lt;type-id&gt;_child_ids</code> where <code>type-id</code> is the numeric ID of the relation type definition. This
ID can be found in the <code>ecr_types</code> table. To store the resolved child IDs in Solr, additional entries for each entity
containing the entity ID, the resolved child IDs, the update counter and the trigger operation are added to the queue
table. Note that the value for the trigger operation field must be set to <code>UPDATE</code> in this case.
The resolved child IDs can be copied from the table containing the relation. The <code>parent_id</code> field in this table will
contain the ID of the entity that is to be stored in Solr. The <code>child_id</code> field contains the IDs of the related child
entities.</p>
</div>
<div class="paragraph">
<p>The code of the trigger function used to populate the queue with the entries containing the resolved child ID might be
useful when writing the SQL script to copy these values. The trigger function will be called like the main table of
the relation type definition with a <code>_nrtf</code> suffix.</p>
</div>
<div class="sect4">
<h5 id="_example_scripts">Example scripts</h5>
<div class="paragraph">
<p>The following examples show how to copy data to the queue table. The main table of the type definition in the example
is called <code>test_simple_invoice</code>.</p>
</div>
<div class="listingblock">
<div class="title">copying data from the main table to the queue table</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">insert</span>
    <span class="class">into</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">test_simple_invoice_nq</span><span class="delimiter">&quot;</span></span>(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">version_number</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">latest_version_id</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">version_comment</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">initial_creation_date</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">creator_user_id</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">retention_date</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">modification_user_id</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">creation_date</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">update_counter</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">last_delete_restore_date</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">litigation_hold</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">deleted</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">parent_id</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">modification_date</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">acl_id</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">invoice_number</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">nosql_processing_counter</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">nosql_trigger_operation</span><span class="delimiter">&quot;</span></span>
    )
<span class="class">select</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">version_number</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">latest_version_id</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">version_comment</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">initial_creation_date</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">creator_user_id</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">retention_date</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">modification_user_id</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">creation_date</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">update_counter</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">last_delete_restore_date</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">litigation_hold</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">deleted</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">parent_id</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">modification_date</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">acl_id</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">invoice_number</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">0</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">INSERT</span><span class="delimiter">'</span></span>
<span class="keyword">from</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test_simple_invoice</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">copying the resolved child IDs to the queue table</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">insert</span>
    <span class="class">into</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">test_simple_invoice_nq</span><span class="delimiter">&quot;</span></span>(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">relation_32877_child_ids</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">nosql_processing_counter</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">nosql_trigger_operation</span><span class="delimiter">&quot;</span></span>
    )
<span class="class">select</span> <span class="keyword">distinct</span>
    a.<span class="string"><span class="delimiter">&quot;</span><span class="content">parent_id</span><span class="delimiter">&quot;</span></span>,
    array(<span class="class">select</span> b.<span class="string"><span class="delimiter">&quot;</span><span class="content">child_id</span><span class="delimiter">&quot;</span></span> <span class="keyword">from</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test_invoice_person_relation</span><span class="delimiter">&quot;</span></span> b
        <span class="keyword">where</span> b.<span class="string"><span class="delimiter">&quot;</span><span class="content">parent_id</span><span class="delimiter">&quot;</span></span> = a.<span class="string"><span class="delimiter">&quot;</span><span class="content">parent_id</span><span class="delimiter">&quot;</span></span> <span class="keyword">and</span> b.<span class="string"><span class="delimiter">&quot;</span><span class="content">parent_version_id</span><span class="delimiter">&quot;</span></span> <span class="keyword">is</span> <span class="predefined-constant">null</span>),
    <span class="integer">0</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">UPDATE</span><span class="delimiter">'</span></span>
<span class="keyword">from</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test_invoice_person_relation</span><span class="delimiter">&quot;</span></span> a;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_system_jobs">System jobs</h3>
<div class="paragraph">
<p>The <em>arveo</em> system uses several background jobs to perform essential functions. These jobs are managed by
a clustered Quartz scheduler running inside the repository service and/or in a dedicated job service. The scheduler
instances are synchronized using the database. The repository service creates the jobs and initial trigger configurations
when the system is started for the first time. Afterwards, it is possible to modify the scheduled jobs manually.</p>
</div>
<div class="paragraph">
<p>By default, the scheduler embedded in the repository service is used to create and to execute the jobs. Dedicated job
service instances configured to use the same database as the repository service can be used to execute the jobs as well.
It is also possible to start the scheduler embedded in the repository service in standby mode. In standby mode, the
repository service will create the jobs (if required), but it will not execute them.</p>
</div>
<div class="paragraph">
<p>The available configuration parameters for the scheduler are listed here: <a href="#_job_service">Job service</a></p>
</div>
<div class="paragraph">
<p>The available configuration parameters for the jobs are listed here: <a href="#_ecr_server_jobs">Job configuration</a></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the jobs are executed in the external Job Service, it is required to configure the user and the password
to be used for the jobs. The user has to own the required authorities to execute the jobs: <code>ECR_PURGE_RECOVERY_TABLE</code>
and the authority configured in <em>security.general.role-for-secured-access</em> (by default <code>ECR_SERVICE_USER</code>). When the
jobs are executed in the scheduler embedded in the repository service, an internal authentication mechanism is used and
no additional configuration is required.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_clean_recovery_table_job">Clean recovery table job</h4>
<div class="paragraph">
<p>The expired entries in the recovery table (see <a href="#_recovery_log">Recovery</a>) are deleted by the
clean recovery table job. By default, the job is triggered every day at 3 a.m. The user configured to execute the system
jobs needs to have the <code>ECR_PURGE_RECOVERY_TABLE</code> authority to be able to perform this operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nosql_queue_job">NOSQL queue job</h4>
<div class="paragraph">
<p>Data that is supposed to be stored in the SOLR NOSQL database is stored in dedicated queue tables in the relational
database used by <em>arveo</em>. The NOSQL queue job is used to read the data from the queue tables and to write
it to SOLR. By default the job is scheduled once a second individually for every queue table in the system. It is
possible to configure the number of entries to process in one run of the job as well as the maximum number of attempts
to write the data to SOLR.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When the NOSQL feature is disabled for a type definition, the queue job and the triggers for the queue job
have to be disabled or removed manually from the scheduler.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_external_job_service_instances">Using external Job Service instances</h4>
<div class="paragraph">
<p>It is possible to use one or more external Job Service instances to execute the scheduled system jobs. The service must
be configured to use the same tenants as the repository service. To be able to execute the system jobs,
the job implementations must be present in each of the Job Service&#8217;s class paths. The jobs are available as a ZIP
file (<em>ecr-packaging-jobs-external&lt;version&gt;.zip</em>) that contains all required libraries. Simply extract the contents of
the ZIP file to a directory (e.g. <em>libs</em>) and start the Job Service with the following parameter:
<code>-Dloader.path=libs</code>.</p>
</div>
<div class="paragraph">
<p>The configuration parameters for the jobs are already configured in the database. No further configuration parameters
for the jobs are required in the Job Service&#8217;s configuration. However, the service must be able to authenticate to
the repository service. As the jobs use a username and password to obtain an access token, the service needs OAuth
client registrations both for the <em>client_credentials</em> and for the <em>password</em> grant types. The following example shows
how to configure two client registrations for the service:</p>
</div>
<div class="listingblock">
<div class="title">OAuth client registrations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">spring</span>:
  <span class="key">security</span>:
    <span class="key">oauth2</span>:
      <span class="key">resourceserver</span>:
        <span class="key">jwt</span>:
          <span class="key">issuer-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:39004</span><span class="delimiter">&quot;</span></span>
      <span class="key">client</span>:
        <span class="key">registration</span>:
          <span class="key">autorization-service-client-credentials</span>:
            <span class="key">provider</span>: <span class="string"><span class="content">authorization-service</span></span>
            <span class="key">client-id</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span>
            <span class="key">client-secret</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span>
            <span class="key">authorization-grant-type</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">client_credentials</span><span class="delimiter">&quot;</span></span>
          <span class="key">authorization-service-password</span>:
            <span class="key">provider</span>: <span class="string"><span class="content">authorization-service</span></span>
            <span class="key">client-id</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span>
            <span class="key">client-secret</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span>
            <span class="key">authorization-grant-type</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>
        <span class="key">provider</span>:
          <span class="key">authorization-service</span>:
            <span class="key">issuer-uri</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:39004</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The username and password to use for the jobs can be configured using the following parameters. Note that these parameters
are added to the job configuration data stored for the triggers in the database used by the scheduler. Because these triggers
are created by the scheduler running in the Repository Service (even if this scheduler is set to standby mode), the job
authentication parameters must be configured for the Repository Service.</p>
</div>
<div class="listingblock">
<div class="title">Job user authentication</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">ecr</span>:
  <span class="key">server</span>:
    <span class="key">jobs</span>:
      <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>
      <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the scheduler included in the repository service instances will be used to execute the scheduled jobs, too.
When the scheduler in the repository service is started in standby mode, only the external Job Service instances will
execute the scheduled jobs. The following configuration can be used to start the repository service with a scheduler in
standby mode:</p>
</div>
<div class="listingblock">
<div class="title">Scheduler in standby mode</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">job-service</span>:
  <span class="key">standbyOnlyScheduler</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hashicorp_vault">Using Hashicorp Vault</h3>
<div class="paragraph">
<p><a href="https://www.vaultproject.io/">Hashicorp Vault</a> can be used to store sensitive configuration parameters like database
passwords or encryption master keys. Each <em>arveo</em> service tries to load configuration data from a Vault
instance at startup. To configure the location and access method for Vault, the following application arguments can
be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>spring.cloud.vault.host</code>: Defines the host name of the Vault host.</p>
</li>
<li>
<p><code>spring.cloud.vault.port</code>: Sets the port used to connect to Vault.</p>
</li>
<li>
<p><code>spring.cloud.vault.scheme</code>: Either https or http</p>
</li>
<li>
<p><code>spring.cloud.vault.authentication</code>: Sets the authentication mechanism to use.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
These properties cannot be configured using the Configuration Service. Configuration data from the Configuration Service
is loaded after the connection to Vault has been established. Instead, these properties must be set as application
parameters. Example: <code>java -jar service.jar --spring.cloud.vault.port=8200</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to disable the Vault integration by setting <code>spring.cloud.vault.enabled=false</code>.</p>
</div>
<div class="paragraph">
<p>Additional information about the configuration parameters, especially the possible authentication mechanisms, can be
found in the <a href="https://docs.spring.io/spring-cloud-vault/docs/current/reference/html/#client-side-usage">Documentation</a> of
the Spring Cloud Vault project.</p>
</div>
<div class="sect3">
<h4 id="_defining_secrets">Defining secrets</h4>
<div class="paragraph">
<p>Vault features several ways to provide secrets to applications. Configuration properties for the <em>arveo</em>
services must be stored in the key value secrets engine. Each secret consists of a <em>path</em> and several <em>key-value-pairs</em>.
The path defines the scope of the property. It can either be set to <code>application</code> to store a secret for all services,
or to the name of the service just like the name of the configuration files in the Configuration Service. For example,
to configure the password of the JDBC datasource used by all services, a key-value-pair of <code>spring.datasource.password=password</code>
would be stored under the path <code>application</code>. A property for the repository service (ecr-service) would be stored
in a key-value-pair <code>property=value</code> under the path <code>ecr-service</code>. The following table contains the application names
of the different services.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Application name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repository Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">content-repository-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Management Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">user-management-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Management Access Control Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">user-management-access-control-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise User Management Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">user-management-enterprise-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Conversion Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">document-conversion-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Administration Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">administration-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">audit-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integration Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">integration-service</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_properties">Configuration Properties</h3>
<div class="sect3">
<h4 id="_ecr_server_caching">ecr.server.caching</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">content-access-tokens.expire-after</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time after which an entity in the cache will be expired.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">content-access-tokens.size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of entities in the cache.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-acls.expire-after</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time after which an entity in the cache will be expired.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-acls.size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of entities in the cache.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enums.expire-after</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time after which an entity in the cache will be expired.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enums.size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of entities in the cache.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type-definition-access.expire-after</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time after which an entity in the cache will be expired.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type-definition-access.size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of entities in the cache.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type-definitions.expire-after</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time after which an entity in the cache will be expired.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type-definitions.size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of entities in the cache.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_content-access-tokens">ecr.server.content-access-tokens</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">alias</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The alias of the certificate used to sign the tokens.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The password for the alias.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key-store-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The password for the keystore.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key-store-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The absolute path to the keystore that contains the certificate used to sign the tokens.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key-store-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the keystore (e.g. PKCS12, JKS&#8230;&#8203;)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max-token-lifetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum allowed lifetime of the generated tokens.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1d</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_http">ecr.server.http</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">file.directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.io.File</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The directory used to store the temporary files.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">file.prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The prefix to use for the names of the temporary files.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">temp</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">file.suffix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The suffix to use for the names of the temporary files.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.dat</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">file.threshold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of the file in bytes from which on a temporary file will be used for buffering.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">131072</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_jobs">ecr.server.jobs</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">clean-recovery-table.cron-expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the CRON expression used to schedule the job.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 0 3 * * ?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">clean-recovery-table.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to false, the job will not be scheduled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jms-statistics.cron-expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the CRON expression used to schedule the job.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*/15 * * * * ?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jms-statistics.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to false, the job will not be scheduled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jms-statistics.jms-receive-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the time the job will wait for a reply from the message broker.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no-sql-queue.batch-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of entries to load from the queue table in one batch.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no-sql-queue.cron-expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the CRON expression used to schedule the job.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*/1 * * * * ?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no-sql-queue.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to false, the job will not be scheduled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no-sql-queue.retries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the maximum number of attempts to write an entry in the queue to solr.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the password of the user used to run the jobs.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retention-cleanup.global-settings.asynchronous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, content of documents will be removed from the storage asynchronously using a message queue. The database entries will not be removed but marked as deleted using the COMPLIANCE_DELETED field.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retention-cleanup.global-settings.batch-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the size of a single batch of entities processed by the job.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retention-cleanup.global-settings.max-message-queue-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum acceptable size of the message queues used by the job. Checked when the job is started. If the size of one of the queues exceeds the limit, the job is cancelled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retention-cleanup.global-settings.max-runtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum acceptable runtime for the job. When the time is exceeded, the job is cancelled.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retention-cleanup.global-settings.purge-content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, all content elements of a document and all it&#8217;s versions will be deleted.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retry-renditions.batch-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the number of document versions to select in one run of the job.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retry-renditions.cron-expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the CRON expression used to schedule the job.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 0 3 * * ?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retry-renditions.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to false, the job will not be scheduled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the name of the user used to run the jobs.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_jobs_retention-cleanup">ecr.server.jobs.retention-cleanup</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global-settings.asynchronous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, content of documents will be removed from the storage asynchronously using a message queue. The database entries will not be removed but marked as deleted using the COMPLIANCE_DELETED field.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global-settings.batch-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the size of a single batch of entities processed by the job.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global-settings.max-message-queue-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum acceptable size of the message queues used by the job. Checked when the job is started. If the size of one of the queues exceeds the limit, the job is cancelled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global-settings.max-runtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum acceptable runtime for the job. When the time is exceeded, the job is cancelled.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global-settings.purge-content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, all content elements of a document and all it&#8217;s versions will be deleted.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_liquibase">ecr.server.liquibase</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auto-change-log</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the location used to store the auto generated changelog.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">changeLog/auto.xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">changelog-directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The directory used when generated changelogs are kept. This setting is only relevant when keepChangelogs is set to true.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">changelog</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-change-log</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the location of a custom liquibase changelog to execute on startup after the database schema was initialized. Changelogs can be loaded from the classpath by adding the 'classpath:' prefix. Files must be identified by an absolute path using the prefix 'file:/'.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keep-changelogs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to true, generated changelogs will be kept in separate files in the configured directory.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-initialization-change-log</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the location of a custom liquibase changelog to execute on startup before the database schema was initialized. Changelogs can be loaded from the classpath by adding the 'classpath:' prefix. Files must be identified by an absolute path using the prefix 'file:/'.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_memory">ecr.server.memory</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">buffer-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines how many bytes of data to keep in memory when working with streams before switching to a temporary file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024000</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_messaging">ecr.server.messaging</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">json-messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If enabled, the payload of JMS messages will be a JSON string.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queue-listener-concurrency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the number of threads used for listeners for queues (NOT topics!) via a "lower-upper" String, e.g. "5-10", or a simple upper limit String, e.g. "10" (the lower limit will be 1 in this case).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">redelivery.back-off-multiplier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number to multiply the redelivery delay with for every redelivery attempt.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">redelivery.initial-redelivery-delay</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time in milliseconds to wait until a failed message will be redelivered.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">redelivery.maximum-redeliveries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of redelivery attempts for failed messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">redelivery.use-exponential-back-off</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, the time between redeliveries of a failed message will be multiplied with the backOffMultiplier for each redelivery.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_query">ecr.server.query</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in-condition-optimization-limit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of entries in an in clause from which in the optimized query is used. -1 disables that feature.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no-sql-query-time-warning-millis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the maximum duration in milliseconds for the execution time of queries on the noSql database after which a warning will be logged.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">statement-execution-time-warning-millis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the maximum duration in milliseconds for the execution time of a database statement after which a warning will be logged. This setting applies to the relational database.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_security">ecr.server.security</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type-definition-access-checks-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines whether type definition specific access checks are enabled or not.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_solr">ecr.server.solr</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">collection-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the collection to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ecr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">collection-replicas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default number of replicas for a new collection created by the respository service.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">collection-shards</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default number of shards for a new collection created by the respository service.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">commit-within-millis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the maximum time in milliseconds after which the solr client will perform a commit.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-config-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the default SolrConfig.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">solr-plugin-config</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the host for the connection of the Solr Client.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http-client-connection-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the connection timeout for the Solr HTTP client in milliseconds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The password used for basic authorization to SOLR.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the schema. If null, the collection name is used.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ssl-key-store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the keystore to use for SSL communication.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ssl-key-store-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The password for the SSL keystore.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ssl-tru-ststore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The truststore to use for SSL communication.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ssl-truststore-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The password for the SSL truststore.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">use-ssl-client-auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to use SSL client authentication.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The username used for basic authorization to SOLR.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_storage">ecr.server.storage</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile-aliases</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.util.Map&lt;java.lang.String,java.lang.String&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A mapping of alias names to storage profile names.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile-templates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.util.List&lt;de.eitco.ecr.server.config.StorageProfileTemplate&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of profile templates used by the bucket selector plugin.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profiles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.util.Map&lt;java.lang.String,de.eitco.ecr.server.config.StorageProfileSettings&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map containing all configured storage profiles.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ecr_server_system">ecr.server.system</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch-update-statement-cache-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables the cache for generated batch update SQL statements.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">create-solr-changes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to false when initializing the type schema solr changes will not be executed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">event-listeners-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables the JMS event listeners used to process system events like recycle bin cleanup and the creation of renditions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fetch-jms-statistics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables the regular fetching of JMS statistics from the ecr_jms_statistics table.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">initialize-empty-database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to true, the system will create the schema even if not in maintenance mode should the table ecr_types be empty.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log-schema-changes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to true together with maintenanceMode, the system will only log required changes to the database schema and shut down after the log was written.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maintenance-mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, the server will update the database schema at startup and shut down after the update was finished. This is actually a combination of updateSchema = true and terminateAfterCreation = true.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema-change-log-directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location of the logfile used when checkForSchemaChanges is set to true.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">terminate-after-creation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, the server will terminate after the database schema was created.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tus-upload-service-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The application name of the tus upload service.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tus-upload-service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tus-upload-service-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL path at which the upload service&#8217;s endpoints are available.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/files</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">update-schema</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to update the database schema at startup or not.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_job-service">job-service</h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">standby-only-scheduler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, the scheduler used by the job service will be in standby mode. It will not process any jobs.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait-for-event</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, the scheduler will not start to process events until the {@link de.eitco.commons.job.service.common.StartSchedulerEvent} is sent.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring"><strong>Monitoring</strong></h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>arveo</em> uses <a href="https://docs.spring.io/spring-boot/docs/3.1.2/reference/html/actuator.html">Spring Boot Actuator</a>
to expose a monitoring REST API that can be consumed by monitoring systems like <a href="https://prometheus.io/">Prometheus</a> or
the Administration Service. The Actuator documentation linked above contains information about the available monitoring
data, how to enable or disable specific endpoints and how to configure security.</p>
</div>
<div class="paragraph">
<p>The overview of all actuator endpoints is available at <code>/actuator</code>. Health information is available at <code>/actuator/health</code>.</p>
</div>
<div class="sect2">
<h3 id="_custom_health_indicators">Custom health indicators</h3>
<div class="paragraph">
<p>In addition to the default health indicators, <em>arveo</em> provides the following additional health indicators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>storagePlugins</code>: Checks if at least one storage profile is configured and if all storage plugins configured in the
storage profiles are able to store data.</p>
<div class="ulist">
<ul>
<li>
<p><code>FileSystemPlugin</code>: Checks if the configured storage directory exists and whether the database sequence used to
generate storage IDs is available.</p>
</li>
<li>
<p><code>S3Plugin</code>: Checks if the configured bucket exists. When the last storage operation has failed, the endpoint checks
if the S3 service is available.</p>
</li>
<li>
<p><code>SwiftV2Plugin</code>, <code>SwiftV3Plugin</code>: Checks if the configured container exists. When the last storage operation has
failed, the endpoint checks if the Swift service is available.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>typeDefinitions</code>: Checks if there is at least one registered type definition.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The custom health indicators can be disabled like any other health indicator by setting the configuration property
<code>management.health.key.enabled</code> (where key is the name of the indicator) to false.</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_endpoints">Custom endpoints</h3>
<div class="paragraph">
<p>In addition to the default actuator endpoints, <em>arveo</em> provides the following custom actuator endpoints.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>storageProfiles</code>: Provides a list of all storage profiles and the storage plugin used by each profile.</p>
</li>
<li>
<p><code>typeDefinitions</code>: Provides a list of all type definitions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The custom endpoints can be disabled like any other actuator endpoint by setting the property
<code>management.endpoint.key.enabled</code> (where key is the name of the endpoint) to false.</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_metrics">Custom metrics</h3>
<div class="paragraph">
<p>In addition to the default metrics, <em>arveo</em> provides additional metrics that can be used to monitor the
performance of the system.</p>
</div>
<div class="sect3">
<h4 id="_storage">Storage</h4>
<div class="paragraph">
<p>For each storage profile a metric is available that records the following statistics:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.read.count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of read operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.write.count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of write operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.read.bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total amount of bytes read</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.write.bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total amount of bytes written</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.read.error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of read errors</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.write.error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of write errors</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.read.time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read times</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.storage.write.time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write times</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each metric contains a tag named <code>profile</code> with a value for each configured storage profile.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
These metrics are reset each time the repository service instance is restarted.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Profiles that use the <code>BucketOrganizerPlugin</code> are not included in the metrics. Instead, a separate metric for each of
the referenced profiles used by the bucket organizer profile is available.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to disable the recording of these metrics by setting the following parameters to false. This does not
only disable the availability of the metrics but the entire recording mechanism.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">management</span>:
  <span class="key">metrics</span>:
    <span class="key">enable</span>:
      <span class="key">ecr</span>:
        <span class="key">storage</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relational_database">Relational database</h4>
<div class="paragraph">
<p>The following metrics are collected for operations on the relational database:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.rdb.statement</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum and total execution time as well as the number of executed database statements</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.rdb.error.count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of database errors</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.rdb.time.warning</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of statements that took longer than the configured threshold to execute</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each of these metrics contains a tag for the current tenant and the type of statement that was executed. The threshold
time after which an execution time warning is logged and the counter is incremented can be configured using the setting
<code>ecr.server.query.statementExecutionTimeWarningMillis</code> (in milliseconds).</p>
</div>
<div class="paragraph">
<p>The recording of these metrics can be disabled using the following configuration parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">management</span>:
  <span class="key">metrics</span>:
    <span class="key">enable</span>:
      <span class="key">ecr</span>:
        <span class="key">rdb</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solr_2">Solr</h4>
<div class="paragraph">
<p>The following metrics are collected for the Solr object database:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.solr.add</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum and total time as well as a counter for add operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.solr.query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum and total time as well as a counter for query operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.solr.deletebyid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum and total time as well as a counter for delete-by-id operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.solr.error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A counter for all Solr exceptions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.solr.time.warning</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of queries that took longer than the configured threshold to execute:</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All of the above metrics contain a tag for the current tenant. The error counter contains a tag for the type of operation
that has failed. The threshold time after which an execution time warning is logged and the counter is incremented can
be configured using the setting <code>ecr.server.query.noSqlQueryTimeWarningMillis</code> (in milliseconds).</p>
</div>
<div class="paragraph">
<p>It is possible to disable the collection of these metrics using the following configuration parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">management</span>:
  <span class="key">metrics</span>:
    <span class="key">enable</span>:
      <span class="key">ecr</span>:
        <span class="key">solr</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jms_queues">JMS queues</h4>
<div class="paragraph">
<p><em>arveo</em> provides metrics to monitor the state of the JMS queues used for asynchronous operations. These
metrics rely on the <a href="https://activemq.apache.org/statisticsplugin">statistics plugin</a> of ActiveMQ to retrieve statistics.
The plugin must be activated in <code>activemq.xml</code> as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;broker...&gt;</span>
    <span class="tag">&lt;plugins&gt;</span>
        <span class="tag">&lt;statisticsBrokerPlugin</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/plugins&gt;</span>
<span class="tag">&lt;/broker&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The statistics collected by the statistics plugin are polled periodically by a job running in the repository service.
The job is disabled by default. To activate it, set the following parameters in the configuration of the repository
service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">ecr</span>:
  <span class="key">server</span>:
    <span class="key">jobs</span>:
      <span class="key">jms-statistics</span>:
        <span class="key">cron-expression</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*/15 * * * * ?</span><span class="delimiter">&quot;</span></span>
        <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example configuration above, the job is triggered every 15 seconds.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Unlike other system jobs, this job always runs within the repository service. It cannot be offloaded to a separate job
service instance.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following metrics will be available once the job was activated:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.jms.queue.size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of messages currently contained in the queue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.jms.queue.enqueuecount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total number of messages that have been enqueued in the queue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.jms.queue.dequeuecount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total number of messages that have been dequeued from the queue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.jms.queue.averageenqueuetime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The average time a message was enqueued before it was dequeued.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each metric contains a tag called <code>queue</code> containing the name of the queue. The following queues are currently used
by the repository service:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Queue</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr-queue-content-to-purge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains messages containing IDs of content elements that have to be purged from the
  storage.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr-queue-delete-recycled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains messages with a delivery delay that will cause an entity to be deleted from the
  recycle bin once it&#8217;s recycle delay has expired.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr-queue-create-renditions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains messages of renditions that have to be created for new content elements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DLQ.ecr-queue-create-renditions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The dead letter queue for the ecr-queue-create-renditions queue. This is used to
  set the rendition availability status to failed once all retries for the creation of a rendition have failed.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_type_definitions_2">Type definitions</h4>
<div class="paragraph">
<p><em>arveo</em> provides metrics for several operations for each type definition. The following metrics are available:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.read</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for read operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.read.error.client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for read operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.read.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for read operation errors caused by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.delete</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for delete operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.delete.error.client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for delete operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.delete.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for delete operation errors caused by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for create operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.create.error.client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for create operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.create.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for create operation errors caused by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.update</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for update operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.update.error.cliet</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for update operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.update.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for update operation errors caused by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.recycle</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for recycle operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.recycle.error.client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for recycle operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.recycle.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for recycle operation errors caused by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.restore</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for restore operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.restore.error.client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for restore operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.restore.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for restore operation errors caused by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.find</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for find operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.find.error.client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for find operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.find.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for find operation errors caused by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.batchupdate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter and time measurements for batchupdate operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.batchupdate.error.client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for batch update operation errors caused by the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ecr.typedefinition.batchupdate.error.server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter for batch update operation errors caused by the server.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each of these metrics has a tag called <code>type-definition</code> containing the name of the type definition the measurement
was taken for.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prometheus">Prometheus</h3>
<div class="paragraph">
<p><em>arveo</em> provides an actuator endpoint that can be used to collect metrics data using <a href="https://prometheus.io/">Prometheus</a>.
Prometheus collects data by periodically calling configured sources ("scrapes"). The following example shows an entry
in the <code>prometheus.yml</code> file for a scrape configuration that collects data from the prometheus actuator endpoint every
15 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">global</span>:
  <span class="key">scrape_interval</span>: <span class="string"><span class="content">15s</span></span>
  <span class="key">evaluation_interval</span>: <span class="string"><span class="content">15s</span></span>

<span class="key">scrape_configs</span>:
  - <span class="string"><span class="content">job_name: 'arveo'</span></span>
    <span class="key">metrics_path</span>: <span class="string"><span class="content">'/actuator/prometheus'</span></span>
    <span class="key">static_configs</span>:
      - <span class="string"><span class="content">targets: ['localhost:39001']</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The metrics support of <em>arveo</em> is based on <a href="https://micrometer.io">Micrometer</a>. To support monitoring systems
like Prometheus, micrometer remembers the last maximum value of time based metrics for a configurable amount of time.
This time should be close to the scrape interval of Prometheus and can be
configured in the configuration properties of <em>arveo</em> as shown in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">management</span>:
  <span class="key">metrics</span>:
    <span class="key">export</span>:
      <span class="key">prometheus</span>:
        <span class="key">step</span>: <span class="string"><span class="content">15s</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The data collected by Prometheus can be visualized using <a href="https://grafana.com/oss/grafana/">Grafana</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_other_monitoring_systems">Other monitoring systems</h3>
<div class="paragraph">
<p>Support for other monitoring system then Prometheus can be enabled by adding the required library to the classpath.
The <a href="https://docs.spring.io/spring-boot/docs/3.1.2/reference/htmlsingle/#actuator.metrics.export">Spring Boot documentation</a>
contains a list of the supported monitoring systems and further information about how to configure them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_attributes_in_mdc">Attributes in MDC</h3>
<div class="paragraph">
<p><em>arveo</em> adds the following additional attributes to the mapped diagnostic context (MDC) of the logging framework
to make it easier to analyze the system&#8217;s behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ecr.user-id</code>: The ID of the user performing the current request, if available</p>
</li>
<li>
<p><code>ecr.tenant</code>: The tenant for which the current request is executed.</p>
</li>
<li>
<p><code>ecr.trace-id</code>: The ID of the current trace, if available. The trace-id is set by Open Telemetry (see below).</p>
</li>
<li>
<p><code>ecr.span-id</code>: The ID of the current span, if available. The span-id is set by Open Telemetry (see below).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These attributes are added using a <code>HandlerInterceptor</code> for the REST endpoints using Spring WebMVC. Note that these
attributes will not be added when <em>arveo</em> is used embedded. In this case, the application using the embedded
<em>arveo</em> instance is responsible for adding required information to the MDC.</p>
</div>
<div class="paragraph">
<p>Depending on the logger appender in use, it is possible to add these attributes to log messages. See the
<a href="https://logback.qos.ch/manual/mdc.html">documentation</a> of logback for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_open_telemetry">Open Telemetry</h3>
<div class="paragraph">
<p><em>arveo</em> supports using <a href="https://opentelemetry.io/">Open Telemetry</a> to monitor the system&#8217;s behavior. Most notably
it is possible to view traces of requests across the different services using a tracing backend like
<a href="https://www.jaegertracing.io/">Jaeger</a> or <a href="https://zipkin.io/">Zipkin</a>. The outermost span of a trace that was started by
a user&#8217;s request will contain the <code>ecr.user-id</code> and <code>ecr.tenant</code> attributes containing the user&#8217;s ID and the current
tenant. This is done by the same mechanism as described above for the <a href="#_attributes_in_mdc">MDC</a>.</p>
</div>
<div class="paragraph">
<p>Because <em>arveo</em> is based on several widely used open source libraries, the automatic instrumentation mode of
Open Telemetry can be used to record traces. This is done by the Open Telemetry java agent as described in the
<a href="https://opentelemetry.io/docs/instrumentation/java/automatic/">Open Telemetry documentation</a>.</p>
</div>
<div class="paragraph">
<p>The following example shows the required parameters to use Open Telemetry with Jaeger for the repository service.</p>
</div>
<div class="listingblock">
<div class="title">Start parameters for Open Telemetry</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">-Dotel.traces.exporter=jaeger
-Dotel.metrics.exporter=none
-Dotel.service.name=repository-service
-javaagent:&lt;path&gt;/opentelemetry-javaagent.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The metrics export is disabled in the above example. As described in the sections above, metrics can be collected using
the actuator endpoints.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_control"><strong>Access Control</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_access_rights">Access rights</h3>
<div class="paragraph">
<p>The REST API has the following user-rights (authorities) for different endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ECR_SERVICE_USER</strong> (configurable): Required authority for all API endpoints. Must always be present.</p>
</li>
<li>
<p><strong>ECR_ADMIN</strong>: Allows editing type- and attribute definitions as well as other administrative operations.</p>
</li>
<li>
<p><strong>ECR_DSGVO_ADMIN</strong>: Allows a user to change the litigation hold and retention settings of entities contained in type
definitions using the retention feature.</p>
</li>
<li>
<p><strong>ECR_DSGVO_PRIVILEGED_DELETE</strong>: An addition to ECR_DSGVO_ADMIN that allows a user to delete an entity which is still
within it&#8217;s retention period. Organisational precautions must be put in place to ensure DSGVO compliance when making use
of this authority.</p>
</li>
<li>
<p><strong>ECR_ALL_TYPES_READ</strong>: Allows read access to all type definitions that use type level access restrictions.</p>
</li>
<li>
<p><strong>ECR_ALL_TYPES_WRITE</strong>: Allows write access to all type definitions that use type level access restrictions.</p>
</li>
<li>
<p><strong>ECR_PURGE_RECOVERY_TABLE</strong>: Allows a user to trigger the removal of expired entries in the recovery table.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_access_control_lists">Access control lists</h3>
<div class="paragraph">
<p><em>arveo</em> makes use of access control lists (ACLs) to protect entities. Each entity can be protected by one ACL.
The handling of ACLs is performed by the Access Control Service. The documentation of the Access Control Service contains
more information about the general concept of the ACLs used by <em>arveo</em>.</p>
</div>
<div class="sect3">
<h4 id="_mapping_of_the_access_control_list_values">Mapping of the Access Control List values</h4>
<div class="paragraph">
<p>Although the module <code>user-management-access-control</code> defines the concepts and functionality of the ACLs, the actual
mapping of the values is implemented in <em>arveo</em>. The class <code>de.eitco.ecr.acl.AclRight</code> implements the
following permissions using the numeric values shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * The user is allowed to see the object's meta data but not the content.
 */</span>
BROWSE(<span class="integer">4000</span>),

<span class="comment">/**
 * The user is allowed to see the meta data and content of the object.
 */</span>
READ(<span class="integer">8000</span>),

<span class="comment">/**
 * The user is allowed to add annotations to the object.
 */</span>
COMMENT(<span class="integer">12000</span>),

<span class="comment">/**
 * The user is allowed to change meta data and content of the object creating a new version.
 */</span>
WRITE(<span class="integer">16000</span>),

<span class="comment">/**
 * The user is allowed to overwrite an existing version of the object.
 */</span>
OVERWRITE(<span class="integer">20000</span>),

<span class="comment">/**
 * The user is allowed to delete the object.
 */</span>
DELETE(<span class="integer">24000</span>),

<span class="comment">/**
 * The user is allowed to change the ACL of the object.
 */</span>
CHANGE_ACL((<span class="predefined-type">Short</span>.MAX_VALUE - <span class="integer">1</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>To illustrate the information above, here are some examples:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The permission COMMENT is assigned to a group or a job position. In this case, the assignee is per default granted
the permissions BROWSE and READ;</p>
</li>
<li>
<p>The prohibition WRITE is assigned to a group or a job position. In this case, the assignee is per default prohibited
all the higher rights, so OVERWRITE, DELETE and CHANGE_ACL;</p>
</li>
<li>
<p>A job position J1 with the permission COMMENT acts as a substitute for a job position J2 with the permission OVERWRITE.
So the job position J1 is assigned the permission OVERWRITE for the time of the substitution.</p>
</li>
<li>
<p>A job position J1 with the prohibition WRITE acts as a substitute for a job position J2 with the prohibition READ.
The job position J1 is still assigned the prohibition WRITE for the time of the substitution. This way, it is guaranteed,
that J1 is still able to perform their tasks (which would become impossible if they were assigned stronger prohibitions,
that is, the prohibitions of J2).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_batch_updates_for_acls">Batch updates for ACLs</h4>
<div class="paragraph">
<p>It is possible to change values of multiple ACLs. So lists of ACLs, that satisfy a certain condition, can be processed.
For every ACL, that fulfills a given condition, the following modifications can be specified:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>addgroupright (adds a given right to a given group in every ACL that fulfills the condition);</p>
</li>
<li>
<p>adduserright (adds a given right to a given user in every ACL that fulfills the condition);</p>
</li>
<li>
<p>keepgroupright (keeps the current right of a given group in every ACL that fulfills the condition);</p>
</li>
<li>
<p>keepuserright (keeps the current right of a given user in every ACL that fulfills the condition).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All the other entries in the ACLs that fulfill the condition, are removed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ACL updates are performed in the the module 'common', in the Client SDK by the class <em>AclServiceClient</em>. It calls the
method <em>updateAclsWhere()</em> and passes two parameters: an <em>Expression</em> of type <em>Boolean</em> (the condition mentioned above)
and a <em>List</em> of type <em>AccessControlListModification</em> as modifications (the four modifications mentioned above) to apply
to every ACL. The method <em>updateAclsWhere()</em> executes the given ACL batch updates.</p>
</div>
<div class="paragraph">
<p>There is also a more convenient method with the same name updateAclsWhere(), that returns a <em>ConditionBuilder</em>, that can
be used in searches (see <a href="#_search_service">Search Service</a>).</p>
</div>
<div class="sect4">
<h5 id="_example_of_usage">Example of usage</h5>
<div class="paragraph">
<p>Consider the following snippet from a test class as an example of the batch update functionality for the ACLs.
Pay attention to the method <em>setRightsTo()</em>, which is called to modify the current rights.</p>
</div>
<div class="listingblock">
<div class="title">Example of batch update functionality</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        aclServiceClient.updateAclsWhere().contextReference(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>).in().values(
                acl1.getIdentifier().getValue(),
                acl2.getIdentifier().getValue()
            ).holds()
            .setRightsTo(GrantAndDeny.grant(AclRight.READ)).of(umAdmin.getIdentifier())
            .execute();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_attribute_based_access_control_abac">Attribute Based Access Control (ABAC)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>arveo allows entity access based on attributes of that entity.
This can be specified per entity by a static method annotated with <code>@Security</code>.
The method must return an eql expression that resolves to a boolean i.e. a condition.
It will be called by arveo when entities of the given type are accessed to retrieve an additional filter for the access.
<strong>Operations will only affect entities where the condition evaluates to true.</strong></p>
</div>
<div class="paragraph">
<p>Every operation on entities of the type will execute the method and add the resulting expression to the filter of the operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Searches will add the expression to the filter of the search request.</p>
</li>
<li>
<p>Batch operations will add the expression to their filter</p>
</li>
<li>
<p>Calls that operate on a specific id will fail if the expression yields <code>false</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The simplest case would look like this:</p>
</div>
<div class="listingblock">
<div class="title">The simplest access check</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>
<span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UnsecuredDocuments</span> {

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; calculateAccess() {

        <span class="keyword">return</span> Eql.alwaysTrue();
    }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This would add the filter 'true' to every operation on the entity, which would allow anyone to access entities.</p>
</div>
<div class="paragraph">
<p>In most cases, one would want to compare attributes of the entity with properties of the user requesting the current operation.
The first can be accomplished with the eql:</p>
</div>
<div class="listingblock">
<div class="title">Accessing an attribute</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre>
<span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ThresholdContainer</span> {

    <span class="type">int</span> getThreshold();

    <span class="type">void</span> setThreshold(<span class="type">int</span> threshold);

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; calculateAccess(Alias alias) {

        <span class="keyword">return</span> EcrQueryLanguage.condition().
                        alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">threshold</span><span class="delimiter">&quot;</span></span>).
                                greaterThan().value(<span class="integer">300</span>);
    }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Users may only access entities of the type above where the field 'threshold' is greater than 300.</p>
</div>
<div class="paragraph">
<p>In order to check the user requesting an operation, one can define a parameter to the method of the type <code>AuthenticationContext</code>.
Other information may be accessed this way, too.
The method can have up to four parameters of the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AuthenticationContext</code>: this class holds information about the user requesting the operation.</p>
</li>
<li>
<p><code>AclRight</code>: the right needed to perform the operation.</p>
</li>
<li>
<p><code>Alias</code>: identifies the part of the query that holds the entity</p>
</li>
<li>
<p><code>DSLContext</code>: an entrypoint to the <a href="https://www.jooq.org/doc/3.15/manual/">jooq</a> api bound to the database and schema the table containing the entities is located in.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_parameters">Parameters</h3>
<div class="sect3">
<h4 id="_authenticationcontext_who_requests_the_operation"><code>AuthenticationContext</code>: who requests the operation?</h4>
<div class="paragraph">
<p>The <code>AuthenticationContext</code> holds information about the user requesting the operation.
This parameter will most likely be used in every such method, except for the most basic cases.</p>
</div>
<div class="paragraph">
<p>Take a case where access to a document is specified by a field named <code>access_token</code>.
It holds the name of a user-management authority every user with access to it must have.
If it is null, every user has access to the document:</p>
</div>
<div class="listingblock">
<div class="title">A type specifying different access to different users</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@OverwriteAllowed</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DocumentWithAccessToken</span> {

    <span class="annotation">@Mandatory</span>(<span class="predefined-constant">false</span>)
    <span class="predefined-type">String</span> getAccessToken(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="type">void</span> setAccessToken(<span class="predefined-type">String</span> accessToken);

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; calculateAccess(Alias alias, AuthenticationContext authenticationContext, DSLContext dslContext) { <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="keyword">return</span> EcrQueryLanguage.condition()
            .alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span>).isNull() <i class="conum" data-value="2"></i><b>(2)</b>
            .or()
            .value(authenticationContext.getAuthorities())
            .contains().alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span>)
            .holds();
    }

    <span class="comment">// ...</span>
    <span class="comment">// more attributes </span><i class="conum" data-value="3"></i><b>(3)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the type defines the attribute that specifies access</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the query generated uses this attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>other elements of the type are omitted for the sake of readability</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>note that the third parameter is unused. In such a case it could be omitted.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_aclright_what_will_the_operation_do"><code>AclRight</code>: what will the operation do?</h4>
<div class="paragraph">
<p>The <code>AclRight</code> parameter holds the right necessary to perform the operation requested.
This is a hint for the method about what should actually be done in the operation.
It allows differentiating between read and write access:</p>
</div>
<div class="listingblock">
<div class="title">A type differentiating between read and write access</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@OverwriteAllowed</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ContainerAccessedByUserId</span> {

    <span class="type">long</span> getOwner(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="type">void</span> setOwner(<span class="type">long</span> owner);

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; getAudience(); <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="type">void</span> setAudience(<span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; audience);

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; checkAccess(Alias alias, AuthenticationContext authenticationContext, AclRight right) {

        <span class="type">long</span> userId = authenticationContext.getUser().getIdentifier().getValue();

        <span class="keyword">if</span> (AclRight.READ.getValue() &lt; right.getValue()) { <i class="conum" data-value="3"></i><b>(3)</b>

            <span class="keyword">return</span> EcrQueryLanguage.condition().alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">owner</span><span class="delimiter">&quot;</span></span>).equalTo().value(userId).holds();
        }

        <span class="keyword">return</span> EcrQueryLanguage.condition()  <i class="conum" data-value="4"></i><b>(4)</b>
            .alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">audience</span><span class="delimiter">&quot;</span></span>).contains().value(userId)
            .or().alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">owner</span><span class="delimiter">&quot;</span></span>).equalTo().value(userId)
            .holds();
    }

    <span class="comment">// ...</span>
    <span class="comment">// more attributes</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This type defines an attribute <code>owner</code> holding the user id of the user, responsible.
The owner of an entity will be the only user to modify the entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The type also defines a list of user ids <code>audience</code>, holding the ids of users that may read the entity.
Users that are neither <code>owner</code> nor <code>audience</code> have no access on the entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Thus, in cases where a right greater than <code>READ</code> is requested, the method returns an expression, that checks whether the current user is the owner of the document.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In every other case .i.e. the requested access right is <code>READ</code> or below, an expression is returned, that checks whether the current user is the owner or part of the audience.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_alias"><code>Alias</code></h4>
<div class="paragraph">
<p>The alias identifies the part of the query executed that contains the entity and should be used to reference its members.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Always use the alias as given in the examples.
Other ways to reference the entity might work in most cases but only using the alias assures that referencing entity attributes works in every case.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The full class name is <code>de.eitco.ecr.common.search.Alias</code>.
Avoid confusion with another <code>Alias</code> class.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_dslcontext"><code>DSLContext</code></h4>
<div class="paragraph">
<p>In some cases, using expressions on the entity itself may become cumbersome or slow.
For that, one can use the DSLContext parameter.
This allows access by <a href="https://www.jooq.org/doc/3.15/manual/">jooq</a> to any table in the same schema the table of the requested entity is located in.
It can be used to obtain specific data directly.</p>
</div>
<div class="paragraph">
<p>Since the access is directly to the database, there are no further access checks on queries using DSLContext.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Depending on the operation requested, the method may be able to execute <code>INSERT</code> or <code>UPDATE</code> statements.
It is the responsibility of the security methods author to make sure changes do not create an inconsistent or otherwise corrupted state of the database.
The simplest way to assure this, is to use the DSLContext only to read data.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_2">Examples</h3>
<div class="sect3">
<h4 id="_subselect">Subselect</h4>
<div class="paragraph">
<p>There might be cases where the attribute defining access is not part of the entity itself, but part of another entity referred to by a foreign key or a relation.
In such cases a subselect comes handy.
Assume two entity types: documents, to which access is restricted by an attribute named <code>owner_group</code> which is part of the second entity a container.
An owner group must be given Documents are linked to their container with a foreign key named <code>contained_in</code>:</p>
</div>
<div class="listingblock">
<div class="title">The container entity</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre>
<span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">OwnedContainer</span> {

    <span class="type">long</span> getOwnerGroup(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="type">void</span> setOwnerGroup(<span class="type">long</span> ownerGroup);


    <span class="comment">// ...</span>
    <span class="comment">// more attributes</span>

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The document entity</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
  <td class="code"><pre>
<span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">OwnedDocument</span> {

    <span class="annotation">@ForeignKey</span>(target = OwnedContainer.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
    ContainerId getContainedIn(); <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="type">void</span> setContainedIn(ContainerId container);

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; calculateAccess(Alias alias, AuthenticationContext authenticationContext) {

        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; groupIds = authenticationContext.getAllGroups().stream().map(group -&gt; group.getIdentifier().getValue()).collect(Collectors.toList()); <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="keyword">return</span> EcrQueryLanguage.condition().alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">contained_in</span><span class="delimiter">&quot;</span></span>).in() <i class="conum" data-value="4"></i><b>(4)</b>
            .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>).from(<span class="string"><span class="delimiter">&quot;</span><span class="content">owned_container</span><span class="delimiter">&quot;</span></span>).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span>).where().
            contextReference(<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">owner_group</span><span class="delimiter">&quot;</span></span>).in().values(groupIds).holds().holds();
    }

    <span class="comment">// ...</span>
    <span class="comment">// more attributes</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The entity <code>OwnedContainer</code> holds the attribute that specifies access.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity <code>OwnedDocument</code> is linked with a container by its attribute <code>contained_in</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>AuthenticationContext</code> is used to obtain the ids of every group the current user is a member of.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The group ids are used to create a check whether the entity is contained in a container whose <code>owner_group</code> is one of the users groups.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_inheritance">Interface inheritance</h3>
<div class="paragraph">
<p>Since attribute based security - by definition - is based on attributes, it must be able to be specified by type.
However, in some cases a more general solution is desired.
In these cases, java interface inheritance comes handy.</p>
</div>
<div class="paragraph">
<p>Assume the class <code>DocumentWithAccessToken</code> from above.
Assume further that there are other types (<code>ContainerWithAccessToken</code> and <code>FolderWithAccessToken</code>) that should be secured by their access-token as well.
In this case it is a good practice to combine the access method and field in a common superinterface:</p>
</div>
<div class="listingblock">
<div class="title">Superinterface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">WithAccessToken</span> {

    <span class="annotation">@Mandatory</span>(<span class="predefined-constant">false</span>)
    <span class="predefined-type">String</span> getAccessToken();

    <span class="type">void</span> setAccessToken(<span class="predefined-type">String</span> accessToken);

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; calculateAccess(Alias alias, AuthenticationContext authenticationContext) {

        <span class="keyword">return</span> EcrQueryLanguage.condition() <i class="conum" data-value="1"></i><b>(1)</b>
            .alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span>).isNull()
            .or()
            .alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span>).in()
            .values(<span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(authenticationContext.getAuthorities()))
            .holds();
    }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The check for the access token is defined here.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>note that this interface does not specify an entity by itself, since it lacks a <code>@Type</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then the types itself can simply inherit this feature:</p>
</div>
<div class="listingblock">
<div class="title">Inheriting entity 1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@OverwriteAllowed</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ContainerWithAccessToken</span> <span class="directive">extends</span> WithAccessToken {
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Inheriting entity 2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.FOLDER)
<span class="annotation">@OverwriteAllowed</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">FolderWithAccessToken</span> <span class="directive">extends</span> WithAccessToken {
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_complex_scenario_a_hospital">Complex scenario: a Hospital</h3>
<div class="paragraph">
<p>Here we take a look at a more complex example: a Hospital.
The hospital manages <strong>documents</strong> concerning <strong>cases</strong>.
A case belongs to a <strong>patient</strong>.
Users of the system are hospital employees and may access data about documents, cases and patients.
These users are part of one or several <strong>wards</strong>.
For every ward there is a group in the system containing the users that are part of this ward.
Cases have a list of wards - that may change over time - where the patient was treated for that case.
Access is specified as follows;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A user may only access cases whose wards contain at least one ward, the user is a member of.</p>
</li>
<li>
<p>A user may only access patients whose cases he may access.</p>
</li>
<li>
<p>A user may only access document whose cases he may access.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cases could be modeled as follows:</p>
</div>
<div class="listingblock">
<div class="title">The case</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MedicalRecordCase</span> {

    <span class="annotation">@Mandatory</span>
    <span class="annotation">@ForeignKey</span>(target = MedicalRecordPatient.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
    ContainerId getPatient();  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="type">void</span> setPatient(ContainerId containerId);

    <span class="annotation">@Mandatory</span>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getWards(); <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="type">void</span> setWards(<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; wards);

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; groupNames = authenticationContext.getAllGroups() <i class="conum" data-value="3"></i><b>(3)</b>
            .stream().map(group -&gt; group.getEntityName().getValue()).collect(Collectors.toList());

        <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; result = <span class="predefined-constant">null</span>;

        <span class="keyword">for</span> (<span class="predefined-type">String</span> groupName : groupNames) { <i class="conum" data-value="4"></i><b>(4)</b>

            <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; wardCondition = EcrQueryLanguage.condition() <i class="conum" data-value="5"></i><b>(5)</b>
                .alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">wards</span><span class="delimiter">&quot;</span></span>).contains().value(groupName)
                .holds();

            <span class="keyword">if</span> (result == <span class="predefined-constant">null</span>) {

                result = wardCondition;

            } <span class="keyword">else</span> {

                result = Eql.or(result, wardCondition); <i class="conum" data-value="6"></i><b>(6)</b>
            }
        }

        <span class="keyword">if</span> (result == <span class="predefined-constant">null</span>) {

            <span class="keyword">return</span> Eql.alwaysFalse(); <i class="conum" data-value="7"></i><b>(7)</b>
        }

        <span class="keyword">return</span> result;
    }


    <span class="comment">// case attributes ... </span><i class="conum" data-value="8"></i><b>(8)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A case holds a foreign key to a patient.
Since a case must have a patient, this attribute is mandatory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A case has a list of wards, where it was treated.
This attribute is also mandatory.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When computing access, the groups - and thus the wards - of the current user are obtained from the <code>AuthenticationContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Since it is necessary to check whether the intersection between the wards of the case and the groups of the user is not empty, it is iterated over all the groups of the user.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A condition is created that checks whether the entities wards contain the current group.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Access is granted when one of the conditions created yields <code>true</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If the user is in no group whatsoever he may access no case at all.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Further attributes are omitted for the sake of readability.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now Patients specify their security as follows:</p>
</div>
<div class="listingblock">
<div class="title">The patient</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MedicalRecordPatient</span> {

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        Alias caseAlias = Alias.byName(<span class="string"><span class="delimiter">&quot;</span><span class="content">case</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; caseAccessCondition = MedicalRecordCase.access(caseAlias, authenticationContext);  <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="keyword">return</span> EcrQueryLanguage.condition().exists()
            .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>).from(MedicalRecordCase.class).as(caseAlias.getValue()) <i class="conum" data-value="3"></i><b>(3)</b>
            .where()
            .alias(caseAlias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">patient</span><span class="delimiter">&quot;</span></span>).equalTo().alias(alias).id() <i class="conum" data-value="4"></i><b>(4)</b>
            .and(caseAccessCondition).holds().holds(); <i class="conum" data-value="5"></i><b>(5)</b>
    }

    <span class="comment">// patient attributes ...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Access to a patient depends on access to cases.
So, the <code>MedicalRecordCase.access()</code> is called (see above).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In order to do that a custom alias is specified, that is used for the method call and in the query below.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Using a subselect its is checked whether there is a case &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203; that is assigned to the patient the access is checked for and &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>&#8230;&#8203; and to which the current user may access.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Documents may specify their security method very similar, only the document-to-case link is specified the other way around:</p>
</div>
<div class="listingblock">
<div class="title">The document</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MedicalRecordDocument</span> {

    <span class="annotation">@ForeignKey</span>(target = MedicalRecordCase.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Mandatory</span>
    ContainerId getCase(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="type">void</span> setCase(ContainerId containerId);

    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        Alias caseAlias = Alias.byName(<span class="string"><span class="delimiter">&quot;</span><span class="content">case</span><span class="delimiter">&quot;</span></span>);

        <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; caseAccessCondition = MedicalRecordCase.access(caseAlias, authenticationContext); <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="keyword">return</span> EcrQueryLanguage.condition()
            .exists().select(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>).from(MedicalRecordCase.class).as(caseAlias.getValue())
            .where()
            .alias(caseAlias).id().equalTo().alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">case</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
            .and(caseAccessCondition).holds().holds();
    }

    <span class="comment">// patient attributes ...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A document is assigned to a case.
This is mandatory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As for patients, the access check for documents depends on the access check for cases.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A similar subselect to the one above is created, however here the outer select holds the link to the inner one.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_revision_history_and_abac">Revision history and ABAC</h3>
<div class="paragraph">
<p>In the example above access to the entities is defined by one attribute: the wards of a case. It is assumed that a case may be treated in several wards - one after another - and every employee belonging to those wards needs access  to the case, its patients data and its documents. Visiting the wards one after another will result in several updates on the case - each adding another ward - and thus in a revision history where the list of wards will build up over time.</p>
</div>
<div class="paragraph">
<p>This has an interesting consequence in the scenario above : The access to older versions of the case will be granted to users who were allowed to access it at the time the version was created.</p>
</div>
<div class="paragraph">
<p>For instance, if a case started in the pulmonology it would have the following revision list:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If it was moved to intensive care after that, it would result in the following revision list:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology, intensive care</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Employees working in intensive care would be unable to access data of revision 1 of this case.
Depending on the scenario this might or might not be desired.</p>
</div>
<div class="paragraph">
<p>If this is not desired, it can be fixed with a simple annotation on the case interface:</p>
</div>
<div class="listingblock">
<div class="title">An alternative case</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>    <span class="annotation">@Mandatory</span>
    <span class="annotation">@Versioned</span>(value = <span class="predefined-constant">false</span>)
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getWards();

</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>By simply specifying the <code>wards</code> attribute as not versioned, changes on the attribute will affect every revision of the case.
If a case started in the pulmonology it would at first have the same revision history as above:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>However, if it was moved to intensive care now, the revision list would look like this:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">revision</th>
<th class="tableblock halign-left valign-top">ward(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology, intensive care</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulmonology, intensive care</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Now all employees in pulmonology and intensive care have access to every revision of this case.</p>
</div>
<div class="paragraph">
<p>This solution can be used generally.
When access control to entities depends on attributes, deciding whether those attributes are versioned or not is an important detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_external_tables">Accessing external tables</h3>
<div class="paragraph">
<p>Assume that in the hospital from the example above, the information which employee belongs to which ward is kept in a separate table named 'employee_to_ward'.
This table is managed by an external application.</p>
</div>
<div class="sect3">
<h4 id="_using_direct_database_access">Using direct database access</h4>
<div class="paragraph">
<p>As stated earlier, it is possible to add a parameter of the type <code>org.jooq.DSLContext</code> to a security method in order to gain direct access to the database.
This could be used to access the 'employee_to_ward' table:</p>
</div>
<div class="listingblock">
<div class="title">Using DSLContext</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre>    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; access(
        Alias alias,
        AuthenticationContext authenticationContext,
        DSLContext context  <i class="conum" data-value="1"></i><b>(1)</b>
    ) {

        <span class="type">long</span> userId = authenticationContext.getUser().getIdentifier().getValue(); <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; wards = context.selectFrom(<span class="string"><span class="delimiter">&quot;</span><span class="content">test_employee_to_ward</span><span class="delimiter">&quot;</span></span>)
            .where(DSL.field(DSL.name(<span class="string"><span class="delimiter">&quot;</span><span class="content">employee</span><span class="delimiter">&quot;</span></span>)).eq(DSL.value(userId))) <i class="conum" data-value="3"></i><b>(3)</b>
            .fetch(DSL.field(<span class="string"><span class="delimiter">&quot;</span><span class="content">ward</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class));

        <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; result = <span class="predefined-constant">null</span>;

        <span class="keyword">for</span> (<span class="predefined-type">String</span> ward : wards) {

 <span class="comment">// ... (as above) </span><i class="conum" data-value="4"></i><b>(4)</b>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>DSLContext</code> is defined as another parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>AuthenticationContext</code> is only used to get the current users id.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The wards of the user are obtained using the <a href="https://www.jooq.org/doc/3.15/manual/">jooq-api</a> to directly access the database.
Depending on the scenario, it might improve performance to cache the result of this query.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After that, the same code as above is executed.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_a_metadata_type">Using a Metadata type</h4>
<div class="paragraph">
<p>Alternatively, an arveo custom <code>@Type</code> could be used to access the external table:</p>
</div>
<div class="listingblock">
<div class="title">An external type</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span class="annotation">@View</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Name</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">employee_to_ward</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@Type</span>(ObjectType.META)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserToWard</span> {

    <span class="type">long</span> getEmployee();

    <span class="type">void</span> setEmployee(<span class="type">long</span> employee);

    <span class="predefined-type">String</span> getWard();

    <span class="type">void</span> setWard(<span class="predefined-type">String</span> ward);
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@View</code> annotation marks the type as external.
This means arveo will not create the corresponding table.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>@Name</code> annotation specifies the name of the table the types entities are stored in.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, in the security method this type can be accessed with a subselect:</p>
</div>
<div class="listingblock">
<div class="title">Using subselect</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre>    <span class="annotation">@Security</span>
    <span class="directive">static</span> <span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; access(Alias alias, AuthenticationContext authenticationContext) {

        <span class="directive">final</span> Alias userWard = Alias.byName(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_ward</span><span class="delimiter">&quot;</span></span>);  <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="keyword">return</span> EcrQueryLanguage.condition()
            .exists().select(<span class="string"><span class="delimiter">&quot;</span><span class="content">ward</span><span class="delimiter">&quot;</span></span>).from(UserToWard.class).as(userWard.getValue())<i class="conum" data-value="2"></i><b>(2)</b>
            .where()
                .alias(userWard).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">employee</span><span class="delimiter">&quot;</span></span>).equalTo()
                .value(authenticationContext.getUser().getIdentifier().getValue()) <i class="conum" data-value="3"></i><b>(3)</b>
            .and()
                .alias(alias).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">wards</span><span class="delimiter">&quot;</span></span>).contains() <i class="conum" data-value="4"></i><b>(4)</b>
                .alias(userWard).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">ward</span><span class="delimiter">&quot;</span></span>).holds()
            .holds();
    }
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First, an alias is declared for the subselect.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then, a query is created that checks whether there is a ward, that &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>&#8230;&#8203; the current user is assigned to and &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203; that is contained in the current entities <code>wards</code> attribute.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_modelling"><strong>Data Modelling</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_objects_types_definitions">Entity types</h3>
<div class="paragraph">
<p>The following chapter defines entity types and type definitions, used in <em>arveo</em>.</p>
</div>
<div class="paragraph">
<p>To be able to store objects in the database we define a class for entity definitions.So an entity represents a type of data structure used in the <em>arveo</em>.There are five supported entity types.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Document</strong>: an entity that can contain metadata and content. Documents are the only objects that can have content, the content may be binary. Documents can be contained in folders (<a href="#_document_type"><strong>Document</strong></a>).</p>
</li>
<li>
<p><strong>Container</strong>: simple folder-like object not organized in a tree structure but with relations to other objects. A Container contains only metadata and cannot be contained in a folder (<a href="#_container_type"><strong>Container</strong></a>).</p>
</li>
<li>
<p><strong>Relation</strong>: an entity that represents a relation between two other entities. A relation can contain metadata (<a href="#_relation_type"><strong>Relation</strong></a>).</p>
</li>
<li>
<p><strong>Folder</strong>: an entity that contains metadata and is organized in a tree structure like in a file system (<a href="#_folder_type"><strong>Folder</strong></a>)</p>
</li>
<li>
<p><strong>Meta</strong>: an entity that contains only metadata. Unlike containers, metadata entities do not support system attributes like ID and creation date (<a href="#_metadata_type"><strong>Metadata</strong></a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each type definition is represented by one (or more) tables in the database.</p>
</div>
<div class="paragraph">
<p>Each entity is referred by its system-wide unique id, which consists of a tenant id and its type definition id, followed by the sequential database id of this entity:</p>
</div>
<div class="paragraph">
<p>[12bit Tenant id][14bit Type Definition id][38bit Entity id].</p>
</div>
<div class="sect3">
<h4 id="_versioned_entities">Versioned entities</h4>
<div class="paragraph">
<p>All above listed entities (except for meta) are versioned by default. It means that they store version information, modification information. The class <em>VersionInformation</em> combines information about a version, including version id, version number and version comment. The version modification object stores a modification stamp, consisting of a user id and a <em>ZonedDateTime</em> object, both for the events of creation and last modification of the entity. The version information is stored in a separate table for each typed entity.</p>
</div>
<div class="paragraph">
<p>When specifying a type definition, you can decide which attributes of this type definition are versioned.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If none of the attributes are versioned, the entire object is not versioned.
For the type <em>Document</em> the content changes are always versioned.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_custom_types">Custom types</h4>
<div class="paragraph">
<p>You can make your class a type and add features by annotating your classes. You can define the custom metadata schema with simple getter and setter methods.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When you start a project you have to create your own types. Simply annotate the class with the TYPE annotation and define your schema with type safe getter/setter methods (<a href="#_entity_types_examples"><strong>Example</strong></a>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can find the <em>arveo</em>-specific annotations in the module <code>type-definition-annotations</code>. The goal is to create a type, and specify its properties. So annotations precisely define the behavior of the type definitions. When defining a type, a database table is created. To achieve this, you annotate the type definition with <em>@Type</em>. There is an exception to that: when annotating with <em>@View</em> or <em>@Partial_View</em>, no database table is created.</p>
</div>
<div class="paragraph">
<p>There are 2 types of annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotations on types (interfaces): <em>@Target({ElementType.TYPE, ElementType.ANNOTATION_TYPE})</em></p>
</li>
<li>
<p>annotations on properties (getter-methods): <em>@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some annotations can be used both on interfaces and on getter-methods. The annotation <em>ElementType.ANNOTATION_TYPE</em> is used for inherited annotations.
The following annotation groups are used in <em>arveo</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>constraint</strong>: contains annotations that define specific properties or behaviour of attributes;</p>
</li>
<li>
<p><strong>defaults</strong>: contains annotations that define default values of attributes;</p>
</li>
<li>
<p><strong>index</strong>: contains annotations that define indexes on type definitions;</p>
</li>
<li>
<p><strong>naming</strong>: contains annotations that specify names for tables,
attribute definitions, type definitions, enumeration types and enumeration values;</p>
</li>
<li>
<p><strong>reference</strong>: contains annotations that specify references between types or attributes;</p>
</li>
<li>
<p><strong>system</strong>: contains annotations that concern system properties;</p>
</li>
<li>
<p><strong>view</strong>: contains annotations that mark an interfaces as view;</p>
</li>
<li>
<p><strong>other</strong>: contains annotations like <em>@Type</em>, <em>@EcrIgnore</em> and others, which stand out and cannot be classified into a
group.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use the 5 entity classes to create custom entity types to serve the needs of your system. The customized entity types reflect the structure of your project or organization and can be created in a flexible way by extending the five entity types of the <em>arveo</em> system.
You can make your class a type and add features by annotating your classes. You can define the custom metadata schema with simple getter and setter methods.</p>
</div>
<div class="paragraph">
<p>To create your first project using <em>arveo</em> you may want to review the following examples and follow the pattern.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inherited_annotations">Inherited annotations</h4>
<div class="paragraph">
<p>Certain properties of annotations have a wide usage throughout the code, so it is therefore more convenient to define a certain annotation once for frequent usage.</p>
</div>
<div class="paragraph">
<p>The following is a listing of the interface definition <em>@CustomAnnotation</em>, which defines itself as a system property version id.If you mark a getter-method with this annotation, there is no
need to list the system property name.</p>
</div>
<div class="listingblock">
<div class="title">Listing of the interface @CustomAnnotation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.ANNOTATION_TYPE})
<span class="annotation">@SystemProperty</span>(SystemPropertyName.VERSION_ID)
<span class="directive">public</span> <span class="annotation">@interface</span> CustomAnnotation {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To take advantage of this interface, we annotate getter-methods with it as shown in the listing below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">InterfaceInheritanceExample</span> {

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ID)
    DocumentId getId();

    <span class="annotation">@CustomAnnotation</span>
    VersionId getVersionId();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entity_types_examples">Examples</h4>
<div class="sect4">
<h5 id="_enumeration_example">Enumeration example</h5>
<div class="paragraph">
<p>Define a enum class and use it in a another object type (<a href="#_document_type_example"><strong>Example</strong></a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Enumeration</span>(typeName = <span class="string"><span class="delimiter">&quot;</span><span class="content">my_enum</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">enum</span> MyEnum {
    ENUM1, ENUM2, ENUM3, ENUM4
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_document_type_example">Document type example</h5>
<div class="listingblock">
<div class="title">Example of a type definition using the object type <em>Document</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.DOCUMENT) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@RetentionProtected</span>
<span class="annotation">@ContentElement</span>(defaultDefinition = <span class="predefined-constant">true</span>, separateField = <span class="predefined-constant">true</span>)
<span class="annotation">@OverwriteAllowed</span>
<span class="annotation">@RecycleBin</span>
<span class="annotation">@Audit</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Resume</span> {
<span class="comment">// Immutable identifier documentid of the resume document: unique and readonly</span>
<span class="annotation">@Unique</span>
<span class="annotation">@ReadOnly</span>
<span class="comment">// alternatively: use autoincrement instead of unique and readonly to let the service create a unique sequence</span>
<span class="comment">//@Autoincrement</span>
<span class="type">long</span> getDocumentId(); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">void</span> setDocumentId(<span class="type">long</span> value);

<span class="comment">// title of the resume document</span>
<span class="predefined-type">String</span> getTitle(); <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">void</span> setTitle(<span class="predefined-type">String</span> value);

<span class="comment">// relation to Person by person.id()</span>
<span class="annotation">@ForeignKey</span> (target = Person.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
<span class="predefined-type">String</span> getPersonId();
<span class="type">void</span> setPersonId(<span class="predefined-type">String</span> value);

<span class="comment">// Multi value with former employers</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getEmployers();
<span class="type">void</span> setEmployers(<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; employers);

MyEnum getEnum();
<span class="type">void</span> setEnum(MyEnum myEnum);

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definition of the object type to allow  <em>Document</em> to upload content</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A database column is created for this property with a default name <em>DocumentId</em>. The column is readonly, mandatory, autoincrement and unique. The database creates a sequence of integer values. The value is readonly and so immutable. This allows users and 3rd party applications to identify and find the object. If you leave the <em>@Autoincrement</em> annotation the id must be set on creation and is readonly and immutable from that moment on.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This annotation specifies a foreign key to class Person</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_container_type_example">Container type example</h5>
<div class="paragraph">
<p>The following example class is marked as type <em>Container</em>. To use an entity type, we annotate the class using the <em>@Type</em> annotation.</p>
</div>
<div class="listingblock">
<div class="title">Example of an object definition of entity type <em>Container</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.CONTAINER) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> getFirstName(); <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="type">void</span> setFirstName(<span class="predefined-type">String</span> value);
    <span class="annotation">@Name</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="predefined-type">String</span> getSurname();
    <span class="type">void</span> setSurname(<span class="predefined-type">String</span> value);
    <span class="annotation">@Unique</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="predefined-type">String</span> getVatNumber();
    <span class="type">void</span> setVatNumber(<span class="predefined-type">String</span> value);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definition of the object type to be <em>Container</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A database column is created for this property with a default name <em>first_name</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This annotation specifies the name of the database column, which is different from the default</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This annotation specifies a unique column, in this case <em>vat_number</em>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_referencing_attributes_by_name">Referencing attributes by name</h4>
<div class="paragraph">
<p>The system creates a column for each attribute of a type definition in the type definition&#8217;s database table. The name
of the column will be a <em>snake case</em> representation of the camel case name of the getter method of the attribute. For
example, the getter <code>getInvoiceNumber</code> will be mapped to an attribute (and a column) named <code>invoice_number</code>. To make it
easy to reference these names in a compile-safe manner, classes with string constants for all type definitions will be
generated automatically. For example, for a type definition class called <code>SimpleInvoice</code> a class named
<code>SimpleInvoiceNames</code> will be generated in the same package as <code>SimpleInvoice</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The classes containing the constants are generated using an annotation processor that is contained in the library
containing the type annotations. The processor is picked up by the compiler automatically.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows how these constants can be used to perform a search referencing two different attributes.</p>
</div>
<div class="listingblock">
<div class="title">Example of a search using generated attribute name constants</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        EcrSearchService&lt;SimpleInvoice&gt; searchService = serviceClient.asEntitySearchService(); <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="predefined-type">List</span>&lt;SimpleInvoice&gt; list = searchService.where() <i class="conum" data-value="2"></i><b>(2)</b>
            .entity().field(SimpleInvoiceNames.INVOICE_NUMBER).like().value(<span class="string"><span class="delimiter">&quot;</span><span class="content">2021-08-*</span><span class="delimiter">&quot;</span></span>)
            .and()
            .entity().field(SimpleInvoiceNames.AMOUNT).greaterThan().value(<span class="float">90D</span>)
            .holds()
            .unpaged();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>serviceClient is a <code>TypedDocumentServiceClient</code> obtained using the <code>TypeDefinitionServiceClient</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A query is formulated using the fluent API of the EQL using the attributes invoice_number and amount</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_type_annotations">Type annotations</h3>
<table id="type_annotations" class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 18. Type annotations</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Type</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObjectType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the entity type of your class by setting a valid ObjectType: DOCUMENT, FOLDER, RELATION,
  CONTAINER, META: <a href="#_document_type_example"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@AccessChecks</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation specifies whether type-based access-checking will be enabled on a type.
  Default = false. See <a href="permissions.html#_permissions_on_type_definitions">permissions on type definitions</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@AclDisabled</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Support for ACLs is enabled by default but can be disabled by annotating the type class with . Additionally,
  annotating a getter for the ACL-Id system property with @Mandatory enforces the assignment of an ACL to every entity.
  Meta types do not support ACLs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@FilingEnabled</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The filing feature makes it possible to assign a document to a folder. The feature is disabled by default and can be
  activated on typ classes of type DOCUMENT by annotating the class with .</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@RetentionProtected</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The retention and litigation hold feature is disabled by default and can be enabled by annotating a type class with.
  Meta types do not support retention. <a href="#_annotations_retentionprotected"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@OptimisticLocking</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The optimistic locking feature makes it possible for clients to ensure that updates do not overwrite changes made by
  other clients by accident. The feature is disabled by default and can be enabled by annotating a type class with</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@RecycleBin</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The recycle bin feature makes it possible to move entities to the recycle bin and restore them again if required.
  The feature is disabled by default but can be enabled by annotating a type class with. <a href="#_recycle_bin"><strong>Recycle Bin</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Recovery</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the recovery log. Content objects or files are deleted after configurable time: <a href="#_recovery_log"><strong>Recovery Log</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@ContentElement</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the allowed content types:  <a href="#_types_of_content_elements"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Audit</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation enables auditing of create-, update- and delete-operations on the type definition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Versioned</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation defines if all properties of a type are versioned or not. If the annotation
  is present on a type and on a getter in the type, the annotation on the getter wins.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@OverwriteAllowed</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, <em>arveo</em> creates a new version if the content object of a document
  is changed. You can always read and restore all older versions of a content element. If overwrite is allowed you can
  replace a content element and overwrite it on the content store. The old version is lost.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@View</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The metadata type is a database view: <a href="#_define_a_view"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Tablename</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the real database table name of a system column which is not camel case but snake case:
  <a href="#_external_views"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@SourceType</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a setter method to be setting a property that is part of an update or
  create call and not a member of the entity itself. Examples are revision commentary or the update counter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@TargetType</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation specifies the class being the target of a foreign key or relation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@InheritedProperty</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a property as an inherited property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Enumeration</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation can be used to configure a registered enumeration type.You must pass the
database snake case name of the enumeration type: <a href="#_enumeration_example"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@EcrIgnore</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignore Property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a method to be ignored as property or a class to be ignored as
type.The property is not stored in the database table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@NOSql</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation enables full-text support for all columns of the document types. By default,
the full-text support is disabled: <a href="#_nosql_example"><strong>Example</strong></a>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_property_annotations">Property annotations</h3>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 19. Property annotations</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@AutoIncrement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The annotation <em>AutoIncrement</em> indicates that the value of an attribute will be auto-incremented by the database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@Indexed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The annotation ensures, that an index will be created for one or more properties. You must pass the index name as a parameter.
  When several attributes are annotated to use an index with the same name, a multi-column-index will be created for
  these columns. Use {@link Index} to configure additional properties of the index.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Unique</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines a unique column. If you try to create an entity with a duplicate value an unique
  constraint violation is thrown. <em>arveo</em> creates an unique index or an unique constraint on the database and
  ensures the integrity of the documents. <a href="#_annotation_examples"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Mandatory</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines a mandatory column. Default = false, the create operation fails with an exception if the property is not set.
  <a href="#_default_values"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Readonly</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The property must be set when the entity is created (like <em>@Mandatory</em>) and cannot be changed afterwards. If a column
  has the annotations <em>@Readonly</em> and <em>@Unique</em> you have an immutable index value that can be used as business primary
  key. This ensures that users and third-party systems can clearly identify and find a document. <a href="#_annotation_examples"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Versioned</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation defines if an attribute of a type is versioned or not (when placed on a getter).
  If the annotation is present on a type and on a getter in the type, the annotation on the getter wins.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Length</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation specifies the length of a string or binary attribute</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Precision</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long<br>
  Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation specifies the precision of a decimal, parameter: digits before and after comma</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Casesensitive</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a field of type String as case-sensitive. This effects how searches on this field will be
  performed. The value itself will always be stored preserving the case.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@DefaultValue</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String<br>
  default&lt;T&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is possible to specify default values for properties. Pass the database name of the property (camel vs. snake case!)
  and define a function returning the required type. If an instance of a type  with a field that has a default value
  specified is created, and a value for that field is not defined, the default value will be used instead. However,
  if the field is explicitly set to null, then null will be used instead. <a href="#_default_values"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@DefaultSystemPropertyValue</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String<br>
  ZonedDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is possible to calculate the initial value of the retention period and set it as a default value for <em>RETENTION_DATE</em>
  system column. Pass the database column name "retention_date" and a function returning a ZonedDateTime value.
  <a href="#_retention_examples"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@PrimaryKey</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a custom property as part of the elements primary key. The primary key will be combined of every
  custom property annotated with this annotation and the system property id. The property will be mandatory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@SecondaryKey</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a property as secondary. The property is mandatory and unique.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@ForeignKey</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines a foreign key. You must pass the class name and the column for the foreign key. _arveo creates the
  foreign key on the database and ensures the data integrity of your entities. <a href="#_entity_types_examples"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@CascadeDelete</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is possible to define foreign keys that cascade a delete operation to the referencing entity.
  <a href="#_foreign_keys_with_on_delete_cascade_example"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@Systemproperty</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SystemPropertyName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To access system properties you can use the annotation <em>@SystemProperty</em> and
  pass one of the following names (<a href="#_retention_examples"><strong>Example</strong></a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@FormattedCounter</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks an attribute of type String as a formatted counter. Formatted
  counters can be used to generate string valued attributes with a counter backed by a sequence as well as a
  prefix and a suffix. The name of the sequence can be user defined, or it can be auto-generated by the system. Prefix,
  suffix, and the name of the sequence can contain placeholders. Currently, the only supported placeholder is
  <code>$date(&lt;format&gt;)</code>. The format string is a simple date format string as supported by
  <code>DateTimeFormatter.ofPattern</code>. <a href="#_formatted_counters_example"><strong>Example</strong></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@RelationCounter</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a property of type Int as a counter for a specific relation type
  identified by the type definition class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@EcrIgnore</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation marks a method to be ignored as property or a class to be ignored as type.
  The property is not stored in the database table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>@NOSql</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This annotation enables or disables full-text support for this property.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Please note the following tips regarding <strong>Unique identifiers</strong>:</p>
</div>
<div class="paragraph">
<p>To allow users and 3rd party applications to identify and find objects in <em>arveo</em> you should define a unique
and immutable property.
The property must be <em>@Unique</em> to ensure that an application can identify the item.
Make the property <em>@ReadOnly</em> to ensure that the identifier is always set and immutable.</p>
</div>
<div class="paragraph">
<p>Your business application or the user must set the value when the object is created.
Use the <em>@AutoIncrement</em> annotation instead of <em>@Unique</em> and <em>@Readonly</em> if a simple sequential Long id meets your
requirements.
If you need a more sophisticated unique identifier you can use the annotation <em>@FormattedCounter</em> which allows you to
create e.g. String identifiers like &lt;year&gt;-&lt;sequence&gt; (<a href="#_formatted_counters_example"><strong>Example</strong></a>).</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If overwrite is turned on it is possible to manipulate the originally saved content and compromise the document without
creating a versioned copy. Ensure that the <em>@OverwriteAllowed</em> annotation is not present on legally compliant document
types.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_annotation_examples">Examples</h4>
<div class="sect4">
<h5 id="_default_values">Default values</h5>
<div class="listingblock">
<div class="title">Example of a default value definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ContainerWithSimpleDefaultProperty</span> {

    <span class="predefined-type">String</span> DEFAULT_STRING = <span class="string"><span class="delimiter">&quot;</span><span class="content">default string</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@Mandatory</span>
    <span class="predefined-type">String</span> getMyStringField();

    <span class="type">void</span> setMyStringField(<span class="predefined-type">String</span> myStringField);

    <span class="annotation">@DefaultValue</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">my_string_field</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">default</span> <span class="predefined-type">String</span> defaultStringField() {

        <span class="keyword">return</span> DEFAULT_STRING;
    }

    <span class="comment">// ...</span>
    <span class="comment">// your custom attribute definitions</span>
    <span class="comment">// ...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>With <code>@DefaultValue("my_string_field")</code> the method <code>defaultStringField</code> is defined to return the default value of <code>my_string_field</code>.Note that the reference in the annotation is in snake-case while the actual property <code>getMyStringField</code> is camel-case.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In a simple case like this it is considered good practice to declare a constant default value as a public constant.However, the default method does not need to return a constant.For example, date-time fields could use <code>ZonedDateTime.now()</code> to specify the timestamp of the creation as default value.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_index_example">Index example</h5>
<div class="paragraph">
<p>As an example of annotations usage let us define an interface <em>BookIndex</em> with two properties, <em>page</em> and <em>chapter</em>.These properties have to be indexed.</p>
</div>
<div class="listingblock">
<div class="title">Object annotation of type <code>Meta</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.META)
<span class="annotation">@Index</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">book-chapter-page-index</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">BookIndex</span> {

    <span class="annotation">@PrimaryKey</span>
    <span class="annotation">@AutoIncrement</span>
    <span class="type">int</span> getId();

    <span class="annotation">@Indexed</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">book-chapter-page-index</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> getChapter();
    <span class="type">void</span> setChapter(<span class="type">int</span> chapter);

    <span class="annotation">@Indexed</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">book-chapter-page-index</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> getPage();
    <span class="type">void</span> setPage(<span class="type">int</span> page);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above-mentioned properties are thus marked with the annotation <em>@Indexed</em>, which ensures, that an index will be created for these attributes.Here, the annotation <em>@Index</em> on the type is an example of an annotation on a type, described above.</p>
</div>
</div>
<div class="sect4">
<h5 id="_formatted_counters_example">Formatted counters example</h5>
<div class="paragraph">
<p>Using the <em>@FormattedCounter</em> annotation it is possible to define counters with prefix and suffix that are backed by a
sequence on the database.There are several properties that can be defined in the annotation:</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The prefix used for the counter values. Can contain placeholders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">suffix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The suffix used by the counter values. Can contain placeholders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">digits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of digits for the counter. Shorter numbers will be padded with zero.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sequenceName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the sequence to use. Can contain placeholders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoGenerateSequences</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of sequences to auto-generate when the system is started in maintenance mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">startValue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The start value of the generated sequence(s).</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The parameters prefix, suffix and sequenceName support placeholders.Currently, the system supports a placeholder for
dates in the form <code>$date(&lt;format&gt;)</code> where <code>format</code> is a java date format string supported by
java.time.format.DateTimeFormatter#ofPattern(String)
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>autoGenerateSequences</code> property can only be used when the <code>sequenceName</code> contains the placeholder
<code>$date(uuuu)</code>.It must not contain any other placeholders.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows a formatted counter attribute used as an invoice number that will produce counter values in
the form <code>2021#0103</code>.It will be backed by a sequence called <code>inv_no_seq_2021</code>.The system will create the next 10
sequences automatically (<code>inv_no_seq_2021</code> to <code>inv_no_seq_2030</code>).The start value of each sequence will be 100. The
sequence to use will be determined automatically because of the date placeholder in the <code>sequenceName</code> property.So on
January 1st 2022, the generated counter values will use another prefix and the counter will start over at 100
(<code>2022#0100</code>).Each time the system is started in maintenance mode, it will make sure that sequences for the next 10
years will be present.</p>
</div>
<div class="listingblock">
<div class="title">Example: Defining a formatted counter attribute</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FormattedCounter</span>(prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">$date(uuuu)#</span><span class="delimiter">&quot;</span></span>, digits = <span class="integer">4</span>, sequenceName = <span class="string"><span class="delimiter">&quot;</span><span class="content">inv_no_seq_$date(uuuu)</span><span class="delimiter">&quot;</span></span>, autoGenerateNextSequences = <span class="integer">10</span>, startValue = <span class="integer">100</span>)
<span class="predefined-type">String</span> getInvoiceNumber();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_foreign_keys_with_on_delete_cascade_example">Foreign keys with ON DELETE CASCADE example</h5>
<div class="paragraph">
<p>Add the <em>@CascadeDelete</em> annotation to the getter for the foreign key attribute.
For relation types it is possible to add the cascade delete option to the foreign keys to the parent and child of the
relation.To do that, add a system property for the parent- and/or child-id and annotate it with <em>@CascadeDelete</em>.</p>
</div>
<div class="listingblock">
<div class="title">Usage of the annotation @CascadeDelete</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// simple foreign key</span>
<span class="annotation">@CascadeDelete</span>
<span class="annotation">@Mandatory</span>(<span class="predefined-constant">false</span>)
<span class="annotation">@ForeignKey</span>(target = BookIndex.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Integer</span> getReferencedIndex();

<span class="comment">// parent- and child-id of a relation</span>
<span class="annotation">@CascadeDelete</span>
<span class="annotation">@SystemProperty</span>(SystemPropertyName.PARENT_ID)
<span class="type">short</span> getParentId();

<span class="annotation">@CascadeDelete</span>
<span class="annotation">@SystemProperty</span>(SystemPropertyName.CHILD_ID)
<span class="type">short</span> getChildId();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The cascade delete option is supported only for entities that are not versioned (hence it cannot be used on <em>Document</em> types) and do not support retention or inheritance.It is also not possible to inherit attribute values from a type definition that has a foreign key with the cascade delete option.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_property_like_system_fields">Property-like system fields</h5>
<div class="paragraph">
<p>If a getter for a system field is defined, then it is possible to define a setter, <em>if</em> the system field is property like.
The following fields are property-like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>acl_id;</p>
</li>
<li>
<p>retention_date.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following listing shows the definition of a getter and a setter method on a property-like field.</p>
</div>
<div class="listingblock">
<div class="title">Example of property-like fields</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Secured</span> {

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ACL_ID)
    AccessControlListId getAclId();

    <span class="type">void</span> setAclId(AccessControlListId aclId);

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_define_a_view">Define a view</h4>
<div class="paragraph">
<p>To define your type as a view or a partial view, you have to annotate your type with <em>@View</em> or <em>@PartialView</em>.The <em>@View</em> annotation specifies whether the defined type is a view i.e. whether it should create the tables for it.The <em>@PartialView</em> annotation marks a class to be a partial view of the type definition created by another class via the <em>@Type</em> annotation.Partial views can be used for updates and selects with limited select clauses.No tables will be
created for classes annotated this way.The interfaces that are to be defined as views of an object type, have to be registered on the interface, representing this object type.For instance, if an interface <em>NamedFile</em> inherits from the interface <em>NamedEntity</em>, and <em>NamedEntity</em> is a partial view of <em>NamedFile</em>, it has to be registered on the object from
which it inherits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PartialView</span>(NamedFile.class)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">NamedEntity</span> {
    <span class="comment">//...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: An interface may also be a partial view of more than one type definitions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_external_views">External views</h4>
<div class="paragraph">
<p>It is possible to expose tables that are under control of other applications to <em>arveo</em> and include them in its type system.This assumes that the given tables are in the same database schema as the tables of <em>arveo</em>.Also, one needs to know the name of these tables as well as their types.In this case one can define a meta-type annotated with <em>@View</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
External views will only be read from ecr.It will never write to an external view.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, the <a href="#Access Control Service">access-control-service</a> defines several tables, one of it named <code>usrv_acl</code>.In this table there are - amongst others - two fields: <code>id</code> (a <code>bigint</code>) and <code>name</code> (a <code>varchar</code>).With this knowledge one can define the following external view:</p>
</div>
<div class="listingblock">
<div class="title">Example for an external view</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span class="annotation">@View</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Type</span>(ObjectType.META) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@TableName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">usrv_acl</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">AclView</span> {

    <span class="annotation">@Unique</span>
    <span class="predefined-type">String</span> getName(); <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="annotation">@PrimaryKey</span>
    <span class="type">long</span> getId(); <i class="conum" data-value="5"></i><b>(5)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We annotate the class with <em>@View</em> to declare it as an external view.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifying the type as a <code>META</code> type is good practice, since every other type would expect specific system fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifying the table name is good practice here, since an external table most likely follows its own name convention. However, it would be possible to omit the <em>@TableName</em> annotation here and instead name the class <code>UsrvAcl</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Since we know that the table <code>usrv_acl</code> has a field <code>name</code> of type <code>varchar</code> we can define the property <code>name</code> of type <code>String</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We know that the table <code>usrv_acl</code> has a field <code>id</code> of type <code>bigint</code>, so we specify a java property accordingly.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_entity_annotations_nosql_example">NoSQL example</h4>
<div class="paragraph">
<p>You can write the annotation <em>@NOSql</em> to the type definitions, which should also be created in the solr schema, so
that the whole class is created with its fields.</p>
</div>
<div class="listingblock">
<div class="title">Example of usage of the @NOSql annotation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@NOSql</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">PersonSimple</span> {
    <span class="predefined-type">String</span> getFirstName();
    <span class="type">void</span> setFirstName(<span class="predefined-type">String</span> value);
    <span class="predefined-type">String</span> getLastName();
    <span class="type">void</span> setLastName(<span class="predefined-type">String</span> value);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to create a field, you can disable it with the annotation <em>@NOSql</em>(value = false).</p>
</div>
<div class="listingblock">
<div class="title">Example of usage of the @NOSql annotation with value set to false</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@NOSql</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">PersonSimple</span> {
    <span class="predefined-type">String</span> getFirstName();
    <span class="type">void</span> setFirstName(<span class="predefined-type">String</span> value);
   <span class="annotation">@NOSql</span>(value = <span class="predefined-constant">false</span>)
    <span class="predefined-type">String</span> getLastName();
    <span class="type">void</span> setLastName(<span class="predefined-type">String</span> value);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_systemproperty_annotation"><em>@SystemProperty</em> annotation</h4>
<div class="paragraph">
<p>To access system properties you can use the annotation <em>@SystemProperty</em> and pass one of the following names (<a href="#_document_type_10_year_retention_period"><strong>Retention Information Getter</strong></a>)</p>
</div>
<div class="paragraph">
<p><em>general system fields:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>ID: The unique identifier of the entity. Use on EcrId properties (or subclasses as applicable). Can be used on any entity</p>
</li>
<li>
<p>CREATION_DATE: The date and time the relation was created. Use on ZonedDateTime properties. Can only be used
on relations.</p>
</li>
<li>
<p>CREATOR_USER_ID: The id of the user that created this relation. Use on UserId properties. Can only be used on
relations.</p>
</li>
<li>
<p>ACL_ID: The id of the ACL currently assigned to the entity. Might be null. This is not supported for metadata entities.</p>
</li>
<li>
<p>ACL_RIGHT: The resolved right based on the ACL currently assigned to the entity and the current user.
This is not supported for metadata entities.</p>
</li>
<li>
<p>RETENTION_INFO: Information about the retention properties of the entity.
It contains the RETENTION_DATE and the LITIGATION_HOLD flag described below.
Can only be used on potentially versioned entities i.e. Folders, Documents, Relations and Containers that declared to be retention protected.</p>
</li>
<li>
<p>RETENTION_DATE: The retention date defines the minimum storage date i.e. the related object can not be deleted until after this date passed. The the storage period may be extended but never shortened.
Can only be used on potentially versioned entities i.e. Folders, Documents, Relations and Containers that
declared to be retention protected.</p>
</li>
<li>
<p>LITIGATION_HOLD:A flag that indicates whether a document is related to a litigation.
If the flag is set the document must never be deleted - even if the retention date has passed by.
Can only be used on potentially versioned entities i.e. Folders, Documents, Relations and Containers that
declared to be retention protected.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>versioned system fields:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>VERSION_NUMBER: The number of the version of the versioned entity. Use on int/Integer properties. Can only be used on versioned entities.</p>
</li>
<li>
<p>VERSION_ID: The unique identifier of the version of the entity. Use on VersionId properties. Can only be used on versioned entities</p>
</li>
<li>
<p>UPDATE_COUNTER: A counter that is incremented each time an entity is updated. It is used for the optimistic locking feature and therefore is only available on type definitions that use optimistic locking.</p>
</li>
<li>
<p>IS_CURRENT_VERSION: A boolean that indicates whether the entity was the current version at the time it was loaded from the backend. Can only be used on versioned entities.</p>
</li>
<li>
<p>MODIFICATION_INFO: Information about the date and time as well as the user of the first and last modification of the entity. Use on ModificationInformation properties. Can only be used on potentially versioned
entities i.e. Folders, Documents, Relations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>document system fields:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>CONTENT: Information about the content of the document. Use on Map&lt;String, ContentInformation&gt;
properties. Can only be used on documents.</p>
</li>
<li>
<p>CONTAINING_FOLDER: The id of the folder containing the document (if any). Use on FolderId properties. Can only
be used on documents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>folder system fields:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>FOLDER_NAME: The name of the folder. Use on String properties. Can only be used on folders.</p>
</li>
<li>
<p>PARENT_FOLDER: The id of this folders parent. Use on FolderId properties. Can only be used on folders.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>relation system fields:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>PARENT_ID: The id of the parent of this relation. Use on TypedId properties (or applicable subclasses). Can
only be used on relations.</p>
</li>
<li>
<p>PARENT_VERSION_ID: The version-id of the parent of this relation. Use on VersionId properties. Can
only be used on relation types that support relations to or from versions.</p>
</li>
<li>
<p>CHILD_ID: The id of the child of this relation. Use on TypedId properties (or applicable subclasses).
Can only be used on relations.</p>
</li>
<li>
<p>CHILD_VERSION_ID: The version-id of the child of this relation. Use on VersionId properties.
Can only be used on relation types that support relations to or from versions.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_types_2">Data Types</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Property Data Types</caption>
<colgroup>
<col style="width: 10.5263%;">
<col style="width: 10.5263%;">
<col style="width: 78.9474%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Java Type</th>
<th class="tableblock halign-center valign-top">Database Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unlimited unicode text. Limit the length with <em>@Length</em> annotation</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Integer or int</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32 bit integer value, Integer = null is allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long or long</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64 bit long value, Long = null is allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Double or double</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">double</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">double value, Double = null is allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Boolean or boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean value, Boolean = 3 state boolean</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Decimal or decimal</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">decimal( precision)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decimal value, Decimal = null is allowed, add <em>@Precision</em> annotation</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">UUID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">uuid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uuid type</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte[ length ]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">bytea</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary data with a length, specified by a java int (max. 4 gb).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String based ID with a non-null length.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">EnumerationType</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">EnumerationType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>arveo</em> creates an enumeration object on postgreSQL 12.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">ZonedDateTime</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>arveo</em> stores a GMT based date time value in postgreSQL 12</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">LocalDate</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>arveo</em> stores a date time value in postgreSQL 12, but only the date is relevant</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">LocalTime</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>arveo</em> stores a date time value in postgreSQL 12, but only the time is relevant</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">List&lt;String&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">array(text)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_arveo stores multiple text values in an array column of postgreSQL 12.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">List&lt;Long&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">array(bigint)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_arveo stores multiple bigint values in an array column of postgreSQL 12.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, postgreSQL 12 does not limit the length of String values. Typically, it is not necessary to define a length using the <em>@Length</em> annotation because postgreSQL 12 does handle Strings of all length very well.<br>
Your strings should have a length up to 4 kByte. Even larger strings are allowed, but you should take care that you do not inadvertently consume too much data space if you store very large strings.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
List data types allow you to store more than String or long value for a property. You can search for each value using the array search operation of the <em>arveo</em> query language.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Enumeration data types allow you to set one or more values from a fixed set of values.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_system_properties">System Properties</h3>
<div class="paragraph">
<p>The following chapter describes types of system properties in <em>arveo</em>.</p>
</div>
<div class="paragraph">
<p>There are different types of system properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>General system properties: system properties that are available on all types of entity (except for meta data entities).</p>
</li>
<li>
<p>General system properties: system properties that are available on all types of entity (except for meta data entities).</p>
</li>
<li>
<p>Versioned entity system properties: system properties that are only available on entities that can be versioned
(Containers, Documents, Folders, Relations).
Those properties are contained in the main table of a type definition.</p>
</li>
<li>
<p>Document system properties: system properties that are only available on documents.</p>
</li>
<li>
<p>Folder system properties: system properties that are only available on folders.</p>
</li>
<li>
<p>Relation system properties: system properties that are only available on relations.</p>
</li>
<li>
<p>Version system properties: system properties that are only available on versions of entities. Those properties are
contained in the version table of a type definition.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_system_property_names">System Property Names</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All system columns in the database are snake case but not camel case. e.g. the Java RetentionDate variable is persisted as "retention_date".
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. <em>General system properties:</em></caption>
<colgroup>
<col style="width: 23%;">
<col style="width: 11%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Database Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique identifier of the entity. Use EcrId properties (or subclasses as applicable). Can be used on any entity and is applied by <em>arveo</em> for all types but metadata.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">acl_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The id of the ACL currently assigned to the entity. Might be null. This is not supported for metadata entities or type with disabled ACLs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creation_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GMT timestamp when the entity or version was created, precision (1/1000 second)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creator_user_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the user who created the entity or version (<a href="user-management.html"><strong>User Management</strong></a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deleted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional flag that indicates that an entity is currently contained in the recycle bin.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">last_delete_restore_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional GMT timestamp of when the entity was last moved in or out of the recycle bin.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retention_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The GMT based retention timestamp defines the minimum storage date i.e. the related object can not be deleted until after this date passed. Cannot be used on meta data entities and is only available on entity types that declared to be retention protected (<a href="#"><strong>Retention</strong></a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">litigation_hold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The boolean indicates whether a document is related to a litigation. If the flag is set the document must never be deleted - even if the retention date has passed by. Cannot be used on meta data entites and is only available on entity types that declared to be retention protected (<a href="#"><strong>Retention</strong></a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">update_counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional counter for the number of updates on an entity used for optimistic locking.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. <em>Versioned entity system properties:</em></caption>
<colgroup>
<col style="width: 23%;">
<col style="width: 11%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Database Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sequential number of the latest version of the versioned entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">latest_version_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique identifier of the latest version of the entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_comment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comment set by the client when a new version is created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modification_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GMT timestamp when the version was created or changed, precision (1/1000 second)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modification_user_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the user who created or changed the version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">initial_creation_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GMT timestamp of when the first version of an entity was created.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 23. <em>Document system properties:</em></caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Database Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">json</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON containing content properties:<br>
ID :  unique id of the content<br>
Hash : SHA256 hash of the content stream <br>
Hash-Algorithm: Algorithm of the hash<br>
MediaType : mime type of the content, e.g. octet-stream<br>
Creation: GMT based ZonedDateTime timestamp of the creation of the object<br>
FileName: Name of the file, if stored on a file system storage<br>
Size: bigint value containing the size of the content stream in bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional field that contains the ID of the folder the document is contained in.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 24. <em>Folder system properties:</em></caption>
<colgroup>
<col style="width: 17%;">
<col style="width: 11%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Database Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">folder_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the folder.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the parent of the folder in the folder tree.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 25. <em>Relation system properties:</em></caption>
<colgroup>
<col style="width: 17%;">
<col style="width: 11%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Database Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The id of the parent of this relation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_version_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The version-id of the parent of this relation. Can only be used on relation types that support relations to or from versions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">child_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The id of the child of this relation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">child_version_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The version-id of the child of this relation. Can only be used on relation types that support relations to or from versions.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 26. <em>Version system properties:</em></caption>
<colgroup>
<col style="width: 17%;">
<col style="width: 11%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Database Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sequential number of the version.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique identifier of the version.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_comment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comment set by the client when a new version is created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entity_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the entity the version belongs to.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_timestamps">Timestamps</h4>
<div class="paragraph">
<p>All timestamp system properties (<em>creation_date</em>, <em>initial_creation_date</em>, <em>modification_date</em>) are stored in the database
using the GMT timezone and a precision of 1 millisecond. When using the Java API, the values will be returned as
<em>ZonedDateTime</em> instances.</p>
</div>
<div class="paragraph">
<p>The <em>initial_creation_date</em> field will contain the
timestamp of when the very first version of an entity was created. This field is never updated. The <em>creation_date</em>
field on the other hand will contain the time a specific version of an entity was created. Thus, the <em>creation_date</em>
field in the main table will be updated when a new version is created because the main table will always contain the
latest version of an entity. The modification timestamp field (<em>modification_date</em>) will contain the timestamp of when a
version was created or overwritten. This field, too, will be updated in the main table each time a new version is created.
It will be updated in the main table and in the version table when a version gets overwritten.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_document_type">Document type</h3>
<div class="paragraph">
<p>The following chapter provides a more detailed overview of the type <code>Document</code>.</p>
</div>
<div class="paragraph">
<p>A <code>Document</code> is one of five entity types supported by the <em>arveo</em> system. Unlike the other entity types, documents are always versioned too keep track of changes of the binary content.</p>
</div>
<div class="paragraph">
<p>A <code>Document</code> consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Technical metadata, which is filled by <em>arveo</em> and cannot be changed, see <a href="#"><strong>System properties</strong></a></p>
</li>
<li>
<p>Typed metadata as defined in the annotated interface (the type definition)</p>
</li>
<li>
<p>0-n content objects: A content object has a content type that is freely configured in the system.A maximum of one
element can be inserted per content type.Examples of content types are: original object, rendition, full text,
text notes, XML properties, etc.</p>
</li>
<li>
<p>content metadata like content size, mime-type and hash</p>
</li>
<li>
<p>0-n annotations per content object: Only for image objects (TIFF, JPEG, PNG, BMP, PDF/A) annotations can be created
in a layer independent of the document.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any number of versions can be created for a <code>Document</code>. All the versions are traceable in the repository and can be referenced via independent system-wide unique IDs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_container_type">Container type</h3>
<div class="paragraph">
<p>The following chapter provides a more detailed overview of the type <code>Container</code>.</p>
</div>
<div class="paragraph">
<p>A <code>Container</code> is an object without content. It supports all system managed metadata attributes and custom attributes
defined by the type definition. It is called 'Container' because it&#8217;s primary use case is to serve as an entity that
contains custom metadata and that is related to other entities like a document via foreign keys or relations.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use container objects to build records and cases that contain documents.You can map the relationship between file,
case and documents either as a foreign key (<a href="#_property_annotations"><strong><em>@ForeignKey</em> annotation</strong></a>)
or using the relation type objects (<a href="#_relation_type"><strong>Relation Type</strong></a>).
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you use Foreign keys to create the relationship between objects you can inherit values from the parent to its
children (<a href="#_inheritance"><strong>Inheritance</strong></a>)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Containers can be versioned. A <code>Container</code> consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Technical meta information, which is filled by <em>arveo</em> and cannot be changed, see <a href="#_system_properties"><strong>System properties</strong></a></p>
</li>
<li>
<p>Typed container type metadata according to the type definition of the container type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any number of versions can be created for a <code>Container</code>. All the versions are traceable in the repository and can be
referenced via independent IDs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_relation_type">Relation type</h3>
<div class="paragraph">
<p>The following chapter provides a more detailed overview of the type <code>Relation</code>.</p>
</div>
<div class="paragraph">
<p>A <code>Relation</code> represents a connection between two entities (document, container, folder or meta). It is directed, having
a parent and a child and it can contain custom metadata attributes. A <code>Relation</code> type must specify the type of the parent
and child entities. Any number of versions can be created for a <code>Relation</code>. All the versions are traceable in the repository and can be referenced via independent IDs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Changes of the child-id or parent-id are not tracked in the version table.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="title">Data model of a <code>Relation</code></div>
<div class="content">
<pre> +------------+               +--------+-----+              +------------+
 |   Parent   |               +   Relation   +              |   Child    |
 |------------|      source   |--------------|  target      |------------|
 |            |&lt;--------------|              |-------------&gt;|            |
 | attributes |               |  attributes  |              | attributes |
 |            |               |              |              |            |
 +---+--------+               +--------------+              +------------+</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: A <code>Relation</code> type definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.RELATION) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@SourceType</span>(Customer.class) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@TargetType</span>(Invoice.class) <i class="conum" data-value="3"></i><b>(3)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">CustomerInvoiceRelation</span> {

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.CHILD_ID) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="annotation">@InputProperty</span>(InputPropertyName.RELATION_CHILD) <i class="conum" data-value="5"></i><b>(5)</b>
    DocumentId getChildId();

    <span class="type">void</span> setChildId(DocumentId childId);

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.PARENT_ID) <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="annotation">@InputProperty</span>(InputPropertyName.RELATION_PARENT) <i class="conum" data-value="7"></i><b>(7)</b>
    ContainerId getParentId();

    <span class="type">void</span> setParentId(ContainerId parentId);

    <span class="predefined-type">String</span> getStatus();

    <span class="type">void</span> setStatus(<span class="predefined-type">String</span> status);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies that the type definition is used for relations</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defines the type of the source or parent of the relation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Defines the type of the target or child of the relation</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Marks an attribute to return the value of the <code>childId</code> property of the relation</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Marks an attribute to set the value of the <code>childId</code> property of the relation</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Marks an attribute to return the value of the <code>parentId</code> property of the relation</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Marks an attribute to set the value of the <code>parentId</code> property of the relation</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_relations_vs_foreign_keys">Relations vs. foreign keys</h4>
<div class="paragraph">
<p>Instead of using relations, it is possible to model a dependency between two entities using foreign keys. The key
difference between the two approaches is that a relation can carry its own metadata attributes, which a foreign key
can not. This possibility requires an additional database table (or two, in case of versioned relations) for a relation,
which might have a negative impact on the performance. If the dependency between the two entities does not require its own
metadata attributes (and is not a many-to-many relation), it is recommended to use foreign keys instead of relations.</p>
</div>
<div class="paragraph">
<p>Foreign keys can be defined by
adding the <code>@ForeignKey</code> annotation to an attribute in a type definition. The <code>targetProperty</code> attribute of the
annotation must point to the ID or to a custom metadata attribute with a unique constraint of the target type.
The type of the annotated attribute must match the type of the target property of the foreign key. The chapter
<a href="foreign-keys.html#_foreign_keys">Foreign Keys</a> contains a more detailed overview of the foreign key feature.</p>
</div>
<div class="listingblock">
<div class="title">Example: Defining a foreign key</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ForeignKey</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">fk_invoice_customer</span><span class="delimiter">&quot;</span></span>, target = Customer.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
<span class="type">long</span> getCustomerNumber();</code></pre>
</div>
</div>
<div class="literalblock">
<div class="title">Data model of a foreign key relationship</div>
<div class="content">
<pre> +------------+                 +------------+
 |   Parent   |                 |   Child    |
 |------------|   foreign key   |------------|
 |            |----------------&gt;|            |
 | attributes |                 | attributes |
 |            |                 |            |
 +---+--------+                 +------------+</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relations_to_versions">Relations to versions</h4>
<div class="paragraph">
<p>By default, a relation can point to the current version or to a specific version of its parent or child, when the
parent- or child-type supports versions. This behavior can be controlled by the <code>supportedNodeVersion</code> property of
the <code>@Source</code> and <code>@Target</code> annotations used for relation type definitions. The attribute supports three different
values (defined in <code>de.eitco.ecr.type.definition.annotations.reference.SupportedNodeVersion</code>):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 27. Possible values of the supportedNodeVersion attribute</caption>
<colgroup>
<col style="width: 25%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CURRENT_VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The relation must point to the current version of the node identified by the node&#8217;s ID (NOT the VersionId of the current version)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SPECIFIC_VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The relation must point to a specific version of the node identified by it&#8217;s VersionId.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CURRENT_OR_SPECIFIC_VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The relation can point to either the current version or a specific version of the node. This is the default.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_unique_relations">Unique relations</h4>
<div class="paragraph">
<p>A single relation always has exactly one parent and one child. However, by default a single entity can be the parent or
child of multiple relations (many-to-many). By adding unique constraints to the <code>parentId</code> and/or <code>childId</code> system
properties of the relation type, it is possible to define one-to-many, many-to-one or one-to-one relations.</p>
</div>
<div class="listingblock">
<div class="title">Example: Adding a unique constraint to the child ID of a relation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SystemProperty</span>(SystemPropertyName.CHILD_ID)
<span class="annotation">@Unique</span>(constraintName = <span class="string"><span class="delimiter">&quot;</span><span class="content">uccr_parent_child_uc</span><span class="delimiter">&quot;</span></span>)
ContainerId getChildId();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relation_counters">Relation counters</h4>
<div class="paragraph">
<p>By using the <code>@RelationCounter</code> annotation it is possible to create counters on the parent- and child-entities for both
incoming and outgoing relations. The counters are persisted in the database and are updated automatically when relations
are added or removed.</p>
</div>
<div class="paragraph">
<p>The <code>@RelationCounter</code> annotation contains two attributes: The <code>relationType</code> attribute
defines the type of relation to count and the <code>direction</code> attribute defines whether to count incoming (the entity is
the child or target of the relation) or outgoing (the entity is the parent or source of the relation). By annotating
the relation counter attribute with <code>@Versioned</code> it is possible to control whether the counter attribute is stored
in the version table for each version or in the main table for all versions. When the counter is stored in the version
table it will contain the count for a single version of the entity. If it is stored in the main table it will contain
the count for all versions of the entity. The following example shows how to define relation counter attributes. The
<code>@Name</code> annotation is used because the attribute name is too long for a database column name.</p>
</div>
<div class="listingblock">
<div class="title">Example: Defining relation counter attributes</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RelationCounter</span>(relationType = TypedContainerContainerRelation.class, direction = RelationCounterDirection.INCOMING)
<span class="annotation">@Versioned</span>(<span class="predefined-constant">false</span>)
<span class="type">int</span> getIncomingRelationCounter();

<span class="annotation">@RelationCounter</span>(relationType = TypedContainerContainerRelation.class, direction = RelationCounterDirection.INCOMING)
<span class="annotation">@Versioned</span>
<span class="annotation">@Name</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">v_in_relation_counter</span><span class="delimiter">&quot;</span></span>)
<span class="type">int</span> getVersionedIncomingRelationCounter();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_working_with_relations">Working with relations</h4>
<div class="paragraph">
<p>The <em>$arveo</em> API provides several methods that can be used to create, modify and resolve relations. Relations
itself are treated just like any other entity type. Entities, that can be the parent or child of a relation (containers,
folders, documents and meta data entities), provide additional relation-specific methods in the client API. The available
methods are defined in the interface <code>de.eitco.ecr.sdk.TypedBaseRelationNodeEntityClient</code>, which is a super interface
of the clients used in the API for documents, folders, containers and meta data entities. The injectable
<code>de.eitco.ecr.sdk.SearchClient</code> offers additional methods to search for relations using filters on the relation, the
parent or the child.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_folder_type">Folder type</h3>
<div class="paragraph">
<p>The following chapter provides a more detailed overview of the type <code>Folder</code>.</p>
</div>
<div class="paragraph">
<p>A <code>Folder</code> is an entity that is organized in a file system like tree structure. A <code>Folder</code> can contain custom metadata
attributes. Documents can be <em>filed</em> in a <code>Folder</code>.</p>
</div>
<div class="paragraph">
<p>A <code>Folder</code> consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Technical meta information, which is filled by <em>arveo</em> and cannot be changed, see <a href="#_system_properties"><strong>System properties</strong></a>.</p>
</li>
<li>
<p>Typed folder type metadata according to a schema defined for the document type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any number of versions can be created for a <code>Folder</code>. All the versions are traceable in the repository and can be referenced via independent IDs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Only documents can be <em>filed</em> in a <code>Folder</code>. To enable the filing feature, add the <em>@FilingEnabled</em> annotation to your
document type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_metadata_type">Metadata type</h3>
<div class="paragraph">
<p><code>Metadata</code> types are used for example to connect external tables. They do not contain any specific system fields and no typed ID as a primary key. The database table can be created by the <em>arveo</em> or an existing table can be used.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use the <em>@View</em> annotation to mark a metadata type as a view for which the system should not create a table and use the <em>@TableName</em> annotation to define the name of the table of the external system.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Metadata</code> types do not support versioning and retention protection.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use the <em>@PrimaryKey</em> annotation to define one or more properties of a <code>Metadata</code> type to be the primary key.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_inheritance">Inheritance</h3>
<div class="sect3">
<h4 id="_simple_direct_inheritance">Simple direct inheritance</h4>
<div class="paragraph">
<p>The following chapter describes the inheritance scheme, used in <em>arveo</em>.
The object to be inherited and its initial state is shown in the following table.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 40%;">
<caption class="title">Table 28. The object to be inherited</caption>
<colgroup>
<col style="width: 40%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Create</th>
<th class="tableblock halign-left valign-top">Initial state</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Company</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID (Company)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTuX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTuX</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CountryCode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PhoneNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following table describes direct inheritance (hence with no intermediate objects).
Here, <strong>Invoice</strong> is an object that inherited from <strong>Company</strong>.
The following table describes its initial state, and the update status after 3 different updates.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. Inheritance scheme</caption>
<colgroup>
<col style="width: 11%;">
<col>
<col>
<col>
<col>
<col>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Create</th>
<th class="tableblock halign-left valign-top">Initial state</th>
<th class="tableblock halign-left valign-top">Update 1</th>
<th class="tableblock halign-left valign-top">After Update 1</th>
<th class="tableblock halign-left valign-top">Update 2</th>
<th class="tableblock halign-left valign-top">After Update 2</th>
<th class="tableblock halign-left valign-top">Update 3</th>
<th class="tableblock halign-left valign-top">After Update 3</th>
<th class="tableblock halign-left valign-top">Update 4</th>
<th class="tableblock halign-left valign-top">After Update 4</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Invoice</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID (Invoice)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">InvoiceNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-53</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTuX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eitco</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eitco</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyCountryCode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyPhone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+41 123456</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+41 123456</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Error: no change!</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Not possible: faulty update parameters!</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note the following principles:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<strong>After update2:</strong> All inherited fields are NULLs if inheritance key is set to NULL, unless values are explicitly specified.
<strong>After update3:</strong> All inherited fields are NULLs if inheritance key is set to NULL, unless values are explicitly specified.
- Even if the inheritance key was already NULL before.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_multilevel_inheritance">Multilevel inheritance</h4>
<div class="paragraph">
<p>This inheritance form has an object to be inherited from, just like the direct inheritance.
An objects inherits from it, after that another object inherits from the second object.
The initial object is still the same, its initial state is described in the table above.</p>
</div>
<div class="paragraph">
<p>In the following table, the second object <strong>Creditor</strong>, which inherits from the first object, is described.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 55%;">
<caption class="title">Table 30. The object to be inherited and inheriting</caption>
<colgroup>
<col style="width: 45%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Create</th>
<th class="tableblock halign-left valign-top">Initial state</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Creditor</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID (Creditor)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">999</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CreditorNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">471147114711</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">471147114711</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CompanyID</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTuX</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyCountryCode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyPhone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the table above, the object <strong>Creditor</strong> inherited the following properites through the companyID: companyName, companyCountryCode, companyPhone.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The results of multilevel inheritance through an intermediate object are shown in the table below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 31. Inheritance Scheme in Multilevel inheritance</caption>
<colgroup>
<col style="width: 25%;">
<col>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Create</th>
<th class="tableblock halign-left valign-top">Initial state</th>
<th class="tableblock halign-left valign-top">Update 1</th>
<th class="tableblock halign-left valign-top">After Update 1</th>
<th class="tableblock halign-left valign-top">Update 2</th>
<th class="tableblock halign-left valign-top">After Update 2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Invoice</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID (Invoice)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">InvoiceNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creditorID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">999</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">999</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTuX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eitco</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EITCO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyCountryCode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyPhone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_indirect_inheritance">Indirect inheritance</h4>
<div class="paragraph">
<p>The third form of inheritance is indirect inheritance.
It is much like the second form, only the inheriting object inherits the IDs of both objects it inherits from.
In the example above, the object <strong>Invoice</strong> inherits both the <em>creditorID</em> and the <em>companyID</em>.</p>
</div>
<div class="paragraph">
<p>In the following table, the object <strong>Creditor</strong> is described.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 55%;">
<caption class="title">Table 32. An object to be inherited</caption>
<colgroup>
<col style="width: 45%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Create</th>
<th class="tableblock halign-left valign-top">Initial state</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Creditor</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID (Creditor)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">999</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CreditorNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">471147114711</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">471147114711</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CompanyID</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The table below describes the mechanism of indirect inheritance.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 33. Inheritance scheme in indirect inheritance</caption>
<colgroup>
<col style="width: 25%;">
<col>
<col>
<col>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Create</th>
<th class="tableblock halign-left valign-top">Initial state</th>
<th class="tableblock halign-left valign-top">Update 1</th>
<th class="tableblock halign-left valign-top">After Update 1</th>
<th class="tableblock halign-left valign-top">Update 2</th>
<th class="tableblock halign-left valign-top">After Update 2</th>
<th class="tableblock halign-left valign-top">Update 2a</th>
<th class="tableblock halign-left valign-top">After Update 2a</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Invoice</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID (Invoice)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">931</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">InvoiceNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIT-11</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creditorID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">999</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">999</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">888</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTuX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eitco</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTuX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eitco</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EITCO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyCountryCode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">companyPhone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[NULL]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+49 (30) 408191-425</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This form of inheritance is currently not needed and therefore not supported by ECR.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_inheritance_of_acls">Inheritance of ACLs</h4>
<div class="paragraph">
<p>The <code>acl_id</code> system field is <a href="#_property_like_system_fields">property-like</a>, thus a type can define it as inherited.
This permits scenarios where there is one main entity providing the access definition with several entities being linked to it. If the acl of the main entity changes, the ACLs of the linked entities change as well:</p>
</div>
<div class="listingblock">
<div class="title">Example for the main entity</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MainEntity</span> {

    <span class="annotation">@Mandatory</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ACL_ID) <i class="conum" data-value="1"></i><b>(1)</b>
    AccessControlListId getMainAcl(); <i class="conum" data-value="7"></i><b>(7)</b>

    <span class="type">void</span> setMainAcl(AccessControlListId id);

    <span class="comment">// ...</span>
    <span class="comment">// your custom attribute definitions</span>
    <span class="comment">// ...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example for linked entities</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ChildEntity</span> {

    <span class="annotation">@Mandatory</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="annotation">@ForeignKey</span>(target = MainEntity.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    ContainerId getCurrentMainEntity(); <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="type">void</span> setCurrentMainEntity(ContainerId mainEntity);


    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ACL_ID)
    <span class="annotation">@InheritedProperty</span>(foreignKeyPropertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">current_main_entity</span><span class="delimiter">&quot;</span></span>, sourcePropertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">acl_id</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="5"></i><b>(5)</b>
    AccessControlListId getAcl();

    <span class="comment">// ...</span>
    <span class="comment">// your custom attribute definitions</span>
    <span class="comment">// ...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The main entity defines a property that accesses the ACL system property.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This property is defined mandatory - thus the main entity will always have an ACL.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The child entity defines a foreign key to the main entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>By specifying the foreign key property as mandatory, every child entity will be linked to a main entity</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Now we can specify an ACL property being inherited.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Note that <code>foreignKeyPropertyName</code> (in line 12) is written in snake-case while the actual property getter is written in camel-case.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Note further, that while the property referenced is actually defined by the getter <code>getMainAcl</code> (MainEntity line 6), <code>sourcePropertyName</code> is set to the name of the system field <code>"acl_id"</code> to derive the property.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see this behaviour in action.
Assume that we have a <code>TypeDefinitionServiceClient</code> named <code>typeDefintionServiceClient</code> and also the ids of two ACLs (<code>firstAclId</code> and <code>differenceAclId</code>).
First we can create service Clients for the two types defined above:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The annotation <em>@DefaultValue()</em> only accepts the database column name as static string parameter. As the document type properties are CAMEL case and the database column names are SNAKE case
you must convert your properties e.g. MyCamelCaseProperty = my_camel_case_property.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>        TypedContainerServiceClient&lt;MainEntity&gt; mainEntityServiceClient =
            typeDefinitionServiceClient.getContainerServiceClient().byClass(MainEntity.class);
        TypedDocumentServiceClient&lt;ChildEntity&gt; childEntityServiceClient =
            typeDefinitionServiceClient.getDocumentServiceClient().byClass(ChildEntity.class);</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>With these service clients we can now create several entity instances of <code>MainEntity</code> and <code>ChildEntity</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre>        MainEntity mainEntity = mainEntityServiceClient.createTypeInstance();
        mainEntity.setMainAcl(firstAclId);
        TypedContainerClient&lt;MainEntity&gt; mainEntityClient = mainEntityServiceClient.createEntity(mainEntity);

        ChildEntity childEntity1 = childEntityServiceClient.createTypeInstance();
        childEntity1.setCurrentMainEntity(mainEntityClient.getIdentifier());
        TypedDocumentClient&lt;ChildEntity&gt; childEntityClient1 = childEntityServiceClient.createEntity(childEntity1);

        <span class="comment">// ...</span>

        ChildEntity childEntityN = childEntityServiceClient.createTypeInstance();
        childEntityN.setCurrentMainEntity(mainEntityClient.getIdentifier());
        TypedDocumentClient&lt;ChildEntity&gt; childEntityClientN = childEntityServiceClient.createEntity(childEntityN);</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The instances of <code>ChildEntity</code> will automatically have the same ACL as <code>mainEntity</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>        Assert.assertEquals(childEntityClient1.getEntity().getAcl(), firstAclId);
        <span class="comment">// ...</span>
        Assert.assertEquals(childEntityClientN.getEntity().getAcl(), firstAclId);</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the ACL of the parent is updated&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>        mainEntity.setMainAcl(differentAclId);
        mainEntityClient.updateAttributes(mainEntity);</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;then the ACLs the instances of <code>ChildEntity</code> change as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>
        childEntityClient1 = childEntityClient1.reload();
        <span class="comment">// ...</span>
        childEntityClientN = childEntityClientN.reload();

        Assert.assertEquals(childEntityClient1.getEntity().getAcl(), differentAclId);
        <span class="comment">// ...</span>
        Assert.assertEquals(childEntityClientN.getEntity().getAcl(), differentAclId);</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_default_acls_and_inheritance">Default ACLs and Inheritance</h4>
<div class="paragraph">
<p>In many cases it will be desirable to be able to specify a default ACL for a given type. But the naive approach for defining a default ACL will prove cumbersome:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ContainerWithDefaultAcl</span> <span class="directive">extends</span> WithData {

    <span class="annotation">@Mandatory</span>
    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ACL_ID)
    <span class="type">long</span> getAclId();

    <span class="type">void</span> setAclId(<span class="type">long</span> aclId);

    <span class="annotation">@DefaultValue</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">acl_id</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">default</span> <span class="type">long</span> defaultAcl() {

        <span class="keyword">return</span> ?? <i class="conum" data-value="2"></i><b>(2)</b>
    }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Of course one can define the ACL system property with a default value.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>However, when specifying the default value one faces a problem. The id of an ACL is set by the Access Control Service
automatically and will vary from deployment to deployment, even between test and production environments.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, the concepts presented so far can be used for a better solution. The main idea is to specify the ACL by its name instead of its id. For that we will need access to a table containing ACL names and their respective ids. Here <a href="#External Views">external views</a> can be used. We have already seen an external view exposing the ACL table to <em>arveo</em>:</p>
</div>
<div class="listingblock">
<div class="title">Defintion of a view to the acl table</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span class="annotation">@View</span>
<span class="annotation">@Type</span>(ObjectType.META)
<span class="annotation">@TableName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">usrv_acl</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">AclView</span> {

    <span class="annotation">@Unique</span>
    <span class="predefined-type">String</span> getName();

    <span class="annotation">@PrimaryKey</span>
    <span class="type">long</span> getId();
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since that exposes ACLs as <em>arveo</em> type instances, ACLs can be used for <a href="#Direct inheritance">inheritance</a>. And since ACL names are unique they can be used as a foreign key, particularly as one defining inheritance. That way the actual ACL id can be inherited by a key that is an ACL name, for which we can easily define a <a href="#Default Values">default value</a> that is stable over every environment:</p>
</div>
<div class="listingblock">
<div class="title">A sofisticated example of an ACL default value</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ContainerWithDefaultAcl</span> <span class="directive">extends</span> WithData {

    <span class="predefined-type">String</span> DEFAULT_ACL_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">default-container-acl</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="annotation">@Id</span>
    ContainerId getId();

    <span class="annotation">@Optional</span> <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="annotation">@ForeignKey</span>(target = AclView.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-type">String</span> getAcl(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="type">void</span> setAcl(<span class="predefined-type">String</span> acl);

    <span class="annotation">@DefaultValue</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">acl</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">default</span> <span class="predefined-type">String</span> defaultAcl() { <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="keyword">return</span> DEFAULT_ACL_NAME;
    }

    <span class="annotation">@Mandatory</span> <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="annotation">@InheritedProperty</span>(foreignKeyPropertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">acl</span><span class="delimiter">&quot;</span></span>, sourcePropertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ACL_ID)
    <span class="type">long</span> getAclId(); <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="type">void</span> setAclId(<span class="type">long</span> aclId);
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In our type we define a property ACL, that holds the name of the ACL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This property is a foreign key that targets the field <code>name</code> table <code>usr_acl</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For this property we can easily specify a default value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now we specify the ACL property.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>It is simply defined to be inherited by the foreign key to the ACL table.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>It is good practice to store constant default values in constants.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Marking the ACL id as <em>@Mandatory</em> enforces that every instance of the entity must have an ACL. However, this does not need to be an inherited one (since the ACL name is marked <em>@Optional</em>). So the more cumbersome way - to set the ACL by its id - is still possible. Marking the ACL propery as <em>@Mandatory</em> would forbid this.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retention_3">Retention</h3>
<div class="sect3">
<h4 id="_annotations_retentionprotected">Annotations <em>@RetentionProtected</em></h4>
<div class="paragraph">
<p>An object may be annotated as <em>@RetentionProtected</em>. This will enable all further retention annotations listed below.Every retention enabled object extends the data model by</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Datetime <em>Retention_Date</em>: contains the fixed retention period as <em>ZonedDateTime</em> format</p>
</li>
<li>
<p>Boolean <em>LitigationHold</em>: stores the litigation hold property</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The convenience class 'Retention_Info' contains both values and can be used to read the retention information with one call.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_annotations_defaultsystempropertyvalueretention_date">Annotations <em>@DefaultSystemPropertyValue(RETENTION_DATE)</em></h4>
<div class="paragraph">
<p>It is possible to define a default value for the <em>RETENTION_DATE</em> system column
(<a href="#_default_values">Default Values</a>]).</p>
</div>
<div class="paragraph">
<p>If a retention date is not explicitly set, a default value for the retention period is calculated using the default value
function implemented by the document type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre><span class="annotation">@DefaultSystemPropertyValue</span>(SystemPropertyName.RETENTION_DATE)
<span class="keyword">default</span> ZonedDateTime defaultDatum() {
    <span class="keyword">return</span> ZonedDateTime.Now().plusYears(<span class="integer">10</span>);
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<em>@RetentionProtected</em> annotations is required if you want to set a default for <em>retention_date</em>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you have defined foreign keys, you can inherit the retention date from container or folder objects.This is very helpful
if you have records in your data model (<a href="#_inheritance">Defaults and Inheritance</a>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_retention_examples">Examples</h4>
<div class="sect4">
<h5 id="_document_type_10_year_retention_period">Document Type: 10 year retention period</h5>
<div class="paragraph">
<p>The following example shows how to set the default retention to creation date + 10 years.
It also shows how to set a default value for the property <em>warrantyEnd</em> based on the ReceiptDate + 3 years.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
It is still possible to set the <em>Retention_date</em> and <em>warrantyEnd</em> when you upload the document and overwrite the default value.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example: Upload a document with new content</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/*
 * Copyright (c) 2020 EITCO GmbH
 * All rights reserved.
 *
 * Created on 02.10.2020
 *
 */</span>
<span class="keyword">package</span> <span class="namespace">de.eitco.ecr.system.test.types.defaultvalues</span>;

<span class="keyword">import</span> <span class="include">de.eitco.ecr.common.RetentionInformation</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.ContentElement</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.ObjectType</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.OverwriteAllowed</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.Type</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.constraint.Mandatory</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.constraint.SecondaryKey</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.defaults.DefaultSystemPropertyValue</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.defaults.DefaultValue</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.system.Id</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.system.RetentionProtected</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.system.SystemProperty</span>;
<span class="keyword">import</span> <span class="include">de.eitco.ecr.type.definition.annotations.system.SystemPropertyName</span>;
<span class="keyword">import</span> <span class="include">org.springframework.http.MediaType</span>;

<span class="keyword">import</span> <span class="include">java.time.ZoneId</span>;
<span class="keyword">import</span> <span class="include">java.time.ZonedDateTime</span>;

<span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@RetentionProtected</span>
<span class="annotation">@ContentElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, separateField = <span class="predefined-constant">true</span>)
<span class="annotation">@OverwriteAllowed</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DocumentWithDefaultRetention</span> {

    <span class="annotation">@Id</span>
    <span class="predefined-type">Object</span> identifier();

    <span class="annotation">@SystemProperty</span>(value = SystemPropertyName.RETENTION_INFO)
    RetentionInformation getRetentionInformation();

    <span class="annotation">@SystemProperty</span>(value = SystemPropertyName.RETENTION_DATE)
    ZonedDateTime getRetentionDate();

    <span class="type">void</span> setRetentionDate(ZonedDateTime retentionDate);

    <span class="annotation">@SystemProperty</span>(value = SystemPropertyName.LITIGATION_HOLD)
    <span class="predefined-type">Boolean</span> getLitigationHold();

    <span class="annotation">@SecondaryKey</span>
    <span class="predefined-type">String</span> getName();

    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

    <span class="annotation">@Mandatory</span>
    ZonedDateTime getReceiptDate();

    <span class="type">void</span> setReceiptDate(ZonedDateTime receiptDate);

    <span class="annotation">@Mandatory</span>
    ZonedDateTime getWarrantyEnd();

    <span class="type">void</span> setWarrantyEnd(ZonedDateTime warrantyEnd);

    <span class="annotation">@Mandatory</span>
    <span class="predefined-type">String</span> getMimeType();

    <span class="type">void</span> setMimeType(<span class="predefined-type">String</span> value);


    <span class="comment">// helper for snake case db column names based on camel case getter/setter names</span>
    <span class="comment">// attenttion you MUST use snake db column names in default value annotations! if the name is wrong you will get a model exception during start up</span>
    <span class="predefined-type">String</span> DB_COL_WARRANTYEND = <span class="string"><span class="delimiter">&quot;</span><span class="content">warranty_end</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">String</span> DB_COL_MIMETYPE = <span class="string"><span class="delimiter">&quot;</span><span class="content">mime_type</span><span class="delimiter">&quot;</span></span>;
    <span class="predefined-type">String</span> DB_COL_RECEIPTDATE = <span class="string"><span class="delimiter">&quot;</span><span class="content">receipt_date</span><span class="delimiter">&quot;</span></span>;
    <span class="predefined-type">String</span> DB_COL_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>;
    <span class="predefined-type">String</span> DB_COL_RETENTIONDATE = <span class="string"><span class="delimiter">&quot;</span><span class="content">retention_date</span><span class="delimiter">&quot;</span></span>;

    ZoneId ZoneIdEuropeBerlin = ZoneId.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Europe/Berlin</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">// set default values</span>
    <span class="annotation">@DefaultValue</span>(DB_COL_WARRANTYEND)
    <span class="keyword">default</span> ZonedDateTime defaultWarrantyEnd() {

        <span class="keyword">return</span> getReceiptDate().withZoneSameInstant(ZoneIdEuropeBerlin).plusYears(<span class="integer">3</span>);
    }

    <span class="annotation">@DefaultSystemPropertyValue</span>(SystemPropertyName.RETENTION_DATE)
    <span class="keyword">default</span> ZonedDateTime defaultRetentionDate() {

        <span class="keyword">return</span> ZonedDateTime.now(ZoneIdEuropeBerlin).plusYears(<span class="integer">10</span>);
    }

    <span class="annotation">@DefaultValue</span>(DB_COL_MIMETYPE)
    <span class="keyword">default</span> <span class="predefined-type">String</span> defaultMimeType() {
        <span class="keyword">return</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
(1) The annotation <em>@DefaultValue()</em> only accepts the database column name as static string parameter.As the document
type properties are CAMEL case and the database column names are SNAKE case
you must convert your properties e.g. MyCamelCaseProperty = my_camel_case_property.In the below example constants are defined in the type.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The retention annotations also work for the document types: container, folder and relation.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tenant_separation">Tenant separation</h3>
<div class="paragraph">
<p>Objects can be separated by <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons.tenant/cmn-tenant-parent/3.0.0/documentation/index.html">tenant</a>. If this is activated on a type definition, the corresponding table will contain a system field <em>tenant_id</em>, where the <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons.tenant/cmn-tenant-parent/3.0.0/documentation/index.html#_tenants">id of the tenant</a> an entity resides in is stored.</p>
</div>
<div class="paragraph">
<p>The field will be assigned to the creation users tenants id and never change. When entities are queried, a filter will be added that filters only entities whose <em>tenant_id</em> field have the value of the querying users tenants id.</p>
</div>
<div class="sect3">
<h4 id="_fallback_tenant">Fallback-tenant</h4>
<div class="paragraph">
<p>Should the creation user be in the <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons.tenant/cmn-tenant-parent/3.0.0/documentation/index.html#<em>the_fallback_tenant">fallback-tenant</a>, the _tenant_id</em> field will be set to <em>NULL</em>.
Should a querying user reside in the fallback-tenant, the query will not be filtered by tenant. This means that the fallback tenant behaves like a view to the data that combines all tenants. If such a thing is unwanted deactivate the fallback tenant using the <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons.tenant/cmn-tenant-parent/3.0.0/documentation/index.html#_configuration">multi-tenancy.mode configuration property</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_usage_2">Usage</h4>
<div class="paragraph">
<p>The behaviour is primarily defined by the <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons.tenant/cmn-tenant-parent/3.0.0/documentation/index.html#_configuration">multi-tenancy.mode configuration property</a></p>
</div>
<div class="paragraph">
<p>It can be controlled more fine-grained by the annotation <em>@TenantSeparation</em>, however this makes sense mostly in environments where <em>multi-tenancy.mode</em> is <em>allowed</em>.</p>
</div>
<div class="listingblock">
<div class="title">A type separating its entities by tenant</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@TenantSeparation</span>(<span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Person</span> {

<span class="comment">// property definitions ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are aliases specified: <em>@TenantSeparated</em> for <em>@TenantSeparation(true)</em> and <em>@TenantAgnostic</em> for <em>@TenantSeparation(false)</em>.</p>
</div>
<div class="paragraph">
<p>The default behaviour depends on the <a href="https://nexus.eitco.de/repository/html-default/de.eitco.commons.tenant/cmn-tenant-parent/3.0.0/documentation/index.html#_configuration">multi-tenancy.mode configuration property</a>:</p>
</div>
<div class="paragraph">
<p>If it is <em>enforced</em>, types are separated by tenant by default. Any type specified to be not separated by tenant will cause arveo to fail at startup.</p>
</div>
<div class="paragraph">
<p>If it is <em>disabled</em>, types are not separated by tenant by default. Any type specified to be separated by tenant will cause arveo to fail at startup.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_db_schema_changes">Advanced db schema changes</h3>
<div class="paragraph">
<p>Simple changes of the database schema like adding a new attribute are performed automatically by the system in
maintenance mode. In some cases it might be required to perform more complex schema changes, which cannot be handled by
the system automatically.
The following changes cannot be performed automatically on tables that already contains data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>setting NOT NULL for an existing column;</p>
</li>
<li>
<p>type changes especially to non-string columns;</p>
</li>
<li>
<p>foreign keys;</p>
</li>
<li>
<p>making a column UNIQUE.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, changing the data type of an attribute is not supported because it usually
requires project specific migration steps. Advanced changes like this can be performed by custom liquibase scripts.</p>
</div>
<div class="paragraph">
<p>To perform custom database schema migrations, <em>arveo</em> offers several ways to define custom liquibase migration
scripts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A global script that will be executed before the first type definition will be created or updated. This script can
be configured using the property <code>ecr.server.liquibase.preInitializationChangeLog</code>.</p>
</li>
<li>
<p>A global script that will be executed after the last type definition was created or updated. This script can
be configured using the property <code>ecr.server.liquibase.customChangeLog</code>.</p>
</li>
<li>
<p>A script for a specific type definition that will be executed before the type definition is created or updated.
This script can be configured using the annotation <code>@PreSchemaInitialization</code> on the class representing the type
definition.</p>
</li>
<li>
<p>A script for a specific type definition that will be executed after the type definition was created or updated.
This script can be configured using the annotation <code>@PostSchemaInitialization</code> on the class representing the type
definition.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The values of the configuration properties for the global scripts and the annotations must be valid URIs pointing to
a liquibase changelog script. The URIs can point to a filesystem resource (using <code>file:/</code>) or a classpath resource
(using <code>classpath:</code>). Each script will be executed in every configured tenant.</p>
</div>
<div class="sect3">
<h4 id="_schema_initialization_steps">Schema initialization steps</h4>
<div class="paragraph">
<p>For a better understanding of how the schema initialization works, the following list shows the steps performed by the
system at startup:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for each tenant:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create or update the system tables</p>
</li>
<li>
<p>Execute custom pre initialization changelog if configured</p>
</li>
<li>
<p>For each registered type definition class:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Execute custom class-specific pre schema initialization script if configured</p>
</li>
<li>
<p>Create or update the type definition table(s)</p>
</li>
<li>
<p>Execute custom class-specific post schema initialization script if configured</p>
</li>
</ol>
</div>
</li>
<li>
<p>Execute custom liquibase changelog if configured</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the actions performed by the automatic schema initialization in step 3.b. can be influenced by the changes
that were already performed by the custom scripts executed before. For example, the system will not try to create a new
attribute if the custom script has already performed the required schema changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example">Example</h4>
<div class="paragraph">
<p>The following example shows a type definition class that defines a custom script that will be executed before the
type definition is updated. The script expects that the type definition table already exists on the database and is
used to change the data type of the attribute <em>postal_code</em> from Long to String. Note that for the sake of simplicity,
the script does not perform an actual data migration but simply drops and re-creates the database column for the
attribute.</p>
</div>
<div class="listingblock">
<div class="title">Example for a type definition with custom pre schema initialization script</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@Index</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">my_container_name_index</span><span class="delimiter">&quot;</span></span>, onVersionTable = <span class="predefined-constant">true</span>)
<span class="annotation">@PreSchemaInitialization</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:liquibase/my-container-changelog.xml</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">MyContainer</span> {</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example for a custom liquibase script</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="preprocessor">&lt;?xml version=&quot;1.1&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;databaseChangeLog</span>
        <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.liquibase.org/xml/ns/dbchangelog</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.liquibase.org/xml/ns/dbchangelog</span>
                      <span class="content">http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">logicalFilePath</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-container-changelog.xml</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;changeSet</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">update-my-container-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">author</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;dropColumn</span> <span class="attribute-name">tableName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my_container</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">columnName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postal_code</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;addColumn</span> <span class="attribute-name">tableName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my_container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postal_code</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/addColumn&gt;</span>
        <span class="tag">&lt;dropColumn</span> <span class="attribute-name">tableName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my_container_ver</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">columnName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postal_code</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;addColumn</span> <span class="attribute-name">tableName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my_container_ver</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postal_code</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/addColumn&gt;</span>
    <span class="tag">&lt;/changeSet&gt;</span>

<span class="tag">&lt;/databaseChangeLog&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the script in the above example first updates the content of the type definition system tables to reflect
the changed data type of the attribute <em>postal_code</em> of the type <em>my_container</em>. Doing this causes the automatic
migration performed afterwards to ignore the change. Other changes in the type class would still be performed automatically, if possible.
The script then simple drops and re-creates the column for the
attribute. In a real-life scenario, this is the place where the actual data migration would happen.</p>
</div>
</div>
<div class="sect3">
<h4 id="_changes_not_checked_during_startup">Changes not checked during startup</h4>
<div class="paragraph">
<p>The following changes in the type system will not be checked for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Inheritance</strong>: Changing the source key or the source property of an inherited property is allowed. The system will accept it (and not even check it). This can have subtle consequences. The data of an entity created before such a change will still be as before. However, the next time it is updated the inheritance will be computed anew and thus the data will change according the new inheritance rule.</p>
</li>
<li>
<p><strong>formatted counter sequence names</strong>: Changing the name of the sequence of a formatted counter will take effect. This can have an impact on your application. It will result in the creation of a new sequence and effectively reset the counters value. This might be desired effect - it could also be the result of an oversight in the type changes. To protect oneself from accidental changes it is deemed could practice to mark formatted counter fields with <code>@Unique</code>.</p>
</li>
<li>
<p><strong>indexes prefixed with <code>ecr_mnl_</code>:</strong> Indexes defined on tables belonging to ecr types will be created and deleted according to changes in the types. However, indexes whose names start with the prefix <code>ecr_mnl_</code> will be excluded from that. This enables admins to quickly react on slow systems without a system update inferring with such a patch. This has two consequences</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Admins, that manually add an index, should pick a name for the index that starts with <code>ecr_mnl_</code></p>
</li>
<li>
<p>Developers, that add an index to an arveo type should pick a name that does not start with <code>ecr_mnl_</code></p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In a case where an index prefixed with <code>ecr_mnl_</code> is used it will be beneficially in the long-run, to add the index to the type. In this case the prefix <code>ecr_mnl_</code> in the name must be omitted when defining the index on the type.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_document_service"><strong>Document Service</strong></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Document Service service is responsible for handling various repository entities such as documents and folders. The following entity types are supported: document, folder, container, relation and metadata.</p>
</div>
<div class="paragraph">
<p>The service saves the binary data belonging to the documents and delivers them again. Various plugins are available for connecting storage devices and services. A plug-in is assigned to a profile and configured. When saving data, the client has to specify the profile to be used and thereby decides where the data will be saved.</p>
</div>
<div class="sect2">
<h3 id="_upload_data">Upload data</h3>
<div class="paragraph">
<p>Content, annotations (see below) and metadata can be uploaded as a coherent document. 0-n content elements of different content types are possible. Each content element is named. As a result, you get a globally unique ID (DocumentID), which can be used to reference content, annotations and / or just metadata of the latest version of the document. It is possible to clone content elements from one document to another, creating a copy of the content on the storage. For that, a ContentReference can be supplied when the document is created.</p>
</div>
<div class="listingblock">
<div class="title">Example: Upload a document with new content</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedDocumentServiceClient&lt;SingleContentDocument&gt; serviceClient =
    typeDefinitionServiceClient.getDocumentServiceClient().byClass(SingleContentDocument.class); <i class="conum" data-value="1"></i><b>(1)</b>

SingleContentDocument document = serviceClient.createTypeInstance();
document.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">some name</span><span class="delimiter">&quot;</span></span>);

TypedDocumentClient&lt;SingleContentDocument&gt; client = serviceClient.create(
    <span class="keyword">new</span> TypedDocumentInput&lt;&gt;(<span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">new</span> ContentUpload(inputStream)), document)); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The typeDefinitionServiceClient is an instance of TypeDefinitionServiceClient, that can be injected.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The type definition SingleContentDocument uses only the default content definition, hence the default name is used.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The actual content is passed as an InputStream.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example: Upload a document with cloned content</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedDocumentServiceClient&lt;TypedTargetDocument&gt; serviceClient =
    typeDefinitionServiceClient.getDocumentServiceClient().byClass(TypedTargetDocument.class); <i class="conum" data-value="1"></i><b>(1)</b>

TypedTargetDocument document = serviceClient.createTypeInstance();

DocumentContentReference reference = <span class="keyword">new</span> DocumentContentReference(documentId, <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="2"></i><b>(2)</b>

TypedDocumentClient&lt;TypedTargetDocument&gt; client =
    serviceClient.create(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(document, <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, reference)));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The typeDefinitionServiceClient is an instance of TypeDefinitionServiceClient, that can be injected.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here the documentId is the ID of an already existing document that uses the default content definition.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example: Upload a document with Base64 encoded data</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Base64EncodedData data = <span class="keyword">new</span> Base64EncodedData(base64Data);<i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentUpload&gt; contentElements = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ContentUpload(data));<i class="conum" data-value="2"></i><b>(2)</b>

serviceClient.create(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(contentElements, document));<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Wrap the Base64 encoded data in a new <code>Base64EncodedData</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a content upload with the created <code>Base64EncodedData</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Upload the document</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_validating_uploaded_content">Validating uploaded content</h4>
<div class="paragraph">
<p>There are several different ways to validate the content of an uploaded document. The method to use depends on the requirements of the client application. Some applications might already have computed a hash of the content while others might offload this to the server.</p>
</div>
<div class="sect4">
<h5 id="_validating_content_on_the_client_side">Validating content on the client side</h5>
<div class="paragraph">
<p>When content is uploaded to a type definition that supports content metadata, the server computes an SHA-256 hash for the received data and returns it in the result of the upload request. The client can use this hash value to compare the data received by the server with the original data. The following example shows how to compare the hash values:</p>
</div>
<div class="listingblock">
<div class="title">Example: Checking hash values on the client side</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ContentTest entity = client.create(input).getEntity(); <i class="conum" data-value="1"></i><b>(1)</b>
Hash hash = entity.getContent().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>).getHash(); <i class="conum" data-value="2"></i><b>(2)</b>

Hash expectedHash = Hash.sha256Hash(inputStream, <span class="integer">1000000</span>, tempFile); <i class="conum" data-value="3"></i><b>(3)</b>
Assert.assertEquals(expectedHash, hash);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The document is uploaded using a type definition service client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the hash returned from the server. <code>getContent</code> is a getter for the system property <code>SystemPropertyName.CONTENT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <code>de.eitco.ecr.common.Hash</code> to compute the expected hash</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>TypedDocumentServiceClient</code> offers an additional method to validate uploaded content. The <code>createAndValidate</code> method automatically computes a hash of the uploaded data and compares it with the hash value returned from the server. If the two hashes do not match, a <code>HashValidationException</code> is thrown and the created document will be purged.</p>
</div>
<div class="listingblock">
<div class="title">Example: Using the createAndValidate method</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedDocumentServiceClient&lt;ContentTest&gt; client = typeDefinitionServiceClient
    .getDocumentServiceClient().byClass(ContentTest.class);

ContentUpload contentUpload = <span class="keyword">new</span> ContentUpload(data);

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentUpload&gt; content = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, contentUpload);

ContentTest instance = client.createTypeInstance();
TypedDocumentInput&lt;ContentTest&gt; input = <span class="keyword">new</span> TypedDocumentInput&lt;&gt;(content, instance);

client.createAndValidate(input);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_validating_content_on_the_server_side">Validating content on the server side</h5>
<div class="paragraph">
<p>It is also possible to pass a hex representation of an SHA-256 hash code of the uploaded content to the server. If such a hash is present, the server will compare the computed hash value with the one specified by the client. If the values do not match, the upload fails and the uploaded file will not be stored.</p>
</div>
<div class="listingblock">
<div class="title">Example: Checking hash values on the server side</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Hash hash = Hash.sha256Hash(inputStream, <span class="integer">1000000</span>, tempFile); <i class="conum" data-value="1"></i><b>(1)</b>

ContentUpload contentUpload = <span class="keyword">new</span> ContentUpload(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">lorem_ipsum.txt</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-constant">null</span>, <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="predefined-constant">null</span>, <i class="conum" data-value="4"></i><b>(4)</b>
    data,
    hash
);

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentUpload&gt; content = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, contentUpload);

ContentTest document = client.createTypeInstance();
TypedDocumentInput&lt;ContentTest&gt; input = <span class="keyword">new</span> TypedDocumentInput&lt;&gt;(content, document);

client.create(input);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>de.eitco.ecr.common.Hash</code> to compute the hash</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The filename</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>null for the length, will be computed by the server</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>null for the content type, will be computed by the server</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_validating_the_content_of_an_existing_document">Validating the content of an existing document</h5>
<div class="paragraph">
<p>The <code>TypedDocumentServiceClient</code> provides a method called <code>hashMatches</code> that can be used to check if the content of an existing document is valid. The client has to provide the expected hash, the document&#8217;s ID and the name of the content element to check. An additional parameter called <code>loadContent</code> defines if the server should use the hash value stored in the database or if it should load the content from the storage and compute a new hash value to compare. It is possible to check the content of a specific version of a document, too.</p>
</div>
<div class="listingblock">
<div class="title">Example: Checking hash values of an existing document</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Hash hash = Hash.sha256Hash(inputStream, <span class="integer">1000000</span>, tempFile);
<span class="type">boolean</span> hashMatches = documentServiceClient.hashMatches(documentId, <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, hash, <span class="predefined-constant">false</span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_resumable_uploads">Resumable uploads</h4>
<div class="paragraph">
<p>In some situations uploading large files might fail because of timeouts or an unstable network connection. For these
situations, arveo supports resumable uploads using the <a href="http://tus.io">tus</a> protocol. On the server side, an
additional service is used that provides the tus API and stores uploaded files in the filesystem. The Content Repository
Service retrieves uploaded files from the upload service and stores them just as any regular content. When the content
was stored successfully, the uploaded file is deleted from the upload service&#8217;s storage automatically. In case storing
the content in the Content Repository Service has failed, the uploaded file is not removed, giving the client the
opportunity to re-try storing the content without having to upload the entire file again.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use the official tus Java client in combination with the arveo SDK to use
resumable uploads.</p>
</div>
<div class="listingblock">
<div class="title">Example: Resumable uploads</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TusClient client = <span class="keyword">new</span> TusClient();
client.setUploadCreationURL(<span class="keyword">new</span> <span class="predefined-type">URL</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:</span><span class="delimiter">&quot;</span></span> + tusUploadServicePort + <span class="string"><span class="delimiter">&quot;</span><span class="content">/files</span><span class="delimiter">&quot;</span></span>)); <i class="conum" data-value="1"></i><b>(1)</b>
client.enableResuming(<span class="keyword">new</span> TusURLMemoryStore());

<span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; headers = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
headers.put(HttpHeaders.AUTHORIZATION, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bearer </span><span class="delimiter">&quot;</span></span> + oAuth2TokenManager.getAccessToken()); <i class="conum" data-value="2"></i><b>(2)</b>
client.setHeaders(headers);

<span class="predefined-type">File</span> file = <span class="keyword">new</span> <span class="predefined-type">File</span>(baseDirectory + <span class="string"><span class="delimiter">&quot;</span><span class="content">/src/test/resources/documents/lorem_ipsum.txt</span><span class="delimiter">&quot;</span></span>);
TusUpload upload = <span class="keyword">new</span> TusUpload(file);

<span class="directive">final</span> <span class="predefined-type">String</span><span class="type">[]</span> uploadId = <span class="keyword">new</span> <span class="predefined-type">String</span>[<span class="integer">1</span>];

TusExecutor executor = <span class="keyword">new</span> TusExecutor() {
    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> makeAttempt() <span class="directive">throws</span> <span class="exception">ProtocolException</span>, <span class="exception">IOException</span> {

        TusUploader uploader = client.resumeOrCreateUpload(upload);
        uploader.setChunkSize(<span class="integer">102400</span>);

        <span class="keyword">do</span> {
            <span class="type">long</span> totalBytes = upload.getSize();
            <span class="type">long</span> bytesUploaded = uploader.getOffset();
            <span class="type">double</span> progress = (<span class="type">double</span>) bytesUploaded / totalBytes * <span class="integer">100</span>;

            <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Upload at %06.2f%%.</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, progress); <i class="conum" data-value="3"></i><b>(3)</b>
        } <span class="keyword">while</span> (uploader.uploadChunk() &gt; -<span class="integer">1</span>);

        uploader.finish();

        <span class="predefined-type">String</span> filePart = uploader.getUploadURL().getFile();
        uploadId[<span class="integer">0</span>] = filePart.substring(filePart.lastIndexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) + <span class="integer">1</span>); <i class="conum" data-value="4"></i><b>(4)</b>
    }
};

executor.makeAttempts();

TypedDocumentServiceClient&lt;Files&gt; serviceClient =
    typeDefinitionServiceClient.getDocumentServiceClient().byClass(Files.class);

Files document = serviceClient.createTypeInstance();
document.setFilename(<span class="string"><span class="delimiter">&quot;</span><span class="content">lorem_ipsum.txt</span><span class="delimiter">&quot;</span></span>);

AsyncUploadReference uploadReference = <span class="keyword">new</span> AsyncUploadReference(uploadId[<span class="integer">0</span>], <span class="string"><span class="delimiter">&quot;</span><span class="content">lorem_ipsum.txt</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="5"></i><b>(5)</b>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentReference&gt; contentReferences = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, uploadReference);

TypedDocumentClient&lt;Files&gt; typedDocumentClient =
    serviceClient.create(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(document, contentReferences));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new TusClient using the URL of the upload service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Authentication is done using OAuth2. The Oauth2TokenManager is provided by the OAuth2 client library from eitco commons and can be injected.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An example that shows how to display the progress of the upload.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Determine the unique ID of the upload. It is the last part of the upload URL returned by the TusUploader.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Reference the uploaded file using its ID for the document creation call for the Content Repository Service.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_download_data">Download data</h3>
<div class="paragraph">
<p>Content, annotations and metadata of a document can be downloaded via API. It is possible to load the entire document as a multipart or a structure of the document that includes all metadata, annotations and a list of content elements with their IDs, types and identifiers. Each content element can then be loaded using the document ID / content ID or the
document ID / content type. Access to individual content elements without a document ID is not possible for reasons of access control. Access control based on the document ID is ensured with every access.</p>
</div>
<div class="sect3">
<h4 id="_update_metadata_without_a_version">Update metadata without a version</h4>
<div class="paragraph">
<p>The meta information of a document can be changed. The changes can be persisted in the database without creating a version. It is possible, to maintain frequently changing information on the document quickly without creating the overhead of a version. However, in the event of an audit, the changes are not traceable.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_document_service_recycle_bin">Delete an object</h3>
<div class="paragraph">
<p>Documents contain one or more content elements which are not stored in the database but in the storage system. When a document is deleted using one of the delete-calls, the content elements will remain on the storage. To delete both the database entries and all content elements (including those referenced from older versions), a client can use the purge
methods provided by the document clients.</p>
</div>
<div class="paragraph">
<p>A type definition can use the optional <em>recycle bin</em> feature. If it is enabled, entities in the type definition can be moved to and restored from the recycle bin.
The Delete-API allows you to execute the methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MoveToRecycleBin(): to move an object to the recycle bin. The <em>DELETE</em>-property of the latest version is set to 1 and content and older versions are not affected.</p>
</li>
<li>
<p>Delete() all the versions of the object are deleted from the database.</p>
</li>
<li>
<p>Purge(): all the version of the objects are deleted from the database and the content objects or files are erased.</p>
</li>
<li>
<p>RestoreFormRecycleBin(): restore an object from the recycle bin, the <em>DELETE</em>-property is set to 0</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If an object has relations to other objects is related by other objects the delete or purge method will fail with a foreign key exception. The Relation API provides methods to delete the relations (<a href="#_removing_all_relations_of_an_entity"><strong>Remove Relations</strong></a>)
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_filter_recycle_bin">Filter recycle bin</h4>
<div class="paragraph">
<p>Entities in the recycle bin will be filtered from normal queries by default, but a client can compose search expressions that override this behavior. To do that it is sufficient to include a reference to the deleted system field in the expression. The following example shows a part of a query that will show only deleted entities:</p>
</div>
<div class="listingblock">
<div class="title">Excerpt of an example query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">....and().systemField(SystemFieldList.GeneralSystemField.Deleted.INSTANCE).equalTo().value(<span class="predefined-constant">true</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the deleted system field can contain <em>null</em> values, which have the same meaning as <em>false</em>. When a client uses one of the <em>delete</em> calls to delete one or more entities, all database entries for those entities will be deleted (including all versions).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no option to restore entities once they have been deleted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If there are relations between entities that are to be deleted, the relations are not deleted. Instead, a <em>ForeignKeyException</em> is thrown - and has to be handled by the caller.</p>
</div>
</div>
<div class="sect3">
<h4 id="_removing_all_relations_of_an_entity">Removing all relations of an entity</h4>
<div class="paragraph">
<p>To delete all relations that originate from a certain entity, the method <em>removeAllRelations()</em> has to be used. The method returns the deleted relations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Relation</span>&gt; removed = sourceContainerClient.removeAllRelations();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also delete all relations that point to a specific entity. For this, there is the method <em>removeAllIncomingRelations()</em>. This also returns the deleted relations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Relation</span>&gt; removed = targetContainerClient.removeAllIncomingRelations();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all relations have been removed, the entity can also be deleted.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_locking">Locking</h3>
<div class="paragraph">
<p>If your applications want to update objects from different processes at the same time you must decide if you want to use no locking or optimistic locking.
No locking means that the latest update wins and overwrites the concurrent update. Depending on the database configuration it might happen that one update becomes a deadlock victim and an exception is thrown.
If optimistic locking is enabled for the document type the API ensures that updates do not overwrite changes made by other clients by accident. The feature is disabled by default and can be enabled by annotating a type class with <em>@OptimisticLocking</em>.
e.g. two processes A and B load the same object including content and versions at the same time and get the same version of the document. Now both processes process the document and some metadata and add additional content. A is faster than B. With No Locking B overwrites the changes made by A. With optimistic locking B cannot save the changes and receives a Locking exception. Process B has to load the changes made by A and retry the operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_download_links_for_external_users">Download links for external users</h3>
<div class="paragraph">
<p>You can create download links for content elements that can be used by external users who do not exist in the user management service. Such a link has an expiration date and can be used to download a single content element. The links are digitally signed using a configurable certificate, so that the receiver cannot alter the
referenced content element or the expiration date of the link. The <em>arveo</em> service provides a special HTTP endpoint to process download links. This endpoint does not require authentication. Instead, the download link contains credentials that allow the user to access the referenced content element.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This feature must be activated by configuring a keystore containing an RSA keypair that will be used to sign the links.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration options are listed <a href="#_ecr_server_content-access-tokens">here</a>.</p>
</div>
<div class="paragraph">
<p>Download links (or content access tokens), can be created using the Java SDK as shown in the following exaple:</p>
</div>
<div class="listingblock">
<div class="title">Injecting and instance of the ContentAccessTokenResourceClient</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> ContentAccessTokenResourceClient contentAccessTokenResourceClient;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Creating a new content access token</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ContentAccessTokenInput input = <span class="keyword">new</span> ContentAccessTokenInput(
    documentId,<i class="conum" data-value="1"></i><b>(1)</b>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>,<i class="conum" data-value="2"></i><b>(2)</b>
    ZonedDateTime.now().plusHours(<span class="integer">3</span>)<i class="conum" data-value="3"></i><b>(3)</b>
);

<span class="predefined-type">String</span> token = contentAccessTokenResourceClient.createToken(input);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The ID of the document containing the content element to download</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the content element</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The expiration date of the link (can be omitted)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The returned token can then be used to download the content by performing a GET request to the following endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>GET http://my-arveo-instance/api/streaming/&lt;token&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Download links can only be created for content elements that are accessible to the user creating the link. When the client does not define an expiration date when the content access token is created, the configured maximum lifetime is used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The creation of new tokens will fail when the client specifies an expiration date that would exceed the configured maximum lifetime.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_versioning_v">Versioning</h3>
<div class="paragraph">
<p>The goal of using the concept of versioning is to create and work with version-safe archives and track the history of each change in the system.</p>
</div>
<div class="sect3">
<h4 id="_versioning_basics">Versioning basics</h4>
<div class="paragraph">
<p>All entity types in <em>arveo</em> may have a version, which itself is an optional attribute.
The attributes of the entity types specify in their definition whether they are versioned. If an entity
type has at least one versioned attribute, a version table is created.
The version number of an existing entity is automatically created and can be retrieved via the system property
version_number.</p>
</div>
<div class="paragraph">
<p>In the version table, the version changes to the metadata are listed, as well as the changes to one or more content
elements. Optionally you can specify a Unicode version comment.
Each version gets a version ID, which is unique for this bundle of version tables. The version id allows a developer to
retrieve content and metadata of exactly this version of the entity.
Using the API a developer can query all versions including their metadata and content elements for each entity ID or
version ID. It is ensured that the existing content of a version is not changed or deleted by a new version, but there is an exception to this rule, which does allow to overwrite a version change.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a function that allows you to make a change without having to note it in the version table. And there is
a way to forbid this for a certain entity type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_of_versioning">Implementation of versioning</h4>
<div class="paragraph">
<p>The concept of versioning is implemented using the annotation <em>@Versioned</em>, which is defined by the interface <em>Versioned</em>.
This annotation defines if an attribute of a type is versioned or not (when placed on a getter) or if all attributes
of a type are versioned or not (when placed on a type). When the annotation is present on a type and on a getter in
the type, the annotation on the getter wins.</p>
</div>
<div class="paragraph">
<p>The following example of an object of type <em>Container</em> contains an attribute "name", which is a versioned attribute.
The other attribute "counter" in this example is marked as not versioned.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.CONTAINER)
<span class="annotation">@OverwriteAllowed</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">TypedSourceContainer</span> {

    <span class="annotation">@Name</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">counter</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Versioned</span>(<span class="predefined-constant">false</span>)
    <span class="type">int</span> getCounter();

    <span class="annotation">@Name</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Versioned</span>
    <span class="predefined-type">String</span> getName();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_data_model_for_versioning">Data model for versioning</h4>
<div class="paragraph">
<p>The actual search table only contains the current status of metadata and system fields.
In the version table, however, all entities and their versions including the metadata are listed. Only versioned
attributes are included in the version table. A current internal version counter (1.,2&#8230;&#8203;n) is maintained in the system
column <em>version_number</em>.</p>
</div>
<div class="paragraph">
<p>During versioning the service counts up the internal version counter by incrementing the value of the system
column version_number by 1. The value is stored in the version table.</p>
</div>
<div class="paragraph">
<p>Changes to non-versioned fields cannot be tracked because they are not written to the version table.
To prevent accidental overwriting of such fields, optimistic locking can be activated.
In this case, a certain property is defined to let the system know, a certain version of an entity is outdated.</p>
</div>
<div class="sect4">
<h5 id="_optimistic_locking">Optimistic locking</h5>
<div class="paragraph">
<p>Activating the optimistic locking prevents overwriting for versioned fields. When simultaneously editing an entity and trying to overwrite saved changes of another user, an error message is thrown. Overwriting is not thus possible. Hence, through activating the optimistic locking on an entity type definition (using the annotation <em>@OptimisticLocking</em>), you prevent data corruption.</p>
</div>
<div class="paragraph">
<p>Optimistic locking is used only for single updates, not for batch updates.</p>
</div>
</div>
<div class="sect4">
<h5 id="_structure_of_the_version_system_table">Structure of the version system table</h5>
<div class="paragraph">
<p>The version system table consists of the following columns (this is not a complete excerpt):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 34. Structure of the system table</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">column</th>
<th class="tableblock halign-left valign-top">db data type</th>
<th class="tableblock halign-left valign-top">java data type</th>
<th class="tableblock halign-left valign-top">nullable?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigserial</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entity_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_acl_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modification_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZonedDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modification_user_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_comment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this table, <em>version_id</em> is the primary key. The foreign key <em>entity_id</em> references the corresponding entity table.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_version_id">Version ID</h4>
<div class="paragraph">
<p>The version ID has the following structure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[12bit Tenant id][14bit Type Definition id][38bit Version id]</pre>
</div>
</div>
<div class="paragraph">
<p>Here the tenant may be for instance a database scheme or a customer. It is followed by a type definition, for instance
<em>Container</em>. The third part is the version id in the database. The composed version id is unique in <em>arveo</em> system.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_search_language">Search language</h3>
<div class="sect3">
<h4 id="_search_service">Concept</h4>
<div class="paragraph">
<p>Any client application, that needs a search function, can implement the Search Service with a suitable parameter. An
example of such an implementation is the class <em>DocumentServiceClient</em> in the Client API. The search queries are
formulated similarly, what is different is the search result, which is always typed. In  <em>arveo</em> the type is
<em>Entity</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_technical_implementation">Technical implementation</h4>
<div class="paragraph">
<p>Search Service is part of the module 'commons'. It was created to enable more convenient searching. The Search Service
works on the basis of EQL (Eitco Query Language). This query language is also used for some other services, like
Access Control Service.
The main interface is SearchService. It is a functional interface, providing just one method to be implemented: search().
However, this functional interface has a variety of convenience methods, enabling faster and more convenient search, like
<em>firstResult()</em>, <em>uniqueResult()</em>, <em>count()</em>, <em>stream()</em> and others.</p>
</div>
<div class="listingblock">
<div class="title">Listing for the search method definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Page&lt;EntityType&gt; search(<span class="annotation">@NotNull</span> SearchRequest searchRequest);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the only parameter, a search request is accepted, returning a <em>Page</em> of results. A Page has a page definition, a
completeCount and a parameterized list of results. The Search Service also provides a method <em>where()</em> with a condition
builder, filtering results based on a specific condition.</p>
</div>
<div class="paragraph">
<p><em>SearchServiceFactory</em> is a server class, which builds search queries. It has methods for creating an instance of search
service for Documents (<em>searchServiceForDocument()</em>), but also for all the other entities, including Metadata. The result
of the search is transformed into a Document (or respectively another entity) by the <em>DocumentMapper</em>.</p>
</div>
<div class="paragraph">
<p>The class <em>SearchResourceImplementation</em> provides an API for searches that are not bound to one and only one type
definition.</p>
</div>
<div class="paragraph">
<p>The interface SearchService is implemented by the class <em>EcrSearchService</em>.</p>
</div>
<div class="paragraph">
<p>The search client creates different search services, which can be used to search for corresponding entities, for
instance a folder search service, a document search service and so on. And there is also a <em>GenericUnionSearchService</em>,
that can be used to create any joins on search statements.</p>
</div>
</div>
<div class="sect3">
<h4 id="_usage_3">Usage</h4>
<div class="paragraph">
<p>The following examples demonstrates the usage of the Search Service to retrieve an object page.</p>
</div>
<div class="listingblock">
<div class="title">Example of Search Service usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SearchService&lt;<span class="predefined-type">Object</span>&gt; searchService = &lt;a valid instance&gt;;
Page&lt;<span class="predefined-type">Object</span>&gt; objectPage = searchService.where()
    .contextReference(<span class="string"><span class="delimiter">&quot;</span><span class="content">field</span><span class="delimiter">&quot;</span></span>).equalTo().value(<span class="integer">7</span>).or()
    .contextReference(<span class="string"><span class="delimiter">&quot;</span><span class="content">other_field</span><span class="delimiter">&quot;</span></span>).greaterEqual().contextReference(<span class="string"><span class="delimiter">&quot;</span><span class="content">another_field</span><span class="delimiter">&quot;</span></span>)
    .holds()
    .order().descendingBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">field</span><span class="delimiter">&quot;</span></span>).from(<span class="integer">5</span>).pageSize(<span class="integer">7</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to check the type of object searched for:</p>
</div>
<div class="listingblock">
<div class="title">Example for type checking</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre>            searchService.where() <i class="conum" data-value="1"></i><b>(1)</b>
                .entity().typeId()   <i class="conum" data-value="2"></i><b>(2)</b>
                .equalTo()
                .typeId(NamedFile.class) <i class="conum" data-value="3"></i><b>(3)</b>
                .or()
                .entity().typeName() <i class="conum" data-value="4"></i><b>(4)</b>
                .in().expressions(x -&gt; x
                    .typeName(NamedTextFile.class) <i class="conum" data-value="5"></i><b>(5)</b>
                    .typeName(NamedFolder.class)
                ).and()
                .entity().typeId().notEqual().typeId(<span class="string"><span class="delimiter">&quot;</span><span class="content">named_relation</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="6"></i><b>(6)</b>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The variable <code>searchService</code> is an <code>EcrSearchService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The id of the type of given entity is referenced by the method <code>typeId()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The type id is checked to be the id of the type defined by the class <code>NamedFile</code> (which is obtained by the method <code>typeId()</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here the type name is referenced instead of the type id.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>As with the type id, the name of the type defined by the class <code>NamedTextFile</code> is obtained.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The type id can also be obtained if only the type name is given.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_search_endpoints">Search endpoints</h3>
<div class="paragraph">
<p>Using the ecr sdk you will be able to obtain a <code>SearchClient</code> by spring injection.</p>
</div>
<div class="listingblock">
<div class="title">Injecting a search client</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> SearchClient searchClient;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A search client has several methods to search in different ways or different contexts.</p>
</div>
<div class="sect3">
<h4 id="_aggregation_searches">Aggregation searches</h4>
<div class="paragraph">
<p>In some situations one needs to accumulate some values that are listed in a database. In SQL this is done using aggregate functions and the <code>group by</code> clause. For example in an invoice archive one might be interested in the number of invoices per customer, or the sum of their totals (per customer).
Queries like this can be executed using the aggregated search. As opposed to the other search methods the result entity type of this search method is <code>Map&lt;String, Object&gt;</code>, since aggregating properties will potentially result in a different type - one that might not be specified. Thus, a more general return type is used.</p>
</div>
<div class="paragraph">
<p>To start an aggregated search query, you will need to build a search service for your aggregated search first. We will build a service for the example above: querying the number and total sum of invoices per user.</p>
</div>
<div class="paragraph">
<p>Assume that we have a type <code>customer</code> defined by the class <code>Customer</code> and a type <code>invoice</code> defined by the class <code>Invoice</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@FilingEnabled</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Customer</span> {

    <span class="annotation">@SystemProperty</span>(SystemPropertyName.ID)
    DocumentId id();

    <span class="annotation">@Unique</span>
    <span class="predefined-type">String</span> getName();

    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

}

<span class="annotation">@Type</span>(ObjectType.DOCUMENT)
<span class="annotation">@FilingEnabled</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Invoice</span> {

    <span class="annotation">@ForeignKey</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">fk_invoice_customer</span><span class="delimiter">&quot;</span></span>, target = Customer.class, targetProperty = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
    <span class="type">long</span> getCustomerNumber();

    <span class="type">void</span> setCustomerNumber(<span class="type">long</span> number);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">String</span> getCustomerName();
    <span class="type">void</span> setCustomerName(<span class="predefined-type">String</span> customerName);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">String</span> getName();

    <span class="type">void</span> setName(<span class="predefined-type">String</span> name);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">Integer</span> getTotal();

    <span class="type">void</span> setTotal(<span class="predefined-type">Integer</span> total);

    <span class="annotation">@Optional</span>
    <span class="predefined-type">Boolean</span> getOpen();

    <span class="type">void</span> setOpen(<span class="predefined-type">Boolean</span> open);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the invoice references the customer with the property <code>customer_number</code> defined by the method <code>getCustomerNumber()</code>. Now we can build a search service as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="directive">final</span> EcrSearchService&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; aggregationSearchService = searchClient.aggregate() <i class="conum" data-value="1"></i><b>(1)</b>
            .count(<span class="string"><span class="delimiter">&quot;</span><span class="content">i</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoice_count</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
            .sum(<span class="string"><span class="delimiter">&quot;</span><span class="content">i</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoice_total</span><span class="delimiter">&quot;</span></span>)
            .groupedBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>)
            .from().type(Invoice.class).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">i</span><span class="delimiter">&quot;</span></span>).join().type(Customer.class).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
            .on().alias(<span class="string"><span class="delimiter">&quot;</span><span class="content">i</span><span class="delimiter">&quot;</span></span>).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">customer_number</span><span class="delimiter">&quot;</span></span>).equalTo().alias(<span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>).id() <i class="conum" data-value="4"></i><b>(4)</b>
            .holds().build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Calling <code>SearchClient.aggregate()</code> is the entry point to the fluent api to build a search service for aggregation search requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>At first, we need to specify what to aggregate and what to group by: In our case we want to get the count (of the invoice ids) and the sum of the invoice totals grouped by customer name (which is  unique). Every field that is grouped by will also be part of the result.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Now we need to specify from where the data to aggregate comes from. We join the type <code>Invoice</code> with the type <code>Customer</code>. Note that we specify aliases for the types <code>"i"</code> and <code>"c"</code>, which we used in the step before to reference the types fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now we specify the condition for the join. The condition is that the invoices <code>customer_number</code> must equal the customers' id - as the foreign key <code>fk_invoice_customer</code> above specifies.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can query for the aggregated data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; all = aggregationSearchService.where().alwaysTrue().holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in a list of maps - one map per customer - where every map contains the keys <code>"customer"</code>, <code>"invoice_count"</code> and <code>"invoice_total"</code>. Holding the customers name, the number of their invoices and their total sum, respectively´.</p>
</div>
<div class="paragraph">
<p>Additionally, we can query specific customers and invoices using the same search service. In this scenario for example we could query every customers <code>"invoice_count"</code> and <code>"invoice_total"</code> of invoices that are open i.e. that they haven&#8217;t paid, yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; open = aggregationSearchService.where()
            .alias(<span class="string"><span class="delimiter">&quot;</span><span class="content">i</span><span class="delimiter">&quot;</span></span>).field(<span class="string"><span class="delimiter">&quot;</span><span class="content">open</span><span class="delimiter">&quot;</span></span>).equalTo().value(<span class="predefined-constant">true</span>)
            .holds().unpaged();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will also result in a list of maps - one map per customer - where every map contains the keys <code>"customer"</code>, <code>"invoice_count"</code> and <code>"invoice_total"</code>. Holding the customers name, the number of their invoices and their total sum, respectively´ - only counting open invoices.</p>
</div>
<div class="paragraph">
<p>Note that we can reference the invoices field <code>open</code> by using the alias <code>i</code> we provided earlier, even though it is not part of the result.
=== Enterprise Search
==== NoSQL Document Database apache solr 8.6
Apache Solr is a search server and is used as an independent full-text search server for ECR Healthcare. Solr uses the Apache Lucene search library as the core for full-text indexing and search.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retention_periods_retention">Retention periods</h3>
<div class="paragraph">
<p><em>arveo</em> supports a range of retention management features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Full support of document life cycle;</p>
</li>
<li>
<p>Supports prolongation and litigation hold for data retention managers;</p>
</li>
<li>
<p>Privileged delete before retention expires;</p>
</li>
<li>
<p>Privileges for data protection officers (delete) and data protection managers (litigation);</p>
</li>
<li>
<p>Flexible storage container definition (e.g. months, years) for documents with identical retention period
(S3 buckets or file system folders);</p>
</li>
<li>
<p>Fast erasure of storage container by asynchronous delete jobs.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_concept">Concept</h4>
<div class="paragraph">
<p><em>arveo</em> is able to store content with a fixed retention date to ensure that the legal or tax relevant
retention period of a document is taken into account and the content is protected from deletion.
You can configure retention rules for <em>arveo</em> document types and automatically apply the appropriate retention
period to uploaded documents.</p>
</div>
<div class="paragraph">
<p>If some of your documents could be required in a legal proceeding but the retention period expires before
the end of dispute you can set a litigation hold or prolong the retention period to protect the data until the
dispute has finished.</p>
</div>
<div class="paragraph">
<p>Let us describe why the storage container concept is used by <em>arveo</em>. Most storage systems can create objects much faster than
they can delete them. Once the retention has expired it is
much faster to remove a bucket (cloud storage) or partition/directory (file system).
You can setup retention rules to define which documents are stored to the containers. All documents within a certain
retention range (e.g. 1 year or 3 months) will be stored to one storage container (S3 bucket or directory).
<em>arveo</em> allows you to delete millions of content objects in a very short time by simply removing the entire storage
container.</p>
</div>
<div class="paragraph">
<p>If a document needs to be deleted e.g. for data privacy reasons, <em>arveo</em> also provides an API call to erase single objects by their ID.
If you want to delete an object before its retention period has expired the user needs along with <em>delete_right</em> also the
<em>dataprivacy_admin</em> privilege.</p>
</div>
<div class="paragraph">
<p>Because the new legal data privacy / protection act makes it necessary to erase data even before the expected retention
period has expired <em>arveo</em> does not use hardware retention features, which protect data from erasure on the hardware level.
<em>arveo</em> protects the content by software design. <em>arveo</em> stores the retention information in the database and only allows access
to the content and metadata by the <em>arveo</em> REST API. The REST API prevents any delete operation before the retention period
has expired.
As only <em>arveo</em> and highly authorized administrators have data writer rights for the database and the storage it is impossible
that content be deleted or manipulated before the retention expires.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The operator must take appropriate technical or organizational measures to ensure that the data is stored in the storage in such a way that it cannot be changed within the legally prescribed retention period.<br>
The provider of the <em>arveo</em> services should ensure that only authorized data protection officers &amp; administrators have data
write (INSERT,UPDTAE; DELETE) permissions for the database and the content repository.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_storage_container_and_document_life_cycle">Storage container and document life cycle</h4>
<div class="paragraph">
<p>Since deleting large amounts of documents is a performance critical task, the <em>arveo</em> repository service provides special
support for mass deletion of documents whose retention period has expired.</p>
</div>
<div class="paragraph">
<p>The basic idea is to define separate storage locations, which are exclusively used to store documents with similar
retention requirements. The deletion of documents with specific retention requirements is then a matter of deleting
all contents of a specific storage location in one step. Storage locations containing documents with the same retention
period will be called storage container for the rest of this section.</p>
</div>
<div class="paragraph">
<p><em>arveo</em> allows you to store data with the same retention in one storage container and is able to create storage containers
automatically.</p>
</div>
<div class="paragraph">
<p>The storage containers are either folders (file system storage) or buckets (S3 object storage).
The actual selection of the storage container for a document with specific retention requirements can be configured by
rules, that select the storage container based on the retention period and litigation hold status of the uploaded document.</p>
</div>
<div class="paragraph">
<p>When the litigation hold is set, the object is moved to the litigation hold directory or bucket and will not be deleted
when the initial retention period expires.
When the litigation hold ends, the document is deleted the next time a delete job runs. The number of objects under litigation
hold is typically small and does not affect the overall erasure performance.</p>
</div>
<div class="paragraph">
<p>When a litigation hold is removed, the objects are moved to other storage container which do not have a litigationHold on them.</p>
</div>
<div class="paragraph">
<p>The following diagram shows the life cycle of a document with a fixed retention period set on upload, a legal dispute and automatic erasure at the end of the document&#8217;s life cycle:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/arveo_infografik_dokument-lebenszyklus-gruen.png" alt="*Retention in Buckets*">
</div>
<div class="title">Figure 8. Retention in buckets</div>
</div>
<div class="paragraph">
<p>Each storage container in fact corresponds to a separate storage profile that is used to store the contents of that storage container.
The rules that are used to map the retention requirements of documents to storage container are defined as rules for the
Bucket Organizer Plugin, see <a href="#_bucketorganizer">Bucketorganizer</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_litigation_hold">Litigation hold</h4>
<div class="paragraph">
<p><em>arveo</em> provides a system property <em>LITIGATION_HOLD</em> that allows you to prolong the retention
until you remove the litigation hold property.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
This function requires the <em>DATAPRIVACY_ADMIN</em> privilege.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_prolongation">Prolongation</h4>
<div class="paragraph">
<p>You can prolong the retention period but not shorten it. You can use the API call to set the initial retention period if
the retention is null.
When the retention is prolonged, <em>arveo</em> moves the object to the appropriate storage container.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
This function requires the <em>DATAPRIVACY_ADMIN</em> privilege.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_erase_a_document">Erase a document</h4>
<div class="paragraph">
<p>The <em>arveo</em> delete API will as for all other objects without a retention period delete the respective objects. See also
<a href="#_recycle_bin">Deletion of objects</a> and <a href="#_recovery_log">Recovery table</a>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
After the retention period has expired, the function requires the <em>DELETE</em> privilege, but
before the retention period has expired, <em>DATAPRIVACY_PRIVILEGED_DELETE</em> privilege is required.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This API should not be used for operations like deleting the objects of a certain year. This should be done using the erasure
storage container API.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_erase_storage_container">Erase storage container</h4>
<div class="paragraph">
<p>If you have used the storage container feature to speed up the deletion of documents at the end of their life cycle, you
can delete all documents within a retention period range with one API REST call 'EraseStorageContainer'.</p>
</div>
<div class="paragraph">
<p>You can either erase the storage container (buckets, folders) controlled by your operating team or with an automated <em>arveo</em> job.
You can set up a scheduled job in the <em>arveo</em> integration service. Use the erasure storage container template job and adopt it to your needs.
The erasure job will delete all entities of a document type within the given retention period range where litigation hold is <strong>not</strong> set.
The job will write an entry for each erased object in the corresponding audit log table.
For more detailed explanation, see the erasure job template example.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Mass deletion of documents under retention requires the <em>SUPER_USER</em> privilege.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Enable the audit log feature for all document types and dependent document types if you need a report of the erased objects.
<a href="#_configure_audit">Audit Log</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Grant the deletion right for your storage containers to <em>arveo</em>. If <em>arveo</em> cannot delete the containers, your operating team is
in charge of this task and you must set the option <em>delete rows only</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_privileges_roles">Privileges &amp; roles</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Privilege</th>
<th class="tableblock halign-left valign-top"><em>DATAPRIVACY_ADMIN</em> (Data Protection Manager)</th>
<th class="tableblock halign-left valign-top"><em>DATAPRIVACY_PRIVILEGED_DELETE</em> (Data Protection Officer)</th>
<th class="tableblock halign-left valign-top">SUPER_USER (Data Protection Administrator)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prolongation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Litigation Hold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete before retention</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mass Delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_examples_3">Examples</h4>
<div class="sect4">
<h5 id="_create_document_with_retention_and_set_litigation_hold">Create document with retention and set litigation hold</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> createDocumentWithRetention() <span class="directive">throws</span> <span class="exception">IOException</span> {

    <span class="directive">final</span> <span class="predefined-type">String</span> TEST_IDENTIFIER = <span class="string"><span class="delimiter">&quot;</span><span class="content">SetLitigationHold test timestamp in ms=</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">final</span> <span class="predefined-type">String</span> TEST_DATA = <span class="string"><span class="delimiter">&quot;</span><span class="content">abcde</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">final</span> <span class="predefined-type">String</span> TEST_DATA_MIMETYPE = MediaType.APPLICATION_OCTET_STREAM_VALUE;

    TypedDocumentServiceClient&lt;DocumentWithRetention&gt; serviceClient =
            typeDefinitionServiceClient.getDocumentServiceClient().byClass(DocumentWithRetention.class);
    ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);

    DocumentWithRetention newDocument = serviceClient.createTypeInstance();
    newDocument.setName(TEST_IDENTIFIER + <span class="predefined-type">System</span>.currentTimeMillis());
    newDocument.setReceiptDate(now );
    newDocument.setMimeType(TEST_DATA_MIMETYPE);
    newDocument.setRetentionDate(now);

    <span class="predefined-type">ByteArrayInputStream</span> data = <span class="keyword">new</span> <span class="predefined-type">ByteArrayInputStream</span>(TEST_DATA.getBytes());

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentUpload&gt; content = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ContentUpload(data));

    TypedDocumentClient&lt;DocumentWithRetention&gt; newClient = serviceClient.create(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(content, newDocument));

    Assert.assertEquals(IOUtils.toByteArray(newClient.readContent(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)), TEST_DATA.getBytes());
    DocumentWithRetention loadedDocument = newClient.getEntity();

    Assert.assertNotNull(loadedDocument);
    Assert.assertTrue(loadedDocument.getName().startsWith(TEST_IDENTIFIER));
    Assert.assertEquals(loadedDocument.getMimeType(), TEST_DATA_MIMETYPE);

    assertDateEquals( loadedDocument.getReceiptDate(), now);
    assertDateEquals(loadedDocument.getRetentionInformation().getRetentionDate(), now);
    Assert.assertFalse(loadedDocument.getRetentionInformation().isLitigationHold());

    <span class="comment">// set LitigationHold = true</span>
    newClient.updateLitigationHold(<span class="predefined-constant">true</span>);
    newClient = newClient.reload();
    DocumentWithRetention litigationOnDocument = newClient.getEntity();
    Assert.assertTrue(litigationOnDocument.getRetentionInformation().isLitigationHold());

    <span class="comment">// set LitigationHold = false)</span>
    newClient.updateLitigationHold(<span class="predefined-constant">false</span>);
    newClient = newClient.reload();
    DocumentWithRetention litigationOffDocument = newClient.getEntity();
    Assert.assertFalse(litigationOffDocument.getRetentionInformation().isLitigationHold());

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_set_retention_prolong_retention">Set retention / prolong retention</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> createDocumentWithoutRetention() <span class="directive">throws</span> <span class="exception">IOException</span> {

    <span class="directive">final</span> <span class="predefined-type">String</span> TEST_IDENTIFIER = <span class="string"><span class="delimiter">&quot;</span><span class="content">SetRetention test timestamp in ms=</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">final</span> <span class="predefined-type">String</span> TEST_DATA = <span class="string"><span class="delimiter">&quot;</span><span class="content">abcde</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">final</span> <span class="predefined-type">String</span> TEST_DATA_MIMETYPE = MediaType.APPLICATION_OCTET_STREAM_VALUE;

    TypedDocumentServiceClient&lt;DocumentWithRetention&gt; serviceClient =
            typeDefinitionServiceClient.getDocumentServiceClient().byClass(DocumentWithRetention.class);
    <span class="comment">// store document without retention</span>
    DocumentWithRetention newDocument = serviceClient.createTypeInstance();
    newDocument.setName(TEST_IDENTIFIER + <span class="predefined-type">System</span>.currentTimeMillis());
    newDocument.setReceiptDate(ZonedDateTime.now());
    newDocument.setMimeType(TEST_DATA_MIMETYPE);

    <span class="predefined-type">ByteArrayInputStream</span> data = <span class="keyword">new</span> <span class="predefined-type">ByteArrayInputStream</span>(TEST_DATA.getBytes());

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ContentUpload&gt; content = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ContentUpload(data));

    TypedDocumentClient&lt;DocumentWithRetention&gt; newClient = serviceClient.create(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(content, newDocument));

    Assert.assertEquals(IOUtils.toByteArray(newClient.readContent(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)), TEST_DATA.getBytes());
    DocumentWithRetention emptyRetentionDocument = newClient.getEntity();

    RetentionInformation retentionInformation = emptyRetentionDocument.getRetentionInformation();
    Assert.assertNotNull(retentionInformation);
    Assert.assertNull(retentionInformation.getRetentionDate());
    Assert.assertFalse(retentionInformation.isLitigationHold());

    <span class="comment">// set initial retention</span>
    ZonedDateTime initialRetentionDate = ZonedDateTime.now();
    emptyRetentionDocument.setRetentionDate(initialRetentionDate);
    TypedDocumentClient&lt;DocumentWithRetention&gt; initialRetentionClient = newClient.updateAttributes(emptyRetentionDocument);
    DocumentWithRetention initialRetentionDocument = initialRetentionClient.getEntity();
    assertDateEquals(initialRetentionDocument.getRetentionInformation().getRetentionDate(), initialRetentionDate);

    <span class="comment">// prolong retention</span>
    ZonedDateTime prolongedRetentionDate = ZonedDateTime.of(<span class="integer">2050</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, ZoneId.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Europe/Berlin</span><span class="delimiter">&quot;</span></span>));
    initialRetentionDocument.setRetentionDate(prolongedRetentionDate);
    TypedDocumentClient&lt;DocumentWithRetention&gt; prolongedRetentionClient = initialRetentionClient.updateAttributes(initialRetentionDocument);
    DocumentWithRetention prolongedRetentionDocument = prolongedRetentionClient.getEntity();
    assertDateEquals(prolongedRetentionDocument.getRetentionInformation().getRetentionDate(), prolongedRetentionDate);

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_retention_cleanup_job">Retention cleanup job</h4>
<div class="paragraph">
<p>The retention cleanup job can be used to remove entities with an expired retention period that are not currently in
litigation hold status. The job can be triggered to run in the internal job scheduler of the repository service or in
a separate instance of the job service. It expects two configuration parameters to be present in the job context of the
triggered execution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type-definition-name</code>: The name of the type definition that contains the entities to remove.</p>
</li>
<li>
<p><code>retention-cleanup-retention-end-time</code>: The time at which the rentention period has expired. All entities with a
retention period that has expired before the specified time will be removed. The specified time must be in the past.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
On systems supporting multiple tenants, the tenant to run the job for must be configured using the property <code>tenant</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following optional properties can be set in the context of the triggered execution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>retention-cleanup-asynchronous</code>: Enables the asynchronous mode of the job. The asynchronous mode is described below.</p>
</li>
<li>
<p><code>retention-cleanup-batch-size</code>: The size of a single batch of entities to process. The default is 1000 and the maximum is 10000.</p>
</li>
<li>
<p><code>retention-cleanup-filter</code>: An optional filter in form of an EQL <code>Expression&lt;Boolean&gt;</code> to apply to the query used to find
entities with expired retention period.</p>
</li>
<li>
<p><code>retention-cleanup-maximum-queue-size</code>: The maximum acceptable size of the message queue used by the job in asynchronous mode. If the queue
size exceeds the configured maximum, the job will stop. The job will check the queue size once a minute.</p>
</li>
<li>
<p><code>retention-cleanup-duration</code>: An optional maximum duration of the job&#8217;s runtime. If the duration is exceeded, the job
will stop. The default is null (no limit). The value must be a <code>java.time.Duration</code>.</p>
</li>
<li>
<p><code>retention-cleanup-max-entity-count</code>: The maximum number of entities to process. If this number is reached, the job
will stop. The default is -1 (no limit).</p>
</li>
<li>
<p><code>retention-cleanup-protocol-file</code>: Optional property that can contain a fully qualified path to a file that will
contain a list of all deleted entity IDs.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>retention-cleanup-maximum-queue-size</code> limitation mechanism relies on statistics data for the JMS queues that is
collected by a separate system job. This job is not enabled by default and must be enabled using the property
<code>ecr.server.jobs.jms-statistics.enabled=true</code> to use this feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All properties except the type definition name, the retention end time and the protocol file can be configured in the
configuration file of the service either globally or for each type definition.
See <a href="#_ecr_server_jobs_retention-cleanup">configuration reference</a> for details.</p>
</div>
<div class="sect4">
<h5 id="_asynchronous_mode">Asynchronous mode</h5>
<div class="paragraph">
<p>In the asynchronous mode, content is not deleted from the storage immediately. Instead, a message queue is used to delete
the content asynchronously. The database entries for the documents are not removed but marked as deleted using the
<code>COMPLIANCE_DELETED</code> field.</p>
</div>
<div class="paragraph">
<p>The entries that were marked as deleted are automatically excluded from query results. It is not possible to read those
entries using the <em>arveo</em> client API.</p>
</div>
<div class="paragraph">
<p>The <em>arveo</em> client API can be used to delete all entities that were marked as deleted as shown in the
following example:</p>
</div>
<div class="listingblock">
<div class="title">Deleting marked entities</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Expression</span>&lt;<span class="predefined-type">Boolean</span>&gt; expression = EcrQueryLanguage.condition()
    .entity().systemField(SystemFieldList.GeneralSystemField.ComplianceDeleted.INSTANCE)
    .equalTo().value(<span class="predefined-constant">true</span>).holds();
serviceClient.delete(expression, <span class="integer">1000</span>); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a limit to reduce database load</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_triggering_the_job">Triggering the job</h5>
<div class="paragraph">
<p>Both the repository service and the job service offer an API that provides methods to create triggers for the job. The
following example shows how to use this API to create a simple trigger that will fire once at a specified time. The API
requires administrator privileges.</p>
</div>
<div class="listingblock">
<div class="title">Triggering the retention cleanup job</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EcrSchedulerResourceClient schedulerClient = systemManagementClient.getSchedulerClient();

JobKeyModel jobKey = <span class="keyword">new</span> JobKeyModel(SystemJobIdentities.ECR_JOBS_GROUP, SystemJobIdentities.RETENTION_CLEANUP);
TriggerKeyModel triggerKey = <span class="keyword">new</span> TriggerKeyModel(SystemJobIdentities.ECR_JOBS_GROUP, <span class="string"><span class="delimiter">&quot;</span><span class="content">test-trigger-retention-cleanup</span><span class="delimiter">&quot;</span></span>);

SimpleTriggerModel trigger = <span class="keyword">new</span> SimpleTriggerModel(triggerKey, jobKey);
trigger.setNextFireTime(ZonedDateTime.now());
trigger.setJobDataMap(<span class="predefined-type">Map</span>.of(
    SystemJobDataKeys.TYPE_DEFINITION_NAME, SimpleInvoiceNames.getTypeDefinitionName(),
    SystemJobDataKeys.RETENTION_CLEANUP_RETENTION_END_TIME, ZonedDateTime.now(),
    SystemJobDataKeys.TENANT, <span class="string"><span class="delimiter">&quot;</span><span class="content">master</span><span class="delimiter">&quot;</span></span>,
    SystemJobDataKeys.RETENTION_CLEANUP_PROTOCOL_FILE, getTargetDir() + <span class="predefined-type">File</span>.separator + <span class="string"><span class="delimiter">&quot;</span><span class="content">retention-cleanup-job.log</span><span class="delimiter">&quot;</span></span>
));

schedulerClient.scheduleSimpleTrigger(trigger);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The API provides additional methods to create cron expression based triggers and to unschedule a job.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rest_api"><strong>REST API</strong></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_client_sdks">Client SDKs</h3>
<div class="paragraph">
<p>The client SDKs provide APIs for applications using <em>arveo</em>. SDKs exist for both Java and TypeScript. Client applications
should not use the REST API of <em>arveo</em> directly but instead use one of the provided SDKs.</p>
</div>
<div class="sect3">
<h4 id="_json_serialization">JSON serialization</h4>
<div class="paragraph">
<p><em>arveo</em> uses a custom serialization for the JSON data in the REST API to support advanced features like polymorphism.
Additionally, the custom serialization allows the <em>arveo</em> server and the client SDKs to pass type information. This way
it is for example possible to differ between number types like short, int and long. The client SDKs take care of the
serialization and the direct usage of the REST API is discouraged.</p>
</div>
<div class="paragraph">
<p>If it is necessary to (de-) serialize the custom JSON data, use the already configured Jackson <em>ObjectMapper</em> that is
used by the server and the SDKs. This <em>ObjectMapper</em> is equipped with mixin types that contain information about how
to (de-) serialize the custom JSON content. The internal <em>ObjectMapper</em> can be obtained by injecting an instance of
<code>de.eitco.commons.spring.web.json.AsdlObjectMapperHolder</code>.</p>
</div>
<div class="paragraph">
<p>The service offers an overview page containing the REST resources and details about the models. It can generate examples
for the models, too. The overview page is located at the root URL of the service.</p>
</div>
</div>
<div class="sect3">
<h4 id="_type_information">Type information</h4>
<div class="paragraph">
<p>Each object contains a type identifier in a json property called <code>@type</code>. The required value is listed in the API
overview page for each model class. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="key"><span class="delimiter">&quot;</span><span class="content">identifier</span><span class="delimiter">&quot;</span></span>: {
  <span class="key"><span class="delimiter">&quot;</span><span class="content">@type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">container-id</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">identifier</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">@long</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_type_information_for_data_types">Type information for data types</h4>
<div class="paragraph">
<p>There are some special type identifiers used to identify the type of JSON fields.</p>
</div>
<div class="paragraph">
<p>The following table lists types and their corresponding identifiers.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 55%;">
<caption class="title">Table 35. Types in Java and their Identifiers in <em>arveo</em></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type (Java)</th>
<th class="tableblock halign-left valign-top">Identifier</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@byte</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@short</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@long</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@big-int</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@float</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@utc-date-time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZonedDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@zoned-date-time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class&lt;?&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@type-reference</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UUID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@uuid</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte[]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@binary</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LocalDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LocalTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@time</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Other data types do not require specific type identifiers.</p>
</div>
<div class="paragraph">
<p>The following example shows a special type identifier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="key"><span class="delimiter">&quot;</span><span class="content">retentionDate</span><span class="delimiter">&quot;</span></span>: {
  <span class="key"><span class="delimiter">&quot;</span><span class="content">@zoned-date-time</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-12-15T15:52:21.5193002+01:00[Europe/Berlin]</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_collections">Collections</h4>
<div class="paragraph">
<p>To distinguish between different types of collections (lists and sets) there are type identifiers for collection
types.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 55%;">
<caption class="title">Table 36. Identifiers for the Types List and Set</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type (Java)</th>
<th class="tableblock halign-left valign-top">Identifier</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@set</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following is an example of the Type <em>List</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="key"><span class="delimiter">&quot;</span><span class="content">list</span><span class="delimiter">&quot;</span></span>: {
  <span class="key"><span class="delimiter">&quot;</span><span class="content">@list</span><span class="delimiter">&quot;</span></span>: []
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_java_sdk">Java SDK</h3>
<div class="paragraph">
<p>The SDK contains the general API for accessing the <em>arveo</em>. The SDK can be used both
to access the <em>arveo</em> via HTTP and to use the <em>arveo</em> as an embedded library.</p>
</div>
<div class="listingblock">
<div class="title">Maven dependency of the Client SDK for usage via HTTP</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>de.eitco.ecr<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>ecr-sdk-http<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>${ecr.version}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Maven dependency of the Client SDK for embedded usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>de.eitco.ecr<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>ecr-embedded<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>${ecr.version}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The SDK offers both a generic API, where attributes of objects are mapped as a generic map, and a typed API. The typed
API uses classes to be created by the project that represent the objects with the attributes.
The main entry point for the API is the class <em>de.eitco.ecr.sdk.TypeDefinitionServiceClient</em>. An instance of this class
can be obtained using Spring Dependency Injection. With the methods</p>
</div>
<div class="ulist">
<ul>
<li>
<p>getDocumentServiceClient()</p>
</li>
<li>
<p>getContainerServiceClient()</p>
</li>
<li>
<p>getFolderServiceClient()</p>
</li>
<li>
<p>getRelationServiceClient()</p>
</li>
<li>
<p>getMetaDataServiceClient()</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>you obtain a client factory that can be used to create a service client for a specific type definition. This service client
can then be used to create new objects or load existing objects. For created or loaded objects, one in turn receives an
entity client that offers methods for accessing the object. Special version clients are also available for concrete
versions of entities.</p>
</div>
<div class="sect3">
<h4 id="_using_the_sdk_in_a_non_web_application">Using the SDK in a non-web application</h4>
<div class="paragraph">
<p>The SDK can be used both in applications that provide web functionality like REST endpoints and in applications that
do not contain any web functionality. For non-web applications, some differences need to be considered.</p>
</div>
<div class="sect4">
<h5 id="_dependencies">Dependencies</h5>
<div class="paragraph">
<p>By default, the SDK contains an OAuth2 client implementation that relies on some web-related spring beans. For non-web
applications, a different OAuth2 client implementation is available. The default implementation needs to be excluded
from the SDK dependency and replaced by the non-web implementation as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>de.eitco.ecr<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>ecr-sdk-http<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${ecr.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;exclusions&gt;</span>
        <span class="tag">&lt;exclusion&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>de.eitco.commons<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>cmn-spring-security5-oauth2-client<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;/exclusion&gt;</span>
    <span class="tag">&lt;/exclusions&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>de.eitco.commons<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>cmn-spring-security5-oauth2-client-non-web<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${commons-oauth2-version}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The current version of the OAuth2 client can be found in the Nexus.</p>
</div>
</div>
<div class="sect4">
<h5 id="_application_initialization">Application initialization</h5>
<div class="paragraph">
<p>The SDK contains some dependencies that cause Spring to initialize some web functionality automatically. This can cause
problems like missing spring security configuration errors. Non-web applications can simply turn off all of Springs
web functionality by using the <code>SpringApplicationBuilder</code> class as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBootApplication</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyApplication</span> {

        <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
                <span class="keyword">new</span> SpringApplicationBuilder(MyApplication.class)
                        .web(WebApplicationType.NONE)
                        .run(args);
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_batch_operations">Batch Operations</h4>
<div class="paragraph">
<p>The SDK provides various methods for batch operations. For example, several objects can be created or updated at once.</p>
</div>
<div class="sect4">
<h5 id="_create_update_or_delete_multiple_objects_of_the_same_type">Create, update or delete multiple objects of the same type</h5>
<div class="paragraph">
<p>All service clients provide methods for creating, updating and deleting multiple objects. Since a service client is bound to a specific type definition, only objects of the same type can be created, updated or deleted in this way.
The objects to be updated or deleted are identified by any selector. When updating, methods are available that return
the updated objects and methods that return only the number of updated objects. Especially if a large number of objects
are updated at once, only the latter methods should be used. With these methods, the objects can only be updated in the
same way. If the objects are to be customised, the methods from the BatchOperationServiceClient (see below) must be used.</p>
</div>
</div>
<div class="sect4">
<h5 id="_create_or_update_several_objects_of_different_types">Create or update several objects of different types</h5>
<div class="paragraph">
<p>The <em>BatchOperationServiceClient</em> class provides methods to create or update multiple objects of different types.</p>
</div>
</div>
<div class="sect4">
<h5 id="_create_several_interdependent_objects">Create several interdependent objects</h5>
<div class="paragraph">
<p>To create multiple objects of different types, special <em>BatchCreateInput</em> input objects are used that bundle the type of
the object and its properties. The order in which the objects are created corresponds to the order in which the input
objects are passed. Each of these input objects contains a virtual ID that identifies it within the batch operation. In
this way, for example, a relation as well as its source and target can be created in a batch operation. The relation only
has to be created with the virtual IDs of source and target.</p>
</div>
<div class="paragraph">
<p>If the relation between the objects consists not only of the ID, but also of a foreign key to any attribute, a reference
to the corresponding attribute of the referenced object must be given to the dependent object. For this purpose, the
class <em>BatchAttributeReference</em> is available, which bundles the name of the foreign key attribute, the referenced attribute and the virtual ID of the other object in the batch operation. Code examples can be found in the class <em>de.eitco.ecr.system.test.BatchCreationIT</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_update_multiple_objects_of_different_types">Update multiple objects of different types</h5>
<div class="paragraph">
<p>The <em>BatchOperationServiceClient</em> also provides methods to update several different objects of different types in a batch operation. A separate input object is passed for each object to be updated, which contains the ID of the object and the properties to be updated. This means that individual changes can also be made to each object with these methods. The BatchUpdateUtility class provides auxiliary methods with which the respective input objects can be created.
Code examples can be found in the class <em>de.eitco.ecr.system.test.BatchUpdateIT</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_automatic_update_in_case_of_collision">Automatic update in case of collision</h5>
<div class="paragraph">
<p>The <em>BatchCreateInput</em> objects used to create various types make it possible to automatically update the existing object
in the event of a collision. To do this, the <em>BatchCreateInput</em> only has to be made aware of the field on which the
collision could occur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedContainerBatchCreateInput&lt;Person&gt; containerBatchCreateInput =
    <span class="keyword">new</span> TypedContainerBatchCreateInput&lt;&gt;(<span class="keyword">new</span> TypedContainerInput&lt;&gt;(person), <span class="predefined-type">List</span>.of());
containerBatchCreateInput.setCollisionCheckAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, a container is to be created in a batch where a collision could possibly occur on the attribute
<code>first_name</code>.</p>
</div>
<div class="paragraph">
<p>The attribute that is to be used to detect the collisions must be provided with a unique constraint.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_or_update_upsert_operations">Create or update (upsert) operations</h4>
<div class="paragraph">
<p>The SDK provides methods to perform create or update (upsert) operations on entities.The entity to update, if it
should exist, is identified by an EQL selector. If a matching entity is found, it is updated using the provided data.
If no matching entity is found, the provided data is used to create a new entity. The selector must match exactly one or
zero existing entities. If it matches more than one entity, an exception is thrown. The following example shows how
to perform an upsert operation.</p>
</div>
<div class="listingblock">
<div class="title">Performing an upsert operation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedContainerServiceClient&lt;Person&gt; serviceClient =
    typeDefinitionServiceClient.getContainerServiceClient().byClass(Person.class);

LocalDate birthday = LocalDate.of(<span class="integer">1995</span>, Month.SEPTEMBER, <span class="integer">16</span>);

Person person = serviceClient.createTypeInstance();
person.setBirthday(birthday);
person.setSurname(<span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);
person.setFirstName(<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>);
person.setBreakTime(LocalTime.NOON);
person.setProcedureDate(ZonedDateTime.now());

TypedContainerClient&lt;Person&gt; client = serviceClient.createOrUpdate(
    EcrQueryLanguage.condition().entity().field(PersonNames.FIRST_NAME).equalTo().value(<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>).holds(), <i class="conum" data-value="1"></i><b>(1)</b>
    person
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The selector that uniquely identifies the entity to update</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_generic_batch_operations">Generic batch operations</h4>
<div class="paragraph">
<p>The generic batch operation API can be used to perform different operations like create, update or delete in one
transaction. The batch operations use the same input types as the other batch functions described above, which makes
it possible to use the result of one operation in another following operation. The following operation types are available:</p>
</div>
<div class="sect4">
<h5 id="_read_operations">Read operations</h5>
<div class="ulist">
<ul>
<li>
<p><code>TypedContainerBatchReadOperation</code></p>
</li>
<li>
<p><code>TypedDocumentBatchReadOperation</code></p>
</li>
<li>
<p><code>TypedFolderBatchReadOperation</code></p>
</li>
<li>
<p><code>TypedMetaDataBatchReadOperation</code></p>
</li>
<li>
<p><code>TypedRelationDataBatchReadOperation</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The purpose of read operations is to provide input data for other operations. For example, a read operation could be used
to read an entity of which only the ID is known, and then use the entity&#8217;s attribute values as input for a create operation.
When the entity cannot be read, the entire batch of operations fails and the transaction is rolled back.</p>
</div>
</div>
<div class="sect4">
<h5 id="_delete_operations">Delete operations</h5>
<div class="ulist">
<ul>
<li>
<p><code>TypedContainerBatchDeleteOperation</code></p>
</li>
<li>
<p><code>TypedDocumentBatchDeleteOperation</code></p>
</li>
<li>
<p><code>TypedFolderBatchDeleteOperation</code></p>
</li>
<li>
<p><code>TypedMetaDataBatchDeleteOperation</code></p>
</li>
<li>
<p><code>TypedRelationBatchDeleteOperation</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Delete operations are used to delete a single entity. Unlike the other operations, it is not possible to reference
a delete operation. When the entity cannot be deleted, the entire batch of operations fails and the transaction is rolled back.</p>
</div>
</div>
<div class="sect4">
<h5 id="_update_operations">Update operations</h5>
<div class="ulist">
<ul>
<li>
<p><code>TypedContainerBatchUpdateOperation</code></p>
</li>
<li>
<p><code>TypedDocumentBatchUpdateOperation</code></p>
</li>
<li>
<p><code>TypedFolderBatchUpdateOperation</code></p>
</li>
<li>
<p><code>TypedMetaDataBatchUpdateOperation</code></p>
</li>
<li>
<p><code>TypedRelationBatchUpdateOperation</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Update operations are used to update a single entity. When the entity cannot be updated, the entire batch of operations
fails and the transaction is rolled back.</p>
</div>
</div>
<div class="sect4">
<h5 id="_create_or_update_operations">Create or update operations</h5>
<div class="ulist">
<ul>
<li>
<p><code>TypedContainerBatchCreateOrUpdateOperation</code></p>
</li>
<li>
<p><code>TypedDocumentBatchCreateOrUpdateOperation</code></p>
</li>
<li>
<p><code>TypedFolderBatchCreateOrUpdateOperation</code></p>
</li>
<li>
<p><code>TypedMetaDataBatchCreateOrUpdateOperation</code></p>
</li>
<li>
<p><code>TypedRelationBatchCreateOrUpdateOperation</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create or update operations perform an upsert as described in <a href="#_create_or_update_upsert_operations">Create or update (upsert) operations</a>. When the
operation cannot update or create the entity, the entire batch of operations fails and the transaction is rolled back.</p>
</div>
</div>
<div class="sect4">
<h5 id="_create_operations">Create operations</h5>
<div class="ulist">
<ul>
<li>
<p><code>TypedContainerBatchCreateOperation</code></p>
</li>
<li>
<p><code>TypedDocumentBatchCreateOperation</code></p>
</li>
<li>
<p><code>TypedFolderBatchCreateOperation</code></p>
</li>
<li>
<p><code>TypedMetaDataBatchCreateOperation</code></p>
</li>
<li>
<p><code>TypedRelationBatchCreateOperation</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create operations are used to create a new entity. When the entity cannot be created, the entire batch of operations
fails and the transaction is rolled back.</p>
</div>
</div>
<div class="sect4">
<h5 id="_examples_4">Examples</h5>
<div class="paragraph">
<p>The first example implements a solution for the following problem: An invoice was archived with a relation to an
invalid customer. The customer must be replaced with a new customer and the reference in the invoice must be updated.</p>
</div>
<div class="listingblock">
<div class="title">Using the generic batch api for crud operations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Customer customer = customerServiceClient.createTypeInstance();
customer.setName(<span class="predefined-type">UUID</span>.randomUUID().toString());

TypedDocumentBatchCreateOperation&lt;Customer&gt; createCustomerOperation = <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">new</span> TypedDocumentBatchCreateOperation&lt;&gt;(customer);

Invoice invoice = invoiceServiceClient.createTypeInstance();

BatchAttributeReference reference = <span class="keyword">new</span> BatchAttributeReference( <i class="conum" data-value="2"></i><b>(2)</b>
    InvoiceNames.CUSTOMER_NUMBER,
    SystemFieldList.GeneralSystemField.Id.INSTANCE.getName(),
    createCustomerOperation.getVirtualId().getUuid()
);

TypedDocumentBatchUpdateInput&lt;Invoice&gt; invoiceInput =
    <span class="keyword">new</span> TypedDocumentBatchUpdateInput&lt;&gt;(invoiceId, <span class="keyword">new</span> TypedDocumentInput&lt;&gt;(invoice), <span class="predefined-type">List</span>.of(reference));

TypedDocumentBatchUpdateOperation&lt;Invoice&gt; updateInvoiceOperation = <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="keyword">new</span> TypedDocumentBatchUpdateOperation&lt;&gt;(invoiceInput);

TypedDocumentBatchDeleteOperation deleteCustomerOperation = <span class="keyword">new</span> TypedDocumentBatchDeleteOperation(customerId); <i class="conum" data-value="4"></i><b>(4)</b>

<span class="predefined-type">List</span>&lt;EcrId&gt; ids = batchOperationServiceClient.performTypedBatchOperations( <i class="conum" data-value="5"></i><b>(5)</b>
    createCustomerOperation, updateInvoiceOperation, deleteCustomerOperation);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The operation to create the new customer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A reference to the ID of the new customer to be used for the customer_number field of the updated invoice</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The operation to update the existing invoice</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The operation to delete the invalid customer</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>An injected instance of <code>de.eitco.ecr.sdk.BatchOperationServiceClient</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second example shows how to use a read operation.</p>
</div>
<div class="listingblock">
<div class="title">Using a read operation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedDocumentBatchReadOperation readCustomerOperation = <span class="keyword">new</span> TypedDocumentBatchReadOperation(customerId);

Invoice invoice = invoiceServiceClient.createTypeInstance();
invoice.setCustomerNumber(customerId.getIdentifier());

BatchAttributeReference attributeReference = <span class="keyword">new</span> BatchAttributeReference( <i class="conum" data-value="1"></i><b>(1)</b>
    InvoiceNames.CUSTOMER_NAME,
    CustomerNames.NAME,
    readCustomerOperation.getVirtualId().getUuid()
);

TypedDocumentBatchCreateInput&lt;Invoice&gt; invoiceInput =
    <span class="keyword">new</span> TypedDocumentBatchCreateInput&lt;&gt;(<span class="keyword">new</span> TypedDocumentInput&lt;&gt;(invoice), <span class="predefined-type">List</span>.of(attributeReference));
TypedDocumentBatchCreateOperation&lt;Invoice&gt; createInvoiceOperation =
    <span class="keyword">new</span> TypedDocumentBatchCreateOperation&lt;&gt;(invoiceInput);

<span class="predefined-type">List</span>&lt;EcrId&gt; ids = batchOperationServiceClient.performTypedBatchOperations(readCustomerOperation, createInvoiceOperation); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A reference to the name attribute of the customer read by the read operation used for the customer_name attribute of the invoice</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>An injected instance of <code>de.eitco.ecr.sdk.BatchOperationServiceClient</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_system_tables"><strong>System tables</strong></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains information about the system tables used by <em>arveo</em>.</p>
</div>
<div class="sect2">
<h3 id="_tables_for_type_definitions">Tables for type definitions</h3>
<div class="paragraph">
<p>The system stores some information like the ID of type definitions in the database. For this, the following tables are
used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ecr-types</code>: Contains en entry for each type definition</p>
</li>
<li>
<p><code>ecr-types-content-elements</code>: Contains 1:n mappings of content elements to type definitions.</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="title">ERD of type system tables</div>
<div class="content">
<pre>         +---------------+                     +----------------------------+
         |   ecr_types   |                     | ecr_types_content_elements |
         +---------------+                     +----------------------------+
         | id            |&lt;----+               | ce_name                    |
         |---------------|     +---------------+ ce_type_id                 |
         | creation_date |                     |----------------------------|
         | ecr_version   |                     | ce_content_type            |
         | object_type   |                     | ce_profile                 |
         | type_name     |                     | ce_store_json              |
         +---------------+                     +----------------------------+</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 37. Columns of ecr_types</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the type definition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creation_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creation date and time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">object_type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of the objects in the type definition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the type definition</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 38. Columns of ecr_types_content_elements</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ce_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the content element</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ce_type_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the type definition containing the content element</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ce_content_type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The allowed content type of the content element</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ce_profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the storage profile used by the content element</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ce_store_json</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the content element uses the JSON field or not</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_folder_structure_tables">Folder structure tables</h3>
<div class="paragraph">
<p>The object type FOLDER is used to create tree-like structures with parent- and child-relationships. The structure is
stored in the <em>ecr_folder_structure</em> table. The table <em>ecr_folder_structure_closure</em> contains a transitive hull of the
parent- and child-relationships to allow fast database queries in the tree.</p>
</div>
<div class="literalblock">
<div class="title">ERD of folder structure tables</div>
<div class="content">
<pre>         +----------------------+         +------------------------------+
         | ecr_folder_structure |         | ecr_folder_structure_closure |
         +----------------------+         +------------------------------+
         | child_id             |         | id                           |
         |----------------------|         |------------------------------|
         | child_name           |         | child_id                     |
         | child_type_id        |         | child_type_id                |
         | parent_id            |         | depth                        |
         | parent_type_id       |         | parent_id                    |
         +----------------------+         | parent_type_id               |
                                          +------------------------------+</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 39. Columns of ecr_folder_structure</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">child_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the child-folder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">child_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(128)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the child-folder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the parent-folder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_type_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the parent type definition</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 40. Columns of ecr_folder_structure_closure</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 15%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uuid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the entry in the closure table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">child_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the child-folder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">child_type_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the child type definition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">depth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The distance between the child and the parent on the direct path in the tree</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the parent folder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent_type_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the parent type definition</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_recovery_table">Recovery table</h3>
<div class="paragraph">
<p>The recovery table <em>ecr_recovery</em> is used for the <a href="#_recovery_log">recovery</a> feature.</p>
</div>
<div class="literalblock">
<div class="title">ERD of ecr_recovery</div>
<div class="content">
<pre>         +----------------+
         |  ecr_recovery  |
         +----------------+
         | deleted_date   |
         | entity         |
         | entity_id      |
         | keep_until     |
         | type_id        |
         | version_id     |
         +----------------+</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 41. Columns of <em>ecr_recovery</em></caption>
<colgroup>
<col style="width: 20%;">
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deleted_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date and time at which the entity was deleted</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jsonb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A JSON representation of the deleted entity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entity_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the entity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keep_until</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The date and time until which to keep the entity in the recovery table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the type definition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The version ID of the deleted entity</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_keystore_tables">Keystore tables</h3>
<div class="paragraph">
<p>When the <a href="#_encryption">encryption</a> feature is enabled for a storage profile, the generated keys are stored in
profile-specific database tables. For each encrypted profile, a table called <code>ecr_keys-&lt;profile&gt;</code> and a table called
<code>ecr_keys_assoc_&lt;profile&gt;</code> is created. The ecr_keys_&lt;profile&gt; table contains the generated keys, and the
ecr_keys_assoc_&lt;profile&gt; table contains the associations between content elements and keys.</p>
</div>
<div class="literalblock">
<div class="title">ERD of keystore tables</div>
<div class="content">
<pre>         +--------------------+           +------------------------+
         |  ecr_keys_profile  |           | ecr_keys_assoc_profile |
         +--------------------+           +------------------------+
         | id                 |&lt;--+       | content_id             |
         |--------------------|   +-------+ id                     |
         | key                |           +------------------------+
         +--------------------+</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 42. Columns of ecr_keys_&lt;profile&gt;</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bytea</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The encryption key</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 43. Columns of ecr_keys_assoc_&lt;profile&gt;</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">content_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the content element</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the key</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compatibility_list"><strong>Compatibility list</strong></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To operate <em>arveo</em> successfully the operator of the platform must provide and manage the following services.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/arveo-architecture.png" alt="diagram">
</div>
<div class="title">Figure 9. Architecture overview</div>
</div>
<div class="paragraph">
<p>The following table lists 3rd party services used in <em>arveo</em>.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 44. 3rd party services in <em>arveo</em></caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Supported Version</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java 17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integration tests run on Eclipse Temurin 17, but all JDKs are supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ActiveMQ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ActiveMQ 5.18.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PostgreSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">postgres 15.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache Solr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache Solr 9.1.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">S3 Storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ceph 15, 16<br>
NetAPP ONTAP 9<br>
Dell Elastic Cloud Storage (ECS)<br>
AWS S3</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">File System</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFS<br>
 CIFS</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linux OS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 18.04, 20.04</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tomcat 9, 10</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kubernetes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If helm deployment is used</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20.10.8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If helm deployment is used</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grant flows:<br>
Client Credentials Flow<br>
Authorization Code Flow with PKCE<br>
Resource Owner Password Flow</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication Services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keycloak 15<br>
ADFS 2.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDAP Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MS Active Directory</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MS Graph</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document Conversion with Microsoft 365, requires M365 account</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kerberos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kerberos Aiuthentication Service is MS Active Directory</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_important_terminology"><strong>Important Terminology</strong></h2>
<div class="sectionbody">
<div class="dlist glossary">
<dl>
<dt>ECR</dt>
<dd>
<p>Short for Enterprise Content Services; this is the collection of the <em>arveo</em> content services providing
all document and record features.</p>
</dd>
<dt>EQL</dt>
<dd>
<p>Eitco Query Language.</p>
<div class="paragraph">
<p>Used for search operations.</p>
</div>
</dd>
<dt>Entity</dt>
<dd>
<p>Object that represents a type of data structure used in <em>arveo</em>.</p>
</dd>
<dt>Document</dt>
<dd>
<p>An entity that can contain metadata and content.</p>
</dd>
<dt>Folder</dt>
<dd>
<p>An entity that contains metadata and is organized in a tree structure like in a file system.</p>
</dd>
<dt>Relation</dt>
<dd>
<p>An entity that represents a relation between two other entities.</p>
</dd>
<dt>Container</dt>
<dd>
<p>Simple folder-like object not organized in a tree structure but with relations to other objects.</p>
</dd>
<dt>Meta</dt>
<dd>
<p>An entity that contains only metadata.</p>
</dd>
<dt>Content type</dt>
<dd>
<p>A meta specification, that classifies the data.</p>
<div class="paragraph">
<p>Examples of content types are: original object, rendition, full text, text notes, XML properties, etc.</p>
</div>
</dd>
<dt>Retention</dt>
<dd>
<p>Continuous audit-proof storage of all company data for compliance or own business purposes.</p>
</dd>
<dt>Litigation hold</dt>
<dd>
<p>A flag that indicates whether a document is related to a litigation.</p>
<div class="paragraph">
<p>If the flag is set the document must never be deleted - even if the retention date has passed by.</p>
</div>
</dd>
<dt>Bucket</dt>
<dd>
<p>Object storage.</p>
</dd>
<dt>Encryption</dt>
<dd>
<p>Translating data into unreadable forms by means of electronic or digital codes
or keys.</p>
<div class="paragraph">
<p>A specific key in the form of a procedure or an algorithm is required for the reverse transformation.
Then the legitimate user can access the original data.</p>
</div>
</dd>
<dt>Annotation</dt>
<dd>
<p>A construct used on interfaces or getter-methods to specify their properties.</p>
</dd>
<dt>Storage profile</dt>
<dd>
<p>Are used to define on which storage the content elements are saved.</p>
</dd>
<dt>Storage Container</dt>
<dd>
<p>Are folders or buckets on the content storage containing documents with the same retention period (e.g. Jan-Dez 2031).</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-10-06 12:26:19 UTC
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>