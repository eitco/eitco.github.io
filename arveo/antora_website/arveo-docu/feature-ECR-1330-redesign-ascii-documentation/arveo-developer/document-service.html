<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Document Service :: arveo Documentation</title>
    <link rel="canonical" href="https://eitco.github.io/arveo-docu/feature-ECR-1330-redesign-ascii-documentation/arveo-developer/document-service.html">
    <link rel="prev" href="advanced-schema-changes.html">
    <link rel="next" href="versioning.html">
    <meta name="generator" content="Antora 3.2.0-alpha.4">
    <link rel="stylesheet" href="../../../ui-assets/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand"> 
      <img src="../../../ui-assets/img/eitco_logo.png">
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://eitco.github.io">Home</a>
        <!--<div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>-->
        <!--<div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>-->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="arveo-docu" data-version="feature-ECR-1330-redesign-ascii-documentation">
  <aside class="nav">
    <div class="panels">      
      <img src="../../../ui-assets/img/arveo_logo_transperent_black.png">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-general/product-summary.html">What is <em>arveo</em>?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architecture Overview</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/content-services.html">Content Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/technology-stack.html">Technologie Stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/application-security.html">Application security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/gobd.html">Compliance recommendations (GoBD)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Store</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-storage.html">Persistence architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-general/data-deletion.html">Data deletion</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-getting-started/getting-started.html">Getting Started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration und Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../arveo-administration/installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/deployment-options.html">Deployment options</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/system-requirements.html">System requirements</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/authentication-oauth2.html">OAuth Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/db-access.html">Database access and Tenants</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/content-elements-storage.html">Storage locations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/renditions.html">Renditions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/retention-container.html">Retention Container</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/encryption.html">Encryption</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/messaging.html">Configure Active MQ</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/maintenance-mode-db-schema.html">Maintenance mode for the database schema</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/audit.html">Audit</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/solr.html">Solr</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/jobs.html">System jobs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../arveo-administration/vault.html">Vault</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arveo-administration/monitoring.html">Monitoring</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Access Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="access-rights.html">Access rights</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="attribute-based-security.html">Attribute Based Access Control (ABAC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="permissions.html">Permissions on Type definitions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Modelling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="entity-types.html">Entity types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="entity-annotations.html">Entity annotations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="data-types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="system-fields.html">System fields</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="document-types.html">Document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="container-types.html">Container types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="relation-types.html">Relation types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="folder-types.html">Folder types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="metadata-types.html">Metadata types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="inheritance.html">Inheritance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention-annotations.html">Retention document types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tenant-separation.html">Tenant separation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced-schema-changes.html">Advanced database schema changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Document Service</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="document-service.html">Document Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="versioning.html">Versioning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="search-service.html">Search language</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="enterprise-search-nosql.html">NoSQL Document database</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="retention.html">Retention periods</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">REST API</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="client-sdks-json-serialization.html">Client SDKs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="sdk-and-batch-operations.html">Java SDK</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="system-tables.html">System Tables</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/compatibility-list.html">Compatibility List</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/release-notes.html">Release Notes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../arveo-commons/glossary.html">Important Terminology</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">arveo Documentation</span>
    <span class="version">feature-ECR-1330-redesign-ascii-documentation</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../arveo-general/product-summary.html">arveo Documentation</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../arveo-general/product-summary.html">feature-ECR-1330-redesign-ascii-documentation</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../arveo-general/product-summary.html">arveo Documentation</a></li>
    <li>Developer</li>
    <li>Document Service</li>
    <li><a href="document-service.html">Document Service</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="file:///C:/DevPacks/Git_Projekte/eitco-content-repository/documentation/project/modules/arveo-developer/pages/document-service.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Document Service</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Document Service service is responsible for handling various repository entities such as documents and folders. The following entity types are supported: document, folder, container, relation and metadata.</p>
</div>
<div class="paragraph">
<p>The service saves the binary data belonging to the documents and delivers them again. Various plugins are available for connecting storage devices and services. A plug-in is assigned to a profile and configured. When saving data, the client has to specify the profile to be used and thereby decides where the data will be saved.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upload_data"><a class="anchor" href="#_upload_data"></a>Upload data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Content, annotations (see below) and metadata can be uploaded as a coherent document. 0-n content elements of different content types are possible. Each content element is named. As a result, you get a globally unique ID (DocumentID), which can be used to reference content, annotations and / or just metadata of the latest version of the document. It is possible to clone content elements from one document to another, creating a copy of the content on the storage. For that, a ContentReference can be supplied when the document is created.</p>
</div>
<div class="listingblock">
<div class="title">Example: Upload a document with new content</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TypedDocumentServiceClient&lt;SingleContentDocument&gt; serviceClient =
    typeDefinitionServiceClient.getDocumentServiceClient().byClass(SingleContentDocument.class); <i class="conum" data-value="1"></i><b>(1)</b>

SingleContentDocument document = serviceClient.createTypeInstance();
document.setName("some name");

TypedDocumentClient&lt;SingleContentDocument&gt; client = serviceClient.create(
    new TypedDocumentInput&lt;&gt;(Map.of("content", <i class="conum" data-value="2"></i><b>(2)</b>
        new ContentUpload(inputStream)), document)); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The typeDefinitionServiceClient is an instance of TypeDefinitionServiceClient, that can be injected.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The type definition SingleContentDocument uses only the default content definition, hence the default name is used.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The actual content is passed as an InputStream.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example: Upload a document with cloned content</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TypedDocumentServiceClient&lt;TypedTargetDocument&gt; serviceClient =
    typeDefinitionServiceClient.getDocumentServiceClient().byClass(TypedTargetDocument.class); <i class="conum" data-value="1"></i><b>(1)</b>

TypedTargetDocument document = serviceClient.createTypeInstance();

DocumentContentReference reference = new DocumentContentReference(documentId, "content"); <i class="conum" data-value="2"></i><b>(2)</b>

TypedDocumentClient&lt;TypedTargetDocument&gt; client =
    serviceClient.create(new TypedDocumentInput&lt;&gt;(document, Map.of("content", reference)));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The typeDefinitionServiceClient is an instance of TypeDefinitionServiceClient, that can be injected.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here the documentId is the ID of an already existing document that uses the default content definition.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example: Upload a document with Base64 encoded data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Base64EncodedData data = new Base64EncodedData(base64Data);<i class="conum" data-value="1"></i><b>(1)</b>
Map&lt;String, ContentUpload&gt; contentElements = Map.of("content", new ContentUpload(data));<i class="conum" data-value="2"></i><b>(2)</b>

serviceClient.create(new TypedDocumentInput&lt;&gt;(contentElements, document));<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Wrap the Base64 encoded data in a new <code>Base64EncodedData</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a content upload with the created <code>Base64EncodedData</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Upload the document</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="validating_uploaded_content"><a class="anchor" href="#validating_uploaded_content"></a>Validating uploaded content</h3>
<div class="paragraph">
<p>There are several different ways to validate the content of an uploaded document. The method to use depends on the requirements of the client application. Some applications might already have computed a hash of the content while others might offload this to the server.</p>
</div>
<div class="sect3">
<h4 id="validating_content_on_the_client_side"><a class="anchor" href="#validating_content_on_the_client_side"></a>Validating content on the client side</h4>
<div class="paragraph">
<p>When content is uploaded to a type definition that supports content metadata, the server computes an SHA-256 hash for the received data and returns it in the result of the upload request. The client can use this hash value to compare the data received by the server with the original data. The following example shows how to compare the hash values:</p>
</div>
<div class="listingblock">
<div class="title">Example: Checking hash values on the client side</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ContentTest entity = client.create(input).getEntity(); <i class="conum" data-value="1"></i><b>(1)</b>
Hash hash = entity.getContent().get("content").getHash(); <i class="conum" data-value="2"></i><b>(2)</b>

Hash expectedHash = Hash.sha256Hash(inputStream, 1000000, tempFile); <i class="conum" data-value="3"></i><b>(3)</b>
Assert.assertEquals(expectedHash, hash);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The document is uploaded using a type definition service client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the hash returned from the server. <code>getContent</code> is a getter for the system property <code>SystemPropertyName.CONTENT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <code>de.eitco.ecr.common.Hash</code> to compute the expected hash</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>TypedDocumentServiceClient</code> offers an additional method to validate uploaded content. The <code>createAndValidate</code> method automatically computes a hash of the uploaded data and compares it with the hash value returned from the server. If the two hashes do not match, a <code>HashValidationException</code> is thrown and the created document will be purged.</p>
</div>
<div class="listingblock">
<div class="title">Example: Using the createAndValidate method</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TypedDocumentServiceClient&lt;ContentTest&gt; client = typeDefinitionServiceClient
    .getDocumentServiceClient().byClass(ContentTest.class);

ContentUpload contentUpload = new ContentUpload(data);

Map&lt;String, ContentUpload&gt; content = Map.of("content", contentUpload);

ContentTest instance = client.createTypeInstance();
TypedDocumentInput&lt;ContentTest&gt; input = new TypedDocumentInput&lt;&gt;(content, instance);

client.createAndValidate(input);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="validating_content_on_the_server_side"><a class="anchor" href="#validating_content_on_the_server_side"></a>Validating content on the server side</h4>
<div class="paragraph">
<p>It is also possible to pass a hex representation of an SHA-256 hash code of the uploaded content to the server. If such a hash is present, the server will compare the computed hash value with the one specified by the client. If the values do not match, the upload fails and the uploaded file will not be stored.</p>
</div>
<div class="listingblock">
<div class="title">Example: Checking hash values on the server side</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Hash hash = Hash.sha256Hash(inputStream, 1000000, tempFile); <i class="conum" data-value="1"></i><b>(1)</b>

ContentUpload contentUpload = new ContentUpload(
    "lorem_ipsum.txt", <i class="conum" data-value="2"></i><b>(2)</b>
    null, <i class="conum" data-value="3"></i><b>(3)</b>
    null, <i class="conum" data-value="4"></i><b>(4)</b>
    data,
    hash
);

Map&lt;String, ContentUpload&gt; content = Map.of("content", contentUpload);

ContentTest document = client.createTypeInstance();
TypedDocumentInput&lt;ContentTest&gt; input = new TypedDocumentInput&lt;&gt;(content, document);

client.create(input);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>de.eitco.ecr.common.Hash</code> to compute the hash</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The filename</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>null for the length, will be computed by the server</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>null for the content type, will be computed by the server</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="validating_the_content_of_an_existing_document"><a class="anchor" href="#validating_the_content_of_an_existing_document"></a>Validating the content of an existing document</h4>
<div class="paragraph">
<p>The <code>TypedDocumentServiceClient</code> provides a method called <code>hashMatches</code> that can be used to check if the content of an existing document is valid. The client has to provide the expected hash, the document&#8217;s ID and the name of the content element to check. An additional parameter called <code>loadContent</code> defines if the server should use the hash value stored in the database or if it should load the content from the storage and compute a new hash value to compare. It is possible to check the content of a specific version of a document, too.</p>
</div>
<div class="listingblock">
<div class="title">Example: Checking hash values of an existing document</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Hash hash = Hash.sha256Hash(inputStream, 1000000, tempFile);
boolean hashMatches = documentServiceClient.hashMatches(documentId, "content", hash, false);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="resumable_uploads"><a class="anchor" href="#resumable_uploads"></a>Resumable uploads</h3>
<div class="paragraph">
<p>In some situations uploading large files might fail because of timeouts or an unstable network connection. For these
situations, arveo supports resumable uploads using the <a href="http://tus.io">tus</a> protocol. On the server side, an
additional service is used that provides the tus API and stores uploaded files in the filesystem. The Content Repository
Service retrieves uploaded files from the upload service and stores them just as any regular content. When the content
was stored successfully, the uploaded file is deleted from the upload service&#8217;s storage automatically. In case storing
the content in the Content Repository Service has failed, the uploaded file is not removed, giving the client the
opportunity to re-try storing the content without having to upload the entire file again.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use the tus client in combination with the arveo SDK to use
resumable uploads. The tus client can be obtained using the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;de.eitco.commons&lt;/groupId&gt;
    &lt;artifactId&gt;tus-upload-service-client-spring&lt;/artifactId&gt;
    &lt;version&gt;${tus-upload-service.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Resumable uploads</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">File file = new File(baseDirectory + "/src/test/resources/documents/lorem_ipsum.txt");
String uploadId;

try (TusClient tusClient = tusClientFactory.newClient()) { <i class="conum" data-value="1"></i><b>(1)</b>

    TusUpload upload = new TusUpload(new FileInputStream(file), "lorem-ipsum.txt", file.length());
    uploadId = tusClient.resumeOrCreateUpload(upload, 100 * 1024); <i class="conum" data-value="2"></i><b>(2)</b>
}

TypedDocumentServiceClient&lt;Files&gt; serviceClient =
    typeDefinitionServiceClient.getDocumentServiceClient().byClass(Files.class);

Files document = serviceClient.createTypeInstance();
document.setFilename("lorem_ipsum.txt");

AsyncUploadReference uploadReference = new AsyncUploadReference(uploadId, "lorem_ipsum.txt"); <i class="conum" data-value="3"></i><b>(3)</b>
Map&lt;String, ContentReference&gt; contentReferences = Map.of("content", uploadReference);

TypedDocumentClient&lt;Files&gt; typedDocumentClient =
    serviceClient.create(new TypedDocumentInput&lt;&gt;(document, contentReferences));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new TusClient using the injectable TusClientFactory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Remember the unique ID of the upload.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reference the uploaded file using its ID for the document creation call for the Content Repository Service.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="download_data"><a class="anchor" href="#download_data"></a>Download data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Content, annotations and metadata of a document can be downloaded via API. It is possible to load the entire document as a multipart or a structure of the document that includes all metadata, annotations and a list of content elements with their IDs, types and identifiers. Each content element can then be loaded using the document ID / content ID or the
document ID / content type. Access to individual content elements without a document ID is not possible for reasons of access control. Access control based on the document ID is ensured with every access.</p>
</div>
<div class="sect2">
<h3 id="update_metadata_without_a_version"><a class="anchor" href="#update_metadata_without_a_version"></a>Update metadata without a version</h3>
<div class="paragraph">
<p>The meta information of a document can be changed. The changes can be persisted in the database without creating a version. It is possible, to maintain frequently changing information on the document quickly without creating the overhead of a version. However, in the event of an audit, the changes are not traceable.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_document_service_recycle_bin"><a class="anchor" href="#_document_service_recycle_bin"></a>Delete an object</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Documents contain one or more content elements which are not stored in the database but in the storage system. When a document is deleted using one of the delete-calls, the content elements will remain on the storage. To delete both the database entries and all content elements (including those referenced from older versions), a client can use the purge
methods provided by the document clients.</p>
</div>
<div class="paragraph">
<p>A type definition can use the optional <em>recycle bin</em> feature. If it is enabled, entities in the type definition can be moved to and restored from the recycle bin.
The Delete-API allows you to execute the methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MoveToRecycleBin(): to move an object to the recycle bin. The <em>DELETE</em>-property of the latest version is set to 1 and content and older versions are not affected.</p>
</li>
<li>
<p>Delete() all the versions of the object are deleted from the database.</p>
</li>
<li>
<p>Purge(): all the version of the objects are deleted from the database and the content objects or files are erased.</p>
</li>
<li>
<p>RestoreFormRecycleBin(): restore an object from the recycle bin, the <em>DELETE</em>-property is set to 0</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If an object has relations to other objects is related by other objects the delete or purge method will fail with a foreign key exception. The Relation API provides methods to delete the relations (<a href="#removing_all_relations_of_an_entity"><strong>Remove Relations</strong></a>)
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="filter_recycle_bin"><a class="anchor" href="#filter_recycle_bin"></a>Filter recycle bin</h3>
<div class="paragraph">
<p>Entities in the recycle bin will be filtered from normal queries by default, but a client can compose search expressions that override this behavior. To do that it is sufficient to include a reference to the deleted system field in the expression. The following example shows a part of a query that will show only deleted entities:</p>
</div>
<div class="listingblock">
<div class="title">Excerpt of an example query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">....and().systemField(SystemFieldList.GeneralSystemField.Deleted.INSTANCE).equalTo().value(true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the deleted system field can contain <em>null</em> values, which have the same meaning as <em>false</em>. When a client uses one of the <em>delete</em> calls to delete one or more entities, all database entries for those entities will be deleted (including all versions).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no option to restore entities once they have been deleted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If there are relations between entities that are to be deleted, the relations are not deleted. Instead, a <em>ForeignKeyException</em> is thrown - and has to be handled by the caller.</p>
</div>
</div>
<div class="sect2">
<h3 id="removing_all_relations_of_an_entity"><a class="anchor" href="#removing_all_relations_of_an_entity"></a>Removing all relations of an entity</h3>
<div class="paragraph">
<p>To delete all relations that originate from a certain entity, the method <em>removeAllRelations()</em> has to be used. The method returns the deleted relations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Relation&gt; removed = sourceContainerClient.removeAllRelations();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also delete all relations that point to a specific entity. For this, there is the method <em>removeAllIncomingRelations()</em>. This also returns the deleted relations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Relation&gt; removed = targetContainerClient.removeAllIncomingRelations();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all relations have been removed, the entity can also be deleted.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="locking"><a class="anchor" href="#locking"></a>Locking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If your applications want to update objects from different processes at the same time you must decide if you want to use no locking or optimistic locking.
No locking means that the latest update wins and overwrites the concurrent update. Depending on the database configuration it might happen that one update becomes a deadlock victim and an exception is thrown.
If optimistic locking is enabled for the document type the API ensures that updates do not overwrite changes made by other clients by accident. The feature is disabled by default and can be enabled by annotating a type class with <em>@OptimisticLocking</em>.
e.g. two processes A and B load the same object including content and versions at the same time and get the same version of the document. Now both processes process the document and some metadata and add additional content. A is faster than B. With No Locking B overwrites the changes made by A. With optimistic locking B cannot save the changes and receives a Locking exception. Process B has to load the changes made by A and retry the operation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="download_links_for_external_users"><a class="anchor" href="#download_links_for_external_users"></a>Download links for external users</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can create download links for content elements that can be used by external users. Such a link has an expiration date and can be used to download a single content element. The links are digitally signed using a configurable certificate, so that the receiver cannot alter the
referenced content element or the expiration date of the link. The <em>arveo</em> service provides a special HTTP endpoint to process download links. This endpoint does not require authentication. Instead, the download link contains credentials that allow the user to access the referenced content element.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This feature must be activated by configuring a keystore containing an RSA keypair that will be used to sign the links.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration options are listed <a href="../commons/configuration-properties.html#_ecr_server_content-access-tokens" class="xref page">here</a>.</p>
</div>
<div class="paragraph">
<p>Download links (or content access tokens), can be created using the Java SDK as shown in the following exaple:</p>
</div>
<div class="listingblock">
<div class="title">Injecting and instance of the ContentAccessTokenResourceClient</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private ContentAccessTokenResourceClient contentAccessTokenResourceClient;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Creating a new content access token</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ContentAccessTokenInput input = new ContentAccessTokenInput(
    documentId,<i class="conum" data-value="1"></i><b>(1)</b>
    "content",<i class="conum" data-value="2"></i><b>(2)</b>
    ZonedDateTime.now().plusHours(3)<i class="conum" data-value="3"></i><b>(3)</b>
);

String token = contentAccessTokenResourceClient.createToken(input);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The ID of the document containing the content element to download</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the content element</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The expiration date of the link (can be omitted)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The returned token can then be used to download the content by performing a GET request to the following endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">GET http://my-arveo-instance/api/streaming/&lt;token&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Download links can only be created for content elements that are accessible to the user creating the link. When the client does not define an expiration date when the content access token is created, the configured maximum lifetime is used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The creation of new tokens will fail when the client specifies an expiration date that would exceed the configured maximum lifetime.
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="advanced-schema-changes.html">Advanced database schema changes</a></span>
  <span class="next"><a href="versioning.html">Versioning</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../ui-assets/js/site.js" data-ui-root-path="../../../ui-assets"></script>
<script async src="../../../ui-assets/js/vendor/highlight.js"></script>
  </body>
</html>
